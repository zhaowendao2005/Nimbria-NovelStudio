# 命令面板与右侧栏系统开发指南

> **版本**: v1.0  
> **更新日期**: 2025-10-08  
> **适用范围**: Nimbria Project Page System

---

## 📋 目录

1. [架构概览](#架构概览)
2. [核心概念](#核心概念)
3. [目录结构](#目录结构)
4. [快速开始](#快速开始)
5. [添加新命令](#添加新命令)
6. [添加新面板](#添加新面板)
7. [跨模块状态访问](#跨模块状态访问)
8. [修改现有功能](#修改现有功能)
9. [开发规范](#开发规范)
10. [常见问题](#常见问题)
11. [最佳实践](#最佳实践)

---

## 🏗️ 架构概览

### 设计原则

1. **插件化**: 命令和面板均通过插件注册，核心系统不包含任何业务逻辑
2. **解耦**: UI、状态、业务逻辑严格分离
3. **延迟加载**: 面板组件使用 `defineAsyncComponent` 动态加载
4. **多窗口隔离**: 每个项目窗口拥有独立的 Pinia Store 实例
5. **类型安全**: 完整的 TypeScript 类型支持

### 系统组成

```
┌─────────────────────────────────────────────────────────┐
│                    ProjectPageSystem                     │
│  (应用启动时统一注册所有插件)                              │
└────────────┬──────────────────────┬─────────────────────┘
             │                      │
    ┌────────▼────────┐    ┌───────▼──────────┐
    │  命令面板系统    │    │   右侧栏系统      │
    │ Command Palette │    │ Right Sidebar    │
    └────────┬────────┘    └───────┬──────────┘
             │                      │
    ┌────────▼────────┐    ┌───────▼──────────┐
    │  Command Store  │    │ Sidebar Store    │
    │  (Pinia)        │    │ (Pinia)          │
    └────────┬────────┘    └───────┬──────────┘
             │                      │
    ┌────────▼────────┐    ┌───────▼──────────┐
    │   Command API   │    │  Sidebar API     │
    │   (单例服务)     │    │  (单例服务)       │
    └────────┬────────┘    └───────┬──────────┘
             │                      │
    ┌────────▼────────┐    ┌───────▼──────────┐
    │  命令插件集合    │    │  面板插件集合     │
    │  (Utils/Plugins) │    │  (Utils/Plugins) │
    └─────────────────┘    └──────────────────┘
```

### 数据流向

```
用户操作
  ↓
UI 组件 (CommandPalette.vue / RightSidebar.vue)
  ↓
API 服务 (command.api.ts / rightSidebar.api.ts)
  ↓
Pinia Store (状态管理)
  ↓
执行插件注册的 action / 渲染插件提供的 component
```

---

## 🧩 核心概念

### 1. 命令 (Command)

命令是一个可执行的操作，由以下部分组成：

```typescript
interface Command {
  id: string                           // 唯一标识（格式: category.action）
  label: string                        // 显示文本
  category: CommandCategory            // 分类 (view/file/edit/navigate/tools/custom)
  action: () => void | Promise<void>   // 执行函数（由插件提供）
  icon?: string                        // Element Plus icon name
  keywords?: string[]                  // 搜索关键词（支持中英文）
  shortcut?: string                    // 快捷键显示文本（仅展示用）
  priority?: number                    // 优先级（数值越大越靠前）
  when?: () => boolean                 // 显示条件（返回false则不显示）
}
```

**关键点**:
- `action` 函数**必须由插件提供**，包含具体的业务逻辑
- `when` 函数用于动态控制命令是否可见（例如：仅在打开文件时显示）

### 2. 面板 (Panel)

面板是右侧栏中的一个标签页，由以下部分组成：

```typescript
interface RightSidebarPanel {
  id: string                    // 唯一标识
  label: string                 // 标签文本
  component: Component          // Vue组件（由插件提供）
  icon?: string                 // Element Plus icon name
  closable?: boolean            // 是否可关闭（默认true）
  order?: number                // 排序权重（数值越小越靠前）
  when?: () => boolean          // 显示条件
}
```

**关键点**:
- `component` **必须由插件提供**，负责渲染面板内容
- 使用 `defineAsyncComponent` 实现懒加载

### 3. 插件 (Plugin)

插件是一个纯函数，负责注册命令或面板：

```typescript
// 命令插件示例
export function registerMyCommands() {
  commandApi.register({
    id: 'my.command',
    label: '我的命令',
    category: 'custom',
    action: () => { /* 业务逻辑 */ }
  })
}

// 面板插件示例
export function registerMyPanel() {
  rightSidebarApi.register({
    id: 'my-panel',
    label: '我的面板',
    component: defineAsyncComponent(() => import('./MyPanel.vue'))
  })
}
```

---

## 📁 目录结构

```
Nimbria/Client/
├── GUI/
│   ├── components/
│   │   └── ProjectPage.Shell/
│   │       ├── CommandPalette/
│   │       │   ├── CommandPalette.vue          # 命令面板 UI
│   │       │   └── CommandPalette.scss         # 命令面板样式
│   │       └── RightSidebar/
│   │           ├── RightSidebar.vue            # 右侧栏容器 UI
│   │           ├── RightSidebar.scss           # 右侧栏样式
│   │           └── panels/                     # 面板组件集合
│   │               └── OutlinePanel.vue        # 示例：大纲面板
│   ├── Index/
│   │   └── ProjectPageSystem.vue               # 🔥 插件注册入口
│   └── layouts/
│       └── ProjectMainLayout.vue               # 🔥 集成点（快捷键监听）
│
├── Service/
│   └── CommandPanelRightSidebar/
│       ├── command.api.ts                      # 命令 API 服务
│       └── rightSidebar.api.ts                 # 右侧栏 API 服务
│
├── stores/
│   └── projectPage/
│       ├── commandPalette/
│       │   ├── commandPalette.store.ts         # 命令面板 Store
│       │   └── types.ts                        # 命令相关类型定义
│       └── rightSidebar/
│           ├── rightSidebar.store.ts           # 右侧栏 Store
│           └── types.ts                        # 面板相关类型定义
│
└── Utils/
    └── Plugins/
        ├── commands/
        │   ├── index.ts                        # 🔥 命令插件注册中心
        │   └── view-commands.plugin.ts         # 示例：视图命令插件
        └── panels/
            ├── index.ts                        # 🔥 面板插件注册中心
            └── outline-panel.plugin.ts         # 示例：大纲面板插件
```

**关键文件说明**:

| 文件 | 职责 | 修改频率 |
|------|------|----------|
| `ProjectPageSystem.vue` | 应用启动时统一调用所有插件注册 | 几乎不改 |
| `ProjectMainLayout.vue` | 集成命令面板、监听全局快捷键 | 几乎不改 |
| `command.api.ts` / `rightSidebar.api.ts` | 封装 Store 操作，提供统一接口 | 几乎不改 |
| `*.store.ts` | Pinia 状态管理 | 几乎不改 |
| `Utils/Plugins/commands/index.ts` | 🔥 **添加新命令插件时需修改** | 经常 |
| `Utils/Plugins/panels/index.ts` | 🔥 **添加新面板插件时需修改** | 经常 |

---

## 🚀 快速开始

### 应用启动流程

1. **`ProjectPageSystem.vue` 挂载时**:
   ```typescript
   onMounted(() => {
     registerAllPanelPlugins()    // 注册所有面板
     registerAllCommandPlugins()  // 注册所有命令
   })
   ```

2. **插件注册中心调用各个插件**:
   ```typescript
   // Utils/Plugins/commands/index.ts
   export function registerAllCommandPlugins() {
     registerViewCommands()
     // ... 其他命令插件
   }
   ```

3. **每个插件通过 API 注册**:
   ```typescript
   export function registerViewCommands() {
     commandApi.register({ /* ... */ })
   }
   ```

### 用户交互流程

1. **打开命令面板**: `Ctrl+Shift+P` → `ProjectMainLayout` 监听键盘事件 → `commandApi.toggle()`
2. **搜索命令**: 输入关键词 → UI 过滤 `availableCommands`
3. **执行命令**: 点击或回车 → `commandApi.execute(commandId)` → 调用插件注册的 `action()`
4. **切换面板**: 点击标签 → `rightSidebarApi.switchTo(panelId)` → 渲染对应 `component`

---

## ➕ 添加新命令

### 步骤 1: 创建命令插件文件

在 `Client/Utils/Plugins/commands/` 下创建新文件，例如 `file-commands.plugin.ts`:

```typescript
/**
 * 文件操作命令插件
 */

import { commandApi } from '@service/CommandPanelRightSidebar/command.api'
import type { Command } from '@stores/projectPage/commandPalette/types'

const createFileCommands = (): Command[] => {
  return [
    {
      id: 'file.newMarkdown',
      label: '新建 Markdown 文件',
      category: 'file',
      keywords: ['new', 'file', 'markdown', '新建', '文件'],
      icon: 'Document',
      shortcut: 'Ctrl+N',
      priority: 100,
      action: async () => {
        // 🔥 这里是你的业务逻辑
        console.log('Creating new markdown file...')
        // 示例：调用 Store 或 Service
        // await markdownStore.createFile()
      },
      when: () => {
        // 可选：动态控制命令是否显示
        // return markdownStore.hasOpenProject
        return true
      }
    },
    {
      id: 'file.save',
      label: '保存当前文件',
      category: 'file',
      keywords: ['save', '保存', 'ctrl+s'],
      icon: 'Document',
      shortcut: 'Ctrl+S',
      priority: 99,
      action: async () => {
        // 你的保存逻辑
      }
    }
  ]
}

/**
 * 注册文件命令插件
 */
export function registerFileCommands() {
  commandApi.registerBatch(createFileCommands())
  console.log('[Plugin] File commands registered')
}
```

### 步骤 2: 在注册中心添加插件

编辑 `Client/Utils/Plugins/commands/index.ts`:

```typescript
import { registerViewCommands } from './view-commands.plugin'
import { registerFileCommands } from './file-commands.plugin'  // 🔥 导入

export function registerAllCommandPlugins() {
  registerViewCommands()
  registerFileCommands()  // 🔥 注册
  // ... 继续添加其他插件
}
```

### 步骤 3: 测试

1. 重启应用
2. 按 `Ctrl+Shift+P` 打开命令面板
3. 搜索你的命令（例如输入 "新建"）
4. 执行命令，查看控制台输出

---

## ➕ 添加新面板

### 步骤 1: 创建面板组件

在 `Client/GUI/components/ProjectPage.Shell/RightSidebar/panels/` 下创建新组件，例如 `SearchPanel.vue`:

```vue
<template>
  <div class="search-panel">
    <h3>搜索结果</h3>
    <p>{{ searchQuery }}</p>
    <!-- 🔥 你的面板内容 -->
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'

/**
 * SearchPanel
 * 搜索结果面板
 * 注意：标题栏和关闭按钮由 RightSidebar 统一管理
 */

const searchQuery = ref('')

// 🔥 你的面板逻辑
</script>

<style scoped>
.search-panel {
  padding: 16px;
  height: 100%;
  overflow-y: auto;
}
</style>
```

### 步骤 2: 创建面板插件

在 `Client/Utils/Plugins/panels/` 下创建插件文件 `search-panel.plugin.ts`:

```typescript
/**
 * 搜索面板插件
 */

import { rightSidebarApi } from '@service/CommandPanelRightSidebar/rightSidebar.api'
import { defineAsyncComponent } from 'vue'

export function registerSearchPanel() {
  rightSidebarApi.register({
    id: 'search',
    label: '搜索',
    icon: 'Search',           // Element Plus icon
    closable: true,           // 可关闭
    order: 2,                 // 排序权重（数值越小越靠前）
    component: defineAsyncComponent(() => 
      import('@components/ProjectPage.Shell/RightSidebar/panels/SearchPanel.vue')
    ),
    when: () => {
      // 可选：动态控制面板是否显示
      return true
    }
  })
  
  console.log('[Plugin] Search panel registered')
}
```

### 步骤 3: 在注册中心添加插件

编辑 `Client/Utils/Plugins/panels/index.ts`:

```typescript
import { registerOutlinePanel } from './outline-panel.plugin'
import { registerSearchPanel } from './search-panel.plugin'  // 🔥 导入

export function registerAllPanelPlugins() {
  registerOutlinePanel()
  registerSearchPanel()  // 🔥 注册
  // ... 继续添加其他插件
}
```

### 步骤 4: (可选) 添加对应的命令

在命令插件中添加打开该面板的命令：

```typescript
{
  id: 'view.showSearch',
  label: '显示搜索面板',
  category: 'view',
  keywords: ['search', '搜索'],
  action: () => {
    rightSidebarApi.switchTo('search')
  }
}
```

---

## 🔗 跨模块状态访问

### 核心原则

**Pinia Store 本身就是全局的**，可以在任何地方（插件、组件、其他 Store）直接导入使用，**无需额外的注册机制**。

### 场景 1: 命令插件访问其他 Store

**直接导入即可**：

```typescript
import { commandApi } from '@service/CommandPanelRightSidebar/command.api'
import { useMarkdownStore } from '@stores/projectPage/Markdown'
import type { MarkdownTab } from '@stores/projectPage/Markdown/types'

export function registerMarkdownCommands() {
  commandApi.register({
    id: 'markdown.save',
    label: '保存当前文件',
    category: 'file',
    action: async () => {
      // 🔥 直接获取 Store 实例
      const markdownStore = useMarkdownStore()
      
      // 访问状态和方法
      if (markdownStore.hasUnsavedChanges) {
        await markdownStore.saveCurrentFile()
      }
    },
    when: () => {
      // 🔥 在条件判断中也可以直接访问
      const markdownStore = useMarkdownStore()
      return markdownStore.openTabs.length > 0
    }
  })
}
```

### 场景 2: 面板组件访问其他 Store

**在 Vue 组件中直接导入**：

```vue
<template>
  <div class="outline-panel">
    <h3>{{ activeFile?.fileName || '无打开文件' }}</h3>
    <div v-for="heading in outlineItems" :key="heading.id">
      {{ heading.text }}
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import { useMarkdownStore } from '@stores/projectPage/Markdown'

// 🔥 直接获取 Store
const markdownStore = useMarkdownStore()

// 🔥 使用 computed 响应式访问状态
const activeFile = computed(() => markdownStore.activeTab)
const outlineItems = computed(() => {
  const content = activeFile.value?.content || ''
  return extractHeadings(content)
})

function extractHeadings(content: string) {
  // 提取标题逻辑
  return []
}
</script>
```

### 场景 3: 命令插件调用多个模块

**导入多个 Store 或 API**：

```typescript
import { commandApi } from '@service/CommandPanelRightSidebar/command.api'
import { rightSidebarApi } from '@service/CommandPanelRightSidebar/rightSidebar.api'
import { useMarkdownStore } from '@stores/projectPage/Markdown'

export function registerViewCommands() {
  commandApi.register({
    id: 'view.showOutlineIfFileOpen',
    label: '显示大纲（如果有打开的文件）',
    category: 'view',
    action: () => {
      const markdownStore = useMarkdownStore()
      
      if (markdownStore.openTabs.length === 0) {
        console.warn('没有打开的文件')
        return
      }
      
      // 切换到大纲面板
      rightSidebarApi.switchTo('outline')
    }
  })
}
```

### 场景 4: Store 之间互相访问

**一个 Store 访问另一个 Store**：

```typescript
import { defineStore } from 'pinia'
import { useMarkdownStore } from './markdown.store'

export const useOutlineStore = defineStore('outline', () => {
  const syncWithMarkdown = () => {
    // 🔥 直接获取其他 Store
    const markdownStore = useMarkdownStore()
    
    const activeContent = markdownStore.activeTab?.content || ''
    // 处理内容...
  }
  
  return { syncWithMarkdown }
})
```

### 关键点

- ✅ **直接导入**: Pinia Store 可以在任何地方直接 `import` 使用
- ✅ **多窗口隔离**: Electron 的进程隔离保证每个窗口有独立的 Store 实例
- ✅ **类型安全**: TypeScript 完整支持，自动补全和类型检查
- ✅ **无需注册**: 不需要额外的注册表或中间层
- ✅ **响应式**: 在 Vue 组件中使用 `computed` 或 `watch` 自动响应状态变化

### ⚠️ 注意事项

1. **在 `action` 函数内部调用 `useXxxStore()`**，而不是在模块顶层：
   ```typescript
   // ❌ 错误：模块顶层调用
   const markdownStore = useMarkdownStore()
   export function registerCommands() { /* ... */ }
   
   // ✅ 正确：在函数内部调用
   export function registerCommands() {
     commandApi.register({
       action: () => {
         const markdownStore = useMarkdownStore()  // ✅
       }
     })
   }
   ```

2. **使用 API 而不是直接访问 Store**（当有 API 封装时）：
   ```typescript
   // ✅ 推荐：通过 API
   rightSidebarApi.toggle()
   
   // ❌ 不推荐：绕过 API 直接访问
   const store = useRightSidebarStore()
   store.toggle()
   ```

---

## 🔧 修改现有功能

### 修改命令

1. **找到对应的插件文件**: 在 `Client/Utils/Plugins/commands/` 中搜索
2. **修改 `action` 函数或其他字段**
3. **重启应用测试**

### 修改面板

1. **找到面板组件**: 在 `Client/GUI/components/ProjectPage.Shell/RightSidebar/panels/` 中
2. **直接修改 Vue 组件**
3. **热重载会自动生效**

### 修改 UI 容器

**不建议**修改以下文件，除非需要改变核心交互逻辑：
- `CommandPalette.vue` / `CommandPalette.scss`
- `RightSidebar.vue` / `RightSidebar.scss`

### 修改 API 或 Store

**极少需要**修改以下文件，除非扩展核心功能：
- `command.api.ts` / `rightSidebar.api.ts`
- `commandPalette.store.ts` / `rightSidebar.store.ts`

---

## 📜 开发规范

### 1. 命名规范

| 类型 | 格式 | 示例 |
|------|------|------|
| 命令 ID | `category.action` | `file.save`, `view.toggleSidebar` |
| 面板 ID | `kebab-case` | `outline`, `search-results` |
| 插件文件 | `name-type.plugin.ts` | `view-commands.plugin.ts`, `outline-panel.plugin.ts` |
| 面板组件 | `PascalCase.vue` | `OutlinePanel.vue`, `SearchPanel.vue` |

### 2. 文件组织

- **一个插件文件只负责一类功能**（例如：视图命令、文件命令）
- **面板组件放在 `RightSidebar/panels/` 下**
- **插件文件放在 `Utils/Plugins/commands/` 或 `Utils/Plugins/panels/` 下**

### 3. 插件编写规范

```typescript
/**
 * 插件描述
 * 职责：...
 */

import { commandApi } from '@service/CommandPanelRightSidebar/command.api'
import type { Command } from '@stores/projectPage/commandPalette/types'

// 🔥 使用工厂函数创建命令数组
const createMyCommands = (): Command[] => {
  return [
    // ...
  ]
}

/**
 * 注册插件（导出函数）
 */
export function registerMyCommands() {
  commandApi.registerBatch(createMyCommands())
  console.log('[Plugin] My commands registered')
}
```

### 4. 类型安全

- **所有命令和面板定义使用 TypeScript**
- **使用 `import type` 导入类型**
- **面板组件使用 `<script setup lang="ts">`**

### 5. 注释规范

```typescript
/**
 * 函数/类/接口的描述
 * @param param 参数说明
 * @returns 返回值说明
 */
```

---

## ❓ 常见问题

### Q1: 命令面板打不开？

**A**: 检查以下几点：
1. `ProjectMainLayout.vue` 是否正确监听了 `Ctrl+Shift+P`
2. `CommandPalette.vue` 是否正确集成到布局中
3. 浏览器控制台是否有错误

### Q2: 命令注册了但不显示？

**A**: 检查：
1. `when()` 函数是否返回 `false`
2. 插件是否在 `registerAllCommandPlugins()` 中调用
3. 浏览器控制台是否有 `[Plugin] XXX registered` 日志

### Q3: 面板关闭后如何重新打开？

**A**: 两种方式：
1. 通过命令面板执行对应的 `view.showXXX` 命令
2. 调用 `rightSidebarApi.switchTo('panel-id')`

### Q4: 如何调试插件？

**A**: 
```typescript
export function registerMyCommands() {
  console.log('[Plugin] Registering my commands...')
  const commands = createMyCommands()
  console.log('Commands:', commands)  // 🔥 打印命令列表
  commandApi.registerBatch(commands)
  console.log('[Plugin] My commands registered')
}
```

### Q5: 面板组件如何访问 Pinia Store?

**A**: 
```vue
<script setup lang="ts">
import { useMarkdownStore } from '@stores/projectPage/Markdown'

const markdownStore = useMarkdownStore()
</script>
```

### Q6: 命令执行失败怎么办？

**A**: 命令的 `action` 函数应该处理错误：
```typescript
action: async () => {
  try {
    await doSomething()
  } catch (error) {
    console.error('Command failed:', error)
    // 可选：显示错误提示
  }
}
```

### Q7: 如何实现命令的快捷键？

**A**: 
- `shortcut` 字段**仅用于展示**，不会自动绑定快捷键
- 需要在 `ProjectMainLayout.vue` 或其他地方手动监听键盘事件并调用 `commandApi.execute()`

---

## 🎯 最佳实践

### 1. 保持插件纯净

```typescript
// ✅ 好的做法：插件只负责注册
export function registerFileCommands() {
  commandApi.registerBatch(createFileCommands())
}

// ❌ 不好的做法：插件包含业务逻辑
export function registerFileCommands() {
  // 不要在这里初始化其他东西
  const fileManager = new FileManager()
  // ...
}
```

### 2. 使用 `when()` 实现智能显示

```typescript
{
  id: 'file.save',
  label: '保存文件',
  category: 'file',
  action: () => { /* ... */ },
  when: () => {
    // 只在有打开的文件时显示
    const activeTab = stateRegistry.get('markdown:activeTab')
    return activeTab !== null
  }
}
```

### 3. 面板组件应该自给自足

```vue
<script setup lang="ts">
/**
 * OutlinePanel
 * 职责：显示当前文档的大纲
 * 依赖：markdown store (通过 stateRegistry 访问)
 * 注意：不要依赖父组件传递的 props
 */

import { ref, watch } from 'vue'
import { stateRegistry } from '@service/StateRegistry'

// 🔥 直接访问需要的状态
const activeTab = ref(stateRegistry.get('markdown:activeTab'))

watch(() => stateRegistry.get('markdown:activeTab'), (newTab) => {
  activeTab.value = newTab
  // 更新大纲
})
</script>
```

### 4. 统一错误处理

```typescript
const createSafeCommand = (command: Omit<Command, 'action'> & { 
  action: () => void | Promise<void> 
}): Command => {
  return {
    ...command,
    action: async () => {
      try {
        await command.action()
      } catch (error) {
        console.error(`Command "${command.id}" failed:`, error)
        // 可选：显示全局错误提示
      }
    }
  }
}

// 使用
const createFileCommands = (): Command[] => {
  return [
    createSafeCommand({
      id: 'file.save',
      label: '保存',
      category: 'file',
      action: async () => {
        // 这里的错误会被自动捕获
        await markdownStore.saveFile()
      }
    })
  ]
}
```

### 5. 面板组件性能优化

```vue
<script setup lang="ts">
import { computed, defineAsyncComponent } from 'vue'

// 🔥 使用 computed 缓存
const outlineItems = computed(() => {
  const content = stateRegistry.get<string>('markdown:content')
  return extractHeadings(content)  // 只在内容变化时重新计算
})

// 🔥 大型子组件使用异步加载
const HeavyComponent = defineAsyncComponent(() => 
  import('./HeavyComponent.vue')
)
</script>
```

---

## 📚 相关文档

- [命令面板与右栏重构 Design](../../Design/命令面板与右栏重构/Design.md)
- [架构设计总览](../../架构设计/架构设计总览.md)
- [开发通用工作流](./开发通用工作流.md)

---

## 🔄 更新日志

| 版本 | 日期 | 内容 |
|------|------|------|
| v1.0 | 2025-10-08 | 初始版本，包含完整的开发指南 |

---

**如有疑问，请查阅代码注释或联系架构负责人。**

