好的Boss！给你完整的设计方案和文件架构修改树。

## 📐 设计方案

### 核心设计原则
1. **单一数据源**：所有对话数据由 `llmChatStore` 管理
2. **轻量传递**：窗口间只传递 `conversationId`，不传递消息内容
3. **按需加载**：新窗口/标签页启动时从数据库加载对话
4. **组件复用**：最大化复用现有的 ChatMessages、ChatInput 等组件

### 功能流程

**左侧栏 → 主面板：**
```
右键对话标签 → "拆分到主面板" 
→ CustomPageAPI.open({ params: { conversationId }})
→ 在主面板 PaneSystem 中打开标签页
→ 显示该对话
```

**左侧栏 → 独立窗口：**
```
右键对话标签 → "拆分到新窗口"
→ window.nimbria.project.detachTabToWindow({ conversationId })
→ 创建新窗口
→ 新窗口加载对话
```

**主面板 → 独立窗口：**
```
右键主面板的 LLM 标签页 → "拆分到新窗口"（已有功能）
→ PaneContent 自动处理
→ 传递 conversationId 到新窗口
```

---

## 🌲 文件架构修改树

```
Nimbria/
├── Client/
│   ├── GUI/
│   │   └── components/
│   │       ├── ProjectPage.MainPanel/
│   │       │   ├── [新增目录] LlmChat/
│   │       │   │   ├── [新增文件] LlmChatTab.vue
│   │       │   │   │   └── 内部模块：对话标签页主组件，接收conversationId参数
│   │       │   │   ├── [新增文件] LlmChatPage.vue
│   │       │   │   │   └── 内部模块：页面包装组件，连接CustomPageManager
│   │       │   │   ├── [新增文件] register.ts
│   │       │   │   │   └── 内部模块：注册到CustomPageManager，定义tabType为'llmchat'
│   │       │   │   └── [新增文件] index.ts
│   │       │   │       └── 内部模块：模块导出
│   │       │   ├── PaneSystem/
│   │       │   │   └── PaneContent.vue [修改内容]
│   │       │   │       ├── 内部模块：template中添加LlmChatTab渲染分支（v-else-if activeTabType === 'llmchat'）
│   │       │   │       ├── 内部模块：导入LlmChatTab组件
│   │       │   │       └── 内部模块：handleDetachToWindow中添加llmchat类型处理，传递conversationId
│   │       │   └── Markdown/
│   │       │       └── MarkdownTab.vue
│   │       └── ProjectPage.Shell/
│   │           └── Navbar.content/
│   │               └── LlmChat/
│   │                   └── LlmChatPanel.vue [修改内容]
│   │                       ├── 内部模块：右键菜单添加"拆分到主面板"选项（command: 'split-to-panel'）
│   │                       ├── 内部模块：右键菜单添加"拆分到新窗口"选项（command: 'split-to-window'）
│   │                       ├── 内部模块：handleContextCommand处理split-to-panel，调用CustomPageAPI.open()
│   │                       └── 内部模块：handleContextCommand处理split-to-window，调用window.nimbria.project.detachTabToWindow()
│   ├── stores/
│   │   └── llmChat/
│   │       └── llmChatStore.ts [修改内容]
│   │           ├── 内部模块：添加loadConversationById(conversationId)方法
│   │           └── 内部模块：支持从数据库按ID加载单个对话及其消息历史
│   └── types/
│       └── llmChat.ts [修改内容]
│           └── 内部模块：可能需要添加对话加载相关的类型定义
├── src-electron/
│   └── ipc/
│       └── project-channel.ts [修改内容]
│           └── 内部模块：detachTabToWindow处理器中添加llmchat类型分支，传递conversationId到新窗口
```

---

## 📋 详细修改说明

### 1️⃣ 新建文件

#### `Client/GUI/components/ProjectPage.MainPanel/LlmChat/LlmChatTab.vue`
**功能：**
- 主面板中的对话标签页组件
- 接收 `conversationId` prop
- 渲染 ChatMessages + ChatInput
- 复用左侧栏的子组件（ModelSelector、ChatMessages等）

**关键点：**
```vue
<script setup>
interface Props {
  tabId: string
  conversationId?: string  // 指定显示的对话ID
}

onMounted(async () => {
  // 如果传入conversationId，加载该对话
  if (props.conversationId) {
    await llmChatStore.loadConversationById(props.conversationId)
    llmChatStore.activeConversationId = props.conversationId
  }
})
</script>
```

#### `Client/GUI/components/ProjectPage.MainPanel/LlmChat/LlmChatPage.vue`
**功能：**
- 简单的包装组件
- 从 CustomPageManager 的 instance.params 获取 conversationId
- 传递给 LlmChatTab

#### `Client/GUI/components/ProjectPage.MainPanel/LlmChat/register.ts`
**功能：**
- 注册页面配置到 CustomPageManager
- 定义 `tabType: 'llmchat'`
- 设置 `singleton: false`（允许多实例）

---

### 2️⃣ 修改文件

#### `LlmChatPanel.vue`（左侧栏）

**模板修改：**
```vue
<!-- 右键菜单添加新选项 -->
<el-dropdown-menu v-if="contextMenuConversation">
  <el-dropdown-item command="rename">
    <el-icon><Edit /></el-icon>
    重命名
  </el-dropdown-item>
  <el-dropdown-item command="export">
    <el-icon><Download /></el-icon>
    导出对话
  </el-dropdown-item>
  
  <!-- 🔥 新增：拆分选项 -->
  <el-dropdown-item command="split-to-panel" divided>
    <el-icon><Grid /></el-icon>
    拆分到主面板
  </el-dropdown-item>
  <el-dropdown-item command="split-to-window">
    <el-icon><FullScreen /></el-icon>
    拆分到新窗口
  </el-dropdown-item>
  
  <el-dropdown-item command="close" divided>
    <el-icon><Close /></el-icon>
    关闭标签
  </el-dropdown-item>
</el-dropdown-menu>
```

**脚本修改：**
```typescript
// 添加导入
import { Grid, FullScreen } from '@element-plus/icons-vue'
import { CustomPageAPI } from '@/Service/CustomPageManager'

// handleContextCommand 添加新的 case
const handleContextCommand = async (command: string) => {
  if (!contextMenuConversation.value) return
  
  const conversation = contextMenuConversation.value
  
  switch (command) {
    case 'split-to-panel':
      // 拆分到主面板
      CustomPageAPI.open('llmchat-conversation', {
        params: { conversationId: conversation.id }
      })
      ElMessage.success('已在主面板打开对话')
      break
      
    case 'split-to-window':
      // 拆分到新窗口
      const projectPath = window.nimbria?.getCurrentProjectPath?.()
      if (!projectPath) {
        ElMessage.error('无法获取项目路径')
        return
      }
      
      const result = await window.nimbria.project.detachTabToWindow({
        tabId: `llmchat-${conversation.id}`,
        tabData: {
          tabType: 'llmchat',
          conversationId: conversation.id,
          title: conversation.title
        },
        projectPath
      })
      
      if (result.success) {
        ElMessage.success('已在新窗口打开对话')
      } else {
        ElMessage.error('打开新窗口失败')
      }
      break
      
    // ... 其他 case
  }
}
```

#### `PaneContent.vue`（主面板）

**模板添加：**
```vue
<!-- 在渲染分支中添加 -->
<LlmChatTab
  v-else-if="localActiveTabId && activeTabType === 'llmchat'"
  :tab-id="localActiveTabId"
  :conversation-id="llmchatConversationId"
/>
```

**脚本添加：**
```typescript
// 导入
import { LlmChatTab } from '@components/ProjectPage.MainPanel/LlmChat'

// 计算当前 llmchat 标签的 conversationId
const llmchatConversationId = computed(() => {
  if (activeTabType.value !== 'llmchat') return undefined
  
  const instance = CustomPageAPI.findInstanceByTabId(localActiveTabId.value)
  return instance?.params?.conversationId
})

// handleDetachToWindow 中添加 llmchat 处理
const handleDetachToWindow = async (tabId: string) => {
  const tab = markdownStore.openTabs.find(t => t.id === tabId)
  if (!tab) return
  
  let tabData: any = {
    id: tab.id,
    title: tab.fileName || 'Untitled',
    tabType: tab.type || 'markdown'
  }
  
  // 🔥 LLM Chat 类型处理
  if (tab.type === 'llmchat') {
    const instance = CustomPageAPI.findInstanceByTabId(tabId)
    tabData.conversationId = instance?.params?.conversationId
    console.log('[PaneContent] Detaching LLM chat:', tabData.conversationId)
  }
  // ... StarChart、Markdown等其他类型处理
  
  // 调用 Electron API
  await window.nimbria.project.detachTabToWindow({
    tabId: tab.id,
    tabData,
    projectPath
  })
}
```

#### `llmChatStore.ts`

**添加方法：**
```typescript
actions: {
  /**
   * 🔥 按ID加载单个对话
   * 用于窗口拆分、标签页恢复等场景
   */
  async loadConversationById(conversationId: string) {
    // 1. 检查是否已加载
    const existing = this.conversations.find(c => c.id === conversationId)
    if (existing) {
      this.activeConversationId = conversationId
      return existing
    }
    
    // 2. 从数据库加载
    const result = await window.nimbria.llmChat.getConversation(conversationId)
    if (!result.success || !result.data) {
      throw new Error('对话不存在')
    }
    
    // 3. 加载消息历史
    const messagesResult = await window.nimbria.llmChat.getMessages(conversationId)
    const messages = messagesResult.success ? messagesResult.data : []
    
    // 4. 添加到 conversations
    const conversation: Conversation = {
      ...result.data,
      messages
    }
    
    this.conversations.push(conversation)
    this.activeConversationId = conversationId
    
    return conversation
  }
}
```

#### `project-channel.ts`（后端）

**在 detachTabToWindow 处理器中：**
```typescript
// 处理不同类型的标签页数据
if (tabData.tabType === 'llmchat') {
  // LLM Chat: 只传递 conversationId
  newWindowOptions.customData = {
    conversationId: tabData.conversationId,
    title: tabData.title
  }
} else if (tabData.tabType === 'starchart') {
  // StarChart: 传递完整状态
  // ...
}
```

---

## 🔄 数据流总结

### 拆分到主面板
```
LlmChatPanel (左侧栏)
  ↓ [右键 → 拆分到主面板]
CustomPageAPI.open({ conversationId })
  ↓
CustomPageManager 创建实例
  ↓
PaneContent 渲染 LlmChatTab
  ↓
llmChatStore.loadConversationById(conversationId)
  ↓
显示对话内容
```

### 拆分到新窗口
```
LlmChatPanel (左侧栏)
  ↓ [右键 → 拆分到新窗口]
window.nimbria.project.detachTabToWindow({ conversationId })
  ↓
Electron 创建新窗口
  ↓
新窗口接收 conversationId
  ↓
CustomPageAPI.open({ conversationId })
  ↓
llmChatStore.loadConversationById(conversationId)
  ↓
显示对话内容
```

---

## ✅ 实现检查清单

- [ ] 创建 `LlmChat/` 目录及4个新文件
- [ ] 修改 `LlmChatPanel.vue` 添加右键菜单
- [ ] 修改 `PaneContent.vue` 支持 llmchat 渲染
- [ ] 修改 `llmChatStore.ts` 添加加载方法
- [ ] 修改 `project-channel.ts` 处理窗口传递
- [ ] 测试：左侧栏 → 主面板
- [ ] 测试：左侧栏 → 新窗口  
- [ ] 测试：主面板 → 新窗口

Boss，这个设计可以开始实现了吗？