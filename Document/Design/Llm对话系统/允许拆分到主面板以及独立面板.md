å¥½çš„Bossï¼ç»™ä½ å®Œæ•´çš„è®¾è®¡æ–¹æ¡ˆå’Œæ–‡ä»¶æ¶æ„ä¿®æ”¹æ ‘ã€‚

## ğŸ“ è®¾è®¡æ–¹æ¡ˆ

### æ ¸å¿ƒè®¾è®¡åŸåˆ™
1. **å•ä¸€æ•°æ®æº**ï¼šæ‰€æœ‰å¯¹è¯æ•°æ®ç”± `llmChatStore` ç®¡ç†
2. **è½»é‡ä¼ é€’**ï¼šçª—å£é—´åªä¼ é€’ `conversationId`ï¼Œä¸ä¼ é€’æ¶ˆæ¯å†…å®¹
3. **æŒ‰éœ€åŠ è½½**ï¼šæ–°çª—å£/æ ‡ç­¾é¡µå¯åŠ¨æ—¶ä»æ•°æ®åº“åŠ è½½å¯¹è¯
4. **ç»„ä»¶å¤ç”¨**ï¼šæœ€å¤§åŒ–å¤ç”¨ç°æœ‰çš„ ChatMessagesã€ChatInput ç­‰ç»„ä»¶

### åŠŸèƒ½æµç¨‹

**å·¦ä¾§æ  â†’ ä¸»é¢æ¿ï¼š**
```
å³é”®å¯¹è¯æ ‡ç­¾ â†’ "æ‹†åˆ†åˆ°ä¸»é¢æ¿" 
â†’ CustomPageAPI.open({ params: { conversationId }})
â†’ åœ¨ä¸»é¢æ¿ PaneSystem ä¸­æ‰“å¼€æ ‡ç­¾é¡µ
â†’ æ˜¾ç¤ºè¯¥å¯¹è¯
```

**å·¦ä¾§æ  â†’ ç‹¬ç«‹çª—å£ï¼š**
```
å³é”®å¯¹è¯æ ‡ç­¾ â†’ "æ‹†åˆ†åˆ°æ–°çª—å£"
â†’ window.nimbria.project.detachTabToWindow({ conversationId })
â†’ åˆ›å»ºæ–°çª—å£
â†’ æ–°çª—å£åŠ è½½å¯¹è¯
```

**ä¸»é¢æ¿ â†’ ç‹¬ç«‹çª—å£ï¼š**
```
å³é”®ä¸»é¢æ¿çš„ LLM æ ‡ç­¾é¡µ â†’ "æ‹†åˆ†åˆ°æ–°çª—å£"ï¼ˆå·²æœ‰åŠŸèƒ½ï¼‰
â†’ PaneContent è‡ªåŠ¨å¤„ç†
â†’ ä¼ é€’ conversationId åˆ°æ–°çª—å£
```

---

## ğŸŒ² æ–‡ä»¶æ¶æ„ä¿®æ”¹æ ‘

```
Nimbria/
â”œâ”€â”€ Client/
â”‚   â”œâ”€â”€ GUI/
â”‚   â”‚   â””â”€â”€ components/
â”‚   â”‚       â”œâ”€â”€ ProjectPage.MainPanel/
â”‚   â”‚       â”‚   â”œâ”€â”€ [æ–°å¢ç›®å½•] LlmChat/
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ [æ–°å¢æ–‡ä»¶] LlmChatTab.vue
â”‚   â”‚       â”‚   â”‚   â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šå¯¹è¯æ ‡ç­¾é¡µä¸»ç»„ä»¶ï¼Œæ¥æ”¶conversationIdå‚æ•°
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ [æ–°å¢æ–‡ä»¶] LlmChatPage.vue
â”‚   â”‚       â”‚   â”‚   â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šé¡µé¢åŒ…è£…ç»„ä»¶ï¼Œè¿æ¥CustomPageManager
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ [æ–°å¢æ–‡ä»¶] register.ts
â”‚   â”‚       â”‚   â”‚   â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ³¨å†Œåˆ°CustomPageManagerï¼Œå®šä¹‰tabTypeä¸º'llmchat'
â”‚   â”‚       â”‚   â”‚   â””â”€â”€ [æ–°å¢æ–‡ä»¶] index.ts
â”‚   â”‚       â”‚   â”‚       â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ¨¡å—å¯¼å‡º
â”‚   â”‚       â”‚   â”œâ”€â”€ PaneSystem/
â”‚   â”‚       â”‚   â”‚   â””â”€â”€ PaneContent.vue [ä¿®æ”¹å†…å®¹]
â”‚   â”‚       â”‚   â”‚       â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼štemplateä¸­æ·»åŠ LlmChatTabæ¸²æŸ“åˆ†æ”¯ï¼ˆv-else-if activeTabType === 'llmchat'ï¼‰
â”‚   â”‚       â”‚   â”‚       â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šå¯¼å…¥LlmChatTabç»„ä»¶
â”‚   â”‚       â”‚   â”‚       â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šhandleDetachToWindowä¸­æ·»åŠ llmchatç±»å‹å¤„ç†ï¼Œä¼ é€’conversationId
â”‚   â”‚       â”‚   â””â”€â”€ Markdown/
â”‚   â”‚       â”‚       â””â”€â”€ MarkdownTab.vue
â”‚   â”‚       â””â”€â”€ ProjectPage.Shell/
â”‚   â”‚           â””â”€â”€ Navbar.content/
â”‚   â”‚               â””â”€â”€ LlmChat/
â”‚   â”‚                   â””â”€â”€ LlmChatPanel.vue [ä¿®æ”¹å†…å®¹]
â”‚   â”‚                       â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šå³é”®èœå•æ·»åŠ "æ‹†åˆ†åˆ°ä¸»é¢æ¿"é€‰é¡¹ï¼ˆcommand: 'split-to-panel'ï¼‰
â”‚   â”‚                       â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šå³é”®èœå•æ·»åŠ "æ‹†åˆ†åˆ°æ–°çª—å£"é€‰é¡¹ï¼ˆcommand: 'split-to-window'ï¼‰
â”‚   â”‚                       â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šhandleContextCommandå¤„ç†split-to-panelï¼Œè°ƒç”¨CustomPageAPI.open()
â”‚   â”‚                       â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šhandleContextCommandå¤„ç†split-to-windowï¼Œè°ƒç”¨window.nimbria.project.detachTabToWindow()
â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â””â”€â”€ llmChat/
â”‚   â”‚       â””â”€â”€ llmChatStore.ts [ä¿®æ”¹å†…å®¹]
â”‚   â”‚           â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ·»åŠ loadConversationById(conversationId)æ–¹æ³•
â”‚   â”‚           â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ”¯æŒä»æ•°æ®åº“æŒ‰IDåŠ è½½å•ä¸ªå¯¹è¯åŠå…¶æ¶ˆæ¯å†å²
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ llmChat.ts [ä¿®æ”¹å†…å®¹]
â”‚           â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šå¯èƒ½éœ€è¦æ·»åŠ å¯¹è¯åŠ è½½ç›¸å…³çš„ç±»å‹å®šä¹‰
â”œâ”€â”€ src-electron/
â”‚   â””â”€â”€ ipc/
â”‚       â””â”€â”€ project-channel.ts [ä¿®æ”¹å†…å®¹]
â”‚           â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šdetachTabToWindowå¤„ç†å™¨ä¸­æ·»åŠ llmchatç±»å‹åˆ†æ”¯ï¼Œä¼ é€’conversationIdåˆ°æ–°çª—å£
```

---

## ğŸ“‹ è¯¦ç»†ä¿®æ”¹è¯´æ˜

### 1ï¸âƒ£ æ–°å»ºæ–‡ä»¶

#### `Client/GUI/components/ProjectPage.MainPanel/LlmChat/LlmChatTab.vue`
**åŠŸèƒ½ï¼š**
- ä¸»é¢æ¿ä¸­çš„å¯¹è¯æ ‡ç­¾é¡µç»„ä»¶
- æ¥æ”¶ `conversationId` prop
- æ¸²æŸ“ ChatMessages + ChatInput
- å¤ç”¨å·¦ä¾§æ çš„å­ç»„ä»¶ï¼ˆModelSelectorã€ChatMessagesç­‰ï¼‰

**å…³é”®ç‚¹ï¼š**
```vue
<script setup>
interface Props {
  tabId: string
  conversationId?: string  // æŒ‡å®šæ˜¾ç¤ºçš„å¯¹è¯ID
}

onMounted(async () => {
  // å¦‚æœä¼ å…¥conversationIdï¼ŒåŠ è½½è¯¥å¯¹è¯
  if (props.conversationId) {
    await llmChatStore.loadConversationById(props.conversationId)
    llmChatStore.activeConversationId = props.conversationId
  }
})
</script>
```

#### `Client/GUI/components/ProjectPage.MainPanel/LlmChat/LlmChatPage.vue`
**åŠŸèƒ½ï¼š**
- ç®€å•çš„åŒ…è£…ç»„ä»¶
- ä» CustomPageManager çš„ instance.params è·å– conversationId
- ä¼ é€’ç»™ LlmChatTab

#### `Client/GUI/components/ProjectPage.MainPanel/LlmChat/register.ts`
**åŠŸèƒ½ï¼š**
- æ³¨å†Œé¡µé¢é…ç½®åˆ° CustomPageManager
- å®šä¹‰ `tabType: 'llmchat'`
- è®¾ç½® `singleton: false`ï¼ˆå…è®¸å¤šå®ä¾‹ï¼‰

---

### 2ï¸âƒ£ ä¿®æ”¹æ–‡ä»¶

#### `LlmChatPanel.vue`ï¼ˆå·¦ä¾§æ ï¼‰

**æ¨¡æ¿ä¿®æ”¹ï¼š**
```vue
<!-- å³é”®èœå•æ·»åŠ æ–°é€‰é¡¹ -->
<el-dropdown-menu v-if="contextMenuConversation">
  <el-dropdown-item command="rename">
    <el-icon><Edit /></el-icon>
    é‡å‘½å
  </el-dropdown-item>
  <el-dropdown-item command="export">
    <el-icon><Download /></el-icon>
    å¯¼å‡ºå¯¹è¯
  </el-dropdown-item>
  
  <!-- ğŸ”¥ æ–°å¢ï¼šæ‹†åˆ†é€‰é¡¹ -->
  <el-dropdown-item command="split-to-panel" divided>
    <el-icon><Grid /></el-icon>
    æ‹†åˆ†åˆ°ä¸»é¢æ¿
  </el-dropdown-item>
  <el-dropdown-item command="split-to-window">
    <el-icon><FullScreen /></el-icon>
    æ‹†åˆ†åˆ°æ–°çª—å£
  </el-dropdown-item>
  
  <el-dropdown-item command="close" divided>
    <el-icon><Close /></el-icon>
    å…³é—­æ ‡ç­¾
  </el-dropdown-item>
</el-dropdown-menu>
```

**è„šæœ¬ä¿®æ”¹ï¼š**
```typescript
// æ·»åŠ å¯¼å…¥
import { Grid, FullScreen } from '@element-plus/icons-vue'
import { CustomPageAPI } from '@/Service/CustomPageManager'

// handleContextCommand æ·»åŠ æ–°çš„ case
const handleContextCommand = async (command: string) => {
  if (!contextMenuConversation.value) return
  
  const conversation = contextMenuConversation.value
  
  switch (command) {
    case 'split-to-panel':
      // æ‹†åˆ†åˆ°ä¸»é¢æ¿
      CustomPageAPI.open('llmchat-conversation', {
        params: { conversationId: conversation.id }
      })
      ElMessage.success('å·²åœ¨ä¸»é¢æ¿æ‰“å¼€å¯¹è¯')
      break
      
    case 'split-to-window':
      // æ‹†åˆ†åˆ°æ–°çª—å£
      const projectPath = window.nimbria?.getCurrentProjectPath?.()
      if (!projectPath) {
        ElMessage.error('æ— æ³•è·å–é¡¹ç›®è·¯å¾„')
        return
      }
      
      const result = await window.nimbria.project.detachTabToWindow({
        tabId: `llmchat-${conversation.id}`,
        tabData: {
          tabType: 'llmchat',
          conversationId: conversation.id,
          title: conversation.title
        },
        projectPath
      })
      
      if (result.success) {
        ElMessage.success('å·²åœ¨æ–°çª—å£æ‰“å¼€å¯¹è¯')
      } else {
        ElMessage.error('æ‰“å¼€æ–°çª—å£å¤±è´¥')
      }
      break
      
    // ... å…¶ä»– case
  }
}
```

#### `PaneContent.vue`ï¼ˆä¸»é¢æ¿ï¼‰

**æ¨¡æ¿æ·»åŠ ï¼š**
```vue
<!-- åœ¨æ¸²æŸ“åˆ†æ”¯ä¸­æ·»åŠ  -->
<LlmChatTab
  v-else-if="localActiveTabId && activeTabType === 'llmchat'"
  :tab-id="localActiveTabId"
  :conversation-id="llmchatConversationId"
/>
```

**è„šæœ¬æ·»åŠ ï¼š**
```typescript
// å¯¼å…¥
import { LlmChatTab } from '@components/ProjectPage.MainPanel/LlmChat'

// è®¡ç®—å½“å‰ llmchat æ ‡ç­¾çš„ conversationId
const llmchatConversationId = computed(() => {
  if (activeTabType.value !== 'llmchat') return undefined
  
  const instance = CustomPageAPI.findInstanceByTabId(localActiveTabId.value)
  return instance?.params?.conversationId
})

// handleDetachToWindow ä¸­æ·»åŠ  llmchat å¤„ç†
const handleDetachToWindow = async (tabId: string) => {
  const tab = markdownStore.openTabs.find(t => t.id === tabId)
  if (!tab) return
  
  let tabData: any = {
    id: tab.id,
    title: tab.fileName || 'Untitled',
    tabType: tab.type || 'markdown'
  }
  
  // ğŸ”¥ LLM Chat ç±»å‹å¤„ç†
  if (tab.type === 'llmchat') {
    const instance = CustomPageAPI.findInstanceByTabId(tabId)
    tabData.conversationId = instance?.params?.conversationId
    console.log('[PaneContent] Detaching LLM chat:', tabData.conversationId)
  }
  // ... StarChartã€Markdownç­‰å…¶ä»–ç±»å‹å¤„ç†
  
  // è°ƒç”¨ Electron API
  await window.nimbria.project.detachTabToWindow({
    tabId: tab.id,
    tabData,
    projectPath
  })
}
```

#### `llmChatStore.ts`

**æ·»åŠ æ–¹æ³•ï¼š**
```typescript
actions: {
  /**
   * ğŸ”¥ æŒ‰IDåŠ è½½å•ä¸ªå¯¹è¯
   * ç”¨äºçª—å£æ‹†åˆ†ã€æ ‡ç­¾é¡µæ¢å¤ç­‰åœºæ™¯
   */
  async loadConversationById(conversationId: string) {
    // 1. æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
    const existing = this.conversations.find(c => c.id === conversationId)
    if (existing) {
      this.activeConversationId = conversationId
      return existing
    }
    
    // 2. ä»æ•°æ®åº“åŠ è½½
    const result = await window.nimbria.llmChat.getConversation(conversationId)
    if (!result.success || !result.data) {
      throw new Error('å¯¹è¯ä¸å­˜åœ¨')
    }
    
    // 3. åŠ è½½æ¶ˆæ¯å†å²
    const messagesResult = await window.nimbria.llmChat.getMessages(conversationId)
    const messages = messagesResult.success ? messagesResult.data : []
    
    // 4. æ·»åŠ åˆ° conversations
    const conversation: Conversation = {
      ...result.data,
      messages
    }
    
    this.conversations.push(conversation)
    this.activeConversationId = conversationId
    
    return conversation
  }
}
```

#### `project-channel.ts`ï¼ˆåç«¯ï¼‰

**åœ¨ detachTabToWindow å¤„ç†å™¨ä¸­ï¼š**
```typescript
// å¤„ç†ä¸åŒç±»å‹çš„æ ‡ç­¾é¡µæ•°æ®
if (tabData.tabType === 'llmchat') {
  // LLM Chat: åªä¼ é€’ conversationId
  newWindowOptions.customData = {
    conversationId: tabData.conversationId,
    title: tabData.title
  }
} else if (tabData.tabType === 'starchart') {
  // StarChart: ä¼ é€’å®Œæ•´çŠ¶æ€
  // ...
}
```

---

## ğŸ”„ æ•°æ®æµæ€»ç»“

### æ‹†åˆ†åˆ°ä¸»é¢æ¿
```
LlmChatPanel (å·¦ä¾§æ )
  â†“ [å³é”® â†’ æ‹†åˆ†åˆ°ä¸»é¢æ¿]
CustomPageAPI.open({ conversationId })
  â†“
CustomPageManager åˆ›å»ºå®ä¾‹
  â†“
PaneContent æ¸²æŸ“ LlmChatTab
  â†“
llmChatStore.loadConversationById(conversationId)
  â†“
æ˜¾ç¤ºå¯¹è¯å†…å®¹
```

### æ‹†åˆ†åˆ°æ–°çª—å£
```
LlmChatPanel (å·¦ä¾§æ )
  â†“ [å³é”® â†’ æ‹†åˆ†åˆ°æ–°çª—å£]
window.nimbria.project.detachTabToWindow({ conversationId })
  â†“
Electron åˆ›å»ºæ–°çª—å£
  â†“
æ–°çª—å£æ¥æ”¶ conversationId
  â†“
CustomPageAPI.open({ conversationId })
  â†“
llmChatStore.loadConversationById(conversationId)
  â†“
æ˜¾ç¤ºå¯¹è¯å†…å®¹
```

---

## âœ… å®ç°æ£€æŸ¥æ¸…å•

- [ ] åˆ›å»º `LlmChat/` ç›®å½•åŠ4ä¸ªæ–°æ–‡ä»¶
- [ ] ä¿®æ”¹ `LlmChatPanel.vue` æ·»åŠ å³é”®èœå•
- [ ] ä¿®æ”¹ `PaneContent.vue` æ”¯æŒ llmchat æ¸²æŸ“
- [ ] ä¿®æ”¹ `llmChatStore.ts` æ·»åŠ åŠ è½½æ–¹æ³•
- [ ] ä¿®æ”¹ `project-channel.ts` å¤„ç†çª—å£ä¼ é€’
- [ ] æµ‹è¯•ï¼šå·¦ä¾§æ  â†’ ä¸»é¢æ¿
- [ ] æµ‹è¯•ï¼šå·¦ä¾§æ  â†’ æ–°çª—å£  
- [ ] æµ‹è¯•ï¼šä¸»é¢æ¿ â†’ æ–°çª—å£

Bossï¼Œè¿™ä¸ªè®¾è®¡å¯ä»¥å¼€å§‹å®ç°äº†å—ï¼Ÿ