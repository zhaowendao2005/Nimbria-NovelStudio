# LLM Chat æœåŠ¡å®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### **Phase 1: åç«¯æœåŠ¡å±‚** âœ…

#### 1.1 ç±»å‹å®šä¹‰ (`types.ts`)
- âœ… å®šä¹‰äº† `Conversation`ã€`ChatMessage`ã€`ConversationSettings` ç­‰æ ¸å¿ƒç±»å‹
- âœ… é›†æˆäº† `ModelConfig` å’Œ `ModelType` ä»ç°æœ‰çš„ LLM æœåŠ¡
- âœ… å®šä¹‰äº† IPC é€šä¿¡åè®®ç±»å‹

#### 1.2 LangChain å®¢æˆ·ç«¯ (`langchain-client.ts`)
- âœ… å°è£…äº† LangChain çš„ `ChatOpenAI` æ¨¡å‹
- âœ… å®ç°äº†æµå¼å“åº” (`chatStream`)
- âœ… å®ç°äº†éæµå¼å“åº” (`chat`)
- âœ… å®ç°äº† Token è®¡æ•° (`countTokens`)
- âœ… æ”¯æŒæ¶ˆæ¯ç±»å‹è½¬æ¢ (system/user/assistant)

#### 1.3 å¯¹è¯ç®¡ç†å™¨ (`conversation-manager.ts`)
- âœ… å®ç°äº†å¯¹è¯çš„åˆ›å»ºã€è·å–ã€åˆ é™¤
- âœ… å®ç°äº†æ¶ˆæ¯çš„æ·»åŠ å’Œç®¡ç†
- âœ… å®ç°äº†å¯¹è¯è®¾ç½®çš„æ›´æ–°
- âœ… å®ç°äº† LocalStorage æŒä¹…åŒ–

#### 1.4 ä¸Šä¸‹æ–‡ç®¡ç†å™¨ (`context-manager.ts`)
- âœ… å®ç°äº† Token è®¡æ•° (`calculateTotalTokens`)
- âœ… å®ç°äº†æ™ºèƒ½æ¶ˆæ¯è£å‰ª (`trimMessages`)
- âœ… ä¿ç•™ç³»ç»Ÿæç¤ºè¯å’Œæœ€è¿‘æ¶ˆæ¯
- âœ… åŸºäº `ModelConfig` åŠ¨æ€è°ƒæ•´ä¸Šä¸‹æ–‡çª—å£

#### 1.5 ä¸»æœåŠ¡ç±» (`llm-chat-service.ts`)
- âœ… åè°ƒæ‰€æœ‰åç«¯ç»„ä»¶
- âœ… é›†æˆ `LlmConfigManager` è·å–æ¨¡å‹é…ç½®
- âœ… å®ç°æ¶ˆæ¯å‘é€ (`sendMessage`)
- âœ… å®ç°æ¶ˆæ¯é‡æ–°ç”Ÿæˆ (`regenerateLastMessage`)
- âœ… å®ç°å¯¹è¯ç®¡ç† (`createConversation`, `deleteConversation`)
- âœ… å®ç°æ¨¡å‹åˆ‡æ¢ (`switchModel`)
- âœ… è‡ªåŠ¨ç›‘å¬æ¨¡å‹é…ç½®å˜åŒ–

---

### **Phase 2: IPC é€šä¿¡å±‚** âœ…

#### 2.1 IPC å¤„ç†å™¨ (`llm-chat-handlers.ts`)
- âœ… æ³¨å†Œæ‰€æœ‰ IPC é€šé“
- âœ… å®ç°å¯¹è¯ç®¡ç† IPC (åˆ›å»ºã€è·å–ã€åˆ é™¤ã€æ›´æ–°)
- âœ… å®ç°æ¶ˆæ¯ç®¡ç† IPC (å‘é€ã€é‡æ–°ç”Ÿæˆã€åˆ é™¤)
- âœ… å®ç°æµå¼å“åº”æ¨é€ (`stream-chunk`, `stream-complete`, `stream-error`)
- âœ… å®ç° LocalStorage é€šä¿¡åè®®

#### 2.2 Preload API (`main-preload.ts`)
- âœ… åœ¨ `window.nimbria.llmChat` æš´éœ²æ‰€æœ‰ API
- âœ… åŒ…å«å¯¹è¯ç®¡ç†æ–¹æ³•
- âœ… åŒ…å«æ¶ˆæ¯ç®¡ç†æ–¹æ³•
- âœ… åŒ…å«æµå¼å“åº”ç›‘å¬å™¨
- âœ… åŒ…å« LocalStorage é€šä¿¡æ–¹æ³•

#### 2.3 æœåŠ¡æ³¨å†Œ (`app-manager.ts`)
- âœ… å¯¼å…¥ LLM Chat ç›¸å…³æœåŠ¡
- âœ… åœ¨ `AppManager` ä¸­åˆå§‹åŒ– `LlmChatService`
- âœ… æ³¨å†Œ IPC å¤„ç†å™¨
- âœ… é›†æˆåˆ°åº”ç”¨å¯åŠ¨æµç¨‹

---

### **Phase 3: å‰ç«¯ Store** âœ…

#### 3.1 å‰ç«¯ç±»å‹å®šä¹‰ (`Client/Types/llmChat.ts`)
- âœ… å®šä¹‰å‰ç«¯ä½¿ç”¨çš„ç±»å‹ (`Conversation`, `ChatMessage`, `ConversationSettings`)
- âœ… å®šä¹‰ IPC å“åº”ç±»å‹ (`IpcResponse`, `StreamChunk`, `StreamComplete`, `StreamError`)
- âœ… å®šä¹‰æ¨¡å‹é€‰é¡¹ç±»å‹ (`ModelOption`)
- âœ… å®šä¹‰ LocalStorage å­˜å‚¨ç±»å‹ (`StoredConversations`)

#### 3.2 LLM Chat Store (`llmChatStore.ts`)
- âœ… å®ç° Pinia Store (`useLlmChatStore`)
- âœ… ç®¡ç†å¯¹è¯åˆ—è¡¨å’Œæ´»è·ƒå¯¹è¯
- âœ… ç®¡ç†åŠ è½½å’Œå‘é€çŠ¶æ€
- âœ… ç®¡ç†æµå¼å“åº”çŠ¶æ€
- âœ… ç®¡ç†æ¨¡å‹é€‰æ‹©
- âœ… ç®¡ç† UI çŠ¶æ€ (ä¾§æ å®½åº¦ã€å¯¼èˆª)
- âœ… å®ç°å¯¹è¯ç®¡ç†æ–¹æ³• (åˆ›å»ºã€åˆ é™¤ã€åŠ è½½ã€æ›´æ–°)
- âœ… å®ç°æ¶ˆæ¯ç®¡ç†æ–¹æ³• (å‘é€ã€é‡æ–°ç”Ÿæˆã€åˆ é™¤)
- âœ… å®ç°æ¨¡å‹ç®¡ç†æ–¹æ³• (é€‰æ‹©ã€æ ¡éªŒã€åˆ‡æ¢)
- âœ… å®ç°æµå¼å“åº”ç›‘å¬å™¨
- âœ… å®ç° UI è®¾ç½®æŒä¹…åŒ–

#### 3.3 æ›´æ–°å‰ç«¯ç»„ä»¶
- âœ… æ›´æ–° `LlmChatPanel.vue` ä½¿ç”¨ `useLlmChatStore`
- âœ… æ›´æ–° `ChatTabs.vue` ä½¿ç”¨ `useLlmChatStore`
- âœ… æ›´æ–° `ChatMessages.vue` ä½¿ç”¨ `useLlmChatStore`
- âœ… æ›´æ–° `ChatInput.vue` ä½¿ç”¨ `useLlmChatStore`
- âœ… æ›´æ–° `ModelSelector.vue` ä½¿ç”¨ `useLlmChatStore`

---

### **Phase 4: ä¾èµ–å®‰è£…** âœ…

#### 4.1 Package.json æ›´æ–°
- âœ… æ·»åŠ  `langchain@^0.3.0`
- âœ… æ·»åŠ  `@langchain/core@^0.3.0`
- âœ… æ·»åŠ  `@langchain/openai@^0.3.0`
- âœ… æ·»åŠ  `tiktoken@^1.0.17` (Token è®¡æ•°)

---

## ğŸ“¦ æ–‡ä»¶æ¸…å•

### åç«¯æœåŠ¡ (Electron Main Process)
```
Nimbria/src-electron/services/llm-chat-service/
â”œâ”€â”€ types.ts                    # ç±»å‹å®šä¹‰
â”œâ”€â”€ langchain-client.ts         # LangChain å®¢æˆ·ç«¯å°è£…
â”œâ”€â”€ conversation-manager.ts     # å¯¹è¯ç®¡ç†å™¨
â”œâ”€â”€ context-manager.ts          # ä¸Šä¸‹æ–‡ç®¡ç†å™¨
â””â”€â”€ llm-chat-service.ts         # ä¸»æœåŠ¡ç±»
```

### IPC é€šä¿¡
```
Nimbria/src-electron/ipc/main-renderer/
â””â”€â”€ llm-chat-handlers.ts        # IPC å¤„ç†å™¨

Nimbria/src-electron/core/
â”œâ”€â”€ main-preload.ts             # Preload API (å·²æ›´æ–°)
â””â”€â”€ app-manager.ts              # æœåŠ¡æ³¨å†Œ (å·²æ›´æ–°)
```

### å‰ç«¯ Store
```
Nimbria/Client/stores/llmChat/
â””â”€â”€ llmChatStore.ts             # Pinia Store

Nimbria/Client/Types/
â””â”€â”€ llmChat.ts                  # å‰ç«¯ç±»å‹å®šä¹‰
```

### å‰ç«¯ç»„ä»¶ (å·²æ›´æ–°)
```
Nimbria/Client/GUI/components/ProjectPage.Shell/Navbar.content/LlmChat/
â”œâ”€â”€ LlmChatPanel.vue            # ä¸»é¢æ¿
â”œâ”€â”€ ChatTabs.vue                # å¯¹è¯æ ‡ç­¾
â”œâ”€â”€ ChatMessages.vue            # æ¶ˆæ¯åˆ—è¡¨
â”œâ”€â”€ ChatInput.vue               # è¾“å…¥æ¡†
â””â”€â”€ ModelSelector.vue           # æ¨¡å‹é€‰æ‹©å™¨
```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. **å¯¹è¯ç®¡ç†**
- âœ… åˆ›å»ºæ–°å¯¹è¯
- âœ… åˆ é™¤å¯¹è¯
- âœ… åˆ‡æ¢æ´»è·ƒå¯¹è¯
- âœ… æ›´æ–°å¯¹è¯æ ‡é¢˜
- âœ… æ›´æ–°å¯¹è¯è®¾ç½®
- âœ… å¯¹è¯æŒä¹…åŒ–åˆ° LocalStorage

### 2. **æ¶ˆæ¯ç®¡ç†**
- âœ… å‘é€ç”¨æˆ·æ¶ˆæ¯
- âœ… æ¥æ”¶ AI æµå¼å“åº”
- âœ… é‡æ–°ç”Ÿæˆæœ€åä¸€æ¡æ¶ˆæ¯
- âœ… åˆ é™¤æ¶ˆæ¯
- âœ… æ¶ˆæ¯ Token è®¡æ•°
- âœ… æ™ºèƒ½ä¸Šä¸‹æ–‡è£å‰ª

### 3. **æ¨¡å‹ç®¡ç†**
- âœ… é€‰æ‹©æ´»è·ƒæ¨¡å‹
- âœ… æ ¡éªŒæ¨¡å‹æœ‰æ•ˆæ€§
- âœ… åˆ‡æ¢å¯¹è¯æ¨¡å‹
- âœ… ä» `LlmConfigManager` è·å–æ¨¡å‹é…ç½®
- âœ… è‡ªåŠ¨ç»§æ‰¿æ¨¡å‹é…ç½® (maxTokens, contextLength, timeout, etc.)

### 4. **æµå¼å“åº”**
- âœ… å®æ—¶æ˜¾ç¤º AI å›å¤
- âœ… æµå¼å—æ¨é€ (`stream-chunk`)
- âœ… æµå¼å®Œæˆé€šçŸ¥ (`stream-complete`)
- âœ… æµå¼é”™è¯¯å¤„ç† (`stream-error`)

### 5. **ä¸Šä¸‹æ–‡ç®¡ç†**
- âœ… åŸºäº Token é™åˆ¶æ™ºèƒ½è£å‰ªæ¶ˆæ¯
- âœ… ä¿ç•™ç³»ç»Ÿæç¤ºè¯
- âœ… ä¿ç•™æœ€è¿‘æ¶ˆæ¯
- âœ… åŠ¨æ€è°ƒæ•´ä¸Šä¸‹æ–‡çª—å£

---

## ğŸ”§ é›†æˆç‚¹

### ä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆ

1. **LlmConfigManager é›†æˆ**
   - âœ… `LlmChatService` ä¾èµ–æ³¨å…¥ `LlmConfigManager`
   - âœ… è‡ªåŠ¨è·å–æ¨¡å‹é…ç½® (`ModelConfig`)
   - âœ… ç›‘å¬æ¨¡å‹é…ç½®å˜åŒ–
   - âœ… ä½¿ç”¨ `contextLength`, `maxTokens`, `timeout`, `maxRetries`, `completionMode`, `systemPromptSeparator`

2. **ModelConfig å­—æ®µä½¿ç”¨**
   - âœ… `contextLength` â†’ ä¸Šä¸‹æ–‡çª—å£å¤§å°
   - âœ… `maxTokens` â†’ æœ€å¤§ç”Ÿæˆ Token æ•°
   - âœ… `timeout` â†’ è¯·æ±‚è¶…æ—¶æ—¶é—´
   - âœ… `maxRetries` â†’ æœ€å¤§é‡è¯•æ¬¡æ•°
   - âœ… `completionMode` â†’ å¯¹è¯æ¨¡å¼ (chat/completion)
   - âœ… `systemPromptSeparator` â†’ ç³»ç»Ÿæç¤ºè¯åˆ†éš”ç¬¦

3. **LocalStorage æŒä¹…åŒ–**
   - âœ… å¯¹è¯æ•°æ®å­˜å‚¨åœ¨æ¸²æŸ“è¿›ç¨‹çš„ LocalStorage
   - âœ… UI è®¾ç½®å­˜å‚¨åœ¨ LocalStorage (`nimbria_llm_chat_ui`)
   - âœ… é€šè¿‡ IPC é€šä¿¡å®ç°ä¸»è¿›ç¨‹ä¸æ¸²æŸ“è¿›ç¨‹çš„æ•°æ®åŒæ­¥

---

## ğŸ“ ä¸‹ä¸€æ­¥å·¥ä½œ

### 1. **å®‰è£…ä¾èµ–**
```bash
cd Nimbria
npm install
```

### 2. **æµ‹è¯•åŸºç¡€åŠŸèƒ½**
- å¯åŠ¨åº”ç”¨: `npm run dev:electron`
- æµ‹è¯•åˆ›å»ºå¯¹è¯
- æµ‹è¯•å‘é€æ¶ˆæ¯
- æµ‹è¯•æµå¼å“åº”
- æµ‹è¯•æ¨¡å‹åˆ‡æ¢

### 3. **å¯èƒ½éœ€è¦çš„è°ƒæ•´**

#### 3.1 å‰ç«¯ç»„ä»¶é€‚é…
- æ£€æŸ¥ `ChatTabs.vue` ä¸­çš„ `activeConversations` getter (å·²æ”¹ä¸º `conversations`)
- æ£€æŸ¥ `ChatMessages.vue` ä¸­çš„æ¶ˆæ¯æ¸²æŸ“é€»è¾‘
- æ£€æŸ¥ `ModelSelector.vue` ä¸­çš„æ¨¡å‹è·å–é€»è¾‘

#### 3.2 ç±»å‹å…¼å®¹æ€§
- å‰ç«¯ç»„ä»¶å¯èƒ½ä½¿ç”¨äº†æ—§çš„ç±»å‹å®šä¹‰ (å¦‚ `isPinned`, `status`)
- éœ€è¦æ ¹æ®æ–°çš„ç±»å‹å®šä¹‰è°ƒæ•´ç»„ä»¶

#### 3.3 LocalStorage é€šä¿¡
- éœ€è¦åœ¨æ¸²æŸ“è¿›ç¨‹å®ç° LocalStorage çš„è¯»å†™ç›‘å¬å™¨
- å“åº”ä¸»è¿›ç¨‹çš„ `storage-save` å’Œ `storage-load-request` äº‹ä»¶

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **çº¯èŠå¤©åŠŸèƒ½**
   - å½“å‰å®ç°ä»…æ”¯æŒçº¯èŠå¤©ï¼Œä¸åŒ…å« Agent åŠŸèƒ½
   - æœªä½¿ç”¨ `functionCalling`, `agentThought`, `structuredOutput`
   - æœªæ¥å¯æ‰©å±•ä¸ºæ”¯æŒ Agent

2. **Token è®¡æ•°**
   - ä½¿ç”¨ `tiktoken` è¿›è¡Œ Token è®¡æ•°
   - éœ€è¦ç¡®ä¿ `tiktoken` åœ¨ Electron ç¯å¢ƒä¸­æ­£å¸¸å·¥ä½œ

3. **æµå¼å“åº”**
   - æµå¼å“åº”é€šè¿‡ IPC æ¨é€åˆ°æ¸²æŸ“è¿›ç¨‹
   - éœ€è¦ç¡®ä¿ `BrowserWindow` å¯ç”¨

4. **é”™è¯¯å¤„ç†**
   - æ‰€æœ‰ IPC æ–¹æ³•éƒ½åŒ…å« `try-catch` é”™è¯¯å¤„ç†
   - é”™è¯¯ä¿¡æ¯é€šè¿‡ `IpcResponse.error` è¿”å›

---

## ğŸ‰ æ€»ç»“

å·²å®Œæˆ LLM Chat æœåŠ¡çš„å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬ï¼š
- âœ… åç«¯æœåŠ¡å±‚ (LangChain é›†æˆ)
- âœ… IPC é€šä¿¡å±‚ (å®Œæ•´çš„å‰åç«¯é€šä¿¡)
- âœ… å‰ç«¯ Store (Pinia çŠ¶æ€ç®¡ç†)
- âœ… å‰ç«¯ç»„ä»¶æ›´æ–° (ä½¿ç”¨æ–°çš„ Store)
- âœ… ä¾èµ–å®‰è£… (LangChain + tiktoken)

**ä¸‹ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–å¹¶æµ‹è¯•åŠŸèƒ½ï¼**

```bash
cd Nimbria
npm install
npm run dev:electron
```

