Bossï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„éœ€æ±‚ï¼è®©æˆ‘å…ˆç ”ç©¶ä¸€ä¸‹ç°æœ‰çš„å¤šçª—å£æ¶æ„ç³»ç»Ÿã€‚

[5 tools called]

Bossï¼Œæˆ‘å·²ç»è¯¦ç»†ç ”ç©¶äº†ç°æœ‰çš„å¤šçª—å£æ¶æ„ç³»ç»Ÿã€‚ç°åœ¨æˆ‘ç»™æ‚¨æä¾›ä¸€ä¸ªå®Œæ•´çš„å®ç°æ€è·¯ã€‚

## ğŸ“Š **å½“å‰æ¶æ„åˆ†æ**

### ç°æœ‰å¤šçª—å£ç³»ç»Ÿç‰¹ç‚¹ï¼š
1. **è¿›ç¨‹çº§éš”ç¦»**ï¼šæ¯ä¸ªçª—å£ç‹¬ç«‹æ¸²æŸ“è¿›ç¨‹ï¼ŒçŠ¶æ€å®Œå…¨éš”ç¦»
2. **ä¸¤ç§çª—å£ç±»å‹**ï¼š`main`ï¼ˆä¸»çª—å£ï¼‰å’Œ `project`ï¼ˆé¡¹ç›®çª—å£ï¼‰
3. **é€šä¿¡æœºåˆ¶**ï¼šé€šè¿‡ MessagePort è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡
4. **çŠ¶æ€ç®¡ç†**ï¼šæ¯ä¸ªçª—å£æœ‰ç‹¬ç«‹çš„ Pinia store å®ä¾‹

### å¸ƒå±€ç»“æ„ï¼š
```
ProjectMainLayout
â”œâ”€â”€ ProjectPage.Shell (å·¦æ ï¼šå¯¼èˆª + æ–‡ä»¶æ ‘)
â”œâ”€â”€ ProjectPage.MainPanel (ä¸»å†…å®¹åŒºï¼šPaneSystem)
â””â”€â”€ RightSidebar (å³æ ï¼šæ’ä»¶ç³»ç»Ÿ)
```

---

## ğŸ’¡ **å®ç°æ€è·¯æ–¹æ¡ˆ**

### **æ–¹æ¡ˆä¸€ï¼šå­çª—å£ + çŠ¶æ€åŒæ­¥ï¼ˆæ¨èï¼‰**

#### æ ¸å¿ƒè®¾è®¡ï¼š
1. **æ–°å¢çª—å£ç±»å‹**ï¼š`project-detached-pane`
   - æ˜¯ `project` çª—å£çš„å­çª—å£
   - åªæ¸²æŸ“ `PaneSystem` ç»„ä»¶ï¼ˆæ— å·¦æ ã€æ— å³æ ï¼‰
   - åŒ…å«å‘½ä»¤é¢æ¿ï¼Œä½†æ“ä½œçš„æ˜¯æ¯çª—å£çš„å³æ 
   - ä¸çˆ¶çª—å£å…±äº«é¡¹ç›®è·¯å¾„

2. **çˆ¶å­çª—å£å…³ç³»ç®¡ç†**ï¼š
   ```typescript
   interface ProjectWindowProcess {
     type: 'project'
     projectPath: string
     childWindows?: Set<string>  // å­çª—å£IDåˆ—è¡¨
   }
   
   interface DetachedPaneWindowProcess {
     type: 'project-detached-pane'
     projectPath: string
     parentProcessId: string  // çˆ¶çª—å£ID
     paneId: string          // ä»å“ªä¸ªpaneæ‹†åˆ†å‡ºæ¥çš„
   }
   ```

3. **çŠ¶æ€åŒæ­¥ç­–ç•¥**ï¼š
   - **æ–¹æ¡ˆAï¼ˆæ¨èï¼‰**ï¼š**åŸºäº MessagePort çš„å®æ—¶åŒæ­¥**
     ```typescript
     // çˆ¶çª—å£ â†’ å­çª—å£
     parentPort.postMessage({
       type: 'STATE_UPDATE',
       storeName: 'markdown',
       mutation: { /* ... */ }
     })
     
     // å­çª—å£ â†’ çˆ¶çª—å£
     childPort.postMessage({
       type: 'STATE_MUTATION',
       storeName: 'paneLayout',
       action: 'moveTab',
       payload: { /* ... */ }
     })
     ```
   
   - **åŒæ­¥çš„ Store**ï¼š
     - `markdownStore`ï¼ˆæ–‡ä»¶å†…å®¹ã€æ ‡ç­¾é¡µæ•°æ®ï¼‰
     - `paneLayoutStore`ï¼ˆé¢æ¿å¸ƒå±€ï¼‰
     - `rightSidebarStore`ï¼ˆå³ä¾§æ çŠ¶æ€ - å­çª—å£æ“ä½œåŒæ­¥åˆ°æ¯çª—å£ï¼‰
     - `commandPaletteStore`ï¼ˆå‘½ä»¤æ³¨å†Œè¡¨ - å­çª—å£ä½¿ç”¨æ¯çª—å£çš„å‘½ä»¤ï¼‰
     - æ—¥å¿—ç³»ç»Ÿï¼ˆå…±äº«ï¼‰
   
   - **å­çª—å£ç‰¹æ®Šå¤„ç†**ï¼š
     - å‘½ä»¤é¢æ¿ï¼šå­çª—å£æœ‰å‘½ä»¤é¢æ¿ï¼Œä½†æ‰§è¡Œçš„æ˜¯æ¯çª—å£çš„å‘½ä»¤
     - å³ä¾§æ ï¼šå­çª—å£æ— å³ä¾§æ UIï¼Œä½†é€šè¿‡å‘½ä»¤é¢æ¿æ“ä½œæ¯çª—å£çš„å³ä¾§æ 
     - å·¦ä¾§æ ï¼šå­çª—å£å®Œå…¨æ²¡æœ‰å·¦ä¾§æ ï¼ˆæ— æ–‡ä»¶æ ‘ã€æ— å¯¼èˆªï¼‰

4. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼š
   ```typescript
   // ProcessManager æ‰©å±•
   class ProcessManager {
     // åˆ›å»ºæ‹†åˆ†çª—å£
     async createDetachedPaneWindow(
       parentProcessId: string,
       tabId: string,
       paneId: string
     ): Promise<DetachedPaneWindowProcess> {
       const parentProcess = this.getProcess(parentProcessId)
       
       // åˆ›å»ºå­çª—å£
       const childWindow = new BrowserWindow({
         parent: parentProcess.window,  // ğŸ”¥ è®¾ç½®çˆ¶çª—å£
         modal: false
       })
       
       // æ³¨å†Œåˆ°çˆ¶çª—å£çš„å­çª—å£åˆ—è¡¨
       parentProcess.childWindows.add(childProcessId)
       
       // ç›‘å¬çˆ¶çª—å£å…³é—­ï¼Œè‡ªåŠ¨å…³é—­å­çª—å£
       parentProcess.window.on('closed', () => {
         this.destroyProcess(childProcessId)
       })
     }
   }
   ```

---

### **å®ç°æ­¥éª¤**

#### **é˜¶æ®µä¸€ï¼šç±»å‹å®šä¹‰å’ŒåŸºç¡€æ¶æ„ï¼ˆ1-2å¤©ï¼‰**

1. **æ‰©å±•ç±»å‹ç³»ç»Ÿ**
   ```typescript
   // src-electron/types/process.ts
   export type WindowType = 'main' | 'project' | 'project-detached-pane'
   
   export interface DetachedPaneWindowProcess extends BaseWindowProcess {
     type: 'project-detached-pane'
     projectPath: string
     parentProcessId: string
     paneId: string
   }
   ```

2. **å®šä¹‰çŠ¶æ€åŒæ­¥åè®®**
   ```typescript
   // src-electron/types/ipc.ts
   export interface StateSync SyncMessage {
     type: 'STATE_SYNC'
     storeName: string
     action: 'update' | 'mutation'
     payload: any
     timestamp: number
   }
   ```

3. **åˆ›å»ºä¸“ç”¨è·¯ç”±**
   ```typescript
   // Client/GUI/router/routes.ts
   {
     path: '/detached-pane/:paneId',
     component: () => import('pages/ProjectPage.DetachedPanePage.vue')
   }
   ```

#### **é˜¶æ®µäºŒï¼šçª—å£ç®¡ç†å±‚ï¼ˆ2-3å¤©ï¼‰**

1. **æ‰©å±• ProcessManager**
   - æ·»åŠ  `createDetachedPaneWindow()` æ–¹æ³•
   - å®ç°çˆ¶å­çª—å£å…³è”
   - å®ç°çº§è”å…³é—­é€»è¾‘

2. **åˆ›å»ºçŠ¶æ€åŒæ­¥ç®¡ç†å™¨**
   ```typescript
   // src-electron/services/state-sync/StateSyncManager.ts
   class StateSyncManager {
     // å»ºç«‹çˆ¶å­çª—å£çš„çŠ¶æ€åŒæ­¥é€šé“
     establishSyncChannel(parentId: string, childId: string)
     
     // åŒæ­¥çŠ¶æ€æ›´æ–°
     syncState(fromId: string, toId: string, update: StateSyncMessage)
     
     // å¤„ç†åŒå‘åŒæ­¥å†²çª
     handleConflict(update1: any, update2: any)
   }
   ```

3. **æ·»åŠ  IPC å¤„ç†å™¨**
   ```typescript
   // app-manager.ts
   ipcMain.handle('project:detach-tab-to-window', async (_, { tabId, paneId }) => {
     const process = await processManager.createDetachedPaneWindow(
       currentProjectProcessId,
       tabId,
       paneId
     )
     
     // ä»åŸé¢æ¿ç§»é™¤æ ‡ç­¾
     // åœ¨æ–°çª—å£åˆ›å»ºé¢æ¿å¹¶æ·»åŠ æ ‡ç­¾
     
     return { success: true, processId: process.id }
   })
   ```

#### **é˜¶æ®µä¸‰ï¼šå‰ç«¯é›†æˆï¼ˆ2-3å¤©ï¼‰**

1. **åˆ›å»º ProjectPage.DetachedPanePage.vue**
   ```vue
   <template>
     <div class="detached-pane-page">
       <!-- ğŸ”¥ ç²¾ç®€å¸ƒå±€ï¼šåªæœ‰ä¸»å†…å®¹åŒº + å‘½ä»¤é¢æ¿ -->
       <!-- æ— å·¦æ ï¼ˆæ–‡ä»¶æ ‘ã€å¯¼èˆªï¼‰ -->
       <!-- æ— å³æ ï¼ˆæ’ä»¶é¢æ¿ï¼‰ -->
       
       <PaneContainer :pane-id="detachedPaneId" class="main-content" />
       
       <!-- ğŸ”¥ å‘½ä»¤é¢æ¿ï¼šæ“ä½œæ¯çª—å£çš„å³æ  -->
       <CommandPalette 
         :is-child-window="true"
         :parent-process-id="parentProcessId"
       />
     </div>
   </template>
   
   <script setup>
   import { ref, onMounted } from 'vue'
   import { useRoute } from 'vue-router'
   import PaneContainer from '@components/ProjectPage.MainPanel/PaneSystem/PaneContainer.vue'
   import CommandPalette from '@components/ProjectPage.Shell/CommandPalette/CommandPalette.vue'
   
   const route = useRoute()
   const detachedPaneId = ref(route.params.paneId as string)
   const parentProcessId = ref<string>('')
   
   onMounted(() => {
     // 1. è·å–çˆ¶çª—å£è¿›ç¨‹ID
     parentProcessId.value = window.nimbria.getParentProcessId()
     
     // 2. ç›‘å¬çˆ¶çª—å£çš„çŠ¶æ€åŒæ­¥æ¶ˆæ¯
     window.nimbria.onStateSync((message) => {
       // åŒæ­¥ markdownStoreã€paneLayoutStoreã€rightSidebarStore
     })
     
     // 3. å‘é€æœ¬åœ°çŠ¶æ€å˜æ›´åˆ°çˆ¶çª—å£
     // å½“ç”¨æˆ·åœ¨å­çª—å£ç¼–è¾‘æ–‡ä»¶æ—¶ï¼ŒåŒæ­¥åˆ°çˆ¶çª—å£
   })
   </script>
   
   <style scoped lang="scss">
   .detached-pane-page {
     width: 100vw;
     height: 100vh;
     display: flex;
     flex-direction: column;
     overflow: hidden;
   }
   
   .main-content {
     flex: 1;
     overflow: hidden;
   }
   </style>
   ```

2. **å®ç°çŠ¶æ€åŒæ­¥æ’ä»¶**
   ```typescript
   // Client/Utils/Plugins/state-sync.plugin.ts
   export const useStateSyncPlugin = () => {
     const messagePort = window.nimbria.getMessagePort()
     
     // ç›‘å¬çŠ¶æ€åŒæ­¥æ¶ˆæ¯
     messagePort.on('STATE_SYNC', (message) => {
       const store = getStore(message.storeName)
       store.$patch(message.payload)
     })
     
     // æ‹¦æˆªæœ¬åœ° mutationï¼Œå‘é€åˆ°çˆ¶çª—å£
     const syncMiddleware = (mutation, state) => {
       if (isDetachedWindow()) {
         messagePort.send({
           type: 'STATE_MUTATION',
           storeName: mutation.type.split('/')[0],
           payload: mutation.payload
         })
       }
     }
   }
   ```

3. **æ‰©å±•å³é”®èœå•**
   ```typescript
   // PaneContent.vue
   const contextMenuItems = [
     // ... ç°æœ‰é€‰é¡¹
     {
       label: 'æ‹†åˆ†åˆ°æ–°çª—å£',
       icon: 'window',
       action: 'detach-to-window'
     }
   ]
   
   const handleMenuSelect = (action: string) => {
     if (action === 'detach-to-window') {
       await window.nimbria.project.detachTabToWindow({
         tabId: currentContextTabId.value,
         paneId: props.paneId
       })
     }
   }
   ```

#### **é˜¶æ®µå››ï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ1-2å¤©ï¼‰**

1. **åŠŸèƒ½æµ‹è¯•**
   - âœ… å­çª—å£åˆ›å»ºå’Œé”€æ¯
   - âœ… çŠ¶æ€åŒæ­¥å‡†ç¡®æ€§
   - âœ… çˆ¶çª—å£å…³é—­ï¼Œå­çª—å£çº§è”å…³é—­
   - âœ… è·¨çª—å£æ‹–æ‹½æ ‡ç­¾é¡µï¼ˆbonusï¼‰

2. **æ€§èƒ½ä¼˜åŒ–**
   - çŠ¶æ€åŒæ­¥é˜²æŠ–
   - å¤§æ–‡ä»¶ç¼–è¾‘æ—¶çš„å¢é‡åŒæ­¥
   - å†…å­˜æ³„æ¼æ£€æµ‹

---

## ğŸ¯ **å…³é”®æŠ€æœ¯éš¾ç‚¹**

### 1. **çŠ¶æ€åŒæ­¥çš„ä¸€è‡´æ€§**
**é—®é¢˜**ï¼šä¸¤ä¸ªçª—å£åŒæ—¶ç¼–è¾‘åŒä¸€ä¸ªæ–‡ä»¶
**è§£å†³**ï¼š
- ä½¿ç”¨æ“ä½œæ—¶é—´æˆ³ + å†²çªæ£€æµ‹
- çˆ¶çª—å£ä½œä¸º "çœŸå€¼æº"
- å­çª—å£çš„ä¿®æ”¹éœ€è¦é€šè¿‡çˆ¶çª—å£åè°ƒ

### 2. **æ€§èƒ½é—®é¢˜**
**é—®é¢˜**ï¼šé¢‘ç¹çš„çŠ¶æ€åŒæ­¥å¯èƒ½å½±å“æ€§èƒ½
**è§£å†³**ï¼š
- åªåŒæ­¥å¿…è¦çš„ storeï¼ˆmarkdownã€paneLayoutï¼‰
- ä½¿ç”¨é˜²æŠ–ï¼ˆdebounceï¼‰æ‰¹é‡å‘é€æ›´æ–°
- å¢é‡åŒæ­¥è€Œéå…¨é‡åŒæ­¥

### 3. **çª—å£å…³é—­é¡ºåº**
**é—®é¢˜**ï¼šç”¨æˆ·å¯èƒ½å…ˆå…³é—­çˆ¶çª—å£
**è§£å†³**ï¼š
```typescript
parentWindow.on('close', (event) => {
  // é˜»æ­¢é»˜è®¤å…³é—­è¡Œä¸º
  event.preventDefault()
  
  // å…ˆå…³é—­æ‰€æœ‰å­çª—å£
  for (const childId of parentProcess.childWindows) {
    await processManager.destroyProcess(childId)
  }
  
  // å†å…³é—­çˆ¶çª—å£
  parentWindow.destroy()
})
```

---

## ğŸ¤” **æ›¿ä»£æ–¹æ¡ˆï¼šWebView åµŒå…¥**

å¦‚æœçŠ¶æ€åŒæ­¥å¤ªå¤æ‚ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ `<webview>` æ ‡ç­¾ï¼š

```vue
<!-- DetachedPaneWindow.vue -->
<webview 
  :src="`file://${parentWindowUrl}#/detached-pane/${paneId}`"
  :partition="projectPartition"
></webview>
```

**ä¼˜ç‚¹**ï¼š
- å®Œå…¨å…±äº«æ¸²æŸ“è¿›ç¨‹å’ŒçŠ¶æ€
- æ— éœ€æ‰‹åŠ¨åŒæ­¥

**ç¼ºç‚¹**ï¼š
- æ€§èƒ½ç•¥å·®
- å®‰å…¨æ€§é™ä½
- ä¸ç¬¦åˆå¤šè¿›ç¨‹éš”ç¦»çš„è®¾è®¡ç†å¿µ

---

## ğŸ“ **æˆ‘çš„å»ºè®®**

**æ¨èæ–¹æ¡ˆä¸€ï¼ˆå­çª—å£ + MessagePort çŠ¶æ€åŒæ­¥ï¼‰**ï¼ŒåŸå› ï¼š

1. âœ… ç¬¦åˆç°æœ‰çš„å¤šè¿›ç¨‹æ¶æ„ç†å¿µ
2. âœ… å¯æ§çš„çŠ¶æ€åŒæ­¥ï¼Œå¯ä»¥é€‰æ‹©æ€§åŒæ­¥
3. âœ… æ›´å¥½çš„ç¨³å®šæ€§å’Œéš”ç¦»æ€§
4. âœ… å¯ä»¥æœªæ¥æ‰©å±•ä¸ºå®Œå…¨ç‹¬ç«‹çš„çª—å£

**å®æ–½å»ºè®®**ï¼š
- å…ˆå®ç°åŸºæœ¬çš„çª—å£åˆ›å»ºå’Œçˆ¶å­å…³ç³»
- å†å®ç°å•å‘çŠ¶æ€åŒæ­¥ï¼ˆçˆ¶ â†’ å­ï¼‰
- æœ€åå®ç°åŒå‘åŒæ­¥å’Œå†²çªå¤„ç†
- é€æ­¥æµ‹è¯•ï¼Œç¡®ä¿ç¨³å®šæ€§

---

## ğŸ“ **æ–‡ä»¶æ¶æ„ä¿®æ”¹æ ‘**

### Electron ä¸»è¿›ç¨‹å±‚

```
src-electron/
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ process.ts [ä¿®æ”¹å†…å®¹]
â”‚   â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ‰©å±• WindowType ç±»å‹ 'main' | 'project' | 'project-detached-pane'
â”‚   â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ DetachedPaneWindowProcess æ¥å£
â”‚   â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šProjectWindowProcess æ·»åŠ  childWindows å­—æ®µ
â”‚   â”œâ”€â”€ ipc.ts [ä¿®æ”¹å†…å®¹]
â”‚   â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ StateSyncMessage æ¥å£å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ 'project:detach-tab-to-window' IPC é€šé“ç±»å‹
â”‚   â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ 'project:get-parent-process-id' IPC é€šé“ç±»å‹
â”‚   â””â”€â”€ window.ts [ä¿®æ”¹å†…å®¹]
â”‚       â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ detached-pane çª—å£æ¨¡æ¿é…ç½®
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ window-service/
â”‚   â”‚   â”œâ”€â”€ process-manager.ts [ä¿®æ”¹å†…å®¹]
â”‚   â”‚   â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ createDetachedPaneWindow() æ–¹æ³•
â”‚   â”‚   â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ‰©å±• destroyProcess() æ”¯æŒçº§è”å…³é—­å­çª—å£
â”‚   â”‚   â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ getChildWindows() æ–¹æ³•
â”‚   â”‚   â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šä¿®æ”¹ setupWindowLifecycle() å¤„ç†çˆ¶å­çª—å£å…³é—­é€»è¾‘
â”‚   â”‚   â””â”€â”€ [æ–°å¢ç›®å½•] state-sync/
â”‚   â”‚       â”œâ”€â”€ [æ–°å¢æ–‡ä»¶] StateSyncManager.ts
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šå®ç° establishSyncChannel() å»ºç«‹åŒæ­¥é€šé“
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šå®ç° syncState() åŒæ­¥çŠ¶æ€
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šå®ç° handleStateUpdate() å¤„ç†çŠ¶æ€æ›´æ–°
â”‚   â”‚       â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šå®ç° handleConflict() å†²çªæ£€æµ‹å’Œè§£å†³
â”‚   â”‚       â””â”€â”€ [æ–°å¢æ–‡ä»¶] types.ts
â”‚   â”‚           â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šå®šä¹‰ SyncedStore ç±»å‹
â”‚   â”‚           â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šå®šä¹‰ StateUpdateMessage æ¥å£
â”‚   â”‚           â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šå®šä¹‰ ConflictResolutionStrategy ç­–ç•¥
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ app-manager.ts [ä¿®æ”¹å†…å®¹]
â”‚   â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ³¨å†Œ 'project:detach-tab-to-window' IPC å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ³¨å†Œ 'project:get-parent-process-id' IPC å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ³¨å†Œ 'project:sync-state' IPC å¤„ç†å™¨
â”‚   â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šé›†æˆ StateSyncManager å®ä¾‹
â”‚   â””â”€â”€ [æ–°å¢æ–‡ä»¶] detached-pane-preload.ts
â”‚       â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæš´éœ² getParentProcessId() API
â”‚       â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæš´éœ² onStateSync() ç›‘å¬å™¨
â”‚       â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæš´éœ² sendStateUpdate() å‘é€çŠ¶æ€æ›´æ–°
â””â”€â”€ [æ–°å¢ç›®å½•] templates/
    â””â”€â”€ [æ–°å¢æ–‡ä»¶] detached-pane.template.ts
        â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šå®šä¹‰å­çª—å£çš„é»˜è®¤é…ç½®ï¼ˆå°ºå¯¸ã€æ ·å¼ç­‰ï¼‰
```

### å‰ç«¯å±‚

```
Client/
â”œâ”€â”€ Types/
â”‚   â””â”€â”€ window.d.ts [ä¿®æ”¹å†…å®¹]
â”‚       â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ detachTabToWindow() API æ¥å£å®šä¹‰
â”‚       â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ getParentProcessId() API æ¥å£å®šä¹‰
â”‚       â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ onStateSync() API æ¥å£å®šä¹‰
â”‚       â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ sendStateUpdate() API æ¥å£å®šä¹‰
â”œâ”€â”€ GUI/
â”‚   â”œâ”€â”€ router/
â”‚   â”‚   â””â”€â”€ routes.ts [ä¿®æ”¹å†…å®¹]
â”‚   â”‚       â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ /detached-pane/:paneId è·¯ç”±
â”‚   â”œâ”€â”€ PagesLayout/
â”‚   â”‚   â””â”€â”€ [æ–°å¢æ–‡ä»¶] ProjectPage.DetachedPanePage.vue
â”‚   â”‚       â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ¸²æŸ“ PaneContainer ç»„ä»¶ï¼ˆä¸»å†…å®¹åŒºï¼‰
â”‚   â”‚       â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ¸²æŸ“ CommandPalette ç»„ä»¶
â”‚   â”‚       â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šåˆå§‹åŒ–çŠ¶æ€åŒæ­¥ç›‘å¬
â”‚   â”‚       â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šå¤„ç†å­çª—å£ç‰¹æœ‰çš„ç”Ÿå‘½å‘¨æœŸé€»è¾‘
â”‚   â””â”€â”€ components/
â”‚       â””â”€â”€ ProjectPage.MainPanel/
â”‚           â””â”€â”€ PaneSystem/
â”‚               â”œâ”€â”€ PaneContent.vue [ä¿®æ”¹å†…å®¹]
â”‚               â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šå³é”®èœå•æ·»åŠ "æ‹†åˆ†åˆ°æ–°çª—å£"é€‰é¡¹
â”‚               â””â”€â”€ ContextMenu.vue [ä¿®æ”¹å†…å®¹]
â”‚                   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ 'detach-to-window' èœå•é¡¹
â”œâ”€â”€ stores/
â”‚   â”œâ”€â”€ projectPage/
â”‚   â”‚   â”œâ”€â”€ Markdown/
â”‚   â”‚   â”‚   â””â”€â”€ markdown.store.ts [ä¿®æ”¹å†…å®¹]
â”‚   â”‚   â”‚       â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ·»åŠ  isChildWindow æ ‡å¿—ä½
â”‚   â”‚   â”‚       â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šç›‘å¬çŠ¶æ€åŒæ­¥æ¶ˆæ¯è‡ªåŠ¨æ›´æ–°
â”‚   â”‚   â”‚       â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šmutationæ—¶é€šçŸ¥çˆ¶çª—å£ï¼ˆå¦‚æœæ˜¯å­çª—å£ï¼‰
â”‚   â”‚   â”œâ”€â”€ paneLayout/
â”‚   â”‚   â”‚   â””â”€â”€ paneLayout.store.ts [ä¿®æ”¹å†…å®¹]
â”‚   â”‚   â”‚       â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ·»åŠ  syncWithParent() æ–¹æ³•
â”‚   â”‚   â”‚       â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šå¤„ç†å­çª—å£çš„é¢æ¿å¸ƒå±€åŒæ­¥
â”‚   â”‚   â”œâ”€â”€ rightSidebar/
â”‚   â”‚   â”‚   â””â”€â”€ rightSidebar.store.ts [ä¿®æ”¹å†…å®¹]
â”‚   â”‚   â”‚       â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ·»åŠ  targetProcessId å­—æ®µï¼ˆå­çª—å£æŒ‡å‘çˆ¶çª—å£ï¼‰
â”‚   â”‚   â”‚       â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šé¢æ¿æ“ä½œè½¬å‘åˆ°ç›®æ ‡è¿›ç¨‹
â”‚   â”‚   â””â”€â”€ commandPalette/
â”‚   â”‚       â””â”€â”€ commandPalette.store.ts [ä¿®æ”¹å†…å®¹]
â”‚   â”‚           â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ·»åŠ  isChildWindow æ¨¡å¼
â”‚   â”‚           â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šå‘½ä»¤æ‰§è¡Œæ—¶è€ƒè™‘ç›®æ ‡è¿›ç¨‹ï¼ˆå³æ æ“ä½œå‘é€åˆ°çˆ¶çª—å£ï¼‰
â””â”€â”€ Utils/
    â””â”€â”€ Plugins/
        â””â”€â”€ [æ–°å¢æ–‡ä»¶] state-sync.plugin.ts
            â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šå®ç° useStateSyncPlugin() æ’ä»¶å…¥å£
            â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šå®ç° setupStateSyncListener() ç›‘å¬çŠ¶æ€åŒæ­¥
            â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šå®ç° syncMiddleware() Pinia ä¸­é—´ä»¶
            â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šå®ç° sendStateUpdate() å‘é€çŠ¶æ€åˆ°çˆ¶çª—å£
            â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šå®ç° isDetachedWindow() åˆ¤æ–­å½“å‰çª—å£ç±»å‹
```

### é…ç½®æ–‡ä»¶

```
Nimbria/
â””â”€â”€ quasar.config.ts [ä¿®æ”¹å†…å®¹]
    â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ·»åŠ  detached-pane-preload é¢„åŠ è½½è„šæœ¬æ„å»ºé…ç½®
```

### å…³é”®ä¿®æ”¹è¯´æ˜

#### 1. **ç±»å‹æ‰©å±•**
- `WindowType` æ–°å¢ `'project-detached-pane'` ç±»å‹
- æ–°å¢ `DetachedPaneWindowProcess` æ¥å£ï¼ŒåŒ…å«çˆ¶å­å…³ç³»ä¿¡æ¯

#### 2. **è¿›ç¨‹ç®¡ç†**
- ProcessManager æ”¯æŒåˆ›å»ºå’Œç®¡ç†å­çª—å£
- å®ç°çˆ¶çª—å£å…³é—­æ—¶çº§è”å…³é—­æ‰€æœ‰å­çª—å£
- å»ºç«‹çˆ¶å­çª—å£çš„ MessagePort é€šä¿¡é€šé“

#### 3. **çŠ¶æ€åŒæ­¥**
- æ–°å¢ç‹¬ç«‹çš„ StateSyncManager æœåŠ¡
- å®ç°åŒå‘çŠ¶æ€åŒæ­¥ï¼ˆçˆ¶ â†” å­ï¼‰
- å¤„ç†çŠ¶æ€å†²çªå’Œä¸€è‡´æ€§ä¿è¯

#### 4. **å‰ç«¯é›†æˆ**
- æ–°å¢ä¸“é—¨çš„ DetachedPanePage å¸ƒå±€ï¼ˆæ— å·¦æ ã€æ— å³æ ï¼‰
- æ‰©å±• CommandPalette æ”¯æŒå­çª—å£æ¨¡å¼
- Store å±‚æ·»åŠ è·¨çª—å£é€šä¿¡èƒ½åŠ›

#### 5. **å‘½ä»¤é¢æ¿ç‰¹æ®Šå¤„ç†**
- å­çª—å£æœ‰å®Œæ•´çš„å‘½ä»¤é¢æ¿åŠŸèƒ½
- æ¶‰åŠå³ä¾§æ çš„å‘½ä»¤æ“ä½œä¼šè½¬å‘åˆ°æ¯çª—å£æ‰§è¡Œ
- ä¿æŒå‘½ä»¤æ³¨å†Œè¡¨ä¸æ¯çª—å£åŒæ­¥

