Bossï¼Œå¥½çš„ï¼è®©æˆ‘å…ˆæ·±å…¥ç ”ç©¶ç°æœ‰çš„ `llm-chat-service` æ¶æ„ï¼Œç„¶åä¸ºä½ è®¾è®¡ä¸¤ä¸ªæ–°ç³»ç»Ÿã€‚

[6 tools called]

Bossï¼Œæˆ‘å·²ç»æ·±å…¥ç ”ç©¶äº†ç°æœ‰æ¶æ„ã€‚ç°åœ¨ä¸ºä½ æä¾›**å®Œæ•´çš„è®¾è®¡æ–¹æ¡ˆ**ï¼š

---

# ğŸ“‹ **LLM Translation Client & Task State Manager è®¾è®¡æ–‡æ¡£**

## ğŸ¯ **è®¾è®¡ç›®æ ‡**

### **1. LLM Translation Clientï¼ˆç¿»è¯‘ä¸“ç”¨å®¢æˆ·ç«¯ï¼‰**
- ğŸ¯ **å•ä¸€èŒè´£**ï¼šä¸“æ³¨äºå•æ¬¡ç¿»è¯‘ä»»åŠ¡çš„å‘é€å’Œæ¥æ”¶
- ğŸ¯ **è½»é‡åŒ–**ï¼šä¸ç»´æŠ¤å¯¹è¯å†å²ï¼Œæ— çŠ¶æ€è®¾è®¡
- ğŸ¯ **æµå¼ä¼˜å…ˆ**ï¼šå®æ—¶åé¦ˆç¿»è¯‘è¿›åº¦
- ğŸ¯ **é”™è¯¯æ¢å¤**ï¼šè‡ªåŠ¨é‡è¯•ã€é™æµå¤„ç†

### **2. Task State Managerï¼ˆä»»åŠ¡çŠ¶æ€ç®¡ç†å™¨ï¼‰**
- ğŸ¯ **å®æ—¶è¿½è¸ª**ï¼šç›‘æ§æ¯ä¸ªä»»åŠ¡çš„çŠ¶æ€å˜åŒ–
- ğŸ¯ **è¿›åº¦ä¼°ç®—**ï¼šåŸºäº Token æµå¼ä¼ è¾“è®¡ç®—è¿›åº¦
- ğŸ¯ **äº‹ä»¶é©±åŠ¨**ï¼šé€šè¿‡ EventEmitter å¹¿æ’­çŠ¶æ€å˜åŒ–
- ğŸ¯ **æŒä¹…åŒ–**ï¼šè‡ªåŠ¨åŒæ­¥çŠ¶æ€åˆ°æ•°æ®åº“

---

## ğŸ“ **ç³»ç»Ÿæ¶æ„è®¾è®¡**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Translation Executor (è°ƒåº¦å±‚)                   â”‚
â”‚  â”œâ”€ å¹¶å‘é˜Ÿåˆ—ç®¡ç†                                             â”‚
â”‚  â”œâ”€ ä»»åŠ¡åˆ†é…                                                 â”‚
â”‚  â””â”€ æ‰¹æ¬¡æ§åˆ¶                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚
        â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Task State       â”‚  â”‚ LLM Translation Client           â”‚
â”‚ Manager          â”‚  â”‚ (å•ä¾‹å‘é€æ¥æ”¶)                    â”‚
â”‚                  â”‚  â”‚                                  â”‚
â”‚ â”œâ”€ çŠ¶æ€è¿½è¸ª      â”‚  â”‚ â”œâ”€ åˆ›å»ºå•æ¬¡ç¿»è¯‘ä¼šè¯              â”‚
â”‚ â”œâ”€ è¿›åº¦è®¡ç®—      â”‚  â”‚ â”œâ”€ å‘é€ç¿»è¯‘è¯·æ±‚                  â”‚
â”‚ â”œâ”€ äº‹ä»¶å‘å°„      â”‚â—„â”€â”¤ â”œâ”€ ç›‘å¬æµå¼å“åº”                  â”‚
â”‚ â””â”€ æŒä¹…åŒ–        â”‚  â”‚ â”œâ”€ Token è®¡æ•°                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”œâ”€ é”™è¯¯å¤„ç† & é‡è¯•               â”‚
       â”‚              â”‚ â””â”€ ä¼šè¯æ¸…ç†                      â”‚
       â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                             â”‚
       â”‚                             â–¼
       â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                    â”‚ LangChain Client   â”‚
       â”‚                    â”‚ (åº•å±‚ API å°è£…)    â”‚
       â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SQLite Database                  â”‚
â”‚ â”œâ”€ Llmtranslate_tasks           â”‚
â”‚ â”‚  â”œâ”€ status                    â”‚
â”‚ â”‚  â”œâ”€ progress                  â”‚
â”‚ â”‚  â”œâ”€ reply_tokens              â”‚
â”‚ â”‚  â””â”€ translation               â”‚
â”‚ â””â”€ Llmtranslate_batches         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ **æ ¸å¿ƒç»„ä»¶è®¾è®¡**

### **ä¼˜å…ˆçº§ 1: æ¨¡å‹é€‰æ‹©ä¸ LLM å®¢æˆ·ç«¯é›†æˆ**

#### **1.1 æ¨¡å‹é€‰æ‹©å™¨å®ç°ï¼ˆHomePage.vueï¼‰**

**éœ€æ±‚åˆ†æï¼š**
- å‚ç…§ `Nimbria\Client\GUI\components\ProjectPage.Shell\Navbar.content\LlmChat` çš„æ¨¡å‹é€‰æ‹©è®¾è®¡
- æ˜¾ç¤ºæ‰€æœ‰æ´»è·ƒæä¾›å•†çš„å·²æ¿€æ´»æ¨¡å‹
- æŒ‰æä¾›å•†åˆ†ç»„å±•ç¤º
- æ”¯æŒæ¨¡å‹é€‰æ‹©ï¼Œä¿è¯åç«¯èƒ½è·å–å¯¹åº”çš„ API Key å’Œ BaseUrl
- **ç±»å‹çº¦æŸï¼š** ä¸¥æ ¼æŒ‰ç…§ `Document\Workflow\ç±»å‹é€šç”¨è§„èŒƒ.md` å®šä¹‰ç±»å‹ï¼Œç¦æ­¢ä½¿ç”¨ `any`

**å®ç°æ¸…å•ï¼š**
- [ ] åˆ›å»º `LlmTranslate/components/ModelSelector.vue` ç»„ä»¶
- [ ] ä» `LlmConfigManager` è·å–æ¨¡å‹é…ç½®å¹¶æä¾›ç»™ `LlmTranslationClient`
- [ ] æ·»åŠ  `ModelOption` ç±»å‹åˆ° `Client/GUI/DemoPage/LlmTranslate/types/`

---

### **ä¼˜å…ˆçº§ 2: å®æ—¶ä»»åŠ¡çŠ¶æ€æ˜¾ç¤ºä¸è¯¦æƒ…é¢æ¿**

#### **2.1 çº¿ç¨‹è¯¦æƒ…é¢æ¿å¢å¼ºï¼ˆThreadDrawer.vueï¼‰**

**éœ€æ±‚åˆ†æï¼š**
- å±•ç¤ºä»»åŠ¡ä¸ LLM å®¢æˆ·ç«¯äº¤äº’çš„æ‰€æœ‰ä¿¡æ¯
- å®æ—¶æ˜¾ç¤ºä»»åŠ¡çŠ¶æ€ï¼ˆåŒ…å«æµå¼å›å¤è¿›åº¦ï¼‰
- ä»»åŠ¡ç»“æŸåæ˜¾ç¤ºå®Œæ•´çš„çŠ¶æ€ä¿¡æ¯
- æä¾›æ•°æ®åº“å†…ä¿¡æ¯æŸ¥çœ‹ï¼Œé¿å…æ‰‹åŠ¨æŸ¥çœ‹ SQLite
- **æ—¶åºä¿è¯ï¼š** å‚ç…§ `Document\Workflow\äº‹ä»¶é©±åŠ¨æ¶æ„èŒƒå¼æ€»ç»“æ–‡æ¡£.md` è®¾è®¡äº‹ä»¶æµ
- **ç±»å‹å®‰å…¨ï¼š** ä¸¥ç¦ `any`ï¼Œå‚ç…§ `Document\Workflow\ç±»å‹é€šç”¨è§„èŒƒ.md`

**å®ç°æ¸…å•ï¼š**
- [ ] æ‰©å±• ThreadDrawer æ˜¾ç¤ºæ¨¡å‹ä¿¡æ¯ã€ç³»ç»Ÿæç¤ºè¯ã€åˆ†ç‰‡ç­–ç•¥ç­‰é…ç½®
- [ ] å®æ—¶æ˜¾ç¤ºæµå¼å›å¤å†…å®¹å’Œè¿›åº¦ç™¾åˆ†æ¯”
- [ ] æ˜¾ç¤ºä»»åŠ¡å…ƒæ•°æ®ï¼ˆToken è®¡æ•°ã€è´¹ç”¨ã€è€—æ—¶ï¼‰

---

### **ä¼˜å…ˆçº§ 3: å¼‚å¸¸å¤„ç†ä¸ä»»åŠ¡çŠ¶æ€ç®¡ç†**

#### **3.1 é”™è¯¯å¤„ç†ä¸é™æµ**

**éœ€æ±‚åˆ†æï¼š**
- HTTP 429ï¼ˆé™æµï¼‰â†’ ä»»åŠ¡è¿›å…¥ `throttled` çŠ¶æ€
- å…¶ä»– HTTP é”™è¯¯ â†’ ä»»åŠ¡è¿›å…¥ `error` çŠ¶æ€
- æ˜¾ç¤ºä½ç½®ï¼šä»»åŠ¡å¡ç‰‡çŠ¶æ€æ ‡ç­¾å³ä¾§æ˜¾ç¤ºé”™è¯¯ä»£ç 
- å‚ç…§ä½ç½®ï¼š`#pane-tasks > div > div > div.main-content > div.task-list-area > div:nth-child(1) > div.card-header > div`

**å®ç°æ¸…å•ï¼š**
- [ ] `LlmTranslationClient` åŒºåˆ†é”™è¯¯ç±»å‹ï¼ˆ429 vs å…¶ä»–ï¼‰
- [ ] `TaskStateManager` è½¬æ¢é”™è¯¯å“åº”ä¸ºå¯¹åº”çŠ¶æ€
- [ ] `TaskManagePage.vue` ä»»åŠ¡å¡ç‰‡æ·»åŠ é”™è¯¯ä»£ç æ˜¾ç¤º

#### **3.2 ä»»åŠ¡æš‚åœä¸å¼‚å¸¸æ¢å¤**

**éœ€æ±‚åˆ†æï¼š**
- æ”¯æŒæ‰‹åŠ¨æš‚åœæ­£åœ¨å‘é€çš„ä»»åŠ¡
- æš‚åœ = æ›´æ”¹ä»»åŠ¡çŠ¶æ€ + åœæ­¢å¯¹è¯¥ä»»åŠ¡çš„è·Ÿè¸ª
- æš‚åœè§†ä¸ºé”™è¯¯å¤„ç†ï¼ˆé”™è¯¯ä»£ç ï¼šUSER_PAUSEDï¼‰
- åº”ç”¨å¯åŠ¨æ—¶ä¸åº”æœ‰è¿›è¡Œä¸­çš„ä»»åŠ¡ï¼Œè‹¥å­˜åœ¨åˆ™æ ‡è®°ä¸º `error`
- Electron å…³é—­å¯¼è‡´çš„ä»»åŠ¡ä¸­æ–­ â†’ `error` çŠ¶æ€
- **å¾®è°ƒï¼š** è¿›è¡Œä¸­çš„ä»»åŠ¡å¡ç‰‡éœ€è¦æ·»åŠ "æš‚åœ"æŒ‰é’®

**å®ç°æ¸…å•ï¼š**
- [ ] `TaskStateManager` æ”¯æŒ `pauseTask()` æ–¹æ³•
- [ ] `TaskManagePage.vue` è¿›è¡Œä¸­çš„ä»»åŠ¡å¡ç‰‡æ·»åŠ æš‚åœæŒ‰é’®
- [ ] `llm-translate-service.ts` å¯åŠ¨æ—¶æ£€æŸ¥å¼‚å¸¸ç»ˆæ­¢çš„ä»»åŠ¡
- [ ] å¼‚å¸¸ä»»åŠ¡è½¬ä¸º `error` çŠ¶æ€å¹¶è®°å½•é”™è¯¯ä»£ç 

---

### **ä¼˜å…ˆçº§ 4: LLM ç¿»è¯‘å®¢æˆ·ç«¯æ ¸å¿ƒå®ç°**

#### **ç»„ä»¶ 4.1: LlmTranslationClientï¼ˆç¿»è¯‘è¯·æ±‚æ‰§è¡Œç«¯ï¼‰**

#### **æ–‡ä»¶ä½ç½®**
```
Nimbria/src-electron/services/llm-translate-service/
â”œâ”€â”€ llm-translation-client.ts    â† æ–°å¢ï¼ˆLLM è¯·æ±‚æ‰§è¡Œï¼‰
â”œâ”€â”€ task-state-manager.ts        â† æ–°å¢ï¼ˆä»»åŠ¡çŠ¶æ€ç®¡ç†ï¼‰
â”œâ”€â”€ llm-translate-service.ts     â† å·²æœ‰ï¼ˆæœåŠ¡ç¼–æ’ï¼‰
â””â”€â”€ translation-executor.ts      â† å·²æœ‰ï¼ˆè°ƒåº¦æ‰§è¡Œï¼‰
```

#### **4.1 LlmTranslationClient - æ¨¡å—èŒè´£**

**å•ä¸€èŒè´£ï¼š** è´Ÿè´£å•æ¬¡ç¿»è¯‘è¯·æ±‚çš„å‘é€å’Œæµå¼æ¥æ”¶

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
1. ä» `LlmConfigManager` è·å– API Key å’Œ BaseUrl
2. ä½¿ç”¨ LangChain è°ƒç”¨ LLM API
3. å¤„ç†æµå¼å“åº”ï¼ˆtoken çº§åˆ«çš„å›å¤ï¼‰
4. ç®¡ç†è¶…æ—¶å’Œé‡è¯•é€»è¾‘
5. å‘å‡º Token æµäº‹ä»¶ä¾› TaskStateManager æ¶ˆè´¹

**å…³é”®è®¾è®¡ç‚¹ï¼š**
- **æµå¼ Token äº‹ä»¶** â†’ EventEmitter å‘å‡º `token-received` äº‹ä»¶
- **é”™è¯¯åŒºåˆ†** â†’ 429 é™æµ vs å…¶ä»–é”™è¯¯
- **å¹‚ç­‰æ€§** â†’ æ”¯æŒä»»åŠ¡é‡è¯•æ—¶çš„å¹‚ç­‰æ“ä½œ
- **è¶…æ—¶æ§åˆ¶** â†’ å¯é…ç½®çš„è¶…æ—¶å’Œé‡è¯•æ¬¡æ•°

#### **4.2 TaskStateManager - æ¨¡å—èŒè´£**

**å•ä¸€èŒè´£ï¼š** ç®¡ç†ä»»åŠ¡çŠ¶æ€æœºå’Œè¿›åº¦è®¡ç®—

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
1. **çŠ¶æ€è½¬ç§»** â†’ æ ¹æ® LLM å“åº”æ›´æ–°ä»»åŠ¡çŠ¶æ€
2. **è¿›åº¦è®¡ç®—** â†’ `received_tokens / predicted_tokens * 100%`
3. **äº‹ä»¶å¹¿æ’­** â†’ ä»»åŠ¡çŠ¶æ€å˜åŒ–æ—¶å‘å‡ºäº‹ä»¶
4. **é”™è¯¯è®°å½•** â†’ è®°å½•é”™è¯¯ä»£ç å’Œé”™è¯¯ä¿¡æ¯
5. **æ•°æ®æŒä¹…åŒ–** â†’ åŒæ­¥çŠ¶æ€åˆ°æ•°æ®åº“

**çŠ¶æ€æœºè®¾è®¡ï¼š**
```
waiting â†’ sending â†’ (æµå¼æ¥æ”¶) â†’ completed
          â†“              â†“
      throttled â†â†’ error/paused
```

**äº‹ä»¶ç±»å‹ï¼š**
```typescript
- task-status-changed: { taskId, status, timestamp }
- task-progress-updated: { taskId, progress, receivedTokens }
- task-error-occurred: { taskId, errorCode, errorMessage }
- task-completed: { taskId, result }
```

---

### **ä¼˜å…ˆçº§ 5: æ•°æ®åº“å­—æ®µä¸ç±»å‹å®šä¹‰**

#### **5.1 Task ç±»å‹å®Œæ•´å®šä¹‰**

```typescript
// src-electron/types/LlmTranslate/backend/index.ts

export interface Task {
  // æ ‡è¯†ç¬¦
  id: string
  batchId: string
  
  // çŠ¶æ€ä¸è¿›åº¦
  status: TaskStatus // 'waiting' | 'sending' | 'throttled' | 'completed' | 'error' | 'paused'
  progress: number   // 0-100
  
  // è¾“å…¥ä¸è¾“å‡º
  content: string              // åŸå§‹å†…å®¹
  translation: string | null   // ç¿»è¯‘ç»“æœ
  
  // Token ç»Ÿè®¡
  inputTokens: number          // è¾“å…¥ Token æ•°
  replyTokens: number          // è¾“å‡º Token æ•°ï¼ˆå®é™…ï¼‰
  predictedTokens: number      // é¢„æµ‹è¾“å‡º Token æ•°
  
  // æ—¶é—´æˆ³
  sentTime: string | null      // å‘é€æ—¶é—´ ISO 8601
  replyTime: string | null     // å›å¤æ—¶é—´ ISO 8601
  durationMs: number           // è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
  
  // é”™è¯¯å¤„ç†
  errorMessage: string | null  // é”™è¯¯æ¶ˆæ¯
  errorType: string | null     // é”™è¯¯ç±»å‹ï¼ˆå¦‚ 'THROTTLED', 'TIMEOUT', 'INVALID_KEY'ï¼‰
  retryCount: number           // é‡è¯•æ¬¡æ•°
  
  // è´¹ç”¨ä¸å…ƒæ•°æ®
  cost: number                 // ä¼°ç®—è´¹ç”¨
  metadata: TaskMetadata       // ä»»åŠ¡å…ƒæ•°æ®ï¼ˆåŒ…å«æ¨¡å‹ä¿¡æ¯ã€é…ç½®ç­‰ï¼‰
  metadataJson: string         // å…ƒæ•°æ® JSON å­—ç¬¦ä¸²ï¼ˆæ•°æ®åº“å­˜å‚¨ï¼‰
  
  // æ—¶é—´æˆ³
  createdAt: string           // åˆ›å»ºæ—¶é—´ ISO 8601
  updatedAt: string           // æ›´æ–°æ—¶é—´ ISO 8601
}

export type TaskStatus = 
  | 'waiting'      // ç­‰å¾…å‘é€
  | 'sending'      // å‘é€ä¸­
  | 'throttled'    // é™æµ
  | 'completed'    // å®Œæˆ
  | 'error'        // é”™è¯¯
  | 'paused'       // ç”¨æˆ·æš‚åœ

export interface TaskMetadata {
  modelId: string                        // æ¨¡å‹ ID
  modelName: string                      // æ¨¡å‹åç§°
  providerId: string                     // æä¾›å•† ID
  systemPrompt: string                   // ç³»ç»Ÿæç¤ºè¯
  chunkStrategy: 'line' | 'token'        // åˆ†ç‰‡ç­–ç•¥
  chunkSize: number                      // åˆ†ç‰‡å¤§å°
  concurrency: number                    // å¹¶å‘æ•°
  replyMode: 'complete' | 'streaming'   // å›å¤æ¨¡å¼
  temperature: number                    // æ¸©åº¦å‚æ•°
  maxTokens: number                      // æœ€å¤§è¾“å‡º Token
}
```

#### **5.2 æ•°æ®åº“å­—æ®µæ˜ å°„**

```sql
-- Llmtranslate_tasks è¡¨
CREATE TABLE Llmtranslate_tasks (
  id TEXT PRIMARY KEY,
  batch_id TEXT NOT NULL,
  status TEXT NOT NULL,
  progress INTEGER DEFAULT 0,
  content TEXT NOT NULL,
  translation TEXT,
  input_tokens INTEGER DEFAULT 0,
  reply_tokens INTEGER DEFAULT 0,
  predicted_tokens INTEGER DEFAULT 0,
  sent_time TEXT,
  reply_time TEXT,
  duration_ms INTEGER DEFAULT 0,
  error_message TEXT,
  error_type TEXT,
  retry_count INTEGER DEFAULT 0,
  cost REAL DEFAULT 0,
  metadata_json TEXT,           -- â­ TaskMetadata JSON
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL
);

-- å­—æ®µåˆ«åæ˜ å°„ï¼ˆSQL AS è¯­å¥ï¼‰
SELECT
  id,
  batch_id AS batchId,
  status,
      progress,
  content,
  translation,
  input_tokens AS inputTokens,
  reply_tokens AS replyTokens,
  predicted_tokens AS predictedTokens,
  sent_time AS sentTime,
  reply_time AS replyTime,
  duration_ms AS durationMs,
  error_message AS errorMessage,
  error_type AS errorType,
  retry_count AS retryCount,
  cost,
  metadata_json AS metadataJson,
  created_at AS createdAt,
  updated_at AS updatedAt
FROM Llmtranslate_tasks
```

---

### **ä¼˜å…ˆçº§ 6: å‰ç«¯ UI ç»„ä»¶å¢å¼º**

#### **6.1 TaskManagePage ä»»åŠ¡å¡ç‰‡ä¿®æ”¹**

**ä¿®æ”¹ä½ç½®ï¼š** `Nimbria\Client\GUI\DemoPage\LlmTranslate\components\TaskManagePage.vue`

**éœ€è¦å¾®è°ƒçš„åœ°æ–¹ï¼š**
```vue
<!-- åŸçŠ¶æ€æ ‡ç­¾ -->
<span class="status-tag" :class="task.status">{{ task.status }}</span>

<!-- â†“ ä¿®æ”¹ä¸ºï¼šæ·»åŠ é”™è¯¯ä»£ç å’Œæš‚åœæŒ‰é’® -->
<div class="status-bar">
  <span class="status-tag" :class="task.status">
    {{ task.status }}
  </span>
  
  <!-- é”™è¯¯ä»£ç æ˜¾ç¤º -->
  <span v-if="task.errorType" class="error-code">
    {{ task.errorType }}
  </span>
  
  <!-- æš‚åœæŒ‰é’®ï¼ˆä»…åœ¨ sending çŠ¶æ€ï¼‰ -->
  <button 
    v-if="task.status === 'sending'"
    @click="pauseTask(task.id)"
    class="btn-pause"
  >
    â¸ æš‚åœ
  </button>
</div>
```

#### **6.2 ThreadDrawer è¯¦æƒ…é¢æ¿å¢å¼º**

**ä¿®æ”¹ä½ç½®ï¼š** `Nimbria\Client\GUI\DemoPage\LlmTranslate\components\ThreadDrawer.vue`

**éœ€è¦å±•ç¤ºçš„é…ç½®ä¿¡æ¯ï¼š**
```vue
<div class="config-section">
  <!-- æ¨¡å‹ä¿¡æ¯ -->
  <div class="config-item">
    <label>æ¨¡å‹</label>
    <span>{{ task.metadata?.modelName }}</span>
  </div>
  
  <!-- ç³»ç»Ÿæç¤ºè¯ï¼ˆå¯å±•å¼€ï¼‰ -->
  <div class="config-item">
    <label>ç³»ç»Ÿæç¤ºè¯</label>
    <details>
      <summary>æŸ¥çœ‹</summary>
      <p>{{ task.metadata?.systemPrompt }}</p>
    </details>
  </div>
  
  <!-- Token ç»Ÿè®¡ -->
  <div class="config-item">
    <label>Token ç»Ÿè®¡</label>
    <span>è¾“å…¥: {{ task.inputTokens }} | è¾“å‡º: {{ task.replyTokens }} / {{ task.predictedTokens }}</span>
  </div>
  
  <!-- è¿›åº¦æ¡ï¼ˆå®æ—¶æ›´æ–°ï¼‰ -->
  <div class="progress-bar">
    <div class="progress" :style="{ width: task.progress + '%' }"></div>
    <span class="progress-text">{{ task.progress }}%</span>
  </div>
  
  <!-- æµå¼å›å¤å†…å®¹ï¼ˆå®æ—¶æ˜¾ç¤ºï¼‰ -->
  <div class="reply-content">
    {{ task.translation }}
  </div>
</div>
```

---

### **ä¼˜å…ˆçº§ 7: äº‹ä»¶é©±åŠ¨æµç¨‹è®¾è®¡**

**å‚ç…§æ–‡æ¡£ï¼š** `Document\Workflow\äº‹ä»¶é©±åŠ¨æ¶æ„èŒƒå¼æ€»ç»“æ–‡æ¡£.md`

**äº‹ä»¶æµæ—¶åºï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TranslationExecutor                                          â”‚
â”‚  â”‚                                                            â”‚
â”‚  â”œâ”€ emit: task-start { taskId, content }                    â”‚
â”‚  â”‚         â†“                                                 â”‚
â”‚  â”‚  TaskStateManager: status = 'sending'                   â”‚
â”‚  â”‚  â†“ update database                                       â”‚
â”‚  â”‚  â†“ emit: task-status-changed                            â”‚
â”‚  â”‚         â†“ notify UI                                      â”‚
â”‚  â”‚                                                            â”‚
â”‚  â””â”€ LlmTranslationClient.sendRequest()                      â”‚
â”‚      â”œâ”€ on('token-received') event                          â”‚
â”‚      â”‚  â”œâ”€ TaskStateManager: progress += 1                  â”‚
â”‚      â”‚  â”œâ”€ emit: task-progress-updated                      â”‚
â”‚      â”‚  â”‚    â†“ update database                              â”‚
â”‚      â”‚  â”‚    â†“ notify UI (real-time)                       â”‚
â”‚      â”‚  â””â”€ if (tokens === predicted) â†’ completed          â”‚
â”‚      â”‚                                                        â”‚
â”‚      â”œâ”€ on('error', 429)                                   â”‚
â”‚      â”‚  â”œâ”€ TaskStateManager: status = 'throttled'          â”‚
â”‚      â”‚  â”œâ”€ emit: task-status-changed                        â”‚
â”‚      â”‚  â””â”€ emit: task-error-occurred                        â”‚
â”‚      â”‚                                                        â”‚
â”‚      â””â”€ on('error', other)                                 â”‚
â”‚         â”œâ”€ TaskStateManager: status = 'error'              â”‚
â”‚         â”œâ”€ emit: task-status-changed                        â”‚
â”‚         â”œâ”€ emit: task-error-occurred                        â”‚
â”‚         â””â”€ if retryCount < maxRetries â†’ retry              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **ä¼˜å…ˆçº§ 8: é€»è¾‘å®Œæ•´æ€§æ£€æŸ¥æ¸…å•**

æ ¹æ®ç”¨æˆ· review æ„è§ï¼Œä»¥ä¸‹æ˜¯å®Œæ•´çš„é€»è¾‘æ£€æŸ¥æ¸…å•ï¼š

- [ ] **å¯åŠ¨æ—¶å¼‚å¸¸ä»»åŠ¡å¤„ç†** â†’ å¯åŠ¨æ—¶æ£€æŸ¥æœ‰æ—  'sending' çŠ¶æ€çš„ä»»åŠ¡ï¼Œè½¬ä¸º 'error'
- [ ] **æš‚åœåŠŸèƒ½** â†’ ç”¨æˆ·å¯åœ¨ä»»åŠ¡å¡ç‰‡ç‚¹å‡»æš‚åœï¼ŒçŠ¶æ€è½¬ä¸º 'paused'ï¼Œæš‚åœè§†ä¸ºé”™è¯¯å¤„ç†
- [ ] **é™æµå¤„ç†** â†’ 429 çŠ¶æ€ç ç‹¬ç«‹å¤„ç†ï¼Œè¿›å…¥ 'throttled'ï¼Œå…¶ä»–é”™è¯¯è¿›å…¥ 'error'
- [ ] **é”™è¯¯ä»£ç æ˜¾ç¤º** â†’ ä»»åŠ¡å¡ç‰‡çŠ¶æ€æ ‡ç­¾å³ä¾§æ˜¾ç¤º errorTypeï¼ˆé”™è¯¯ä»£ç ï¼‰
- [ ] **å…³é—­æ¢å¤** â†’ Electron æ„å¤–å…³é—­åï¼Œé‡å¯æ—¶å°†è¿›è¡Œä¸­çš„ä»»åŠ¡æ ‡è®°ä¸º 'error'
- [ ] **æµå¼è¿›åº¦** â†’ åŸºäº predictedTokens å’Œ replyTokens å®æ—¶è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
- [ ] **å…ƒæ•°æ®æ˜¾ç¤º** â†’ ThreadDrawer å®Œæ•´æ˜¾ç¤ºä»»åŠ¡çš„æ‰€æœ‰å…ƒæ•°æ®ï¼ˆä¸ä½¿ç”¨ `any` ç±»å‹ï¼‰
- [ ] **æ—¶åºä¿è¯** â†’ æ‰€æœ‰äº‹ä»¶æŒ‰ç…§äº‹ä»¶é©±åŠ¨æ¨¡å¼å‘å‡ºï¼Œä¿è¯å‰åç«¯æ•°æ®åŒæ­¥

---

## ğŸ”— **é›†æˆåˆ° TranslationExecutor**

```typescript
// translation-executor.ts (ä¿®æ”¹ç‰ˆ)

import { LlmTranslationClient } from './llm-translation-client'
import { TaskStateManager } from './task-state-manager'
import type { TranslationClientConfig, TranslationRequest } from './types'

export class TranslationExecutor {
  private llmTranslateService: LlmTranslateService
  private llmConfigManager: any
  private taskStateManager: TaskStateManager
  private taskQueues: Map<string, string[]> = new Map()
  private pausedBatches: Set<string> = new Set()
  private activeTaskCount: Map<string, number> = new Map()

  constructor(
    llmTranslateService: LlmTranslateService,
    llmConfigManager: any,
    taskStateManager: TaskStateManager
  ) {
    this.llmTranslateService = llmTranslateService
    this.llmConfigManager = llmConfigManager
    this.taskStateManager = taskStateManager
  }

  /**
   * æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—
   */
  async executeTasks(
    batchId: string,
    taskIds: string[],
    config: TranslateConfig,
    concurrency: number
  ): Promise<void> {
    this.taskQueues.set(batchId, [...taskIds])
    this.activeTaskCount.set(batchId, 0)

    console.log(`ğŸ¬ [TranslationExecutor] å¼€å§‹æ‰§è¡Œæ‰¹æ¬¡ ${batchId}ï¼Œå…± ${taskIds.length} ä¸ªä»»åŠ¡ï¼Œå¹¶å‘: ${concurrency}`)

    // å¯åŠ¨å¹¶å‘ worker
    const workers: Promise<void>[] = []
    for (let i = 0; i < Math.min(concurrency, taskIds.length); i++) {
      workers.push(this.worker(batchId, config))
    }

    await Promise.all(workers)

    console.log(`âœ… [TranslationExecutor] æ‰¹æ¬¡ ${batchId} æ‰§è¡Œå®Œæˆ`)

    // æ¸…ç†æ‰¹æ¬¡çŠ¶æ€
    this.taskStateManager.cleanupBatch(batchId)
  }

  /**
   * Worker çº¿ç¨‹
   */
  private async worker(batchId: string, config: TranslateConfig): Promise<void> {
    while (true) {
      if (this.pausedBatches.has(batchId)) {
        break
      }

      const queue = this.taskQueues.get(batchId)
      if (!queue || queue.length === 0) {
        break
      }

      const taskId = queue.shift()
      if (!taskId) break

      await this.executeTask(batchId, taskId, config)
      await this.delay(1000 / config.concurrency * 60)
    }
  }

  /**
   * æ‰§è¡Œå•ä¸ªä»»åŠ¡ï¼ˆæ–°ç‰ˆæœ¬ï¼‰
   */
  private async executeTask(
    batchId: string,
    taskId: string,
    config: TranslateConfig
  ): Promise<void> {
    const projectDb = this.llmTranslateService.getProjectDatabase()
    if (!projectDb) return

    try {
      // 1. è·å–ä»»åŠ¡ä¿¡æ¯
      const task = await this.llmTranslateService.getTask(taskId)
      if (!task) {
        throw new Error(`Task ${taskId} not found`)
      }

      // 2. åˆå§‹åŒ–ä»»åŠ¡çŠ¶æ€
      this.taskStateManager.initializeTask(taskId, batchId, config.predictedTokens)

      // 3. æ›´æ–°çŠ¶æ€ä¸º waiting
      await this.taskStateManager.updateState(taskId, 'waiting')

      // 4. åˆ›å»ºç¿»è¯‘å®¢æˆ·ç«¯é…ç½®
      const clientConfig: TranslationClientConfig = {
        modelId: config.modelId,
        systemPrompt: config.systemPrompt,
        temperature: 0.7,
        maxTokens: config.predictedTokens,
        timeout: 30000,
        maxRetries: 3
      }

      // 5. åˆ›å»ºç¿»è¯‘å®¢æˆ·ç«¯
      const client = new LlmTranslationClient(clientConfig, this.llmConfigManager)

      // 6. æ„å»ºç¿»è¯‘è¯·æ±‚
      const request: TranslationRequest = {
        taskId,
        content: task.content,
        estimatedTokens: config.predictedTokens
      }

      // 7. æ‰§è¡Œç¿»è¯‘ï¼ˆæµå¼ï¼‰
      const result = await client.translateStream(request, {
        onStart: (id) => {
          console.log(`ğŸš€ [Executor] ä»»åŠ¡ ${id} å¼€å§‹ç¿»è¯‘`)
        },
        onProgress: (id, chunk, tokens) => {
          // æ›´æ–°è¿›åº¦
          this.taskStateManager.updateProgress(id, chunk, tokens)
        },
        onComplete: (id, res) => {
          console.log(`âœ… [Executor] ä»»åŠ¡ ${id} ç¿»è¯‘å®Œæˆ`)
        },
        onError: (id, error) => {
          console.error(`âŒ [Executor] ä»»åŠ¡ ${id} ç¿»è¯‘å¤±è´¥:`, error)
        }
      })

      // 8. æ ‡è®°ä»»åŠ¡å®Œæˆ
      await this.taskStateManager.markComplete(taskId, {
        translation: result.translation,
        inputTokens: result.inputTokens,
        outputTokens: result.outputTokens,
        cost: result.cost,
        durationMs: result.durationMs
      })

      // 9. æ›´æ–°æ‰¹æ¬¡ç»Ÿè®¡
      await this.llmTranslateService.updateBatchStats(batchId)

    } catch (error) {
      const err = error as Error
      console.error(`âŒ [Executor] ä»»åŠ¡ ${taskId} æ‰§è¡Œå¤±è´¥:`, err)

      // æ ‡è®°ä»»åŠ¡é”™è¯¯
      await this.taskStateManager.markError(
        taskId,
        this.classifyError(err),
        err.message,
        0
      )

      // æ›´æ–°æ‰¹æ¬¡ç»Ÿè®¡
      await this.llmTranslateService.updateBatchStats(batchId)
    }
  }

  private classifyError(error: Error): string {
    const message = error.message.toLowerCase()
    if (message.includes('429')) return 'rate_limit'
    if (message.includes('timeout')) return 'timeout'
    if (message.includes('network')) return 'network'
    return 'unknown'
  }

  private delay(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms))
  }
}
```

---

## ğŸ“¡ **äº‹ä»¶æµè®¾è®¡**

```
ä»»åŠ¡æ‰§è¡Œæµç¨‹ä¸­çš„äº‹ä»¶å‘å°„ï¼š

1. ä»»åŠ¡å¼€å§‹
   â”œâ”€ TaskStateManager.emit('state:change', waiting)
   â”œâ”€ LlmTranslationClient.emit('translation:start')
   â””â”€ LlmTranslateService.emit('task:submitted')

2. æµå¼è¿›åº¦ (æ¯ 100ms)
   â”œâ”€ LlmTranslationClient.emit('translation:progress', { chunk, tokens, progress })
   â””â”€ TaskStateManager.emit('progress:update', { progress, currentTokens })

3. ä»»åŠ¡å®Œæˆ
   â”œâ”€ LlmTranslationClient.emit('translation:complete', result)
   â”œâ”€ TaskStateManager.emit('state:change', completed)
   â”œâ”€ TaskStateManager.emit('task:complete', completionData)
   â””â”€ LlmTranslateService.emit('task:complete')

4. ä»»åŠ¡é”™è¯¯
   â”œâ”€ LlmTranslationClient.emit('translation:error', error)
   â”œâ”€ TaskStateManager.emit('state:change', error)
   â””â”€ TaskStateManager.emit('task:error', errorData)
```

---

## ğŸ“Š **æ€§èƒ½ä¼˜åŒ–**

### **1. è¿›åº¦æ›´æ–°èŠ‚æµ**
- æœ€å°é—´éš” 100ms å‘å°„ä¸€æ¬¡è¿›åº¦äº‹ä»¶
- é¿å…é«˜é¢‘æ•°æ®åº“å†™å…¥

### **2. å†…å­˜ç¼“å­˜**
- TaskStateManager ä½¿ç”¨ Map ç¼“å­˜çŠ¶æ€
- å¿«é€Ÿè¯»å–ï¼Œå¼‚æ­¥æŒä¹…åŒ–

### **3. è½»é‡çº§å®¢æˆ·ç«¯**
- LlmTranslationClient ä»»åŠ¡å®Œæˆåè‡ªåŠ¨æ¸…ç†
- ä¸ç»´æŠ¤é•¿æœŸçŠ¶æ€

### **4. å¹¶å‘æ§åˆ¶**
- Worker æ¨¡å¼é™åˆ¶å¹¶å‘æ•°
- é˜²é™æµå»¶è¿Ÿç­–ç•¥

---

## ğŸ“¦ **æ–‡ä»¶ç»“æ„æ€»è§ˆ**

```
Nimbria/src-electron/services/llm-translate-service/
â”œâ”€â”€ llm-translate-service.ts          # ä¸»æœåŠ¡ï¼ˆå·²æœ‰ï¼‰
â”œâ”€â”€ translation-executor.ts           # æ‰§è¡Œå¼•æ“ï¼ˆä¿®æ”¹ï¼‰
â”œâ”€â”€ llm-translation-client.ts         # â­ æ–°å¢ï¼šç¿»è¯‘å®¢æˆ·ç«¯
â”œâ”€â”€ task-state-manager.ts             # â­ æ–°å¢ï¼šçŠ¶æ€ç®¡ç†å™¨
â”œâ”€â”€ export-service.ts                 # å¯¼å‡ºæœåŠ¡ï¼ˆå·²æœ‰ï¼‰
â””â”€â”€ types.ts                           # ç±»å‹å®šä¹‰ï¼ˆæ‰©å±•ï¼‰
```

## ğŸ“ æ–‡ä»¶æ¶æ„ä¿®æ”¹æ ‘

å®Œæ•´çš„å¼€å‘æµç¨‹åˆ†ä¸º 8 ä¸ªä¼˜å…ˆçº§ï¼Œæ¶‰åŠå‰åç«¯å…± 15+ ä¸ªæ–‡ä»¶çš„ä¿®æ”¹å’Œæ–°å¢ã€‚ä¸‹é¢æ˜¯è¯¦ç»†çš„ä¿®æ”¹æ¸…å•ï¼š

### **ç¬¬ä¸€å±‚ï¼šæ–°å¢æ ¸å¿ƒæœåŠ¡æ¨¡å—**

```
Nimbria/src-electron/services/llm-translate-service/
â”‚
â”œâ”€â”€ [æ–°å¢æ–‡ä»¶] llm-translation-client.ts
â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼š
â”‚       â”œâ”€â”€ LlmTranslationClient ç±»
â”‚       â”‚   â”œâ”€â”€ constructor(config, llmConfigManager)
â”‚       â”‚   â”œâ”€â”€ translateStream(request, callbacks) - æµå¼ç¿»è¯‘æ‰§è¡Œ
â”‚       â”‚   â”œâ”€â”€ translate(request) - éæµå¼ç¿»è¯‘æ‰§è¡Œ
â”‚       â”‚   â”œâ”€â”€ initClient() - LangChain å®¢æˆ·ç«¯åˆå§‹åŒ–
â”‚       â”‚   â”œâ”€â”€ getModelConfig(modelId) - è·å–æ¨¡å‹é…ç½®
â”‚       â”‚   â”œâ”€â”€ estimateTokens(text) - Token å¿«é€Ÿä¼°ç®—
â”‚       â”‚   â”œâ”€â”€ countTokensAccurate(text) - Token ç²¾ç¡®è®¡ç®—
â”‚       â”‚   â”œâ”€â”€ calculateCost(inputTokens, outputTokens) - è´¹ç”¨è®¡ç®—
â”‚       â”‚   â””â”€â”€ classifyError(error) - é”™è¯¯åˆ†ç±»
â”‚       â””â”€â”€ äº‹ä»¶å‘å°„ï¼štranslation:start, translation:progress, translation:complete, translation:error
â”‚
â”œâ”€â”€ [æ–°å¢æ–‡ä»¶] task-state-manager.ts
â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼š
â”‚       â”œâ”€â”€ TaskStateManager ç±»
â”‚       â”‚   â”œâ”€â”€ setProjectDatabase(db) - ç»‘å®šæ•°æ®åº“
â”‚       â”‚   â”œâ”€â”€ initializeTask(taskId, batchId, estimatedTokens) - åˆå§‹åŒ–ä»»åŠ¡çŠ¶æ€
â”‚       â”‚   â”œâ”€â”€ updateState(taskId, newStatus, additionalData) - æ›´æ–°ä»»åŠ¡çŠ¶æ€
â”‚       â”‚   â”œâ”€â”€ updateProgress(taskId, chunk, currentTokens) - æ›´æ–°è¿›åº¦ï¼ˆèŠ‚æµï¼‰
â”‚       â”‚   â”œâ”€â”€ markComplete(taskId, result) - æ ‡è®°ä»»åŠ¡å®Œæˆ
â”‚       â”‚   â”œâ”€â”€ markError(taskId, errorType, errorMessage, retryCount) - æ ‡è®°ä»»åŠ¡é”™è¯¯
â”‚       â”‚   â”œâ”€â”€ pauseTask(taskId) - æš‚åœä»»åŠ¡ [æ–°å¢]
â”‚       â”‚   â”œâ”€â”€ getState(taskId) - è·å–ä»»åŠ¡çŠ¶æ€å¿«ç…§
â”‚       â”‚   â”œâ”€â”€ getBatchStates(batchId) - è·å–æ‰¹æ¬¡æ‰€æœ‰ä»»åŠ¡çŠ¶æ€
â”‚       â”‚   â”œâ”€â”€ cleanup(taskId) - æ¸…ç†å•ä¸ªä»»åŠ¡çŠ¶æ€
â”‚       â”‚   â”œâ”€â”€ cleanupBatch(batchId) - æ¸…ç†æ‰¹æ¬¡çŠ¶æ€
â”‚       â”‚   â”œâ”€â”€ shouldEmitProgress(taskId) - èŠ‚æµåˆ¤æ–­
â”‚       â”‚   â”œâ”€â”€ persistState(snapshot) - çŠ¶æ€æŒä¹…åŒ–
â”‚       â”‚   â”œâ”€â”€ persistProgress(taskId, progress, currentTokens) - è¿›åº¦æŒä¹…åŒ–
â”‚       â”‚   â”œâ”€â”€ persistCompletion(taskId, result) - å®Œæˆç»“æœæŒä¹…åŒ–
â”‚       â”‚   â””â”€â”€ persistError(taskId, errorType, errorMessage, retryCount) - é”™è¯¯ä¿¡æ¯æŒä¹…åŒ–
â”‚       â””â”€â”€ äº‹ä»¶å‘å°„ï¼šstate:change, progress:update, task:complete, task:error
â”‚
â”œâ”€â”€ [ä¿®æ”¹æ–‡ä»¶] translation-executor.ts
â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ä¿®æ”¹ï¼š
â”‚       â”œâ”€â”€ TranslationExecutor ç±» [ä¿®æ”¹]
â”‚       â”‚   â”œâ”€â”€ constructor() - æ–°å¢ taskStateManager å‚æ•°
â”‚       â”‚   â”œâ”€â”€ executeTasks() - æ·»åŠ  TaskStateManager åˆå§‹åŒ–é€»è¾‘
â”‚       â”‚   â”œâ”€â”€ worker() - æ·»åŠ ä»»åŠ¡æš‚åœæ£€æŸ¥
â”‚       â”‚   â””â”€â”€ executeTask() - [é‡æ„] å®Œå…¨é‡å†™
â”‚       â”‚       â”œâ”€â”€ æ­¥éª¤1ï¼šè·å–ä»»åŠ¡ä¿¡æ¯
â”‚       â”‚       â”œâ”€â”€ æ­¥éª¤2ï¼šåˆå§‹åŒ–ä»»åŠ¡çŠ¶æ€ï¼ˆTaskStateManagerï¼‰
â”‚       â”‚       â”œâ”€â”€ æ­¥éª¤3ï¼šæ›´æ–°çŠ¶æ€ä¸º waiting
â”‚       â”‚       â”œâ”€â”€ æ­¥éª¤4ï¼šåˆ›å»º LlmTranslationClient é…ç½®
â”‚       â”‚       â”œâ”€â”€ æ­¥éª¤5ï¼šåˆ›å»ºç¿»è¯‘å®¢æˆ·ç«¯å®ä¾‹
â”‚       â”‚       â”œâ”€â”€ æ­¥éª¤6ï¼šæ„å»ºç¿»è¯‘è¯·æ±‚
â”‚       â”‚       â”œâ”€â”€ æ­¥éª¤7ï¼šæ‰§è¡Œç¿»è¯‘æµï¼ˆregisterProgressHandlerï¼‰
â”‚       â”‚       â”œâ”€â”€ æ­¥éª¤8ï¼šæ ‡è®°ä»»åŠ¡å®Œæˆï¼ˆmarkCompleteï¼‰
â”‚       â”‚       â””â”€â”€ æ­¥éª¤9ï¼šæ›´æ–°æ‰¹æ¬¡ç»Ÿè®¡
â”‚       â””â”€â”€ æ–°å¢æ–¹æ³•ï¼šclassifyError()
â”‚
â”œâ”€â”€ [ä¿®æ”¹æ–‡ä»¶] llm-translate-service.ts
â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ä¿®æ”¹ï¼š
â”‚       â”œâ”€â”€ LlmTranslateService ç±» [ä¿®æ”¹]
â”‚       â”‚   â”œâ”€â”€ initialize() - æ–°å¢ï¼šTaskStateManager åˆ›å»ºå’Œåˆå§‹åŒ–
â”‚       â”‚   â”œâ”€â”€ createBatch() - ä¿æŒä¸å˜ï¼ˆé…ç½®å·²åŒ…å«åœ¨ metadata ä¸­ï¼‰
â”‚       â”‚   â”œâ”€â”€ getTasks() - [ä¿®æ”¹] æ·»åŠ å­—æ®µåˆ«åæ˜ å°„ âœ… å·²å®Œæˆ
â”‚       â”‚   â”œâ”€â”€ getTask() - [ä¿®æ”¹] æ·»åŠ å­—æ®µåˆ«åæ˜ å°„ âœ… å·²å®Œæˆ
â”‚       â”‚   â”œâ”€â”€ getBatches() - [ä¿®æ”¹] æ·»åŠ å­—æ®µåˆ«åæ˜ å°„ âœ… å·²å®Œæˆ
â”‚       â”‚   â”œâ”€â”€ getBatch() - [ä¿®æ”¹] æ·»åŠ å­—æ®µåˆ«åæ˜ å°„ âœ… å·²å®Œæˆ
â”‚       â”‚   â”œâ”€â”€ loadBatches() - [ä¿®æ”¹] æ·»åŠ å­—æ®µåˆ«åæ˜ å°„ âœ… å·²å®Œæˆ
â”‚       â”‚   â”œâ”€â”€ handleTerminatedTasks() - [ä¿®æ”¹] æ·»åŠ å­—æ®µåˆ«åæ˜ å°„ âœ… å·²å®Œæˆ
â”‚       â”‚   â”œâ”€â”€ handleRecoveryTasks() - [æ–°å¢] å¯åŠ¨æ—¶å¼‚å¸¸ä»»åŠ¡æ¢å¤
â”‚       â”‚   â”‚   â”œâ”€â”€ æŸ¥è¯¢æ‰€æœ‰ 'sending' çŠ¶æ€çš„ä»»åŠ¡
â”‚       â”‚   â”‚   â”œâ”€â”€ å°†å…¶è½¬ä¸º 'error' çŠ¶æ€
â”‚       â”‚   â”‚   â””â”€â”€ è®°å½•é”™è¯¯ä»£ç ï¼š'APP_CRASHED'
â”‚       â”‚   â”œâ”€â”€ pauseTask(taskId) - [æ–°å¢] æš‚åœä»»åŠ¡å¤„ç†
â”‚       â”‚   â”œâ”€â”€ retryFailedTasks() - æ–°å¢æˆ–ä¿®æ”¹ï¼šé›†æˆ TaskStateManager
â”‚       â”‚   â””â”€â”€ updateBatchStats() - åŒæ­¥ TaskStateManager æ•°æ®åˆ°æ•°æ®åº“
â”‚       â””â”€â”€ æ–°å¢å±æ€§ï¼štaskStateManager
â”‚
â”œâ”€â”€ [ä¿®æ”¹æ–‡ä»¶] types.ts
â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ä¿®æ”¹ï¼š
â”‚       â”œâ”€â”€ å¯¼å‡ºå·²æœ‰ç±»å‹ï¼šTranslationClientConfig, TranslationRequest, TranslationResult
â”‚       â”œâ”€â”€ å¯¼å‡ºå·²æœ‰ç±»å‹ï¼šErrorType, TranslationStreamCallbacks
â”‚       â”œâ”€â”€ [æ–°å¢] TaskStatus ç±»å‹
â”‚       â”œâ”€â”€ [æ–°å¢] TaskMetadata æ¥å£
â”‚       â”œâ”€â”€ [æ–°å¢] Task æ¥å£ï¼ˆæ‰©å±•ï¼‰
â”‚       â”‚   â”œâ”€â”€ æ–°å¢å­—æ®µï¼šerrorType, errorMessage, retryCount
â”‚       â”‚   â”œâ”€â”€ æ–°å¢å­—æ®µï¼šmetadata, metadataJson
â”‚       â”‚   â””â”€â”€ ä¿®æ”¹å­—æ®µï¼šstatus çš„å¯é€‰å€¼
â”‚       â”œâ”€â”€ [æ–°å¢] TaskStateChangeEvent æ¥å£
â”‚       â”œâ”€â”€ [æ–°å¢] TaskProgressUpdateEvent æ¥å£
â”‚       â”œâ”€â”€ [æ–°å¢] TaskCompletionEvent æ¥å£
â”‚       â””â”€â”€ [æ–°å¢] TaskErrorEvent æ¥å£
â”‚
â””â”€â”€ export-service.ts - ä¿æŒä¸å˜ï¼ˆé€»è¾‘ä¸å—å½±å“ï¼‰
```

---

### **ç¬¬äºŒå±‚ï¼šå‰ç«¯ä¸»è¦é¡µé¢å’Œç»„ä»¶ä¿®æ”¹**

```
Nimbria/Client/GUI/DemoPage/LlmTranslate/
â”‚
â”œâ”€â”€ [æ–°å¢æ–‡ä»¶] components/ModelSelector.vue
â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼š
â”‚       â”œâ”€â”€ æ¨¡æ¿éƒ¨åˆ†ï¼š
â”‚       â”‚   â”œâ”€â”€ El-Select ä¸‹æ‹‰æ¡†ï¼ˆæ”¯æŒåˆ†ç»„ï¼‰
â”‚       â”‚   â”œâ”€â”€ æŒ‰æä¾›å•†åˆ†ç»„å±•ç¤ºæ¨¡å‹
â”‚       â”‚   â””â”€â”€ æ˜¾ç¤ºæ¨¡å‹åç§°ã€æä¾›å•†ä¿¡æ¯
â”‚       â”œâ”€â”€ è„šæœ¬éƒ¨åˆ†ï¼š
â”‚       â”‚   â”œâ”€â”€ props: modelId (v-model)
â”‚       â”‚   â”œâ”€â”€ data: providers åˆ—è¡¨, selectedModel
â”‚       â”‚   â”œâ”€â”€ computed: groupedModels() - æŒ‰æä¾›å•†åˆ†ç»„
â”‚       â”‚   â”œâ”€â”€ methods:
â”‚       â”‚   â”‚   â”œâ”€â”€ loadProviders() - ä» LlmConfigManager è·å–
â”‚       â”‚   â”‚   â”œâ”€â”€ onModelSelect(modelId) - é€‰æ‹©å˜æ›´å›è°ƒ
â”‚       â”‚   â”‚   â””â”€â”€ getModelInfo(modelId) - è·å–æ¨¡å‹å®Œæ•´ä¿¡æ¯
â”‚       â”‚   â””â”€â”€ onMounted: åˆå§‹åŒ–åŠ è½½æä¾›å•†åˆ—è¡¨
â”‚       â””â”€â”€ æ ·å¼éƒ¨åˆ†ï¼šæä¾›å•†åˆ†ç»„æ ·å¼
â”‚
â”œâ”€â”€ [ä¿®æ”¹æ–‡ä»¶] components/HomePage.vue
â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ä¿®æ”¹ï¼š
â”‚       â”œâ”€â”€ æ¨¡æ¿éƒ¨åˆ† [ä¿®æ”¹]ï¼š
â”‚       â”‚   â”œâ”€â”€ ç¬¬ 215-223 è¡Œï¼šæ›¿æ¢åŸç®€å•ä¸‹æ‹‰æ¡†
â”‚       â”‚   â””â”€â”€ æ–°å¢ï¼š<ModelSelector v-model="store.modelId" />
â”‚       â”œâ”€â”€ è„šæœ¬éƒ¨åˆ† [ä¿®æ”¹]ï¼š
â”‚       â”‚   â”œâ”€â”€ importsï¼šæ–°å¢ ModelSelector ç»„ä»¶
â”‚       â”‚   â”œâ”€â”€ data: ç¡®ä¿ modelId æ•°æ®ç»‘å®š
â”‚       â”‚   â”œâ”€â”€ methods.createNewBatch() - ä¿æŒé€»è¾‘
â”‚       â”‚   â”‚   â”œâ”€â”€ æ£€æŸ¥ modelId æ˜¯å¦é€‰æ‹©
â”‚       â”‚   â”‚   â””â”€â”€ éªŒè¯ modelId æ ¼å¼ï¼ˆproviderId.modelNameï¼‰
â”‚       â”‚   â””â”€â”€ methods.validateModelId() - [æ–°å¢]
â”‚       â””â”€â”€ æ ·å¼éƒ¨åˆ†ï¼šä¿æŒä¸å˜
â”‚
â”œâ”€â”€ [ä¿®æ”¹æ–‡ä»¶] components/TaskManagePage.vue
â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ä¿®æ”¹ï¼š
â”‚       â”œâ”€â”€ æ¨¡æ¿éƒ¨åˆ† [ä¿®æ”¹]ï¼š
â”‚       â”‚   â”œâ”€â”€ ç¬¬ 276-309 è¡Œï¼šä»»åŠ¡å¡ç‰‡ header åŒºåŸŸ
â”‚       â”‚   â”œâ”€â”€ åŸçŠ¶æ€æ ‡ç­¾ï¼š<span class="status-tag">{{ task.status }}</span>
â”‚       â”‚   â””â”€â”€ æ–°ç‰ˆæœ¬ï¼š
â”‚       â”‚   â”‚   â”œâ”€â”€ çŠ¶æ€æ ‡ç­¾ä¿æŒ
â”‚       â”‚   â”‚   â”œâ”€â”€ æ–°å¢ï¼šé”™è¯¯ä»£ç æ˜¾ç¤º <span v-if="task.errorType">{{ task.errorType }}</span>
â”‚       â”‚   â”‚   â””â”€â”€ æ–°å¢ï¼šæš‚åœæŒ‰é’® <button v-if="task.status === 'sending'">â¸ æš‚åœ</button>
â”‚       â”‚   â”œâ”€â”€ ç¬¬ 380-400 è¡Œï¼šè¿›åº¦æ¡æ˜¾ç¤º [ä¿®æ”¹]
â”‚       â”‚   â”‚   â”œâ”€â”€ åŸå§‹è¿›åº¦è®¡ç®—ï¼štask.progress
â”‚       â”‚   â”‚   â””â”€â”€ ä¿æŒä¸å˜ï¼ˆå·²ç”±åç«¯è®¡ç®—ï¼‰
â”‚       â”‚   â”œâ”€â”€ ç¬¬ 310-340 è¡Œï¼šæ–°å¢è¿›åº¦æ¡åŒºåŸŸï¼ˆä»»åŠ¡å¡ç‰‡å†…ï¼‰[æ–°å¢]
â”‚       â”‚   â”‚   â”œâ”€â”€ ä½ç½®ï¼šçŠ¶æ€æ ‡ç­¾ä¸‹æ–¹ã€åŸå†…å®¹ä¸Šæ–¹
â”‚       â”‚   â”‚   â”œâ”€â”€ æ˜¾ç¤ºæ¡ä»¶ï¼štask.status === 'sending' æˆ– task.status === 'waiting'
â”‚       â”‚   â”‚   â”œâ”€â”€ è¿›åº¦æ¡æ ·å¼ï¼š
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ ä½¿ç”¨ el-progress ç»„ä»¶
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ :percentage="task.progress"
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ :stroke-width="2"
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ é¢œè‰²æ ¹æ®çŠ¶æ€ï¼šsending='#409eff', waiting='#67c23a'
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ ä¸‹æ–¹æ˜¾ç¤ºï¼štask.replyTokens / task.predictedTokens tokens
â”‚       â”‚   â”‚   â””â”€â”€ å“åº”å¼æ›´æ–°ï¼šç›‘å¬ task.progress å˜åŒ–ï¼Œå®æ—¶åŒæ­¥æ˜¾ç¤º
â”‚       â”‚   â””â”€â”€ ç¬¬ 415-440 è¡Œï¼šä»»åŠ¡ç»Ÿè®¡åŒºåŸŸ [ä¿®æ”¹]
â”‚       â”‚   â”‚   â”œâ”€â”€ æ˜¾ç¤ºå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡æ•°
â”‚       â”‚   â”‚   â””â”€â”€ æ˜¾ç¤ºå„ç§çŠ¶æ€çš„ä»»åŠ¡ç»Ÿè®¡
â”‚       â”œâ”€â”€ è„šæœ¬éƒ¨åˆ† [ä¿®æ”¹]ï¼š
â”‚       â”‚   â”œâ”€â”€ data: æ–°å¢ selectedTaskId, threadDrawerVisible
â”‚       â”‚   â”œâ”€â”€ computed:
â”‚       â”‚   â”‚   â”œâ”€â”€ currentTask() - è·å–å½“å‰é€‰ä¸­ä»»åŠ¡ âœ… å·²æœ‰
â”‚       â”‚   â”‚   â””â”€â”€ taskStatistics() - ç»Ÿè®¡å„ç§çŠ¶æ€çš„ä»»åŠ¡æ•° [æ–°å¢]
â”‚       â”‚   â”œâ”€â”€ methods:
â”‚       â”‚   â”‚   â”œâ”€â”€ pauseTask(taskId) - [æ–°å¢]
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ è°ƒç”¨ IPC æ¥å£ï¼šipc-invoke('pause-task', taskId)
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ ä»»åŠ¡çŠ¶æ€å˜ä¸º 'paused'
â”‚       â”‚   â”‚   â”œâ”€â”€ onTaskClick(taskId) - [ä¿®æ”¹]
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ è®¾ç½® selectedTaskId
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ æ‰“å¼€ ThreadDrawerï¼ˆå·²æœ‰é€»è¾‘ï¼‰
â”‚       â”‚   â”‚   â”œâ”€â”€ onThreadDrawerClose() - [æ–°å¢]
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ é‡ç½® selectedTaskId
â”‚       â”‚   â”‚   â””â”€â”€ äº‹ä»¶ç›‘å¬ï¼šç›‘å¬ä»»åŠ¡çŠ¶æ€å˜åŒ–ï¼Œå®æ—¶æ›´æ–°åˆ—è¡¨
â”‚       â”‚   â””â”€â”€ onMounted: åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
â”‚       â””â”€â”€ æ ·å¼éƒ¨åˆ†ï¼š
â”‚           â”œâ”€â”€ .status-bar æ–°ç±»
â”‚           â”œâ”€â”€ .error-code æ–°ç±»ï¼ˆçº¢è‰²æ˜¾ç¤ºï¼‰
â”‚           â””â”€â”€ .btn-pause æ–°ç±»ï¼ˆé»„è‰²è­¦å‘Šè‰²ï¼‰
â”‚
â”‚       **è¯¦ç»†æ ·ä¾‹ä»£ç ï¼š**
â”‚       ```vue
â”‚       <!-- ä»»åŠ¡å¡ç‰‡å†…å®¹ç¤ºä¾‹ -->
â”‚       <div class="task-card">
â”‚         <!-- Headerï¼šçŠ¶æ€å’ŒæŒ‰é’® -->
â”‚         <div class="card-header">
â”‚           <div class="status-bar">
â”‚             <span class="status-tag" :class="task.status">
â”‚               {{ task.status }}
â”‚             </span>
â”‚             <span v-if="task.errorType" class="error-code">
â”‚               {{ task.errorType }}
â”‚             </span>
â”‚             <button v-if="task.status === 'sending'" class="btn-pause">
â”‚               â¸ æš‚åœ
â”‚             </button>
â”‚           </div>
â”‚         </div>
â”‚
â”‚         <!-- è¿›åº¦æ¡åŒºåŸŸï¼ˆä»»åŠ¡å¡ç‰‡å†…æ–°å¢ï¼‰[ä¼˜å…ˆçº§ 6]-->
â”‚         <div v-if="task.status === 'sending' || task.status === 'waiting'" class="progress-section">
â”‚           <el-progress
â”‚             :percentage="task.progress"
â”‚             :stroke-width="2"
â”‚             :color="task.status === 'sending' ? '#409eff' : '#67c23a'"
â”‚           ></el-progress>
â”‚           <div class="progress-info">
â”‚             {{ task.replyTokens }} / {{ task.predictedTokens }} tokens ({{ task.progress.toFixed(0) }}%)
â”‚           </div>
â”‚         </div>
â”‚
â”‚         <!-- åŸæœ‰å†…å®¹ -->
â”‚         <div class="card-content">
â”‚           <p class="task-content">{{ task.content }}</p>
â”‚         </div>
â”‚       </div>
â”‚       ```
â”‚
â”‚       **CSS æ ·å¼ï¼š**
â”‚       ```scss
â”‚       .progress-section {
â”‚         margin: 8px 0;
â”‚         padding: 8px 0;
â”‚         border-top: 1px solid #f0f0f0;
â”‚         border-bottom: 1px solid #f0f0f0;
â”‚
â”‚         :deep(.el-progress) {
â”‚           margin-bottom: 4px;
â”‚         }
â”‚
â”‚         .progress-info {
â”‚           font-size: 12px;
â”‚           color: #909399;
â”‚           text-align: right;
â”‚           margin-top: 4px;
â”‚         }
â”‚       }
â”‚       ```
â”‚
â”‚       **å“åº”å¼ç‰¹æ€§ï¼š**
â”‚       - âœ… å®æ—¶å“åº” task.progress çš„å˜åŒ–ï¼ˆ0-100ï¼‰
â”‚       - âœ… åŸºäºåç«¯è®¡ç®—çš„è¿›åº¦ï¼ˆpredictedTokens vs replyTokensï¼‰
â”‚       - âœ… é¢œè‰²åŒºåˆ†ï¼šsending è“è‰² / waiting ç»¿è‰²
â”‚       - âœ… è‡ªåŠ¨éšè—ï¼šä»»åŠ¡å®Œæˆæˆ–å¤±è´¥æ—¶æ¶ˆå¤±
â”‚
â”œâ”€â”€ [ä¿®æ”¹æ–‡ä»¶] components/ThreadDrawer.vue
â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ä¿®æ”¹ï¼š
â”‚       â”œâ”€â”€ æ¨¡æ¿éƒ¨åˆ† [ä¿®æ”¹]ï¼š
â”‚       â”‚   â”œâ”€â”€ ç¬¬ 28-79 è¡Œï¼šé…ç½®æ˜¾ç¤ºåŒºåŸŸ âœ… å·²æœ‰
â”‚       â”‚   â”‚   â”œâ”€â”€ æ¨¡å‹åç§°ï¼štask.metadata?.modelName
â”‚       â”‚   â”‚   â”œâ”€â”€ æä¾›å•†ï¼štask.metadata?.providerId
â”‚       â”‚   â”‚   â”œâ”€â”€ ç³»ç»Ÿæç¤ºè¯ï¼š<details> å±•å¼€æ˜¾ç¤º
â”‚       â”‚   â”‚   â”œâ”€â”€ åˆ†ç‰‡ç­–ç•¥ï¼štask.metadata?.chunkStrategy
â”‚       â”‚   â”‚   â”œâ”€â”€ åˆ†ç‰‡å¤§å°ï¼štask.metadata?.chunkSize
â”‚       â”‚   â”‚   â”œâ”€â”€ å¹¶å‘æ•°ï¼štask.metadata?.concurrency
â”‚       â”‚   â”‚   â”œâ”€â”€ æ¸©åº¦å‚æ•°ï¼štask.metadata?.temperature
â”‚       â”‚   â”‚   â”œâ”€â”€ æœ€å¤§ Tokenï¼štask.metadata?.maxTokens
â”‚       â”‚   â”‚   â””â”€â”€ å›å¤æ¨¡å¼ï¼štask.metadata?.replyMode
â”‚       â”‚   â”œâ”€â”€ ç¬¬ 80-120 è¡Œï¼šçŠ¶æ€ä¿¡æ¯åŒºåŸŸ [ä¿®æ”¹]
â”‚       â”‚   â”‚   â”œâ”€â”€ çŠ¶æ€æ ‡ç­¾ï¼štask.statusï¼ˆå½©è‰²æ¸²æŸ“ï¼‰
â”‚       â”‚   â”‚   â”œâ”€â”€ é”™è¯¯ä»£ç ï¼štask.errorType ï¼ˆçº¢è‰²æ˜¾ç¤ºï¼‰
â”‚       â”‚   â”‚   â”œâ”€â”€ é”™è¯¯æ¶ˆæ¯ï¼štask.errorMessage
â”‚       â”‚   â”‚   â”œâ”€â”€ é‡è¯•æ¬¡æ•°ï¼štask.retryCount
â”‚       â”‚   â”‚   â””â”€â”€ è¿›åº¦æ¡ï¼ˆå®æ—¶æ›´æ–°ï¼‰
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ :style="{ width: task.progress + '%' }"
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ æ˜¾ç¤ºç™¾åˆ†æ¯”æ–‡æœ¬
â”‚       â”‚   â”œâ”€â”€ ç¬¬ 121-180 è¡Œï¼šToken ç»Ÿè®¡åŒºåŸŸ [ä¿®æ”¹]
â”‚       â”‚   â”‚   â”œâ”€â”€ è¾“å…¥ Tokenï¼štask.inputTokens
â”‚       â”‚   â”‚   â”œâ”€â”€ è¾“å‡º Tokenï¼ˆå®é™…ï¼‰ï¼štask.replyTokens
â”‚       â”‚   â”‚   â”œâ”€â”€ è¾“å‡º Tokenï¼ˆé¢„æµ‹ï¼‰ï¼štask.predictedTokens
â”‚       â”‚   â”‚   â”œâ”€â”€ è¿›åº¦ç™¾åˆ†æ¯”ï¼š(task.replyTokens / task.predictedTokens * 100).toFixed(2)%
â”‚       â”‚   â”‚   â””â”€â”€ è´¹ç”¨ä¼°ç®—ï¼štask.cost
â”‚       â”‚   â”œâ”€â”€ ç¬¬ 181-250 è¡Œï¼šç¿»è¯‘ç»“æœåŒºåŸŸ [æ–°å¢]
â”‚       â”‚   â”‚   â”œâ”€â”€ åŸå§‹å†…å®¹ï¼štask.content
â”‚       â”‚   â”‚   â”œâ”€â”€ ç¿»è¯‘ç»“æœï¼štask.translation ï¼ˆå®æ—¶æ›´æ–°ï¼‰
â”‚       â”‚   â”‚   â””â”€â”€ æ—¶é—´æˆ³ä¿¡æ¯
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ å‘é€æ—¶é—´ï¼štask.sentTime
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ å®Œæˆæ—¶é—´ï¼štask.replyTime
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ è€—æ—¶ï¼štask.durationMs ms
â”‚       â”‚   â””â”€â”€ ç¬¬ 251-280 è¡Œï¼šæ“ä½œæŒ‰é’®åŒºåŸŸ [æ–°å¢]
â”‚       â”‚       â”œâ”€â”€ æš‚åœ/ç»§ç»­ æŒ‰é’®ï¼ˆæ¡ä»¶æ˜¾ç¤ºï¼‰
â”‚       â”‚       â”œâ”€â”€ é‡è¯• æŒ‰é’®ï¼ˆä»…é”™è¯¯çŠ¶æ€ï¼‰
â”‚       â”‚       â””â”€â”€ å…³é—­ æŒ‰é’®
â”‚       â”œâ”€â”€ è„šæœ¬éƒ¨åˆ† [ä¿®æ”¹]ï¼š
â”‚       â”‚   â”œâ”€â”€ props: task (Task interface)
â”‚       â”‚   â”œâ”€â”€ data: autoRefresh, refreshInterval
â”‚       â”‚   â”œâ”€â”€ computed:
â”‚       â”‚   â”‚   â”œâ”€â”€ taskProgress() - è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯” [æ–°å¢]
â”‚       â”‚   â”‚   â”œâ”€â”€ formattedStatus() - æ ¼å¼åŒ–çŠ¶æ€æ–‡æœ¬ [æ–°å¢]
â”‚       â”‚   â”‚   â””â”€â”€ costDisplay() - æ ¼å¼åŒ–è´¹ç”¨æ˜¾ç¤º [æ–°å¢]
â”‚       â”‚   â”œâ”€â”€ methods:
â”‚       â”‚   â”‚   â”œâ”€â”€ pauseTask() - [æ–°å¢] è°ƒç”¨æš‚åœæ¥å£
â”‚       â”‚   â”‚   â”œâ”€â”€ retryTask() - [æ–°å¢] è°ƒç”¨é‡è¯•æ¥å£
â”‚       â”‚   â”‚   â””â”€â”€ formatTime() - æ—¶é—´æ ¼å¼åŒ–è¾…åŠ©å‡½æ•° [æ–°å¢]
â”‚       â”‚   â”œâ”€â”€ watchers:
â”‚       â”‚   â”‚   â””â”€â”€ watch task.translation - å®æ—¶æ»šåŠ¨åˆ°åº•éƒ¨ [æ–°å¢]
â”‚       â”‚   â””â”€â”€ onMounted/onUnmounted: è‡ªåŠ¨åˆ·æ–°æ§åˆ¶ [æ–°å¢]
â”‚       â””â”€â”€ æ ·å¼éƒ¨åˆ†ï¼š
â”‚           â”œâ”€â”€ .config-section - é…ç½®åŒºåŸŸæ ·å¼
â”‚           â”œâ”€â”€ .status-section - çŠ¶æ€åŒºåŸŸæ ·å¼
â”‚           â”œâ”€â”€ .progress-bar - è¿›åº¦æ¡æ ·å¼ï¼ˆå¸¦åŠ¨ç”»ï¼‰
â”‚           â”œâ”€â”€ .translation-result - ç¿»è¯‘ç»“æœåŒºåŸŸæ ·å¼
â”‚           â””â”€â”€ .token-stats - Token ç»Ÿè®¡æ ·å¼
â”‚
â””â”€â”€ [ä¿®æ”¹æ–‡ä»¶] stores/translate.store.ts
    â””â”€â”€ å†…éƒ¨æ¨¡å—ä¿®æ”¹ï¼š
        â”œâ”€â”€ State [ä¿®æ”¹]ï¼š
        â”‚   â”œâ”€â”€ ç°æœ‰å­—æ®µä¿æŒä¸å˜
        â”‚   â”œâ”€â”€ æ–°å¢ï¼šenableRealTimeUpdateï¼ˆå®æ—¶æ›´æ–°å¼€å…³ï¼‰
        â”‚   â””â”€â”€ æ–°å¢ï¼štaskStateCacheï¼ˆä»»åŠ¡çŠ¶æ€ç¼“å­˜ï¼‰
        â”œâ”€â”€ Getters [ä¿®æ”¹]ï¼š
        â”‚   â”œâ”€â”€ ç°æœ‰ Getters ä¿æŒä¸å˜
        â”‚   â””â”€â”€ æ–°å¢ï¼šgetTaskState(taskId)
        â”œâ”€â”€ Actions [ä¿®æ”¹]ï¼š
        â”‚   â”œâ”€â”€ fetchTaskList() - ä¿æŒä¸å˜
        â”‚   â”œâ”€â”€ subscribeTaskUpdates() - [æ–°å¢]
        â”‚   â”‚   â”œâ”€â”€ è®¢é˜…åç«¯ä»»åŠ¡çŠ¶æ€å˜åŒ–äº‹ä»¶
        â”‚   â”‚   â”œâ”€â”€ å®æ—¶æ›´æ–° store ä¸­çš„ä»»åŠ¡çŠ¶æ€
        â”‚   â”‚   â””â”€â”€ è§¦å‘ UI å“åº”å¼æ›´æ–°
        â”‚   â”œâ”€â”€ pauseTask(taskId) - [æ–°å¢]
        â”‚   â”‚   â”œâ”€â”€ è°ƒç”¨åç«¯ IPCï¼šipc-invoke('pause-task', taskId)
        â”‚   â”‚   â”œâ”€â”€ æ›´æ–°æœ¬åœ°çŠ¶æ€
        â”‚   â”‚   â””â”€â”€ è¿”å›æˆåŠŸ/å¤±è´¥ç»“æœ
        â”‚   â””â”€â”€ unsubscribeTaskUpdates() - [æ–°å¢]
        â”‚       â””â”€â”€ æ¸…ç†äº‹ä»¶ç›‘å¬
        â””â”€â”€ Persistence å±‚ [ä¿®æ”¹]ï¼š
            â”œâ”€â”€ ç°æœ‰æŒä¹…åŒ–é€»è¾‘ä¿æŒä¸å˜
            â””â”€â”€ æ–°å¢ï¼šå®æ—¶æ¨é€äº‹ä»¶å¤„ç†
```

---

### **ç¬¬ä¸‰å±‚ï¼šå‰ç«¯ç±»å‹å®šä¹‰ä¿®æ”¹**

```
Nimbria/Client/GUI/DemoPage/LlmTranslate/types/
â”‚
â”œâ”€â”€ [ä¿®æ”¹æ–‡ä»¶] task.ts
â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ä¿®æ”¹ï¼š
â”‚       â”œâ”€â”€ Task æ¥å£ [æ‰©å±•]
â”‚       â”‚   â”œâ”€â”€ åŸæœ‰å­—æ®µä¿æŒ
â”‚       â”‚   â”œâ”€â”€ æ–°å¢å­—æ®µï¼šerrorType?: string ï¼ˆé”™è¯¯ç±»å‹ä»£ç ï¼‰
â”‚       â”‚   â”œâ”€â”€ æ–°å¢å­—æ®µï¼šerrorMessage?: string ï¼ˆé”™è¯¯ä¿¡æ¯ï¼‰
â”‚       â”‚   â”œâ”€â”€ æ–°å¢å­—æ®µï¼šretryCount: number ï¼ˆé‡è¯•æ¬¡æ•°ï¼‰
â”‚       â”‚   â”œâ”€â”€ æ–°å¢å­—æ®µï¼šmetadata?: TaskMetadata ï¼ˆä»»åŠ¡å…ƒæ•°æ®ï¼‰
â”‚       â”‚   â”œâ”€â”€ æ–°å¢å­—æ®µï¼šmetadataJson?: string ï¼ˆå…ƒæ•°æ® JSONï¼‰
â”‚       â”‚   â””â”€â”€ ä¿®æ”¹å­—æ®µï¼šstatus çš„ç±»å‹å€¼
â”‚       â””â”€â”€ TaskStatus ç±»å‹ [æ–°å¢]
â”‚           â”œâ”€â”€ 'unsent' - æœªå‘é€
â”‚           â”œâ”€â”€ 'waiting' - ç­‰å¾…ä¸­
â”‚           â”œâ”€â”€ 'sending' - å‘é€ä¸­
â”‚           â”œâ”€â”€ 'throttled' - é™æµ
â”‚           â”œâ”€â”€ 'completed' - å·²å®Œæˆ
â”‚           â”œâ”€â”€ 'error' - é”™è¯¯
â”‚           â””â”€â”€ 'paused' - å·²æš‚åœ
â”‚
â”œâ”€â”€ [æ–°å¢æ–‡ä»¶] model.ts
â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼š
â”‚       â”œâ”€â”€ ModelOption æ¥å£
â”‚       â”‚   â”œâ”€â”€ modelId: string ï¼ˆæ ¼å¼ï¼šproviderId.modelNameï¼‰
â”‚       â”‚   â”œâ”€â”€ modelName: string ï¼ˆæ˜¾ç¤ºåç§°ï¼‰
â”‚       â”‚   â”œâ”€â”€ providerId: string ï¼ˆæä¾›å•† IDï¼‰
â”‚       â”‚   â”œâ”€â”€ providerName: string ï¼ˆæä¾›å•†åç§°ï¼‰
â”‚       â”‚   â””â”€â”€ isActive: boolean ï¼ˆæ˜¯å¦å·²æ¿€æ´»ï¼‰
â”‚       â””â”€â”€ ModelGroup æ¥å£
â”‚           â”œâ”€â”€ providerId: string
â”‚           â”œâ”€â”€ providerName: string
â”‚           â””â”€â”€ models: ModelOption[]
â”‚
â”œâ”€â”€ [æ–°å¢æ–‡ä»¶] metadata.ts
â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼š
â”‚       â””â”€â”€ TaskMetadata æ¥å£
â”‚           â”œâ”€â”€ modelId: string
â”‚           â”œâ”€â”€ modelName: string
â”‚           â”œâ”€â”€ providerId: string
â”‚           â”œâ”€â”€ systemPrompt: string
â”‚           â”œâ”€â”€ chunkStrategy: 'line' | 'token'
â”‚           â”œâ”€â”€ chunkSize: number
â”‚           â”œâ”€â”€ concurrency: number
â”‚           â”œâ”€â”€ replyMode: 'complete' | 'streaming'
â”‚           â”œâ”€â”€ temperature: number
â”‚           â”œâ”€â”€ maxTokens: number
â”‚           â””â”€â”€ [å…¶ä»–é…ç½®å­—æ®µ]
â”‚
â””â”€â”€ [ä¿®æ”¹æ–‡ä»¶] batch.ts
    â””â”€â”€ å†…éƒ¨æ¨¡å—ä¿®æ”¹ï¼š
        â”œâ”€â”€ Batch æ¥å£ [ä¿®æ”¹]
        â”‚   â”œâ”€â”€ åŸæœ‰å­—æ®µä¿æŒ
        â”‚   â”œâ”€â”€ configJson: string ä¿æŒ
        â”‚   â”œâ”€â”€ æ–°å¢å­—æ®µï¼šconfig?: BatchConfig ï¼ˆè§£æåçš„é…ç½®å¯¹è±¡ï¼‰
        â”‚   â””â”€â”€ [å…¶ä»–å­—æ®µ]
        â””â”€â”€ BatchConfig æ¥å£ [å·²å­˜åœ¨]
```

---

### **ç¬¬å››å±‚ï¼šåç«¯ IPC æ¶ˆæ¯å¤„ç†ä¿®æ”¹**

```
Nimbria/src-electron/ipc/main-renderer/
â”‚
â””â”€â”€ [ä¿®æ”¹æ–‡ä»¶] llm-translate-handlers.ts
    â””â”€â”€ å†…éƒ¨æ¨¡å—ä¿®æ”¹ï¼š
        â”œâ”€â”€ IPC Handler æ³¨å†Œ [ä¿®æ”¹]ï¼š
        â”‚   â”œâ”€â”€ ipcMain.handle('get-batches', ...) - ä¿æŒä¸å˜
        â”‚   â”œâ”€â”€ ipcMain.handle('get-tasks', ...) - ä¿æŒä¸å˜
        â”‚   â”œâ”€â”€ ipcMain.handle('submit-tasks', ...) - ä¿æŒä¸å˜
        â”‚   â”‚   â”œâ”€â”€ æ–°å¢ï¼šè°ƒç”¨ TaskStateManager.initializeTask()
        â”‚   â”‚   â””â”€â”€ æ–°å¢ï¼šå‘å‡ºä»»åŠ¡æäº¤äº‹ä»¶
        â”‚   â”œâ”€â”€ ipcMain.handle('pause-task', ...) - [æ–°å¢]
        â”‚   â”‚   â”œâ”€â”€ å‚æ•°ï¼štaskId
        â”‚   â”‚   â”œâ”€â”€ è°ƒç”¨ TaskStateManager.pauseTask(taskId)
        â”‚   â”‚   â”œâ”€â”€ æ›´æ–°æ•°æ®åº“ä»»åŠ¡çŠ¶æ€ä¸º 'paused'
        â”‚   â”‚   â””â”€â”€ è¿”å›æ“ä½œç»“æœ
        â”‚   â”œâ”€â”€ ipcMain.handle('retry-task', ...) - [æ–°å¢]
        â”‚   â”‚   â”œâ”€â”€ å‚æ•°ï¼štaskId
        â”‚   â”‚   â”œâ”€â”€ é‡ç½®ä»»åŠ¡çŠ¶æ€ä¸º 'waiting'
        â”‚   â”‚   â””â”€â”€ æ”¾å›ä»»åŠ¡é˜Ÿåˆ—
        â”‚   â””â”€â”€ ipcMain.on('task-state-changed', ...) - [æ–°å¢]
        â”‚       â”œâ”€â”€ æ¥æ”¶æ¥è‡ªåç«¯çš„ä»»åŠ¡çŠ¶æ€å˜åŒ–äº‹ä»¶
        â”‚       â””â”€â”€ è½¬å‘ç»™æ‰€æœ‰ renderer è¿›ç¨‹
        â”‚
        â””â”€â”€ äº‹ä»¶å¹¿æ’­ [æ–°å¢]ï¼š
            â”œâ”€â”€ mainWindow.webContents.send('task:state-changed', event)
            â”œâ”€â”€ mainWindow.webContents.send('task:progress-updated', event)
            â”œâ”€â”€ mainWindow.webContents.send('task:completed', event)
            â””â”€â”€ mainWindow.webContents.send('task:error-occurred', event)
```

---

### **ç¬¬äº”å±‚ï¼šæ•°æ®åº“ç±»å‹å’Œåˆå§‹åŒ–ä¿®æ”¹**

```
Nimbria/src-electron/types/LlmTranslate/
â”‚
â”œâ”€â”€ [ä¿®æ”¹æ–‡ä»¶] backend/index.ts
â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ä¿®æ”¹ï¼š
â”‚       â”œâ”€â”€ Task æ¥å£ [æ‰©å±•] âœ… å·²åœ¨è®¾è®¡æ–‡æ¡£ä¸­å®šä¹‰
â”‚       â”œâ”€â”€ TaskStatus ç±»å‹ [æ–°å¢] âœ… å·²åœ¨è®¾è®¡æ–‡æ¡£ä¸­å®šä¹‰
â”‚       â”œâ”€â”€ TaskMetadata æ¥å£ [æ–°å¢] âœ… å·²åœ¨è®¾è®¡æ–‡æ¡£ä¸­å®šä¹‰
â”‚       â”œâ”€â”€ Batch æ¥å£ - ä¿æŒä¸å˜
â”‚       â””â”€â”€ [å…¶ä»–ç±»å‹] - ä¿æŒä¸å˜
â”‚
â””â”€â”€ [ä¿®æ”¹æ–‡ä»¶] backend/database.ts
    â””â”€â”€ å†…éƒ¨æ¨¡å—ä¿®æ”¹ï¼š
        â”œâ”€â”€ initializeLlmTranslateSchema() - ä¿æŒä¸å˜ï¼ˆè¡¨å·²å­˜åœ¨ï¼‰
        â”œâ”€â”€ è¿ç§»è„šæœ¬ï¼ˆå¦‚éœ€ï¼‰ - æ·»åŠ æ–°å­—æ®µ
        â”‚   â”œâ”€â”€ è¿ç§»ï¼šALTER TABLE Llmtranslate_tasks ADD COLUMN error_type TEXT
        â”‚   â”œâ”€â”€ è¿ç§»ï¼šALTER TABLE Llmtranslate_tasks ADD COLUMN error_message TEXT
        â”‚   â”œâ”€â”€ è¿ç§»ï¼šALTER TABLE Llmtranslate_tasks ADD COLUMN retry_count INTEGER DEFAULT 0
        â”‚   â”œâ”€â”€ è¿ç§»ï¼šALTER TABLE Llmtranslate_tasks ADD COLUMN metadata_json TEXT
        â”‚   â””â”€â”€ [éªŒè¯æ‰€æœ‰å­—æ®µéƒ½å·²å­˜åœ¨]
        â””â”€â”€ å­—æ®µåˆ«åæ˜ å°„å·²å®Œæˆ âœ…
```

---

## ğŸ“‹ å®ç°ä¼˜å…ˆçº§å’Œä¾èµ–å…³ç³»

```
ä¼˜å…ˆçº§ 1: ModelSelector ç»„ä»¶ [å‰æï¼šæ— ]
  â””â”€ ä¼˜å…ˆçº§ 2: ThreadDrawer è¯¦æƒ…é¢æ¿å¢å¼º
      â””â”€ ä¼˜å…ˆçº§ 3: å¼‚å¸¸å¤„ç†ä¸çŠ¶æ€ç®¡ç†
          â”œâ”€ ä¼˜å…ˆçº§ 4: LlmTranslationClient
          â””â”€ ä¼˜å…ˆçº§ 5: TaskStateManager
              â”œâ”€ ä¼˜å…ˆçº§ 6: UI ç»„ä»¶è°ƒæ•´ï¼ˆä»»åŠ¡å¡ç‰‡ï¼‰
              â”œâ”€ ä¼˜å…ˆçº§ 7: äº‹ä»¶é©±åŠ¨é›†æˆ
              â””â”€ ä¼˜å…ˆçº§ 8: é€»è¾‘å®Œæ•´æ€§æ£€æŸ¥
```

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

- [x] å­—æ®µåˆ«åæ˜ å°„ä¿®å¤ï¼ˆ6 ä¸ª SQL æŸ¥è¯¢æ–¹æ³•ï¼‰
- [x] æ‰¹æ³¨æ–‡æ¡£å¤„ç†å’Œè®¾è®¡æ–‡æ¡£ç¼–å†™
- [x] æ–‡ä»¶æ¶æ„ä¿®æ”¹æ ‘è§„åˆ’

## â³ å¾…å®Œæˆçš„å·¥ä½œ

- [ ] ä¼˜å…ˆçº§ 1: ModelSelector.vue ç»„ä»¶å¼€å‘
- [ ] ä¼˜å…ˆçº§ 2: ThreadDrawer å¢å¼º
- [ ] ä¼˜å…ˆçº§ 3-8: æ ¸å¿ƒæœåŠ¡å’ŒçŠ¶æ€ç®¡ç†å¼€å‘

