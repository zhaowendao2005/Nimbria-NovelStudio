Boss，好的！让我先深入研究现有的 `llm-chat-service` 架构，然后为你设计两个新系统。

[6 tools called]

Boss，我已经深入研究了现有架构。现在为你提供**完整的设计方案**：

---

# 📋 **LLM Translation Client & Task State Manager 设计文档**

## 🎯 **设计目标**

### **1. LLM Translation Client（翻译专用客户端）**
- 🎯 **单一职责**：专注于单次翻译任务的发送和接收
- 🎯 **轻量化**：不维护对话历史，无状态设计
- 🎯 **流式优先**：实时反馈翻译进度
- 🎯 **错误恢复**：自动重试、限流处理

### **2. Task State Manager（任务状态管理器）**
- 🎯 **实时追踪**：监控每个任务的状态变化
- 🎯 **进度估算**：基于 Token 流式传输计算进度
- 🎯 **事件驱动**：通过 EventEmitter 广播状态变化
- 🎯 **持久化**：自动同步状态到数据库

---

## 📐 **系统架构设计**

```
┌─────────────────────────────────────────────────────────────┐
│              Translation Executor (调度层)                   │
│  ├─ 并发队列管理                                             │
│  ├─ 任务分配                                                 │
│  └─ 批次控制                                                 │
└──────────────────┬──────────────────────────────────────────┘
                   │
        ┌──────────┴──────────┐
        │                     │
        ▼                     ▼
┌──────────────────┐  ┌──────────────────────────────────┐
│ Task State       │  │ LLM Translation Client           │
│ Manager          │  │ (单例发送接收)                    │
│                  │  │                                  │
│ ├─ 状态追踪      │  │ ├─ 创建单次翻译会话              │
│ ├─ 进度计算      │  │ ├─ 发送翻译请求                  │
│ ├─ 事件发射      │◄─┤ ├─ 监听流式响应                  │
│ └─ 持久化        │  │ ├─ Token 计数                    │
└──────┬───────────┘  │ ├─ 错误处理 & 重试               │
       │              │ └─ 会话清理                      │
       │              └──────────────┬───────────────────┘
       │                             │
       │                             ▼
       │                    ┌────────────────────┐
       │                    │ LangChain Client   │
       │                    │ (底层 API 封装)    │
       │                    └────────────────────┘
       │
       ▼
┌──────────────────────────────────┐
│ SQLite Database                  │
│ ├─ Llmtranslate_tasks           │
│ │  ├─ status                    │
│ │  ├─ progress                  │
│ │  ├─ reply_tokens              │
│ │  └─ translation               │
│ └─ Llmtranslate_batches         │
└──────────────────────────────────┘
```

## 🔧 **核心组件设计**

### **优先级 1: 模型选择与 LLM 客户端集成**

#### **1.1 模型选择器实现（HomePage.vue）**

**需求分析：**
- 参照 `Nimbria\Client\GUI\components\ProjectPage.Shell\Navbar.content\LlmChat` 的模型选择设计
- 显示所有活跃提供商的已激活模型
- 按提供商分组展示
- 支持模型选择，保证后端能获取对应的 API Key 和 BaseUrl
- **类型约束：** 严格按照 `Document\Workflow\类型通用规范.md` 定义类型，禁止使用 `any`

**实现清单：**
- [ ] 创建 `LlmTranslate/components/ModelSelector.vue` 组件
- [ ] 从 `LlmConfigManager` 获取模型配置并提供给 `LlmTranslationClient`
- [ ] 添加 `ModelOption` 类型到 `Client/GUI/DemoPage/LlmTranslate/types/`

---

### **优先级 2: 实时任务状态显示与详情面板**

#### **2.1 线程详情面板增强（ThreadDrawer.vue）**

**需求分析：**
- 展示任务与 LLM 客户端交互的所有信息
- 实时显示任务状态（包含流式回复进度）
- 任务结束后显示完整的状态信息
- 提供数据库内信息查看，避免手动查看 SQLite
- **时序保证：** 参照 `Document\Workflow\事件驱动架构范式总结文档.md` 设计事件流
- **类型安全：** 严禁 `any`，参照 `Document\Workflow\类型通用规范.md`

**实现清单：**
- [ ] 扩展 ThreadDrawer 显示模型信息、系统提示词、分片策略等配置
- [ ] 实时显示流式回复内容和进度百分比
- [ ] 显示任务元数据（Token 计数、费用、耗时）

---

### **优先级 3: 异常处理与任务状态管理**

#### **3.1 错误处理与限流**

**需求分析：**
- HTTP 429（限流）→ 任务进入 `throttled` 状态
- 其他 HTTP 错误 → 任务进入 `error` 状态
- 显示位置：任务卡片状态标签右侧显示错误代码
- 参照位置：`#pane-tasks > div > div > div.main-content > div.task-list-area > div:nth-child(1) > div.card-header > div`

**实现清单：**
- [ ] `LlmTranslationClient` 区分错误类型（429 vs 其他）
- [ ] `TaskStateManager` 转换错误响应为对应状态
- [ ] `TaskManagePage.vue` 任务卡片添加错误代码显示

#### **3.2 任务暂停与异常恢复**

**需求分析：**
- 支持手动暂停正在发送的任务
- 暂停 = 更改任务状态 + 停止对该任务的跟踪
- 暂停视为错误处理（错误代码：USER_PAUSED）
- 应用启动时不应有进行中的任务，若存在则标记为 `error`
- Electron 关闭导致的任务中断 → `error` 状态
- **微调：** 进行中的任务卡片需要添加"暂停"按钮

**实现清单：**
- [ ] `TaskStateManager` 支持 `pauseTask()` 方法
- [ ] `TaskManagePage.vue` 进行中的任务卡片添加暂停按钮
- [ ] `llm-translate-service.ts` 启动时检查异常终止的任务
- [ ] 异常任务转为 `error` 状态并记录错误代码

---

### **优先级 4: LLM 翻译客户端核心实现**

#### **组件 4.1: LlmTranslationClient（翻译请求执行端）**

#### **文件位置**
```
Nimbria/src-electron/services/llm-translate-service/
├── llm-translation-client.ts    ← 新增（LLM 请求执行）
├── task-state-manager.ts        ← 新增（任务状态管理）
├── llm-translate-service.ts     ← 已有（服务编排）
└── translation-executor.ts      ← 已有（调度执行）
```

#### **4.1 LlmTranslationClient - 模块职责**

**单一职责：** 负责单次翻译请求的发送和流式接收

**核心功能：**
1. 从 `LlmConfigManager` 获取 API Key 和 BaseUrl
2. 使用 LangChain 调用 LLM API
3. 处理流式响应（token 级别的回复）
4. 管理超时和重试逻辑
5. 发出 Token 流事件供 TaskStateManager 消费

**关键设计点：**
- **流式 Token 事件** → EventEmitter 发出 `token-received` 事件
- **错误区分** → 429 限流 vs 其他错误
- **幂等性** → 支持任务重试时的幂等操作
- **超时控制** → 可配置的超时和重试次数

#### **4.2 TaskStateManager - 模块职责**

**单一职责：** 管理任务状态机和进度计算

**核心功能：**
1. **状态转移** → 根据 LLM 响应更新任务状态
2. **进度计算** → `received_tokens / predicted_tokens * 100%`
3. **事件广播** → 任务状态变化时发出事件
4. **错误记录** → 记录错误代码和错误信息
5. **数据持久化** → 同步状态到数据库

**状态机设计：**
```
waiting → sending → (流式接收) → completed
          ↓              ↓
      throttled ←→ error/paused
```

**事件类型：**
```typescript
- task-status-changed: { taskId, status, timestamp }
- task-progress-updated: { taskId, progress, receivedTokens }
- task-error-occurred: { taskId, errorCode, errorMessage }
- task-completed: { taskId, result }
```

---

### **优先级 5: 数据库字段与类型定义**

#### **5.1 Task 类型完整定义**

```typescript
// src-electron/types/LlmTranslate/backend/index.ts

export interface Task {
  // 标识符
  id: string
  batchId: string
  
  // 状态与进度
  status: TaskStatus // 'waiting' | 'sending' | 'throttled' | 'completed' | 'error' | 'paused'
  progress: number   // 0-100
  
  // 输入与输出
  content: string              // 原始内容
  translation: string | null   // 翻译结果
  
  // Token 统计
  inputTokens: number          // 输入 Token 数
  replyTokens: number          // 输出 Token 数（实际）
  predictedTokens: number      // 预测输出 Token 数
  
  // 时间戳
  sentTime: string | null      // 发送时间 ISO 8601
  replyTime: string | null     // 回复时间 ISO 8601
  durationMs: number           // 耗时（毫秒）
  
  // 错误处理
  errorMessage: string | null  // 错误消息
  errorType: string | null     // 错误类型（如 'THROTTLED', 'TIMEOUT', 'INVALID_KEY'）
  retryCount: number           // 重试次数
  
  // 费用与元数据
  cost: number                 // 估算费用
  metadata: TaskMetadata       // 任务元数据（包含模型信息、配置等）
  metadataJson: string         // 元数据 JSON 字符串（数据库存储）
  
  // 时间戳
  createdAt: string           // 创建时间 ISO 8601
  updatedAt: string           // 更新时间 ISO 8601
}

export type TaskStatus = 
  | 'waiting'      // 等待发送
  | 'sending'      // 发送中
  | 'throttled'    // 限流
  | 'completed'    // 完成
  | 'error'        // 错误
  | 'paused'       // 用户暂停

export interface TaskMetadata {
  modelId: string                        // 模型 ID
  modelName: string                      // 模型名称
  providerId: string                     // 提供商 ID
  systemPrompt: string                   // 系统提示词
  chunkStrategy: 'line' | 'token'        // 分片策略
  chunkSize: number                      // 分片大小
  concurrency: number                    // 并发数
  replyMode: 'complete' | 'streaming'   // 回复模式
  temperature: number                    // 温度参数
  maxTokens: number                      // 最大输出 Token
}
```

#### **5.2 数据库字段映射**

```sql
-- Llmtranslate_tasks 表
CREATE TABLE Llmtranslate_tasks (
  id TEXT PRIMARY KEY,
  batch_id TEXT NOT NULL,
  status TEXT NOT NULL,
  progress INTEGER DEFAULT 0,
  content TEXT NOT NULL,
  translation TEXT,
  input_tokens INTEGER DEFAULT 0,
  reply_tokens INTEGER DEFAULT 0,
  predicted_tokens INTEGER DEFAULT 0,
  sent_time TEXT,
  reply_time TEXT,
  duration_ms INTEGER DEFAULT 0,
  error_message TEXT,
  error_type TEXT,
  retry_count INTEGER DEFAULT 0,
  cost REAL DEFAULT 0,
  metadata_json TEXT,           -- ⭐ TaskMetadata JSON
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL
);

-- 字段别名映射（SQL AS 语句）
SELECT
  id,
  batch_id AS batchId,
  status,
      progress,
  content,
  translation,
  input_tokens AS inputTokens,
  reply_tokens AS replyTokens,
  predicted_tokens AS predictedTokens,
  sent_time AS sentTime,
  reply_time AS replyTime,
  duration_ms AS durationMs,
  error_message AS errorMessage,
  error_type AS errorType,
  retry_count AS retryCount,
  cost,
  metadata_json AS metadataJson,
  created_at AS createdAt,
  updated_at AS updatedAt
FROM Llmtranslate_tasks
```

---

### **优先级 6: 前端 UI 组件增强**

#### **6.1 TaskManagePage 任务卡片修改**

**修改位置：** `Nimbria\Client\GUI\DemoPage\LlmTranslate\components\TaskManagePage.vue`

**需要微调的地方：**
```vue
<!-- 原状态标签 -->
<span class="status-tag" :class="task.status">{{ task.status }}</span>

<!-- ↓ 修改为：添加错误代码和暂停按钮 -->
<div class="status-bar">
  <span class="status-tag" :class="task.status">
    {{ task.status }}
  </span>
  
  <!-- 错误代码显示 -->
  <span v-if="task.errorType" class="error-code">
    {{ task.errorType }}
  </span>
  
  <!-- 暂停按钮（仅在 sending 状态） -->
  <button 
    v-if="task.status === 'sending'"
    @click="pauseTask(task.id)"
    class="btn-pause"
  >
    ⏸ 暂停
  </button>
</div>
```

#### **6.2 ThreadDrawer 详情面板增强**

**修改位置：** `Nimbria\Client\GUI\DemoPage\LlmTranslate\components\ThreadDrawer.vue`

**需要展示的配置信息：**
```vue
<div class="config-section">
  <!-- 模型信息 -->
  <div class="config-item">
    <label>模型</label>
    <span>{{ task.metadata?.modelName }}</span>
  </div>
  
  <!-- 系统提示词（可展开） -->
  <div class="config-item">
    <label>系统提示词</label>
    <details>
      <summary>查看</summary>
      <p>{{ task.metadata?.systemPrompt }}</p>
    </details>
  </div>
  
  <!-- Token 统计 -->
  <div class="config-item">
    <label>Token 统计</label>
    <span>输入: {{ task.inputTokens }} | 输出: {{ task.replyTokens }} / {{ task.predictedTokens }}</span>
  </div>
  
  <!-- 进度条（实时更新） -->
  <div class="progress-bar">
    <div class="progress" :style="{ width: task.progress + '%' }"></div>
    <span class="progress-text">{{ task.progress }}%</span>
  </div>
  
  <!-- 流式回复内容（实时显示） -->
  <div class="reply-content">
    {{ task.translation }}
  </div>
</div>
```

---

### **优先级 7: 事件驱动流程设计**

**参照文档：** `Document\Workflow\事件驱动架构范式总结文档.md`

**事件流时序：**

```
┌─────────────────────────────────────────────────────────────┐
│ TranslationExecutor                                          │
│  │                                                            │
│  ├─ emit: task-start { taskId, content }                    │
│  │         ↓                                                 │
│  │  TaskStateManager: status = 'sending'                   │
│  │  ↓ update database                                       │
│  │  ↓ emit: task-status-changed                            │
│  │         ↓ notify UI                                      │
│  │                                                            │
│  └─ LlmTranslationClient.sendRequest()                      │
│      ├─ on('token-received') event                          │
│      │  ├─ TaskStateManager: progress += 1                  │
│      │  ├─ emit: task-progress-updated                      │
│      │  │    ↓ update database                              │
│      │  │    ↓ notify UI (real-time)                       │
│      │  └─ if (tokens === predicted) → completed          │
│      │                                                        │
│      ├─ on('error', 429)                                   │
│      │  ├─ TaskStateManager: status = 'throttled'          │
│      │  ├─ emit: task-status-changed                        │
│      │  └─ emit: task-error-occurred                        │
│      │                                                        │
│      └─ on('error', other)                                 │
│         ├─ TaskStateManager: status = 'error'              │
│         ├─ emit: task-status-changed                        │
│         ├─ emit: task-error-occurred                        │
│         └─ if retryCount < maxRetries → retry              │
└─────────────────────────────────────────────────────────────┘
```

---

### **优先级 8: 逻辑完整性检查清单**

根据用户 review 意见，以下是完整的逻辑检查清单：

- [ ] **启动时异常任务处理** → 启动时检查有无 'sending' 状态的任务，转为 'error'
- [ ] **暂停功能** → 用户可在任务卡片点击暂停，状态转为 'paused'，暂停视为错误处理
- [ ] **限流处理** → 429 状态码独立处理，进入 'throttled'，其他错误进入 'error'
- [ ] **错误代码显示** → 任务卡片状态标签右侧显示 errorType（错误代码）
- [ ] **关闭恢复** → Electron 意外关闭后，重启时将进行中的任务标记为 'error'
- [ ] **流式进度** → 基于 predictedTokens 和 replyTokens 实时计算进度百分比
- [ ] **元数据显示** → ThreadDrawer 完整显示任务的所有元数据（不使用 `any` 类型）
- [ ] **时序保证** → 所有事件按照事件驱动模式发出，保证前后端数据同步

---

## 🔗 **集成到 TranslationExecutor**

```typescript
// translation-executor.ts (修改版)

import { LlmTranslationClient } from './llm-translation-client'
import { TaskStateManager } from './task-state-manager'
import type { TranslationClientConfig, TranslationRequest } from './types'

export class TranslationExecutor {
  private llmTranslateService: LlmTranslateService
  private llmConfigManager: any
  private taskStateManager: TaskStateManager
  private taskQueues: Map<string, string[]> = new Map()
  private pausedBatches: Set<string> = new Set()
  private activeTaskCount: Map<string, number> = new Map()

  constructor(
    llmTranslateService: LlmTranslateService,
    llmConfigManager: any,
    taskStateManager: TaskStateManager
  ) {
    this.llmTranslateService = llmTranslateService
    this.llmConfigManager = llmConfigManager
    this.taskStateManager = taskStateManager
  }

  /**
   * 执行任务队列
   */
  async executeTasks(
    batchId: string,
    taskIds: string[],
    config: TranslateConfig,
    concurrency: number
  ): Promise<void> {
    this.taskQueues.set(batchId, [...taskIds])
    this.activeTaskCount.set(batchId, 0)

    console.log(`🎬 [TranslationExecutor] 开始执行批次 ${batchId}，共 ${taskIds.length} 个任务，并发: ${concurrency}`)

    // 启动并发 worker
    const workers: Promise<void>[] = []
    for (let i = 0; i < Math.min(concurrency, taskIds.length); i++) {
      workers.push(this.worker(batchId, config))
    }

    await Promise.all(workers)

    console.log(`✅ [TranslationExecutor] 批次 ${batchId} 执行完成`)

    // 清理批次状态
    this.taskStateManager.cleanupBatch(batchId)
  }

  /**
   * Worker 线程
   */
  private async worker(batchId: string, config: TranslateConfig): Promise<void> {
    while (true) {
      if (this.pausedBatches.has(batchId)) {
        break
      }

      const queue = this.taskQueues.get(batchId)
      if (!queue || queue.length === 0) {
        break
      }

      const taskId = queue.shift()
      if (!taskId) break

      await this.executeTask(batchId, taskId, config)
      await this.delay(1000 / config.concurrency * 60)
    }
  }

  /**
   * 执行单个任务（新版本）
   */
  private async executeTask(
    batchId: string,
    taskId: string,
    config: TranslateConfig
  ): Promise<void> {
    const projectDb = this.llmTranslateService.getProjectDatabase()
    if (!projectDb) return

    try {
      // 1. 获取任务信息
      const task = await this.llmTranslateService.getTask(taskId)
      if (!task) {
        throw new Error(`Task ${taskId} not found`)
      }

      // 2. 初始化任务状态
      this.taskStateManager.initializeTask(taskId, batchId, config.predictedTokens)

      // 3. 更新状态为 waiting
      await this.taskStateManager.updateState(taskId, 'waiting')

      // 4. 创建翻译客户端配置
      const clientConfig: TranslationClientConfig = {
        modelId: config.modelId,
        systemPrompt: config.systemPrompt,
        temperature: 0.7,
        maxTokens: config.predictedTokens,
        timeout: 30000,
        maxRetries: 3
      }

      // 5. 创建翻译客户端
      const client = new LlmTranslationClient(clientConfig, this.llmConfigManager)

      // 6. 构建翻译请求
      const request: TranslationRequest = {
        taskId,
        content: task.content,
        estimatedTokens: config.predictedTokens
      }

      // 7. 执行翻译（流式）
      const result = await client.translateStream(request, {
        onStart: (id) => {
          console.log(`🚀 [Executor] 任务 ${id} 开始翻译`)
        },
        onProgress: (id, chunk, tokens) => {
          // 更新进度
          this.taskStateManager.updateProgress(id, chunk, tokens)
        },
        onComplete: (id, res) => {
          console.log(`✅ [Executor] 任务 ${id} 翻译完成`)
        },
        onError: (id, error) => {
          console.error(`❌ [Executor] 任务 ${id} 翻译失败:`, error)
        }
      })

      // 8. 标记任务完成
      await this.taskStateManager.markComplete(taskId, {
        translation: result.translation,
        inputTokens: result.inputTokens,
        outputTokens: result.outputTokens,
        cost: result.cost,
        durationMs: result.durationMs
      })

      // 9. 更新批次统计
      await this.llmTranslateService.updateBatchStats(batchId)

    } catch (error) {
      const err = error as Error
      console.error(`❌ [Executor] 任务 ${taskId} 执行失败:`, err)

      // 标记任务错误
      await this.taskStateManager.markError(
        taskId,
        this.classifyError(err),
        err.message,
        0
      )

      // 更新批次统计
      await this.llmTranslateService.updateBatchStats(batchId)
    }
  }

  private classifyError(error: Error): string {
    const message = error.message.toLowerCase()
    if (message.includes('429')) return 'rate_limit'
    if (message.includes('timeout')) return 'timeout'
    if (message.includes('network')) return 'network'
    return 'unknown'
  }

  private delay(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms))
  }
}
```

---

## 📡 **事件流设计**

```
任务执行流程中的事件发射：

1. 任务开始
   ├─ TaskStateManager.emit('state:change', waiting)
   ├─ LlmTranslationClient.emit('translation:start')
   └─ LlmTranslateService.emit('task:submitted')

2. 流式进度 (每 100ms)
   ├─ LlmTranslationClient.emit('translation:progress', { chunk, tokens, progress })
   └─ TaskStateManager.emit('progress:update', { progress, currentTokens })

3. 任务完成
   ├─ LlmTranslationClient.emit('translation:complete', result)
   ├─ TaskStateManager.emit('state:change', completed)
   ├─ TaskStateManager.emit('task:complete', completionData)
   └─ LlmTranslateService.emit('task:complete')

4. 任务错误
   ├─ LlmTranslationClient.emit('translation:error', error)
   ├─ TaskStateManager.emit('state:change', error)
   └─ TaskStateManager.emit('task:error', errorData)
```

---

## 📊 **性能优化**

### **1. 进度更新节流**
- 最小间隔 100ms 发射一次进度事件
- 避免高频数据库写入

### **2. 内存缓存**
- TaskStateManager 使用 Map 缓存状态
- 快速读取，异步持久化

### **3. 轻量级客户端**
- LlmTranslationClient 任务完成后自动清理
- 不维护长期状态

### **4. 并发控制**
- Worker 模式限制并发数
- 防限流延迟策略

---

## 📦 **文件结构总览**

```
Nimbria/src-electron/services/llm-translate-service/
├── llm-translate-service.ts          # 主服务（已有）
├── translation-executor.ts           # 执行引擎（修改）
├── llm-translation-client.ts         # ⭐ 新增：翻译客户端
├── task-state-manager.ts             # ⭐ 新增：状态管理器
├── export-service.ts                 # 导出服务（已有）
└── types.ts                           # 类型定义（扩展）
```

## 📁 文件架构修改树

完整的开发流程分为 8 个优先级，涉及前后端共 15+ 个文件的修改和新增。下面是详细的修改清单：

### **第一层：新增核心服务模块**

```
Nimbria/src-electron/services/llm-translate-service/
│
├── [新增文件] llm-translation-client.ts
│   └── 内部模块：
│       ├── LlmTranslationClient 类
│       │   ├── constructor(config, llmConfigManager)
│       │   ├── translateStream(request, callbacks) - 流式翻译执行
│       │   ├── translate(request) - 非流式翻译执行
│       │   ├── initClient() - LangChain 客户端初始化
│       │   ├── getModelConfig(modelId) - 获取模型配置
│       │   ├── estimateTokens(text) - Token 快速估算
│       │   ├── countTokensAccurate(text) - Token 精确计算
│       │   ├── calculateCost(inputTokens, outputTokens) - 费用计算
│       │   └── classifyError(error) - 错误分类
│       └── 事件发射：translation:start, translation:progress, translation:complete, translation:error
│
├── [新增文件] task-state-manager.ts
│   └── 内部模块：
│       ├── TaskStateManager 类
│       │   ├── setProjectDatabase(db) - 绑定数据库
│       │   ├── initializeTask(taskId, batchId, estimatedTokens) - 初始化任务状态
│       │   ├── updateState(taskId, newStatus, additionalData) - 更新任务状态
│       │   ├── updateProgress(taskId, chunk, currentTokens) - 更新进度（节流）
│       │   ├── markComplete(taskId, result) - 标记任务完成
│       │   ├── markError(taskId, errorType, errorMessage, retryCount) - 标记任务错误
│       │   ├── pauseTask(taskId) - 暂停任务 [新增]
│       │   ├── getState(taskId) - 获取任务状态快照
│       │   ├── getBatchStates(batchId) - 获取批次所有任务状态
│       │   ├── cleanup(taskId) - 清理单个任务状态
│       │   ├── cleanupBatch(batchId) - 清理批次状态
│       │   ├── shouldEmitProgress(taskId) - 节流判断
│       │   ├── persistState(snapshot) - 状态持久化
│       │   ├── persistProgress(taskId, progress, currentTokens) - 进度持久化
│       │   ├── persistCompletion(taskId, result) - 完成结果持久化
│       │   └── persistError(taskId, errorType, errorMessage, retryCount) - 错误信息持久化
│       └── 事件发射：state:change, progress:update, task:complete, task:error
│
├── [修改文件] translation-executor.ts
│   └── 内部模块修改：
│       ├── TranslationExecutor 类 [修改]
│       │   ├── constructor() - 新增 taskStateManager 参数
│       │   ├── executeTasks() - 添加 TaskStateManager 初始化逻辑
│       │   ├── worker() - 添加任务暂停检查
│       │   └── executeTask() - [重构] 完全重写
│       │       ├── 步骤1：获取任务信息
│       │       ├── 步骤2：初始化任务状态（TaskStateManager）
│       │       ├── 步骤3：更新状态为 waiting
│       │       ├── 步骤4：创建 LlmTranslationClient 配置
│       │       ├── 步骤5：创建翻译客户端实例
│       │       ├── 步骤6：构建翻译请求
│       │       ├── 步骤7：执行翻译流（registerProgressHandler）
│       │       ├── 步骤8：标记任务完成（markComplete）
│       │       └── 步骤9：更新批次统计
│       └── 新增方法：classifyError()
│
├── [修改文件] llm-translate-service.ts
│   └── 内部模块修改：
│       ├── LlmTranslateService 类 [修改]
│       │   ├── initialize() - 新增：TaskStateManager 创建和初始化
│       │   ├── createBatch() - 保持不变（配置已包含在 metadata 中）
│       │   ├── getTasks() - [修改] 添加字段别名映射 ✅ 已完成
│       │   ├── getTask() - [修改] 添加字段别名映射 ✅ 已完成
│       │   ├── getBatches() - [修改] 添加字段别名映射 ✅ 已完成
│       │   ├── getBatch() - [修改] 添加字段别名映射 ✅ 已完成
│       │   ├── loadBatches() - [修改] 添加字段别名映射 ✅ 已完成
│       │   ├── handleTerminatedTasks() - [修改] 添加字段别名映射 ✅ 已完成
│       │   ├── handleRecoveryTasks() - [新增] 启动时异常任务恢复
│       │   │   ├── 查询所有 'sending' 状态的任务
│       │   │   ├── 将其转为 'error' 状态
│       │   │   └── 记录错误代码：'APP_CRASHED'
│       │   ├── pauseTask(taskId) - [新增] 暂停任务处理
│       │   ├── retryFailedTasks() - 新增或修改：集成 TaskStateManager
│       │   └── updateBatchStats() - 同步 TaskStateManager 数据到数据库
│       └── 新增属性：taskStateManager
│
├── [修改文件] types.ts
│   └── 内部模块修改：
│       ├── 导出已有类型：TranslationClientConfig, TranslationRequest, TranslationResult
│       ├── 导出已有类型：ErrorType, TranslationStreamCallbacks
│       ├── [新增] TaskStatus 类型
│       ├── [新增] TaskMetadata 接口
│       ├── [新增] Task 接口（扩展）
│       │   ├── 新增字段：errorType, errorMessage, retryCount
│       │   ├── 新增字段：metadata, metadataJson
│       │   └── 修改字段：status 的可选值
│       ├── [新增] TaskStateChangeEvent 接口
│       ├── [新增] TaskProgressUpdateEvent 接口
│       ├── [新增] TaskCompletionEvent 接口
│       └── [新增] TaskErrorEvent 接口
│
└── export-service.ts - 保持不变（逻辑不受影响）
```

---

### **第二层：前端主要页面和组件修改**

```
Nimbria/Client/GUI/DemoPage/LlmTranslate/
│
├── [新增文件] components/ModelSelector.vue
│   └── 内部模块：
│       ├── 模板部分：
│       │   ├── El-Select 下拉框（支持分组）
│       │   ├── 按提供商分组展示模型
│       │   └── 显示模型名称、提供商信息
│       ├── 脚本部分：
│       │   ├── props: modelId (v-model)
│       │   ├── data: providers 列表, selectedModel
│       │   ├── computed: groupedModels() - 按提供商分组
│       │   ├── methods:
│       │   │   ├── loadProviders() - 从 LlmConfigManager 获取
│       │   │   ├── onModelSelect(modelId) - 选择变更回调
│       │   │   └── getModelInfo(modelId) - 获取模型完整信息
│       │   └── onMounted: 初始化加载提供商列表
│       └── 样式部分：提供商分组样式
│
├── [修改文件] components/HomePage.vue
│   └── 内部模块修改：
│       ├── 模板部分 [修改]：
│       │   ├── 第 215-223 行：替换原简单下拉框
│       │   └── 新增：<ModelSelector v-model="store.modelId" />
│       ├── 脚本部分 [修改]：
│       │   ├── imports：新增 ModelSelector 组件
│       │   ├── data: 确保 modelId 数据绑定
│       │   ├── methods.createNewBatch() - 保持逻辑
│       │   │   ├── 检查 modelId 是否选择
│       │   │   └── 验证 modelId 格式（providerId.modelName）
│       │   └── methods.validateModelId() - [新增]
│       └── 样式部分：保持不变
│
├── [修改文件] components/TaskManagePage.vue
│   └── 内部模块修改：
│       ├── 模板部分 [修改]：
│       │   ├── 第 276-309 行：任务卡片 header 区域
│       │   ├── 原状态标签：<span class="status-tag">{{ task.status }}</span>
│       │   └── 新版本：
│       │   │   ├── 状态标签保持
│       │   │   ├── 新增：错误代码显示 <span v-if="task.errorType">{{ task.errorType }}</span>
│       │   │   └── 新增：暂停按钮 <button v-if="task.status === 'sending'">⏸ 暂停</button>
│       │   ├── 第 380-400 行：进度条显示 [修改]
│       │   │   ├── 原始进度计算：task.progress
│       │   │   └── 保持不变（已由后端计算）
│       │   ├── 第 310-340 行：新增进度条区域（任务卡片内）[新增]
│       │   │   ├── 位置：状态标签下方、原内容上方
│       │   │   ├── 显示条件：task.status === 'sending' 或 task.status === 'waiting'
│       │   │   ├── 进度条样式：
│       │   │   │   ├── 使用 el-progress 组件
│       │   │   │   ├── :percentage="task.progress"
│       │   │   │   ├── :stroke-width="2"
│       │   │   │   ├── 颜色根据状态：sending='#409eff', waiting='#67c23a'
│       │   │   │   └── 下方显示：task.replyTokens / task.predictedTokens tokens
│       │   │   └── 响应式更新：监听 task.progress 变化，实时同步显示
│       │   └── 第 415-440 行：任务统计区域 [修改]
│       │   │   ├── 显示当前正在执行的任务数
│       │   │   └── 显示各种状态的任务统计
│       ├── 脚本部分 [修改]：
│       │   ├── data: 新增 selectedTaskId, threadDrawerVisible
│       │   ├── computed:
│       │   │   ├── currentTask() - 获取当前选中任务 ✅ 已有
│       │   │   └── taskStatistics() - 统计各种状态的任务数 [新增]
│       │   ├── methods:
│       │   │   ├── pauseTask(taskId) - [新增]
│       │   │   │   ├── 调用 IPC 接口：ipc-invoke('pause-task', taskId)
│       │   │   │   ├── 显示确认对话框
│       │   │   │   └── 任务状态变为 'paused'
│       │   │   ├── onTaskClick(taskId) - [修改]
│       │   │   │   ├── 设置 selectedTaskId
│       │   │   │   └── 打开 ThreadDrawer（已有逻辑）
│       │   │   ├── onThreadDrawerClose() - [新增]
│       │   │   │   └── 重置 selectedTaskId
│       │   │   └── 事件监听：监听任务状态变化，实时更新列表
│       │   └── onMounted: 初始化事件监听
│       └── 样式部分：
│           ├── .status-bar 新类
│           ├── .error-code 新类（红色显示）
│           └── .btn-pause 新类（黄色警告色）
│
│       **详细样例代码：**
│       ```vue
│       <!-- 任务卡片内容示例 -->
│       <div class="task-card">
│         <!-- Header：状态和按钮 -->
│         <div class="card-header">
│           <div class="status-bar">
│             <span class="status-tag" :class="task.status">
│               {{ task.status }}
│             </span>
│             <span v-if="task.errorType" class="error-code">
│               {{ task.errorType }}
│             </span>
│             <button v-if="task.status === 'sending'" class="btn-pause">
│               ⏸ 暂停
│             </button>
│           </div>
│         </div>
│
│         <!-- 进度条区域（任务卡片内新增）[优先级 6]-->
│         <div v-if="task.status === 'sending' || task.status === 'waiting'" class="progress-section">
│           <el-progress
│             :percentage="task.progress"
│             :stroke-width="2"
│             :color="task.status === 'sending' ? '#409eff' : '#67c23a'"
│           ></el-progress>
│           <div class="progress-info">
│             {{ task.replyTokens }} / {{ task.predictedTokens }} tokens ({{ task.progress.toFixed(0) }}%)
│           </div>
│         </div>
│
│         <!-- 原有内容 -->
│         <div class="card-content">
│           <p class="task-content">{{ task.content }}</p>
│         </div>
│       </div>
│       ```
│
│       **CSS 样式：**
│       ```scss
│       .progress-section {
│         margin: 8px 0;
│         padding: 8px 0;
│         border-top: 1px solid #f0f0f0;
│         border-bottom: 1px solid #f0f0f0;
│
│         :deep(.el-progress) {
│           margin-bottom: 4px;
│         }
│
│         .progress-info {
│           font-size: 12px;
│           color: #909399;
│           text-align: right;
│           margin-top: 4px;
│         }
│       }
│       ```
│
│       **响应式特性：**
│       - ✅ 实时响应 task.progress 的变化（0-100）
│       - ✅ 基于后端计算的进度（predictedTokens vs replyTokens）
│       - ✅ 颜色区分：sending 蓝色 / waiting 绿色
│       - ✅ 自动隐藏：任务完成或失败时消失
│
├── [修改文件] components/ThreadDrawer.vue
│   └── 内部模块修改：
│       ├── 模板部分 [修改]：
│       │   ├── 第 28-79 行：配置显示区域 ✅ 已有
│       │   │   ├── 模型名称：task.metadata?.modelName
│       │   │   ├── 提供商：task.metadata?.providerId
│       │   │   ├── 系统提示词：<details> 展开显示
│       │   │   ├── 分片策略：task.metadata?.chunkStrategy
│       │   │   ├── 分片大小：task.metadata?.chunkSize
│       │   │   ├── 并发数：task.metadata?.concurrency
│       │   │   ├── 温度参数：task.metadata?.temperature
│       │   │   ├── 最大 Token：task.metadata?.maxTokens
│       │   │   └── 回复模式：task.metadata?.replyMode
│       │   ├── 第 80-120 行：状态信息区域 [修改]
│       │   │   ├── 状态标签：task.status（彩色渲染）
│       │   │   ├── 错误代码：task.errorType （红色显示）
│       │   │   ├── 错误消息：task.errorMessage
│       │   │   ├── 重试次数：task.retryCount
│       │   │   └── 进度条（实时更新）
│       │   │   │   ├── :style="{ width: task.progress + '%' }"
│       │   │   │   └── 显示百分比文本
│       │   ├── 第 121-180 行：Token 统计区域 [修改]
│       │   │   ├── 输入 Token：task.inputTokens
│       │   │   ├── 输出 Token（实际）：task.replyTokens
│       │   │   ├── 输出 Token（预测）：task.predictedTokens
│       │   │   ├── 进度百分比：(task.replyTokens / task.predictedTokens * 100).toFixed(2)%
│       │   │   └── 费用估算：task.cost
│       │   ├── 第 181-250 行：翻译结果区域 [新增]
│       │   │   ├── 原始内容：task.content
│       │   │   ├── 翻译结果：task.translation （实时更新）
│       │   │   └── 时间戳信息
│       │   │   │   ├── 发送时间：task.sentTime
│       │   │   │   ├── 完成时间：task.replyTime
│       │   │   │   └── 耗时：task.durationMs ms
│       │   └── 第 251-280 行：操作按钮区域 [新增]
│       │       ├── 暂停/继续 按钮（条件显示）
│       │       ├── 重试 按钮（仅错误状态）
│       │       └── 关闭 按钮
│       ├── 脚本部分 [修改]：
│       │   ├── props: task (Task interface)
│       │   ├── data: autoRefresh, refreshInterval
│       │   ├── computed:
│       │   │   ├── taskProgress() - 计算进度百分比 [新增]
│       │   │   ├── formattedStatus() - 格式化状态文本 [新增]
│       │   │   └── costDisplay() - 格式化费用显示 [新增]
│       │   ├── methods:
│       │   │   ├── pauseTask() - [新增] 调用暂停接口
│       │   │   ├── retryTask() - [新增] 调用重试接口
│       │   │   └── formatTime() - 时间格式化辅助函数 [新增]
│       │   ├── watchers:
│       │   │   └── watch task.translation - 实时滚动到底部 [新增]
│       │   └── onMounted/onUnmounted: 自动刷新控制 [新增]
│       └── 样式部分：
│           ├── .config-section - 配置区域样式
│           ├── .status-section - 状态区域样式
│           ├── .progress-bar - 进度条样式（带动画）
│           ├── .translation-result - 翻译结果区域样式
│           └── .token-stats - Token 统计样式
│
└── [修改文件] stores/translate.store.ts
    └── 内部模块修改：
        ├── State [修改]：
        │   ├── 现有字段保持不变
        │   ├── 新增：enableRealTimeUpdate（实时更新开关）
        │   └── 新增：taskStateCache（任务状态缓存）
        ├── Getters [修改]：
        │   ├── 现有 Getters 保持不变
        │   └── 新增：getTaskState(taskId)
        ├── Actions [修改]：
        │   ├── fetchTaskList() - 保持不变
        │   ├── subscribeTaskUpdates() - [新增]
        │   │   ├── 订阅后端任务状态变化事件
        │   │   ├── 实时更新 store 中的任务状态
        │   │   └── 触发 UI 响应式更新
        │   ├── pauseTask(taskId) - [新增]
        │   │   ├── 调用后端 IPC：ipc-invoke('pause-task', taskId)
        │   │   ├── 更新本地状态
        │   │   └── 返回成功/失败结果
        │   └── unsubscribeTaskUpdates() - [新增]
        │       └── 清理事件监听
        └── Persistence 层 [修改]：
            ├── 现有持久化逻辑保持不变
            └── 新增：实时推送事件处理
```

---

### **第三层：前端类型定义修改**

```
Nimbria/Client/GUI/DemoPage/LlmTranslate/types/
│
├── [修改文件] task.ts
│   └── 内部模块修改：
│       ├── Task 接口 [扩展]
│       │   ├── 原有字段保持
│       │   ├── 新增字段：errorType?: string （错误类型代码）
│       │   ├── 新增字段：errorMessage?: string （错误信息）
│       │   ├── 新增字段：retryCount: number （重试次数）
│       │   ├── 新增字段：metadata?: TaskMetadata （任务元数据）
│       │   ├── 新增字段：metadataJson?: string （元数据 JSON）
│       │   └── 修改字段：status 的类型值
│       └── TaskStatus 类型 [新增]
│           ├── 'unsent' - 未发送
│           ├── 'waiting' - 等待中
│           ├── 'sending' - 发送中
│           ├── 'throttled' - 限流
│           ├── 'completed' - 已完成
│           ├── 'error' - 错误
│           └── 'paused' - 已暂停
│
├── [新增文件] model.ts
│   └── 内部模块：
│       ├── ModelOption 接口
│       │   ├── modelId: string （格式：providerId.modelName）
│       │   ├── modelName: string （显示名称）
│       │   ├── providerId: string （提供商 ID）
│       │   ├── providerName: string （提供商名称）
│       │   └── isActive: boolean （是否已激活）
│       └── ModelGroup 接口
│           ├── providerId: string
│           ├── providerName: string
│           └── models: ModelOption[]
│
├── [新增文件] metadata.ts
│   └── 内部模块：
│       └── TaskMetadata 接口
│           ├── modelId: string
│           ├── modelName: string
│           ├── providerId: string
│           ├── systemPrompt: string
│           ├── chunkStrategy: 'line' | 'token'
│           ├── chunkSize: number
│           ├── concurrency: number
│           ├── replyMode: 'complete' | 'streaming'
│           ├── temperature: number
│           ├── maxTokens: number
│           └── [其他配置字段]
│
└── [修改文件] batch.ts
    └── 内部模块修改：
        ├── Batch 接口 [修改]
        │   ├── 原有字段保持
        │   ├── configJson: string 保持
        │   ├── 新增字段：config?: BatchConfig （解析后的配置对象）
        │   └── [其他字段]
        └── BatchConfig 接口 [已存在]
```

---

### **第四层：后端 IPC 消息处理修改**

```
Nimbria/src-electron/ipc/main-renderer/
│
└── [修改文件] llm-translate-handlers.ts
    └── 内部模块修改：
        ├── IPC Handler 注册 [修改]：
        │   ├── ipcMain.handle('get-batches', ...) - 保持不变
        │   ├── ipcMain.handle('get-tasks', ...) - 保持不变
        │   ├── ipcMain.handle('submit-tasks', ...) - 保持不变
        │   │   ├── 新增：调用 TaskStateManager.initializeTask()
        │   │   └── 新增：发出任务提交事件
        │   ├── ipcMain.handle('pause-task', ...) - [新增]
        │   │   ├── 参数：taskId
        │   │   ├── 调用 TaskStateManager.pauseTask(taskId)
        │   │   ├── 更新数据库任务状态为 'paused'
        │   │   └── 返回操作结果
        │   ├── ipcMain.handle('retry-task', ...) - [新增]
        │   │   ├── 参数：taskId
        │   │   ├── 重置任务状态为 'waiting'
        │   │   └── 放回任务队列
        │   └── ipcMain.on('task-state-changed', ...) - [新增]
        │       ├── 接收来自后端的任务状态变化事件
        │       └── 转发给所有 renderer 进程
        │
        └── 事件广播 [新增]：
            ├── mainWindow.webContents.send('task:state-changed', event)
            ├── mainWindow.webContents.send('task:progress-updated', event)
            ├── mainWindow.webContents.send('task:completed', event)
            └── mainWindow.webContents.send('task:error-occurred', event)
```

---

### **第五层：数据库类型和初始化修改**

```
Nimbria/src-electron/types/LlmTranslate/
│
├── [修改文件] backend/index.ts
│   └── 内部模块修改：
│       ├── Task 接口 [扩展] ✅ 已在设计文档中定义
│       ├── TaskStatus 类型 [新增] ✅ 已在设计文档中定义
│       ├── TaskMetadata 接口 [新增] ✅ 已在设计文档中定义
│       ├── Batch 接口 - 保持不变
│       └── [其他类型] - 保持不变
│
└── [修改文件] backend/database.ts
    └── 内部模块修改：
        ├── initializeLlmTranslateSchema() - 保持不变（表已存在）
        ├── 迁移脚本（如需） - 添加新字段
        │   ├── 迁移：ALTER TABLE Llmtranslate_tasks ADD COLUMN error_type TEXT
        │   ├── 迁移：ALTER TABLE Llmtranslate_tasks ADD COLUMN error_message TEXT
        │   ├── 迁移：ALTER TABLE Llmtranslate_tasks ADD COLUMN retry_count INTEGER DEFAULT 0
        │   ├── 迁移：ALTER TABLE Llmtranslate_tasks ADD COLUMN metadata_json TEXT
        │   └── [验证所有字段都已存在]
        └── 字段别名映射已完成 ✅
```

---

## 📋 实现优先级和依赖关系

```
优先级 1: ModelSelector 组件 [前提：无]
  └─ 优先级 2: ThreadDrawer 详情面板增强
      └─ 优先级 3: 异常处理与状态管理
          ├─ 优先级 4: LlmTranslationClient
          └─ 优先级 5: TaskStateManager
              ├─ 优先级 6: UI 组件调整（任务卡片）
              ├─ 优先级 7: 事件驱动集成
              └─ 优先级 8: 逻辑完整性检查
```

---

## ✅ 已完成的工作

- [x] 字段别名映射修复（6 个 SQL 查询方法）
- [x] 批注文档处理和设计文档编写
- [x] 文件架构修改树规划

## ⏳ 待完成的工作

- [ ] 优先级 1: ModelSelector.vue 组件开发
- [ ] 优先级 2: ThreadDrawer 增强
- [ ] 优先级 3-8: 核心服务和状态管理开发

