æˆ‘æ¥åˆ†æå“ªä¸ªæ–¹æ¡ˆæ”¹åŠ¨æœ€å°‘ï¼Œç„¶åæ±‡æ€»å®Œæ•´çš„è¡ŒåŠ¨è®¡åˆ’ã€‚

[7 tools called]

## ğŸ“Š **æ–¹æ¡ˆå¯¹æ¯”åˆ†æ**

### **æ–¹æ¡ˆ1ï¼šæ”¹å›åŸå§‹åç§°** âœ… **æ¨è**

æ”¹åŠ¨æ–‡ä»¶ï¼š2ä¸ª | æ”¹åŠ¨è¡Œæ•°ï¼š6è¡Œ

```typescript
// llm-translate-service.ts çº¿117-131
this.emit('task:progress', event)        // æ”¹è‡ª progress-updated
this.emit('task:complete', event)        // æ”¹è‡ª completed  
this.emit('task:error', event)           // æ”¹è‡ª error-occurred

// translate.store.ts çº¿542, 577
'llm-translate:task-progress'            // æ”¹è‡ª task-progress-updated
'llm-translate:task-error'               // æ”¹è‡ª task-error-occurred
// task-complete å·²ç»æ­£ç¡®ï¼Œä¸ç”¨æ”¹
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ”¹åŠ¨æœ€å°‘ï¼ˆ2ä¸ªæ–‡ä»¶ï¼Œ6è¡Œï¼‰
- âœ… é€»è¾‘æœ€æ¸…æ™°ï¼ˆæ¢å¤åŸè®¾è®¡ï¼‰
- âœ… å½±å“æœ€å°åŒ–
- âœ… ä¸IPCå¤„ç†å™¨ç°æœ‰è®¾è®¡ä¸€è‡´

---

### **æ–¹æ¡ˆ2ï¼šæ”¹IPCå¤„ç†å™¨åˆ°æ–°åç§°**

æ”¹åŠ¨æ–‡ä»¶ï¼š1ä¸ª | æ”¹åŠ¨è¡Œæ•°ï¼š8è¡Œ

```typescript
// llm-translate-handlers.ts çº¿93, 99, 105
llmTranslateService.on('task:progress-updated', ...)
llmTranslateService.on('task:completed', ...)
llmTranslateService.on('task:error-occurred', ...)
// ä»¥åŠå¯¹åº”çš„sendè°ƒç”¨ä¹Ÿè¦æ”¹
```

**åŠ£åŠ¿**ï¼š
- âŒ IPCå¤„ç†å™¨é€»è¾‘å¤æ‚åŒ–
- âŒ æ–°åç§°ä¸åŸIPCè®¾è®¡ä¸ç¬¦
- âš ï¸ å‰ç«¯å·²ç»ç”¨äº†æ–°åç§°ï¼Œæ— æ³•å®Œå…¨åŒæ­¥

---

**âœ… é€‰æ‹©æ–¹æ¡ˆ1**ï¼ˆæ”¹å›åŸå§‹åç§°ï¼‰

---

## ğŸ¯ **å®Œæ•´è¡ŒåŠ¨è®¡åˆ’**

### **ç¬¬ä¸€éƒ¨åˆ†ï¼šäº‹ä»¶é“¾è·¯ä¿®å¤**

#### **P0-1: æ¢å¤äº‹ä»¶åç§°** (2ä¸ªæ–‡ä»¶ï¼Œ6è¡Œ)

**ä¿®æ”¹æ–‡ä»¶1**: `llm-translate-service.ts` çº¿117-131
```diff
- this.emit('task:progress-updated', event)
+ this.emit('task:progress', event)

- this.emit('task:completed', event)
+ this.emit('task:complete', event)

- this.emit('task:error-occurred', event)
+ this.emit('task:error', event)
```

**ä¿®æ”¹æ–‡ä»¶2**: `translate.store.ts` çº¿542, 577
```diff
- ;(window as any).nimbria.on('llm-translate:task-progress-updated', ...)
+ ;(window as any).nimbria.on('llm-translate:task-progress', ...)

- ;(window as any).nimbria.on('llm-translate:task-error-occurred', ...)
+ ;(window as any).nimbria.on('llm-translate:task-error', ...)
```

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… å‰ç«¯èƒ½æ”¶åˆ°è¿›åº¦æ›´æ–°
- âœ… å‰ç«¯èƒ½æ”¶åˆ°ä»»åŠ¡å®Œæˆ
- âœ… è°ƒåº¦å™¨èƒ½ç»§ç»­å¤„ç†ä¸‹ä¸€æ‰¹

---

### **ç¬¬äºŒéƒ¨åˆ†ï¼šä¸šåŠ¡é€»è¾‘ä¼˜åŒ–**

#### **P0-2: æµå¼å†™å…¥æ”¹æ•´ä½“å†™å…¥** (task-state-manager.ts)

**æ”¹åŠ¨**: ç§»é™¤ `updateProgress()` ä¸­çš„æ•°æ®åº“å†™å…¥

```typescript
// çº¿149ï¼šåˆ é™¤è¿™è¡Œ
// await this.persistProgress(taskId, progress, currentTokens, updated.translation || '')
```

**ç†ç”±**ï¼š
- æµå¼è¿›åº¦ä»…ç”¨äºUIæ˜¾ç¤ºï¼ˆé€šè¿‡äº‹ä»¶ï¼‰
- æœ€ç»ˆç»“æœåœ¨ `markComplete()` æ—¶ä¸€æ¬¡æ€§å†™å…¥
- å‡å°‘æ•°æ®åº“å†™å…¥é¢‘æ¬¡ï¼ˆä»æ•°ç™¾æ¬¡ â†’ 2-3æ¬¡ï¼‰
- å¦‚æœä»»åŠ¡ä¸­æ–­ï¼Œè¿›åº¦æ•°æ®è¢«erroræ•°æ®è¦†ç›–ï¼Œæ— éœ€ä¿ç•™

**ä¿®æ”¹ç‚¹**ï¼š
```typescript
async updateProgress(taskId, chunk, currentTokens) {
  const current = this.stateCache.get(taskId)
  if (!current) return

  // è®¡ç®—è¿›åº¦
  const progress = Math.min((currentTokens / current.estimatedTokens) * 100, 100)
  
  // âœ… åªæ›´æ–°å†…å­˜ç¼“å­˜
  this.stateCache.set(taskId, {
    ...current,
    progress,
    currentTokens,
    translation: (current.translation || '') + chunk
  })

  // âœ… èŠ‚æµå‘å°„UIäº‹ä»¶ï¼ˆä¿ç•™ï¼‰
  if (this.shouldEmitProgress(taskId)) {
    this.emit('progress:update', {...})
    this.progressUpdateThrottle.set(taskId, Date.now())
  }
  // âŒ åˆ é™¤: await this.persistProgress(...)
}
```

---

#### **P0-3: waiting çŠ¶æ€ä¿æŒä¸å˜**

**æ”¹åŠ¨**: `llm-translate-service.ts` çº¿197-233 `handleTerminatedTasks()`

```typescript
private async handleTerminatedTasks(): void {
  if (!this.projectDatabase) return

  const waitingTasks = this.projectDatabase.query(
    `SELECT ... FROM Llmtranslate_tasks WHERE status = 'waiting'`
  )

  if (waitingTasks.length > 0) {
    console.log(`âš ï¸ [LlmTranslateService] å‘ç° ${waitingTasks.length} ä¸ªç­‰å¾…ä¸­çš„ä»»åŠ¡ï¼Œä¿æŒçŠ¶æ€ä¸å˜`)
    // âœ… ä»€ä¹ˆéƒ½ä¸åšï¼Œè®©è¿™äº›ä»»åŠ¡ä¿ç•™ä¸º waiting çŠ¶æ€
    // ç”¨æˆ·é‡å¯åå¯ä»¥æ‰‹åŠ¨ç‚¹å‡»"å‘é€"é‡æ–°æäº¤ï¼Œæˆ–ç‚¹å‡»"å–æ¶ˆç­‰å¾…"æ”¹å› unsent
  }
}
```

**ç†ç”±**ï¼š
- waiting çŠ¶æ€è¡¨ç¤º"é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…å‘é€"
- ç¨‹åºé‡å¯åè¿™äº›ä»»åŠ¡ä¿ç•™ä¸º waitingï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ï¼š
  - ç»§ç»­å‘é€ï¼ˆç‚¹å‡»"å‘é€"æŒ‰é’®ï¼‰
  - å–æ¶ˆç­‰å¾…ï¼ˆç‚¹å‡»"å–æ¶ˆç­‰å¾…"æŒ‰é’®ï¼ŒçŠ¶æ€æ”¹å› unsentï¼‰
- ä¸éœ€è¦ç‰¹æ®Šæ ‡è®°æˆ– terminated çŠ¶æ€ï¼Œé€»è¾‘ç®€æ´æ¸…æ™°

---

#### **P0-4: sending â†’ errorï¼ˆå¼‚å¸¸é‡å¯ï¼‰**

**æ”¹åŠ¨**: `llm-translate-service.ts` çº¿243-277 `handleRecoveryTasks()`

```typescript
private async handleRecoveryTasks(): void {
  if (!this.projectDatabase) return

  const sendingTasks = this.projectDatabase.query(
    `SELECT ... FROM Llmtranslate_tasks WHERE status = 'sending'`
  )

  if (sendingTasks.length > 0) {
    console.log(`âš ï¸ [LlmTranslateService] å‘ç° ${sendingTasks.length} ä¸ªå¼‚å¸¸ä¸­æ­¢ä»»åŠ¡ï¼Œå·²æ ‡è®°ä¸º error`)
    
    // æ ‡è®°ä¸º errorï¼Œé”™è¯¯ç±»å‹ä¸º APP_CRASHED
    this.projectDatabase.execute(
      `UPDATE Llmtranslate_tasks 
       SET status = 'error', 
           error_type = 'APP_CRASHED',
           error_message = 'ç¨‹åºå¼‚å¸¸ä¸­æ­¢ï¼Œä»»åŠ¡æœªå®Œæˆã€‚è¯·æ£€æŸ¥APIæˆ–é‡æ–°å‘é€',
           updated_at = CURRENT_TIMESTAMP
       WHERE status = 'sending'`
    )
    
    // æ›´æ–°æ‰¹æ¬¡ç»Ÿè®¡
    const batchIds = new Set(sendingTasks.map(t => t.batchId))
    for (const batchId of batchIds) {
      await this.updateBatchStats(batchId)
    }
  }
}
```

**ç†ç”±**ï¼š
- `sending` çŠ¶æ€è¡¨ç¤º"æ­£åœ¨APIè°ƒç”¨ä¸­"
- å¦‚æœç¨‹åºå¼‚å¸¸é‡å¯ï¼Œè¿™äº›ä»»åŠ¡å¯èƒ½å·²éƒ¨åˆ†å¤„ç†æˆ–å®Œå…¨æœªå¤„ç†ï¼ŒçŠ¶æ€ä¸æ˜ç¡®
- æ ‡è®°ä¸º error å¹¶æ¸…æ™°æŒ‡å‡ºåŸå› ï¼Œç”¨æˆ·å¯ä»¥ï¼š
  - æ£€æŸ¥APIæ˜¯å¦æˆåŠŸå¤„ç†ï¼ˆæŸ¥çœ‹æ•°æ®åº“æˆ–APIæ—¥å¿—ï¼‰
  - å¦‚æœç¡®å®å¤±è´¥ï¼Œç‚¹å‡»"é‡è¯•"
  - å¦‚æœæˆåŠŸï¼Œæ‰‹åŠ¨æ ‡è®°ä¸ºå®Œæˆ

---

### **ç¬¬ä¸‰éƒ¨åˆ†ï¼šUIä¼˜åŒ–**

#### **P1: ç­‰å¾…ä¸­å¡ç‰‡ä¼˜åŒ–** (TaskManagePage.vue)

**æ”¹åŠ¨1**: ä¿®æ”¹ `.task-card.waiting` çš„èƒŒæ™¯è‰²ä¸ºæ©™é»„è‰²

```vue
<style scoped>
.task-card.waiting {
  background-color: #fef3c7;  /* æ©™é»„è‰² */
  border-color: #fcd34d;
}

.task-card.waiting:hover {
  background-color: #fde68a;
}
</style>
```

**æ”¹åŠ¨2**: æ·»åŠ "å–æ¶ˆç­‰å¾…"æŒ‰é’®

```vue
<template>
  <!-- åœ¨ waiting çŠ¶æ€çš„ä»»åŠ¡å¡ç‰‡ä¸­ -->
  <div v-if="task.status === 'waiting'" class="task-actions">
    <el-button 
      size="small" 
      type="warning"
      @click="handleCancelWaiting(task.id)"
    >
      å–æ¶ˆç­‰å¾…
    </el-button>
  </div>
</template>

<script setup>
// å–æ¶ˆç­‰å¾…ï¼šwaiting â†’ unsentï¼Œä»è°ƒåº¦é˜Ÿåˆ—ç§»é™¤
const handleCancelWaiting = async (taskId: string) => {
  try {
    // 1. è°ƒç”¨åç«¯APIå°†ä»»åŠ¡çŠ¶æ€æ”¹ä¸º unsent
    await window.nimbria.invoke('llm-translate:cancel-waiting-task', { taskId })
    
    // 2. æ›´æ–°æœ¬åœ°ä»»åŠ¡çŠ¶æ€
    const task = taskList.value.find(t => t.id === taskId)
    if (task) {
      task.status = 'unsent'
    }
    
    ElMessage.success('å·²å–æ¶ˆç­‰å¾…')
  } catch (error) {
    ElMessage.error('å–æ¶ˆå¤±è´¥')
  }
}
</script>
```

**åç«¯æ”¯æŒ** (llm-translate-service.ts æ–°å¢æ–¹æ³•):

```typescript
/**
 * å–æ¶ˆç­‰å¾…ä¸­çš„ä»»åŠ¡
 * å°† waiting â†’ unsentï¼Œä»è°ƒåº¦é˜Ÿåˆ—ç§»é™¤
 */
async cancelWaitingTask(taskId: string): Promise<void> {
  if (!this.projectDatabase) return
  
  // æ›´æ–°æ•°æ®åº“çŠ¶æ€
  this.projectDatabase.execute(
    `UPDATE Llmtranslate_tasks 
     SET status = 'unsent', updated_at = CURRENT_TIMESTAMP 
     WHERE id = ? AND status = 'waiting'`,
    [taskId]
  )
  
  // ä»è°ƒåº¦å™¨é˜Ÿåˆ—ä¸­ç§»é™¤ï¼ˆå¦‚æœè°ƒåº¦å™¨æ­£åœ¨è¿è¡Œï¼‰
  const task = await this.getTask(taskId)
  if (task) {
    const scheduler = this.schedulers.get(task.batchId)
    if (scheduler) {
      scheduler.removeTaskFromQueue(taskId)
    }
  }
  
  console.log(`âœ‚ï¸ [LlmTranslateService] ä»»åŠ¡ ${taskId} å·²å–æ¶ˆç­‰å¾…`)
}
```

**ç†ç”±**ï¼š
- waiting (æ©™é»„) â‰  sending (è“è‰²)ï¼Œè§†è§‰ä¸Šæ¸…æ™°åŒºåˆ†é˜Ÿåˆ—çŠ¶æ€å’Œæ‰§è¡ŒçŠ¶æ€
- ç”¨æˆ·å¯ä»¥çµæ´»æ§åˆ¶é˜Ÿåˆ—ï¼šå¦‚æœä¸æƒ³å‘é€æŸä¸ª waiting ä»»åŠ¡ï¼Œå¯ä»¥å–æ¶ˆå›åˆ° unsent
- é…åˆ P0-3 çš„è®¾è®¡ï¼Œç”¨æˆ·é‡å¯åå¯ä»¥é€‰æ‹©ç»§ç»­å‘é€æˆ–å–æ¶ˆç­‰å¾…

---

## ğŸ“‹ **æ‰§è¡Œæ¸…å•**

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | æ–‡ä»¶ | æ”¹åŠ¨ | é¢„æœŸæ•ˆæœ |
|--------|------|------|------|---------|
| ğŸ”´ P0 | æ¢å¤äº‹ä»¶åç§° | llm-translate-service.ts | 3è¡Œ | âœ… å‰ç«¯æ”¶åˆ°è¿›åº¦/å®Œæˆ/é”™è¯¯ |
| ğŸ”´ P0 | æ¢å¤äº‹ä»¶åç§° | translate.store.ts | 2è¡Œ | âœ… å‰ç«¯èƒ½ç›‘å¬åˆ°äº‹ä»¶ |
| ğŸ”´ P0 | æµå¼å†™å…¥æ”¹æ•´ä½“å†™å…¥ | task-state-manager.ts | -1è¡Œ | âœ… å‡å°‘DBå†™å…¥ï¼Œæ—¥å¿—æ¸…æ´ |
| ğŸ”´ P0 | waitingä¿æŒä¸å˜ | llm-translate-service.ts | åˆ é™¤é€»è¾‘ | âœ… ç®€åŒ–æ¢å¤æµç¨‹ |
| ğŸ”´ P0 | sendingæ”¹error | llm-translate-service.ts | +15è¡Œ | âœ… æ¸…æ™°è¡¨ç¤ºå¼‚å¸¸ä¸­æ­¢ |
| ğŸŸ¡ P1 | ç­‰å¾…ä¸­å¡ç‰‡ä¼˜åŒ– | TaskManagePage.vue + llm-translate-service.ts | æ–°å¢åŠŸèƒ½ | âœ… UIæ¸…æ™°+å–æ¶ˆç­‰å¾… |

---

## ğŸš€ **æ‰§è¡Œæ­¥éª¤**

### **Step 1: ä¿®å¤äº‹ä»¶é“¾è·¯** (ç«‹å³ä¿®å¤è°ƒåº¦å™¨é˜»å¡)
```bash
1. æ”¹ llm-translate-service.ts 3ä¸ªemit
2. æ”¹ translate.store.ts 2ä¸ªç›‘å¬
3. éªŒè¯ï¼šé‡å¯åè¿›åº¦æ¡åº”è¯¥åŠ¨äº†
```

### **Step 2: ä¼˜åŒ–æµå¼å†™å…¥** (å‡å°‘DBå‹åŠ›)
```bash
1. æ³¨é‡Š task-state-manager.ts çš„persistProgressè°ƒç”¨
2. éªŒè¯ï¼šæ—¥å¿—åº”è¯¥å¹²å‡€å¾—å¤š
```

### **Step 3: ç®€åŒ–å¼‚å¸¸å¤„ç†** (æ¸…æ™°çš„æ¢å¤æµç¨‹)
```bash
1. æ”¹ handleTerminatedTasks: åˆ é™¤æ‰€æœ‰å¤„ç†é€»è¾‘ï¼Œwaiting ä¿æŒä¸å˜
2. æ”¹ handleRecoveryTasks: sending â†’ error (APP_CRASHED)
3. éªŒè¯ï¼šé‡å¯æµ‹è¯•ï¼Œwaiting ä»»åŠ¡ä¿æŒåŸæ ·ï¼Œsending ä»»åŠ¡å˜ä¸º error
```

### **Step 4: UIæ”¹è¿› + å–æ¶ˆç­‰å¾…åŠŸèƒ½**
```bash
1. æ”¹ TaskManagePage.vue çš„ç­‰å¾…ä¸­å¡ç‰‡æ ·å¼ä¸ºæ©™é»„è‰²
2. æ·»åŠ "å–æ¶ˆç­‰å¾…"æŒ‰é’®ï¼ˆwaiting â†’ unsentï¼‰
3. å®ç°åç«¯ cancelWaitingTask æ–¹æ³•
4. æ·»åŠ  IPC handler: 'llm-translate:cancel-waiting-task'
5. éªŒè¯ï¼šç‚¹å‡»"å–æ¶ˆç­‰å¾…"ï¼Œä»»åŠ¡å›åˆ° unsent çŠ¶æ€
```

---

