# ğŸ“‹ Markdown è‡ªåŠ¨ä¿å­˜ç³»ç»Ÿæ€»ä½“è®¾è®¡

## ä¸€ã€ç³»ç»Ÿè®¾è®¡ç›®æ ‡

### æ ¸å¿ƒåŠŸèƒ½
1. **æ™ºèƒ½é˜²æŠ–ä¿å­˜**ï¼šç¼–è¾‘åœæ­¢ 2 ç§’åè‡ªåŠ¨ä¿å­˜
2. **æ‰¹é‡ä¿å­˜**ï¼šæ”¯æŒä¿å­˜æ‰€æœ‰æœªä¿å­˜æ ‡ç­¾é¡µ
3. **ä¿å­˜çŠ¶æ€ç®¡ç†**ï¼šå®æ—¶æ˜¾ç¤ºä¿å­˜è¿›åº¦å’ŒçŠ¶æ€
4. **é”™è¯¯æ¢å¤**ï¼šä¿å­˜å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•ï¼Œæ”¯æŒæœ¬åœ°ç¼“å­˜
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…é«˜é¢‘ I/Oï¼Œæ”¯æŒé˜Ÿåˆ—åŒ–ä¿å­˜

### è®¾è®¡åŸåˆ™
- **æ¸è¿›å¢å¼º**ï¼šåŸºç¡€åŠŸèƒ½ä¼˜å…ˆï¼Œé«˜çº§ç‰¹æ€§å¯é€‰
- **ç”¨æˆ·å¯æ§**ï¼šæ”¯æŒå¼€å¯/å…³é—­è‡ªåŠ¨ä¿å­˜
- **æ•°æ®å®‰å…¨**ï¼šåŸå­æ€§å†™å…¥ + å¤‡ä»½æœºåˆ¶
- **ç±»å‹å®‰å…¨**ï¼šå…¨é“¾è·¯ TypeScript æ”¯æŒ

---

## äºŒã€æ¶æ„åˆ†å±‚è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å‰ç«¯å±‚ (Client/)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ GUI/components/                             â”‚   â”‚
â”‚  â”‚  â””â”€â”€ AutoSaveIndicator.vue (ä¿å­˜çŠ¶æ€æŒ‡ç¤ºå™¨) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ stores/projectPage/Markdown/                â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ markdown.store.ts (çŠ¶æ€ç®¡ç†)           â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ markdown.autosave.ts (è‡ªåŠ¨ä¿å­˜é€»è¾‘) â­ â”‚   â”‚
â”‚  â”‚  â””â”€â”€ types.ts (ç±»å‹æ‰©å±•)                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ types/window.d.ts (API ç±»å‹å®šä¹‰æ‰©å±•)        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†• IPC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Preload å±‚ (src-electron/core/)            â”‚
â”‚  â””â”€â”€ project-preload.ts (æš´éœ²ä¿å­˜ API)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ä¸»è¿›ç¨‹å±‚ (src-electron/)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ services/markdown-service/ â­æ–°å¢           â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ markdown-scanner.ts (æ–‡ä»¶æ ‘æ‰«æ)       â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ markdown-reader.ts (æ–‡ä»¶è¯»å–)          â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ markdown-writer.ts (æ–‡ä»¶å†™å…¥) â­       â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ markdown-backup.ts (å¤‡ä»½ç®¡ç†) â­       â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ markdown-queue.ts (ä¿å­˜é˜Ÿåˆ—) â­        â”‚   â”‚
â”‚  â”‚  â””â”€â”€ types.ts (ç±»å‹å®šä¹‰)                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ipc/main-renderer/                          â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ channel-definitions.ts (é€šé“å®šä¹‰æ‰©å±•)  â”‚   â”‚
â”‚  â”‚  â””â”€â”€ ipc-handlers.ts (IPC å¤„ç†å™¨æ³¨å†Œ)       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€æ ¸å¿ƒæ¨¡å—è®¾è®¡

### æ¨¡å—1ï¼šå‰ç«¯è‡ªåŠ¨ä¿å­˜æ§åˆ¶å™¨

**æ–‡ä»¶**ï¼š`Client/stores/projectPage/Markdown/markdown.autosave.ts`

**èŒè´£**ï¼š
- é˜²æŠ–å®šæ—¶å™¨ç®¡ç†
- è‡ªåŠ¨ä¿å­˜ç­–ç•¥æ§åˆ¶
- ä¿å­˜é˜Ÿåˆ—åè°ƒ
- é”™è¯¯é‡è¯•é€»è¾‘

**æ ¸å¿ƒé€»è¾‘**ï¼š
```typescript
class AutoSaveController {
  private timers: Map<string, NodeJS.Timeout>
  private saveQueue: Set<string>
  private retryCount: Map<string, number>
  
  // ç¼–è¾‘è§¦å‘é˜²æŠ–
  scheduleAutoSave(tabId: string, delay: number)
  
  // æ‰§è¡Œä¿å­˜
  executeSave(tabId: string): Promise<SaveResult>
  
  // æ‰¹é‡ä¿å­˜
  saveAll(): Promise<BatchSaveResult>
  
  // é‡è¯•é€»è¾‘
  retrySave(tabId: string, maxRetries: number)
}
```

---

### æ¨¡å—2ï¼šåç«¯ä¿å­˜é˜Ÿåˆ—ç®¡ç†å™¨

**æ–‡ä»¶**ï¼š`src-electron/services/markdown-service/markdown-queue.ts`

**èŒè´£**ï¼š
- ç®¡ç†ä¿å­˜è¯·æ±‚é˜Ÿåˆ—
- é¿å…åŒæ—¶å†™å…¥åŒä¸€æ–‡ä»¶
- åˆå¹¶è¿ç»­çš„ä¿å­˜è¯·æ±‚
- ä¼˜å…ˆçº§è°ƒåº¦

**æ ¸å¿ƒé€»è¾‘**ï¼š
```typescript
class MarkdownSaveQueue {
  private queue: Map<string, SaveTask>
  private processing: Set<string>
  
  // æ·»åŠ ä¿å­˜ä»»åŠ¡
  enqueue(task: SaveTask): Promise<void>
  
  // å¤„ç†é˜Ÿåˆ—
  processQueue(): Promise<void>
  
  // åˆå¹¶é‡å¤ä»»åŠ¡
  mergeTasks(path: string): void
}
```

---

### æ¨¡å—3ï¼šå¤‡ä»½ç®¡ç†å™¨

**æ–‡ä»¶**ï¼š`src-electron/services/markdown-service/markdown-backup.ts`

**èŒè´£**ï¼š
- ä¿å­˜å‰è‡ªåŠ¨å¤‡ä»½
- ç®¡ç†å¤‡ä»½å†å²
- æ¸…ç†è¿‡æœŸå¤‡ä»½
- æ¢å¤å¤‡ä»½æ–‡ä»¶

**æ ¸å¿ƒé€»è¾‘**ï¼š
```typescript
class MarkdownBackup {
  // åˆ›å»ºå¤‡ä»½
  createBackup(filePath: string, content: string): Promise<string>
  
  // åˆ—å‡ºå†å²ç‰ˆæœ¬
  listBackups(filePath: string): Promise<BackupInfo[]>
  
  // æ¢å¤å¤‡ä»½
  restoreBackup(backupPath: string): Promise<void>
  
  // æ¸…ç†æ—§å¤‡ä»½
  cleanupOldBackups(filePath: string, keepCount: number)
}
```

---

## å››ã€æ•°æ®æµè®¾è®¡

### ä¿å­˜æµç¨‹æ—¶åºå›¾

```
ç”¨æˆ·ç¼–è¾‘ 
  â†’ Store.updateContent() 
  â†’ AutoSaveController.scheduleAutoSave()
  â†’ [ç­‰å¾… 2 ç§’é˜²æŠ–]
  â†’ AutoSaveController.executeSave()
  â†’ IPC: markdown:writeFile
  â†’ MarkdownQueue.enqueue()
  â†’ [æ£€æŸ¥é˜Ÿåˆ—]
  â†’ MarkdownBackup.createBackup() (å¯é€‰)
  â†’ MarkdownWriter.writeFile()
  â†’ [åŸå­æ€§å†™å…¥]
  â†’ è¿”å›ç»“æœ
  â†’ æ›´æ–°å‰ç«¯çŠ¶æ€ (isDirty = false)
```

---

## äº”ã€æ–‡ä»¶æ¶æ„ä¿®æ”¹æ ‘

```
Nimbria/
â”œâ”€â”€ Client/
â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â””â”€â”€ projectPage/
â”‚   â”‚       â””â”€â”€ Markdown/
â”‚   â”‚           â”œâ”€â”€ markdown.store.ts [ä¿®æ”¹å†…å®¹]
â”‚   â”‚           â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šé›†æˆ AutoSaveController
â”‚   â”‚           â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ autoSaveEnabled é…ç½®çŠ¶æ€
â”‚   â”‚           â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ saveProgress è¿›åº¦çŠ¶æ€
â”‚   â”‚           â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ batchSaveAllTabs æ–¹æ³•
â”‚   â”‚           â”œâ”€â”€ [æ–°å¢æ–‡ä»¶] markdown.autosave.ts
â”‚   â”‚           â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šAutoSaveController ç±»å®šä¹‰
â”‚   â”‚           â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šscheduleAutoSave é˜²æŠ–è°ƒåº¦é€»è¾‘
â”‚   â”‚           â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šexecuteSave ä¿å­˜æ‰§è¡Œé€»è¾‘
â”‚   â”‚           â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šretrySave é”™è¯¯é‡è¯•æœºåˆ¶
â”‚   â”‚           â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šsaveAll æ‰¹é‡ä¿å­˜é€»è¾‘
â”‚   â”‚           â”œâ”€â”€ types.ts [ä¿®æ”¹å†…å®¹]
â”‚   â”‚           â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ‰©å±• MarkdownTab æ¥å£ï¼ˆæ–°å¢ isSaving, saveError å­—æ®µï¼‰
â”‚   â”‚           â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ AutoSaveConfig æ¥å£å®šä¹‰
â”‚   â”‚           â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ SaveProgress æ¥å£å®šä¹‰
â”‚   â”‚           â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ SaveResult ç±»å‹å®šä¹‰
â”‚   â”‚           â””â”€â”€ index.ts [ä¿®æ”¹å†…å®¹]
â”‚   â”‚               â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šå¯¼å‡º markdown.autosave.ts æ¨¡å—
â”‚   â”œâ”€â”€ GUI/
â”‚   â”‚   â””â”€â”€ components/
â”‚   â”‚       â””â”€â”€ ProjectPage.MainPanel/
â”‚   â”‚           â”œâ”€â”€ [æ–°å¢ç›®å½•] AutoSave/
â”‚   â”‚           â”‚   â”œâ”€â”€ [æ–°å¢æ–‡ä»¶] AutoSaveIndicator.vue
â”‚   â”‚           â”‚   â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šä¿å­˜çŠ¶æ€å®æ—¶æ˜¾ç¤ºç»„ä»¶
â”‚   â”‚           â”‚   â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šä¿å­˜è¿›åº¦æ¡æ¸²æŸ“
â”‚   â”‚           â”‚   â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šé”™è¯¯æç¤º UI
â”‚   â”‚           â”‚   â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šè‡ªåŠ¨ä¿å­˜å¼€å…³æ§ä»¶
â”‚   â”‚           â”‚   â””â”€â”€ [æ–°å¢æ–‡ä»¶] SaveStatusBadge.vue
â”‚   â”‚           â”‚       â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šå•ä¸ªæ ‡ç­¾é¡µä¿å­˜çŠ¶æ€å¾½ç« 
â”‚   â”‚           â”‚       â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šisDirty / isSaving çŠ¶æ€æŒ‡ç¤º
â”‚   â”‚           â””â”€â”€ Markdown/
â”‚   â”‚               â”œâ”€â”€ MarkdownEditor.vue [ä¿®æ”¹å†…å®¹]
â”‚   â”‚               â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šé›†æˆ AutoSaveController.scheduleAutoSave()
â”‚   â”‚               â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šVditor input äº‹ä»¶è§¦å‘è‡ªåŠ¨ä¿å­˜
â”‚   â”‚               â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ˜¾ç¤ºä¿å­˜çŠ¶æ€æç¤º
â”‚   â”‚               â””â”€â”€ MarkdownTab.vue [ä¿®æ”¹å†…å®¹]
â”‚   â”‚                   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ˜¾ç¤º AutoSaveIndicator ç»„ä»¶
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ core/
â”‚           â””â”€â”€ window.d.ts [ä¿®æ”¹å†…å®¹]
â”‚               â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ‰©å±• window.nimbria.markdown æ¥å£
â”‚               â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ writeFile æ–¹æ³•ç±»å‹å®šä¹‰
â”‚               â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ batchWriteFiles æ–¹æ³•ç±»å‹å®šä¹‰
â”‚               â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ createBackup æ–¹æ³•ç±»å‹å®šä¹‰
â”œâ”€â”€ src-electron/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ [æ–°å¢ç›®å½•] markdown-service/
â”‚   â”‚       â”œâ”€â”€ [æ–°å¢æ–‡ä»¶] markdown-scanner.ts
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šscanMarkdownTree é€’å½’æ‰«ææ–‡ä»¶æ ‘
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šbuildFileTreeNode æ„å»ºæ ‘èŠ‚ç‚¹
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šfilterMarkdownFiles è¿‡æ»¤ .md æ–‡ä»¶
â”‚   â”‚       â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šgenerateFileId ç”Ÿæˆå”¯ä¸€ ID
â”‚   â”‚       â”œâ”€â”€ [æ–°å¢æ–‡ä»¶] markdown-reader.ts
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šreadMarkdownFile è¯»å–å•ä¸ªæ–‡ä»¶
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šparseFrontMatter è§£æå…ƒæ•°æ®
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šdetectEncoding æ£€æµ‹æ–‡ä»¶ç¼–ç 
â”‚   â”‚       â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šbatchReadFiles æ‰¹é‡è¯»å–
â”‚   â”‚       â”œâ”€â”€ [æ–°å¢æ–‡ä»¶] markdown-writer.ts
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šwriteMarkdownFile åŸå­æ€§å†™å…¥
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šbatchWriteFiles æ‰¹é‡å†™å…¥äº‹åŠ¡
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šverifyWrite å†™å…¥éªŒè¯
â”‚   â”‚       â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šrollbackWrite å†™å…¥å›æ»š
â”‚   â”‚       â”œâ”€â”€ [æ–°å¢æ–‡ä»¶] markdown-queue.ts
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šMarkdownSaveQueue ç±»å®šä¹‰
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šenqueue æ·»åŠ ä¿å­˜ä»»åŠ¡åˆ°é˜Ÿåˆ—
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šprocessQueue å¤„ç†é˜Ÿåˆ—é€»è¾‘
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šmergeTasks åˆå¹¶é‡å¤ä»»åŠ¡
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šprioritySchedule ä¼˜å…ˆçº§è°ƒåº¦
â”‚   â”‚       â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šacquireLock / releaseLock æ–‡ä»¶é”ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ [æ–°å¢æ–‡ä»¶] markdown-backup.ts
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šMarkdownBackup ç±»å®šä¹‰
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šcreateBackup åˆ›å»ºå¤‡ä»½å‰¯æœ¬
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šlistBackups åˆ—å‡ºå†å²ç‰ˆæœ¬
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šrestoreBackup æ¢å¤å¤‡ä»½
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šcleanupOldBackups æ¸…ç†è¿‡æœŸå¤‡ä»½
â”‚   â”‚       â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šgetBackupPath è®¡ç®—å¤‡ä»½è·¯å¾„
â”‚   â”‚       â”œâ”€â”€ [æ–°å¢æ–‡ä»¶] types.ts
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šMarkdownFile æ¥å£å®šä¹‰
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šMarkdownTreeOptions æ¥å£å®šä¹‰
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šSaveTask æ¥å£å®šä¹‰
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šSaveResult æ¥å£å®šä¹‰
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šBackupInfo æ¥å£å®šä¹‰
â”‚   â”‚       â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šFileOperationResult æ¥å£å®šä¹‰
â”‚   â”‚       â””â”€â”€ [æ–°å¢æ–‡ä»¶] index.ts
â”‚   â”‚           â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šå¯¼å‡ºæ‰€æœ‰ markdown-service æ¨¡å—
â”‚   â”‚           â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šåˆå§‹åŒ– MarkdownService å•ä¾‹
â”‚   â”œâ”€â”€ ipc/
â”‚   â”‚   â””â”€â”€ main-renderer/
â”‚   â”‚       â”œâ”€â”€ channel-definitions.ts [ä¿®æ”¹å†…å®¹]
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ MARKDOWN_SCAN_TREE é€šé“
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ MARKDOWN_READ_FILE é€šé“
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ MARKDOWN_WRITE_FILE é€šé“
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ MARKDOWN_BATCH_WRITE é€šé“
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ MARKDOWN_CREATE_BACKUP é€šé“
â”‚   â”‚       â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ MARKDOWN_LIST_BACKUPS é€šé“
â”‚   â”‚       â”œâ”€â”€ ipc-handlers.ts [ä¿®æ”¹å†…å®¹]
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ³¨å†Œ markdown:scanTree handler
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ³¨å†Œ markdown:readFile handler
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ³¨å†Œ markdown:writeFile handler
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ³¨å†Œ markdown:batchWrite handler
â”‚   â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ³¨å†Œ markdown:createBackup handler
â”‚   â”‚       â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šé›†æˆ MarkdownSaveQueue åˆ° handler
â”‚   â”‚       â””â”€â”€ types.ts [ä¿®æ”¹å†…å®¹]
â”‚   â”‚           â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ‰©å±• IPCRequest ç±»å‹ï¼ˆæ–°å¢ markdown ç›¸å…³è¯·æ±‚ï¼‰
â”‚   â”‚           â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ‰©å±• IPCResponse ç±»å‹ï¼ˆæ–°å¢ markdown ç›¸å…³å“åº”ï¼‰
â”‚   â””â”€â”€ core/
â”‚       â”œâ”€â”€ app-manager.ts [ä¿®æ”¹å†…å®¹]
â”‚       â”‚   â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šåˆå§‹åŒ– MarkdownService å®ä¾‹
â”‚       â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šåº”ç”¨é€€å‡ºæ—¶æ¸…ç†ä¿å­˜é˜Ÿåˆ—
â”‚       â””â”€â”€ project-preload.ts [ä¿®æ”¹å†…å®¹]
â”‚           â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæš´éœ² markdown.scanTree API
â”‚           â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæš´éœ² markdown.readFile API
â”‚           â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæš´éœ² markdown.writeFile API
â”‚           â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæš´éœ² markdown.batchWriteFiles API
â”‚           â”œâ”€â”€ å†…éƒ¨æ¨¡å—ï¼šæš´éœ² markdown.createBackup API
â”‚           â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæš´éœ² markdown.listBackups API
â””â”€â”€ package.json [ä¿®æ”¹å†…å®¹]
    â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ–°å¢ä¾èµ– chokidar (æ–‡ä»¶ç›‘è§†)ã€fast-glob (æ–‡ä»¶æ‰«æ)

é…ç½®æ–‡ä»¶ä¿®æ”¹:
â”œâ”€â”€ quasar.config.ts [ä¿®æ”¹å†…å®¹]
â”‚   â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ— ä¿®æ”¹ï¼ˆè·¯å¾„åˆ«åå·²å­˜åœ¨ï¼‰
â””â”€â”€ tsconfig.json [ä¿®æ”¹å†…å®¹]
    â””â”€â”€ å†…éƒ¨æ¨¡å—ï¼šæ— ä¿®æ”¹ï¼ˆç±»å‹é…ç½®å·²è¦†ç›–ï¼‰
```

---

## å…­ã€å…³é”®æŠ€æœ¯è®¾è®¡

### 1. é˜²æŠ–ç­–ç•¥

```typescript
// markdown.autosave.ts

export class AutoSaveController {
  private timers = new Map<string, NodeJS.Timeout>()
  private readonly DEFAULT_DELAY = 2000 // 2ç§’
  
  scheduleAutoSave(tabId: string, delay = this.DEFAULT_DELAY) {
    // æ¸…é™¤æ—§å®šæ—¶å™¨
    if (this.timers.has(tabId)) {
      clearTimeout(this.timers.get(tabId)!)
    }
    
    // è®¾ç½®æ–°å®šæ—¶å™¨
    const timer = setTimeout(() => {
      this.executeSave(tabId)
      this.timers.delete(tabId)
    }, delay)
    
    this.timers.set(tabId, timer)
  }
}
```

---

### 2. ä¿å­˜é˜Ÿåˆ—ç®¡ç†

```typescript
// markdown-queue.ts

export class MarkdownSaveQueue {
  private queue = new Map<string, SaveTask>()
  private processing = new Set<string>()
  private locks = new Map<string, boolean>()
  
  async enqueue(task: SaveTask): Promise<SaveResult> {
    // æ£€æŸ¥æ˜¯å¦æ­£åœ¨å¤„ç†åŒä¸€æ–‡ä»¶
    if (this.processing.has(task.filePath)) {
      // åˆå¹¶ä»»åŠ¡ï¼ˆä½¿ç”¨æœ€æ–°å†…å®¹ï¼‰
      this.queue.set(task.filePath, task)
      return { success: true, queued: true }
    }
    
    // ç«‹å³å¤„ç†
    this.processing.add(task.filePath)
    
    try {
      const result = await this.processTask(task)
      return result
    } finally {
      this.processing.delete(task.filePath)
      
      // æ£€æŸ¥æ˜¯å¦æœ‰åˆå¹¶çš„ä»»åŠ¡
      if (this.queue.has(task.filePath)) {
        const nextTask = this.queue.get(task.filePath)!
        this.queue.delete(task.filePath)
        await this.enqueue(nextTask)
      }
    }
  }
}
```

---

### 3. åŸå­æ€§å†™å…¥

```typescript
// markdown-writer.ts

export class MarkdownWriter {
  async writeMarkdownFile(
    filePath: string,
    content: string,
    options?: WriteOptions
  ): Promise<FileOperationResult> {
    const absolutePath = path.resolve(filePath)
    const tempPath = `${absolutePath}.tmp.${Date.now()}`
    const backupPath = options?.createBackup 
      ? `${absolutePath}.bak.${Date.now()}`
      : null
    
    try {
      // æ­¥éª¤1ï¼šå¤‡ä»½åŸæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
      if (backupPath && await fs.pathExists(absolutePath)) {
        await fs.copy(absolutePath, backupPath)
      }
      
      // æ­¥éª¤2ï¼šå†™å…¥ä¸´æ—¶æ–‡ä»¶
      await fs.writeFile(tempPath, content, 'utf-8')
      
      // æ­¥éª¤3ï¼šéªŒè¯å†™å…¥
      const written = await fs.readFile(tempPath, 'utf-8')
      if (written !== content) {
        throw new Error('Write verification failed')
      }
      
      // æ­¥éª¤4ï¼šåŸå­æ€§é‡å‘½å
      await fs.rename(tempPath, absolutePath)
      
      return { success: true }
      
    } catch (error) {
      // å›æ»šï¼šåˆ é™¤ä¸´æ—¶æ–‡ä»¶
      await fs.remove(tempPath).catch(() => {})
      
      // æ¢å¤å¤‡ä»½
      if (backupPath && await fs.pathExists(backupPath)) {
        await fs.copy(backupPath, absolutePath)
        await fs.remove(backupPath)
      }
      
      return { success: false, error: String(error) }
    }
  }
}
```

---

### 4. å¤‡ä»½ç®¡ç†

```typescript
// markdown-backup.ts

export class MarkdownBackup {
  private readonly BACKUP_DIR = '.nimbria-backups'
  private readonly MAX_BACKUPS = 10
  
  async createBackup(filePath: string): Promise<string> {
    const dir = path.dirname(filePath)
    const fileName = path.basename(filePath)
    const backupDir = path.join(dir, this.BACKUP_DIR)
    
    await fs.ensureDir(backupDir)
    
    const timestamp = Date.now()
    const backupFileName = `${fileName}.${timestamp}.bak`
    const backupPath = path.join(backupDir, backupFileName)
    
    await fs.copy(filePath, backupPath)
    
    // æ¸…ç†æ—§å¤‡ä»½
    await this.cleanupOldBackups(filePath)
    
    return backupPath
  }
  
  async cleanupOldBackups(filePath: string) {
    const backups = await this.listBackups(filePath)
    
    // æŒ‰æ—¶é—´å€’åºæ’åº
    backups.sort((a, b) => b.timestamp - a.timestamp)
    
    // åˆ é™¤è¶…å‡ºæ•°é‡çš„å¤‡ä»½
    for (const backup of backups.slice(this.MAX_BACKUPS)) {
      await fs.remove(backup.path)
    }
  }
}
```

---

### 5. é”™è¯¯é‡è¯•æœºåˆ¶

```typescript
// markdown.autosave.ts

export class AutoSaveController {
  private retryCount = new Map<string, number>()
  private readonly MAX_RETRIES = 3
  private readonly RETRY_DELAY = 1000 // 1ç§’
  
  async executeSave(tabId: string): Promise<SaveResult> {
    const tab = this.getTab(tabId)
    if (!tab || !tab.isDirty) {
      return { success: true, skipped: true }
    }
    
    try {
      const result = await window.nimbria.markdown.writeFile(
        tab.filePath,
        tab.content
      )
      
      if (result.success) {
        // é‡ç½®é‡è¯•è®¡æ•°
        this.retryCount.delete(tabId)
        return { success: true }
      } else {
        throw new Error(result.error)
      }
      
    } catch (error) {
      // è‡ªåŠ¨é‡è¯•
      const retries = this.retryCount.get(tabId) || 0
      
      if (retries < this.MAX_RETRIES) {
        this.retryCount.set(tabId, retries + 1)
        
        // æŒ‡æ•°é€€é¿
        const delay = this.RETRY_DELAY * Math.pow(2, retries)
        
        setTimeout(() => {
          this.executeSave(tabId)
        }, delay)
        
        return { 
          success: false, 
          error: String(error),
          retrying: true,
          retryCount: retries + 1
        }
      } else {
        // é‡è¯•è€—å°½
        this.retryCount.delete(tabId)
        
        return { 
          success: false, 
          error: String(error),
          retryExhausted: true
        }
      }
    }
  }
}
```

---

## ä¸ƒã€é…ç½®ä¸ç”¨æˆ·æ§åˆ¶

### å‰ç«¯é…ç½® Store

```typescript
// markdown.store.ts

export const useMarkdownStore = defineStore('projectPage-markdown', () => {
  // è‡ªåŠ¨ä¿å­˜é…ç½®
  const autoSaveConfig = ref<AutoSaveConfig>({
    enabled: true,           // æ˜¯å¦å¯ç”¨
    delay: 2000,             // é˜²æŠ–å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
    createBackup: true,      // æ˜¯å¦åˆ›å»ºå¤‡ä»½
    maxRetries: 3,           // æœ€å¤§é‡è¯•æ¬¡æ•°
    batchSaveOnClose: true   // å…³é—­æ—¶æ‰¹é‡ä¿å­˜
  })
  
  // ä¿å­˜çŠ¶æ€
  const saveProgress = ref<SaveProgress>({
    total: 0,      // æ€»ä»»åŠ¡æ•°
    completed: 0,  // å·²å®Œæˆæ•°
    failed: 0,     // å¤±è´¥æ•°
    inProgress: [] // è¿›è¡Œä¸­çš„ä»»åŠ¡
  })
  
  // åˆ‡æ¢è‡ªåŠ¨ä¿å­˜
  function toggleAutoSave(enabled: boolean) {
    autoSaveConfig.value.enabled = enabled
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('markdown-autosave-enabled', String(enabled))
  }
  
  return {
    autoSaveConfig,
    saveProgress,
    toggleAutoSave
  }
})
```

---

## å…«ã€UI ç»„ä»¶è®¾è®¡

### ä¿å­˜çŠ¶æ€æŒ‡ç¤ºå™¨

```vue
<!-- AutoSaveIndicator.vue -->

<template>
  <div class="autosave-indicator">
    <!-- è‡ªåŠ¨ä¿å­˜å¼€å…³ -->
    <q-toggle
      v-model="markdownStore.autoSaveConfig.enabled"
      label="è‡ªåŠ¨ä¿å­˜"
      dense
    />
    
    <!-- ä¿å­˜çŠ¶æ€æ˜¾ç¤º -->
    <div class="save-status">
      <template v-if="isSaving">
        <q-spinner size="16px" />
        <span>æ­£åœ¨ä¿å­˜...</span>
      </template>
      
      <template v-else-if="hasUnsaved">
        <q-icon name="circle" color="orange" size="12px" />
        <span>æœ‰æœªä¿å­˜ä¿®æ”¹</span>
      </template>
      
      <template v-else>
        <q-icon name="check_circle" color="positive" size="16px" />
        <span>å·²ä¿å­˜</span>
      </template>
    </div>
    
    <!-- æ‰¹é‡ä¿å­˜æŒ‰é’® -->
    <q-btn
      v-if="hasUnsaved"
      icon="save_all"
      label="å…¨éƒ¨ä¿å­˜"
      size="sm"
      @click="saveAll"
      :loading="isBatchSaving"
    />
  </div>
</template>
```

---

## ä¹ã€å®ç°ä¼˜å…ˆçº§

### P0ï¼ˆå¿…é¡»å®ç°ï¼‰
1. âœ… åŸºç¡€æ–‡ä»¶è¯»å†™ï¼ˆmarkdown-reader/writerï¼‰
2. âœ… IPC é€šé“å®šä¹‰ä¸æ³¨å†Œ
3. âœ… Preload API æš´éœ²
4. âœ… å‰ç«¯ Store é›†æˆ
5. âœ… é˜²æŠ–è‡ªåŠ¨ä¿å­˜é€»è¾‘

### P1ï¼ˆæ¨èå®ç°ï¼‰
6. âœ… ä¿å­˜é˜Ÿåˆ—ç®¡ç†ï¼ˆé¿å…å¹¶å‘å†²çªï¼‰
7. âœ… åŸå­æ€§å†™å…¥ä¿æŠ¤
8. âœ… é”™è¯¯é‡è¯•æœºåˆ¶
9. âœ… ä¿å­˜çŠ¶æ€ UI æŒ‡ç¤º

### P2ï¼ˆå¯é€‰å®ç°ï¼‰
10. âš ï¸ å¤‡ä»½å†å²ç®¡ç†
11. âš ï¸ æ‰¹é‡ä¿å­˜ä¼˜åŒ–
12. âš ï¸ ä¿å­˜æ€§èƒ½ç›‘æ§

---

## åã€å¼€å‘æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ |
|-----|------|---------|
| é˜¶æ®µ1 | ç±»å‹å®šä¹‰ + é€šé“å®šä¹‰ | 1-2 å°æ—¶ |
| é˜¶æ®µ2 | åç«¯æœåŠ¡å®ç°ï¼ˆreader/writer/queueï¼‰ | 4-5 å°æ—¶ |
| é˜¶æ®µ3 | IPC æ¡¥æ¥ + Preload æš´éœ² | 2-3 å°æ—¶ |
| é˜¶æ®µ4 | å‰ç«¯ Store æ”¹é€  + AutoSaveController | 3-4 å°æ—¶ |
| é˜¶æ®µ5 | UI ç»„ä»¶å¼€å‘ï¼ˆæŒ‡ç¤ºå™¨ã€çŠ¶æ€æ˜¾ç¤ºï¼‰ | 2-3 å°æ—¶ |
| é˜¶æ®µ6 | æµ‹è¯• + è°ƒè¯• | 2-3 å°æ—¶ |
| **æ€»è®¡** | | **14-20 å°æ—¶** |

