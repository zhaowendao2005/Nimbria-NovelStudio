# StarChart å¯è§†åŒ–è§†å›¾ Panel ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

**ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025-10-16  
**æ–‡æ¡£çŠ¶æ€**: å¾…å®ç°  
**åŸºäºå‚è€ƒ**: fcose-gene Cytoscape.js Demo

---

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

StarChart å¯è§†åŒ–è§†å›¾æ˜¯ä¸€ä¸ªåŸºäº Cytoscape.js çš„å›¾æ•°æ®åº“å¯è§†åŒ–é¢æ¿ï¼Œç”¨äºå±•ç¤ºå’Œç¼–è¾‘å°è¯´è®¾å®šä¸­çš„å®ä½“å…³ç³»å›¾ã€‚æ”¯æŒèŠ‚ç‚¹åˆ›å»ºã€è¿æ¥ç¼–è¾‘ã€å¸ƒå±€è°ƒæ•´ç­‰äº¤äº’åŠŸèƒ½ã€‚

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§

- **å›¾æ•°æ®å¯è§†åŒ–**: ä½¿ç”¨ Cytoscape.js æ¸²æŸ“èŠ‚ç‚¹å’Œè¾¹çš„å…³ç³»
- **fCoSE å¸ƒå±€ç®—æ³•**: åŠ›å¯¼å‘å¸ƒå±€ï¼Œè‡ªåŠ¨ä¼˜åŒ–èŠ‚ç‚¹ä½ç½®
- **äº¤äº’å¼ç¼–è¾‘**: æ”¯æŒèŠ‚ç‚¹æ‹–æ‹½ã€ç¼©æ”¾ã€å¹³ç§»
- **å›ºå®šé¡¶æ å·¥å…·**: æä¾›åˆ›å»ºã€å¸ƒå±€ã€å¯¼å‡ºç­‰å¿«æ·æ“ä½œ
- **å“åº”å¼è§†å£**: è§†å£é«˜åº¦è‡ªé€‚åº”çˆ¶å®¹å™¨
- **Mock ä¼˜å…ˆå¼€å‘**: ä½¿ç”¨ Mock æ•°æ®å¿«é€Ÿå¼€å‘ï¼ŒåæœŸå¯¹æ¥ StarChart æ•°æ®åº“

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### ç»„ä»¶å±‚æ¬¡ç»“æ„

```
NovelAgent Panel (WritingPanel.vue)
â””â”€â”€ åˆ†ç±»äºŒ: StarChart å¯è§†åŒ–è§†å›¾
    â””â”€â”€ StarChartPanel.vue (ä¸»å®¹å™¨)
        â”œâ”€â”€ StarChartTopBar.vue (å›ºå®šé¡¶æ )
        â”‚   â”œâ”€â”€ ä»‹ç»æ–‡æœ¬
        â”‚   â”œâ”€â”€ åˆ›å»ºè§†å›¾æŒ‰é’®
        â”‚   â”œâ”€â”€ å¸ƒå±€æ§åˆ¶
        â”‚   â””â”€â”€ å¯¼å‡ºå·¥å…·
        â””â”€â”€ StarChartViewport.vue (Cytoscape è§†å£)
            â”œâ”€â”€ Cytoscape å®ä¾‹
            â”œâ”€â”€ èŠ‚ç‚¹æ¸²æŸ“
            â””â”€â”€ è¾¹æ¸²æŸ“
```

### æ•°æ®æµæ¶æ„

```
Vueç»„ä»¶ â† useStarChartStore (Pinia Store)
           â†“
       DataSource (æŠ½è±¡å±‚)
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â†“             â†“
Mockæ•°æ®      StarChartæ•°æ®åº“
(å¼€å‘é˜¶æ®µ)    (ç”Ÿäº§ç¯å¢ƒ)
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

### å®Œæ•´æ–‡ä»¶æ¸…å•

```
Nimbria/Client/
â”œâ”€â”€ GUI/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ ProjectPage.MainPanel/
â”‚   â”‚       â””â”€â”€ StarChart/                          [æ–°å¢ç›®å½•]
â”‚   â”‚           â”œâ”€â”€ StarChartPanel.vue              [æ–°å¢] ä¸»å®¹å™¨
â”‚   â”‚           â”œâ”€â”€ StarChartTopBar.vue             [æ–°å¢] é¡¶æ å·¥å…·
â”‚   â”‚           â”œâ”€â”€ StarChartViewport.vue           [æ–°å¢] Cytoscape è§†å£
â”‚   â”‚           â”œâ”€â”€ StarChartNodeTooltip.vue        [æ–°å¢] èŠ‚ç‚¹æ‚¬æµ®æç¤º
â”‚   â”‚           â””â”€â”€ index.ts                        [æ–°å¢] ç»„ä»¶å¯¼å‡º
â”‚   â”‚
â”‚   â””â”€â”€ PagesLayout/
â”‚       â””â”€â”€ ProjectPage.Shell/
â”‚           â””â”€â”€ Navbar.content/
â”‚               â””â”€â”€ Writing/
â”‚                   â””â”€â”€ WritingPanel.vue            [ä¿®æ”¹] æ·»åŠ  StarChart å…¥å£
â”‚
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ projectPage/
â”‚       â””â”€â”€ starChart/                               [æ–°å¢ç›®å½•]
â”‚           â”œâ”€â”€ index.ts                             [æ–°å¢] ç»Ÿä¸€å¯¼å‡º + DataSource ç®¡ç†
â”‚           â”œâ”€â”€ starChart.store.ts                   [æ–°å¢] Store çŠ¶æ€ç®¡ç†
â”‚           â”œâ”€â”€ starChart.types.ts                   [æ–°å¢] ç±»å‹å®šä¹‰
â”‚           â”œâ”€â”€ data.mock.ts                         [æ–°å¢] Mock æ•°æ®
â”‚           â”œâ”€â”€ DataSource.ts                        [æ–°å¢] æ•°æ®æºæŠ½è±¡
â”‚           â””â”€â”€ logic.ts                             [æ–°å¢] ä¸šåŠ¡é€»è¾‘å°è£…
```

---

## ğŸ”§ æ ¸å¿ƒå®ç°

### Phase 1: ç±»å‹å®šä¹‰

#### `stores/projectPage/starChart/starChart.types.ts`

```typescript
/**
 * StarChart æ ¸å¿ƒç±»å‹å®šä¹‰
 */

// èŠ‚ç‚¹æ•°æ®ç»“æ„
export interface StarChartNode {
  id: string
  name: string
  type?: string          // èŠ‚ç‚¹ç±»å‹ (è§’è‰²/åœ°ç‚¹/äº‹ä»¶ç­‰)
  score?: number         // é‡è¦æ€§è¯„åˆ† (å½±å“èŠ‚ç‚¹å¤§å°)
  color?: string         // èŠ‚ç‚¹é¢œè‰²
  metadata?: Record<string, unknown>
}

// è¾¹æ•°æ®ç»“æ„
export interface StarChartEdge {
  id: string
  source: string         // æºèŠ‚ç‚¹ ID
  target: string         // ç›®æ ‡èŠ‚ç‚¹ ID
  weight?: number        // æƒé‡ (å½±å“è¾¹ç²—ç»†)
  type?: string          // å…³ç³»ç±»å‹
  label?: string         // è¾¹æ ‡ç­¾
  metadata?: Record<string, unknown>
}

// å›¾æ•°æ®ç»“æ„
export interface StarChartGraphData {
  nodes: StarChartNode[]
  edges: StarChartEdge[]
}

// Cytoscape å…ƒç´ ç±»å‹ (å…¼å®¹ Cytoscape.js æ ¼å¼)
export interface CytoscapeElement {
  data: {
    id: string
    name?: string
    source?: string
    target?: string
    weight?: number
    score?: number
    [key: string]: unknown
  }
  group?: 'nodes' | 'edges'
}

// å¸ƒå±€é…ç½®
export interface LayoutConfig {
  name: 'fcose' | 'grid' | 'circle' | 'cose'
  nodeRepulsion?: number
  idealEdgeLength?: number
  animate?: boolean
  randomize?: boolean
}

// è§†å›¾çŠ¶æ€
export interface ViewportState {
  zoom: number
  pan: { x: number; y: number }
}
```

---

### Phase 2: Mock æ•°æ®

#### `stores/projectPage/starChart/data.mock.ts`

```typescript
/**
 * StarChart Mock æ•°æ®
 * åŒ…å« 30 ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¹³å‡ 3-5 æ¡å…³ç³»
 * èŠ‚ç‚¹ç±»å‹ï¼šè§’è‰²ã€åœ°ç‚¹ã€äº‹ä»¶ã€ç‰©å“ç­‰
 */

import type { StarChartNode, StarChartEdge, StarChartGraphData } from './starChart.types'

// Mock èŠ‚ç‚¹æ•°æ® (30ä¸ª - å°è¯´è®¾å®šå…³ç³»ç½‘ç»œ)
export const mockNodes: StarChartNode[] = [
  // ä¸»è¦è§’è‰² (6ä¸ª)
  { id: 'char-1', name: 'å‡Œäº‘', type: 'protagonist', score: 0.95, color: '#ff6b6b' },
  { id: 'char-2', name: 'çƒŸé›¨', type: 'heroine', score: 0.9, color: '#f06595' },
  { id: 'char-3', name: 'é­”å°Š', type: 'antagonist', score: 0.88, color: '#5c7cfa' },
  { id: 'char-4', name: 'æ¸…é£ä¸Šäºº', type: 'mentor', score: 0.78, color: '#51cf66' },
  { id: 'char-5', name: 'å‰‘ç—´', type: 'supporting', score: 0.65, color: '#868e96' },
  { id: 'char-6', name: 'æœˆç´ä»™å­', type: 'supporting', score: 0.62, color: '#a78bfa' },
  
  // æ¬¡è¦è§’è‰² (8ä¸ª)
  { id: 'char-7', name: 'å¼ ä¸‰', type: 'supporting', score: 0.45, color: '#868e96' },
  { id: 'char-8', name: 'æå››', type: 'supporting', score: 0.42, color: '#868e96' },
  { id: 'char-9', name: 'ç‹äº”', type: 'supporting', score: 0.48, color: '#868e96' },
  { id: 'char-10', name: 'èµµå…­', type: 'antagonist_minor', score: 0.55, color: '#94d82d' },
  { id: 'char-11', name: 'å­™ä¸ƒ', type: 'supporting', score: 0.38, color: '#868e96' },
  { id: 'char-12', name: 'å‘¨å…«', type: 'supporting', score: 0.40, color: '#868e96' },
  { id: 'char-13', name: 'å´ä¹', type: 'supporting', score: 0.52, color: '#868e96' },
  { id: 'char-14', name: 'éƒ‘å', type: 'mentor', score: 0.58, color: '#51cf66' },
  
  // åœ°ç‚¹ (7ä¸ª)
  { id: 'place-1', name: 'å‡Œéœ„å®—', type: 'location', score: 0.75, color: '#ffd43b' },
  { id: 'place-2', name: 'é­”æ¸Šåœ°ç‹±', type: 'location', score: 0.72, color: '#fa5252' },
  { id: 'place-3', name: 'æ¸…é£å±±åº„', type: 'location', score: 0.65, color: '#ffd43b' },
  { id: 'place-4', name: 'ä»™ç•Œç§˜å¢ƒ', type: 'location', score: 0.68, color: '#ffd43b' },
  { id: 'place-5', name: 'ç¦åœ°é—è¿¹', type: 'location', score: 0.70, color: '#ff922b' },
  { id: 'place-6', name: 'è½æ—¥åŸ', type: 'location', score: 0.55, color: '#ffd43b' },
  { id: 'place-7', name: 'å¦–å…½æ£®æ—', type: 'location', score: 0.58, color: '#ffd43b' },
  
  // äº‹ä»¶ (5ä¸ª)
  { id: 'event-1', name: 'ç§˜å¢ƒå¼€å¯', type: 'event', score: 0.85, color: '#ff8787' },
  { id: 'event-2', name: 'å¤§æˆ˜å†³æˆ˜', type: 'event', score: 0.82, color: '#ff8787' },
  { id: 'event-3', name: 'å®—é—¨å†ç»ƒ', type: 'event', score: 0.60, color: '#ff8787' },
  { id: 'event-4', name: 'é­”æ—å…¥ä¾µ', type: 'event', score: 0.80, color: '#ff8787' },
  { id: 'event-5', name: 'æ¸¡åŠ«æˆä»™', type: 'event', score: 0.75, color: '#ff8787' },
  
  // ç‰©å“/åŠŸæ³• (4ä¸ª)
  { id: 'item-1', name: 'è¯›ä»™å‰‘', type: 'item', score: 0.70, color: '#74c0fc' },
  { id: 'item-2', name: 'æ··å…ƒåŠŸ', type: 'technique', score: 0.68, color: '#74c0fc' },
  { id: 'item-3', name: 'ä»™ç»ç§˜ç±', type: 'item', score: 0.55, color: '#74c0fc' },
  { id: 'item-4', name: 'ç ´é­”ç ', type: 'item', score: 0.62, color: '#74c0fc' }
]

// Mock è¾¹æ•°æ® (å…³ç³»ç½‘ç»œ - æ¯ä¸ªèŠ‚ç‚¹å¹³å‡3-5æ¡)
export const mockEdges: StarChartEdge[] = [
  // å‡Œäº‘å…³ç³» (5æ¡)
  { id: 'e1', source: 'char-1', target: 'char-2', weight: 0.95, type: 'love', label: 'çˆ±æƒ…' },
  { id: 'e2', source: 'char-1', target: 'char-3', weight: 0.90, type: 'conflict', label: 'å®¿æ•Œ' },
  { id: 'e3', source: 'char-1', target: 'char-4', weight: 0.80, type: 'mentor', label: 'å¸ˆå¾’' },
  { id: 'e4', source: 'char-1', target: 'place-1', weight: 0.75, type: 'location', label: 'å®—ä¸»' },
  { id: 'e5', source: 'char-1', target: 'item-1', weight: 0.70, type: 'possession', label: 'æŒæœ‰' },
  
  // çƒŸé›¨å…³ç³» (4æ¡)
  { id: 'e6', source: 'char-2', target: 'char-5', weight: 0.68, type: 'friendship', label: 'æœ‹å‹' },
  { id: 'e7', source: 'char-2', target: 'char-14', weight: 0.65, type: 'mentor', label: 'å¸ˆé•¿' },
  { id: 'e8', source: 'char-2', target: 'place-3', weight: 0.60, type: 'location', label: 'å‡ºèº«' },
  { id: 'e9', source: 'char-2', target: 'item-2', weight: 0.62, type: 'learn', label: 'ä¿®ç‚¼' },
  
  // é­”å°Šå…³ç³» (5æ¡)
  { id: 'e10', source: 'char-3', target: 'char-10', weight: 0.75, type: 'alliance', label: 'æ‰‹ä¸‹' },
  { id: 'e11', source: 'char-3', target: 'place-2', weight: 0.85, type: 'location', label: 'ç»Ÿæ²»' },
  { id: 'e12', source: 'char-3', target: 'event-4', weight: 0.80, type: 'participate', label: 'å‘èµ·' },
  { id: 'e13', source: 'char-3', target: 'event-1', weight: 0.70, type: 'conflict', label: 'å¯¹æŠ—' },
  { id: 'e14', source: 'char-3', target: 'item-4', weight: 0.65, type: 'possession', label: 'æŒæœ‰' },
  
  // æ¸…é£ä¸Šäººå…³ç³» (4æ¡)
  { id: 'e15', source: 'char-4', target: 'place-1', weight: 0.80, type: 'location', label: 'å®—å†…' },
  { id: 'e16', source: 'char-4', target: 'char-5', weight: 0.72, type: 'mentor', label: 'æ•™å¯¼' },
  { id: 'e17', source: 'char-4', target: 'item-2', weight: 0.70, type: 'teach', label: 'ä¼ æˆ' },
  { id: 'e18', source: 'char-4', target: 'event-1', weight: 0.68, type: 'participate', label: 'å‚ä¸' },
  
  // å‰‘ç—´å…³ç³» (3æ¡)
  { id: 'e19', source: 'char-5', target: 'item-1', weight: 0.75, type: 'obsession', label: 'ç—´è¿·' },
  { id: 'e20', source: 'char-5', target: 'event-2', weight: 0.72, type: 'participate', label: 'å‚æˆ˜' },
  { id: 'e21', source: 'char-5', target: 'char-13', weight: 0.55, type: 'friendship', label: 'æ—§è¯†' },
  
  // æœˆç´ä»™å­å…³ç³» (4æ¡)
  { id: 'e22', source: 'char-6', target: 'place-4', weight: 0.70, type: 'location', label: 'é©»åœ°' },
  { id: 'e23', source: 'char-6', target: 'event-2', weight: 0.68, type: 'participate', label: 'åŠ©æˆ˜' },
  { id: 'e24', source: 'char-6', target: 'char-2', weight: 0.62, type: 'friendship', label: 'çŸ¥å·±' },
  { id: 'e25', source: 'char-6', target: 'item-3', weight: 0.58, type: 'possession', label: 'æ”¶è—' },
  
  // èµµå…­å…³ç³» (3æ¡)
  { id: 'e26', source: 'char-10', target: 'place-2', weight: 0.72, type: 'location', label: 'é©»æ‰' },
  { id: 'e27', source: 'char-10', target: 'event-4', weight: 0.70, type: 'participate', label: 'å‚ä¸' },
  { id: 'e28', source: 'char-10', target: 'char-11', weight: 0.60, type: 'alliance', label: 'åŒå…š' },
  
  // éƒ‘åå…³ç³» (3æ¡)
  { id: 'e29', source: 'char-14', target: 'place-3', weight: 0.75, type: 'location', label: 'åˆ›å»º' },
  { id: 'e30', source: 'char-14', target: 'event-3', weight: 0.65, type: 'participate', label: 'ä¸»æŒ' },
  { id: 'e31', source: 'char-14', target: 'char-6', weight: 0.68, type: 'friendship', label: 'è‡³å‹' },
  
  // åœ°ç‚¹é—´å…³ç³» (3æ¡)
  { id: 'e32', source: 'place-1', target: 'place-3', weight: 0.55, type: 'neighbor', label: 'é‚»è¿‘' },
  { id: 'e33', source: 'place-2', target: 'place-5', weight: 0.65, type: 'connection', label: 'ç›¸è¿' },
  { id: 'e34', source: 'place-5', target: 'place-7', weight: 0.50, type: 'neighbor', label: 'æ¥å£¤' },
  
  // äº‹ä»¶é—´å…³ç³» (3æ¡)
  { id: 'e35', source: 'event-1', target: 'event-4', weight: 0.70, type: 'causality', label: 'å¼•å‘' },
  { id: 'e36', source: 'event-4', target: 'event-2', weight: 0.75, type: 'sequence', label: 'å¯¼è‡´' },
  { id: 'e37', source: 'event-2', target: 'event-5', weight: 0.68, type: 'consequence', label: 'æˆå°±' },
  
  // ç‰©å“ä½¿ç”¨å…³ç³» (3æ¡)
  { id: 'e38', source: 'item-1', target: 'item-4', weight: 0.60, type: 'combination', label: 'å¯ç»“åˆ' },
  { id: 'e39', source: 'item-2', target: 'event-1', weight: 0.65, type: 'requirement', label: 'éœ€è¦' },
  { id: 'e40', source: 'item-3', target: 'item-2', weight: 0.55, type: 'contain', label: 'è®°è½½' }
]

// Mock å®Œæ•´å›¾æ•°æ®
export const mockGraphData: StarChartGraphData = {
  nodes: mockNodes,
  edges: mockEdges
}

// è½¬æ¢ä¸º Cytoscape æ ¼å¼
export function convertToCytoscapeFormat(graphData: StarChartGraphData) {
  const nodes = graphData.nodes.map(node => ({
    data: {
      id: node.id,
      name: node.name,
      score: node.score || 0.5,
      type: node.type,
      color: node.color
    },
    group: 'nodes' as const
  }))

  const edges = graphData.edges.map(edge => ({
    data: {
      id: edge.id,
      source: edge.source,
      target: edge.target,
      weight: edge.weight || 0.5,
      type: edge.type,
      label: edge.label
    },
    group: 'edges' as const
  }))

  return [...nodes, ...edges]
}

// é»˜è®¤å¯¼å‡º
export default {
  mockGraphData,
  convertToCytoscapeFormat
}
```

---

### Phase 3: DataSource æŠ½è±¡å±‚

#### `stores/projectPage/starChart/DataSource.ts`

```typescript
/**
 * StarChart DataSource
 * è´Ÿè´£å†³å®šä½¿ç”¨ Mock æ•°æ®è¿˜æ˜¯çœŸå® StarChart æ•°æ®åº“
 */

import { Environment } from '@utils/environment'
import type { StarChartGraphData } from './starChart.types'
import { mockGraphData } from './data.mock'

export class StarChartDataSource {
  /**
   * åŠ è½½å›¾æ•°æ®
   */
  async loadGraphData(): Promise<StarChartGraphData> {
    if (Environment.shouldUseMock()) {
      console.log('[StarChart DataSource] ä½¿ç”¨ Mock æ•°æ®')
      return Promise.resolve(mockGraphData)
    }

    // Electron ç¯å¢ƒï¼šè°ƒç”¨ StarChart æ•°æ®åº“
    try {
      const result = await window.nimbria.starChart.getGraphData()
      if (result.success && result.data) {
        return result.data as StarChartGraphData
      }
      throw new Error(result.error || 'åŠ è½½å¤±è´¥')
    } catch (error) {
      console.error('[StarChart DataSource] åŠ è½½å¤±è´¥ï¼Œå›é€€åˆ° Mock:', error)
      return mockGraphData
    }
  }

  /**
   * ä¿å­˜å›¾æ•°æ®
   */
  async saveGraphData(data: StarChartGraphData): Promise<boolean> {
    if (Environment.shouldUseMock()) {
      console.log('[StarChart DataSource] Mock ä¿å­˜:', data)
      return Promise.resolve(true)
    }

    // Electron ç¯å¢ƒï¼šä¿å­˜åˆ° StarChart æ•°æ®åº“
    try {
      const result = await window.nimbria.starChart.saveGraphData(data)
      return result.success
    } catch (error) {
      console.error('[StarChart DataSource] ä¿å­˜å¤±è´¥:', error)
      return false
    }
  }

  /**
   * æ·»åŠ èŠ‚ç‚¹
   */
  async addNode(node: StarChartNode): Promise<boolean> {
    if (Environment.shouldUseMock()) {
      console.log('[StarChart DataSource] Mock æ·»åŠ èŠ‚ç‚¹:', node)
      mockGraphData.nodes.push(node)
      return Promise.resolve(true)
    }

    // Electron ç¯å¢ƒ
    try {
      const result = await window.nimbria.starChart.addNode(node)
      return result.success
    } catch (error) {
      console.error('[StarChart DataSource] æ·»åŠ èŠ‚ç‚¹å¤±è´¥:', error)
      return false
    }
  }
}

// å•ä¾‹å¯¼å‡º
export const starChartDataSource = new StarChartDataSource()
```

---

### Phase 4: Store çŠ¶æ€ç®¡ç†

#### `stores/projectPage/starChart/starChart.store.ts`

```typescript
/**
 * StarChart Store
 * è´Ÿè´£ä¸º Vue ç»„ä»¶æä¾›å“åº”å¼æ•°æ®
 */

import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import type { StarChartGraphData, LayoutConfig, ViewportState, StarChartNode } from './starChart.types'
import { starChartDataSource } from './DataSource'
import { convertToCytoscapeFormat } from './data.mock'
import type { CytoscapeElement } from './starChart.types'

export const useStarChartStore = defineStore('projectPage-starChart', () => {
  // ==================== çŠ¶æ€ ====================
  
  const graphData = ref<StarChartGraphData | null>(null)
  const cytoscapeElements = ref<CytoscapeElement[]>([])
  const layoutConfig = ref<LayoutConfig>({
    name: 'fcose',
    nodeRepulsion: 4500,
    idealEdgeLength: 1,
    animate: true,
    randomize: false
  })
  const viewportState = ref<ViewportState>({
    zoom: 1,
    pan: { x: 0, y: 0 }
  })
  
  const loading = ref<boolean>(false)
  const error = ref<string | null>(null)
  const initialized = ref<boolean>(false)
  
  // ==================== è®¡ç®—å±æ€§ ====================
  
  const hasData = computed(() => graphData.value !== null)
  const nodeCount = computed(() => graphData.value?.nodes.length || 0)
  const edgeCount = computed(() => graphData.value?.edges.length || 0)
  
  // ==================== æ–¹æ³• ====================
  
  /**
   * åˆå§‹åŒ–ï¼šåŠ è½½å›¾æ•°æ®
   */
  const initialize = async () => {
    if (initialized.value) {
      console.log('[StarChart Store] å·²åˆå§‹åŒ–ï¼Œè·³è¿‡')
      return
    }

    loading.value = true
    error.value = null
    
    try {
      const data = await starChartDataSource.loadGraphData()
      graphData.value = data
      cytoscapeElements.value = convertToCytoscapeFormat(data)
      initialized.value = true
      
      console.log('[StarChart Store] åˆå§‹åŒ–æˆåŠŸ:', {
        nodes: data.nodes.length,
        edges: data.edges.length
      })
    } catch (err) {
      const errorMsg = err instanceof Error ? err.message : 'åˆå§‹åŒ–å¤±è´¥'
      error.value = errorMsg
      console.error('[StarChart Store] åˆå§‹åŒ–å¤±è´¥:', err)
      throw err
    } finally {
      loading.value = false
    }
  }
  
  /**
   * æ·»åŠ èŠ‚ç‚¹
   */
  const addNode = async (node: StarChartNode) => {
    try {
      const success = await starChartDataSource.addNode(node)
      if (success && graphData.value) {
        graphData.value.nodes.push(node)
        cytoscapeElements.value = convertToCytoscapeFormat(graphData.value)
      }
      return success
    } catch (err) {
      console.error('[StarChart Store] æ·»åŠ èŠ‚ç‚¹å¤±è´¥:', err)
      return false
    }
  }
  
  /**
   * æ›´æ–°å¸ƒå±€é…ç½®
   */
  const updateLayout = (config: Partial<LayoutConfig>) => {
    layoutConfig.value = { ...layoutConfig.value, ...config }
  }
  
  /**
   * æ›´æ–°è§†å£çŠ¶æ€
   */
  const updateViewport = (state: Partial<ViewportState>) => {
    viewportState.value = { ...viewportState.value, ...state }
  }
  
  /**
   * é‡ç½®
   */
  const reset = () => {
    graphData.value = null
    cytoscapeElements.value = []
    initialized.value = false
    loading.value = false
    error.value = null
  }
  
  // ==================== è¿”å› ====================
  
  return {
    // çŠ¶æ€
    graphData,
    cytoscapeElements,
    layoutConfig,
    viewportState,
    loading,
    error,
    initialized,
    
    // è®¡ç®—å±æ€§
    hasData,
    nodeCount,
    edgeCount,
    
    // æ–¹æ³•
    initialize,
    addNode,
    updateLayout,
    updateViewport,
    reset
  }
})
```

---

### Phase 5: ç»„ä»¶å®ç°

#### `GUI/components/ProjectPage.MainPanel/StarChart/StarChartPanel.vue`

```vue
<template>
  <div class="starchart-panel">
    <!-- é¡¶æ å·¥å…· -->
    <StarChartTopBar 
      @create-view="handleCreateView"
      @relayout="handleRelayout"
      @export="handleExport"
    />
    
    <!-- Cytoscape è§†å£ -->
    <StarChartViewport 
      v-if="starChartStore.initialized"
      :elements="starChartStore.cytoscapeElements"
      :layout="starChartStore.layoutConfig"
      @viewport-change="handleViewportChange"
    />
    
    <!-- ç©ºçŠ¶æ€ -->
    <div v-else-if="!starChartStore.loading" class="empty-state">
      <el-empty description="æš‚æ— æ•°æ®">
        <el-button type="primary" @click="handleCreateView">
          åˆ›å»ºè§†å›¾
        </el-button>
      </el-empty>
    </div>
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <div v-else class="loading-state">
      <el-icon class="is-loading"><Loading /></el-icon>
      <span>åŠ è½½ä¸­...</span>
    </div>
  </div>
</template>

<script setup lang="ts">
import { onMounted } from 'vue'
import { Loading } from '@element-plus/icons-vue'
import { ElMessage } from 'element-plus'
import { useStarChartStore } from '@stores/projectPage/starChart'
import StarChartTopBar from './StarChartTopBar.vue'
import StarChartViewport from './StarChartViewport.vue'
import type { ViewportState } from '@stores/projectPage/starChart/starChart.types'

const starChartStore = useStarChartStore()

// åˆ›å»ºè§†å›¾
const handleCreateView = async () => {
  try {
    await starChartStore.initialize()
    ElMessage.success('è§†å›¾åˆ›å»ºæˆåŠŸ')
  } catch (error) {
    ElMessage.error('åˆ›å»ºå¤±è´¥')
  }
}

// é‡æ–°å¸ƒå±€
const handleRelayout = () => {
  starChartStore.updateLayout({ randomize: true, animate: true })
  ElMessage.success('å¸ƒå±€å·²æ›´æ–°')
}

// å¯¼å‡º
const handleExport = () => {
  ElMessage.info('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...')
}

// è§†å£å˜åŒ–
const handleViewportChange = (state: ViewportState) => {
  starChartStore.updateViewport(state)
}

// ç”Ÿå‘½å‘¨æœŸ
onMounted(() => {
  console.log('[StarChartPanel] ç»„ä»¶å·²æŒ‚è½½')
})
</script>

<style scoped lang="scss">
.starchart-panel {
  display: flex;
  flex-direction: column;
  height: 100%;
  background: var(--obsidian-background-primary);
  overflow: hidden;
}

.empty-state,
.loading-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  color: var(--obsidian-text-secondary);
}

.loading-state {
  font-size: 14px;
  
  .el-icon {
    font-size: 32px;
  }
}
</style>
```

#### `GUI/components/ProjectPage.MainPanel/StarChart/StarChartTopBar.vue`

```vue
<template>
  <div class="starchart-topbar">
    <div class="topbar-left">
      <span class="topbar-title">ğŸ“Š StarChart å¯è§†åŒ–è§†å›¾</span>
      <span class="topbar-desc">åŸºäº Cytoscape.js çš„å°è¯´è®¾å®šå…³ç³»å›¾</span>
    </div>
    
    <div class="topbar-right">
      <el-button size="small" @click="$emit('create-view')">
        <el-icon><Plus /></el-icon>
        åˆ›å»ºè§†å›¾
      </el-button>
      
      <el-button size="small" @click="$emit('relayout')">
        <el-icon><Refresh /></el-icon>
        é‡æ–°å¸ƒå±€
      </el-button>
      
      <el-button size="small" @click="$emit('export')">
        <el-icon><Download /></el-icon>
        å¯¼å‡º
      </el-button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { Plus, Refresh, Download } from '@element-plus/icons-vue'

defineEmits<{
  'create-view': []
  'relayout': []
  'export': []
}>()
</script>

<style scoped lang="scss">
.starchart-topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 56px; /* å›ºå®šé«˜åº¦ */
  padding: 0 16px;
  background: var(--obsidian-background-secondary);
  border-bottom: 1px solid var(--obsidian-border-color);
  flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
}

.topbar-left {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.topbar-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--obsidian-text-primary);
}

.topbar-desc {
  font-size: 12px;
  color: var(--obsidian-text-secondary);
}

.topbar-right {
  display: flex;
  gap: 8px;
}
</style>
```

#### `GUI/components/ProjectPage.MainPanel/StarChart/StarChartViewport.vue`

```vue
<template>
  <div ref="containerRef" class="starchart-viewport"></div>
</template>

<script setup lang="ts">
import { ref, onMounted, onBeforeUnmount, watch } from 'vue'
import cytoscape from 'cytoscape'
import fcose from 'cytoscape-fcose'
import type { CytoscapeElement, LayoutConfig, ViewportState } from '@stores/projectPage/starChart/starChart.types'

// æ³¨å†Œ fcose å¸ƒå±€
cytoscape.use(fcose)

const props = defineProps<{
  elements: CytoscapeElement[]
  layout: LayoutConfig
}>()

const emit = defineEmits<{
  'viewport-change': [state: ViewportState]
}>()

const containerRef = ref<HTMLElement | null>(null)
let cyInstance: cytoscape.Core | null = null

// åˆå§‹åŒ– Cytoscape
const initCytoscape = () => {
  if (!containerRef.value) return

  cyInstance = cytoscape({
    container: containerRef.value,
    elements: props.elements,
    style: getCytoscapeStyle(),
    layout: { name: 'grid' }, // åˆå§‹å¸ƒå±€
    minZoom: 0.1,
    maxZoom: 5,
    wheelSensitivity: 0.2
  })

  // ç›‘å¬è§†å£å˜åŒ–
  cyInstance.on('zoom pan', () => {
    if (cyInstance) {
      emit('viewport-change', {
        zoom: cyInstance.zoom(),
        pan: cyInstance.pan()
      })
    }
  })

  // è¿è¡Œå¸ƒå±€
  runLayout()
}

// è¿è¡Œå¸ƒå±€
const runLayout = () => {
  if (!cyInstance) return

  const layout = cyInstance.layout({
    name: props.layout.name,
    nodeRepulsion: props.layout.nodeRepulsion,
    idealEdgeLength: (edge: any) => {
      return props.layout.idealEdgeLength! / (edge.data('weight') || 1)
    },
    animate: props.layout.animate,
    randomize: props.layout.randomize
  })

  layout.run()
}

// Cytoscape æ ·å¼ï¼ˆåŸºäº cy-style.jsonï¼‰
const getCytoscapeStyle = () => [
  {
    selector: 'node',
    style: {
      'width': 'mapData(score, 0, 1, 20, 60)',
      'height': 'mapData(score, 0, 1, 20, 60)',
      'content': 'data(name)',
      'font-size': '12px',
      'text-valign': 'center',
      'text-halign': 'center',
      'background-color': 'data(color)',
      'text-outline-color': '#555',
      'text-outline-width': '2px',
      'color': '#fff'
    }
  },
  {
    selector: 'edge',
    style: {
      'curve-style': 'bezier',
      'opacity': 0.6,
      'line-color': '#999',
      'width': 'mapData(weight, 0, 1, 1, 8)',
      'target-arrow-shape': 'triangle',
      'target-arrow-color': '#999'
    }
  },
  {
    selector: 'node:selected',
    style: {
      'border-width': '4px',
      'border-color': '#4dabf7'
    }
  }
]

// ç›‘å¬ elements å˜åŒ–
watch(() => props.elements, () => {
  if (cyInstance) {
    cyInstance.elements().remove()
    cyInstance.add(props.elements)
    runLayout()
  }
})

// ç›‘å¬ layout å˜åŒ–
watch(() => props.layout, () => {
  runLayout()
}, { deep: true })

onMounted(() => {
  initCytoscape()
})

onBeforeUnmount(() => {
  if (cyInstance) {
    cyInstance.destroy()
    cyInstance = null
  }
})
</script>

<style scoped lang="scss">
.starchart-viewport {
  flex: 1; /* å æ»¡å‰©ä½™ç©ºé—´ */
  min-height: 0; /* å…³é”®ï¼šå…è®¸ flex å‹ç¼© */
  width: 100%;
  background: var(--obsidian-background-primary);
  position: relative;
}
</style>
```

---

### Phase 6: é›†æˆåˆ° WritingPanel

#### ä¿®æ”¹ `Navbar.content/Writing/WritingPanel.vue`

```vue
<template>
  <div class="writing-panel">
    <div class="writing-header">
      <h3>NovelAgent</h3>
    </div>
    
    <el-collapse v-model="activeNames" class="writing-collapse">
      <!-- åˆ†ç±»ä¸€ -->
      <el-collapse-item title="åˆ†ç±»ä¸€" name="category1">
        <div class="collapse-content">
          <el-empty description="åŠŸèƒ½å¼€å‘ä¸­..." />
        </div>
      </el-collapse-item>

      <!-- åˆ†ç±»äºŒ: StarChart å¯è§†åŒ–è§†å›¾ -->
      <el-collapse-item title="StarChart å¯è§†åŒ–è§†å›¾" name="category2">
        <div class="collapse-content collapse-content--starchart">
          <StarChartPanel />
        </div>
      </el-collapse-item>
    </el-collapse>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import StarChartPanel from '@components/ProjectPage.MainPanel/StarChart/StarChartPanel.vue'

const activeNames = ref(['category1'])
</script>

<style scoped>
/* ... ç°æœ‰æ ·å¼ ... */

/* StarChart ä¸“ç”¨ï¼šå–æ¶ˆå†…è¾¹è·ï¼Œè®©è§†å£å æ»¡ */
.collapse-content--starchart {
  padding: 0 !important;
  min-height: 400px; /* ç¡®ä¿æœ€å°é«˜åº¦ */
}
</style>
```

---

## ğŸ“¦ ä¾èµ–å®‰è£…

### éœ€è¦å®‰è£…çš„ npm åŒ…

```json
{
  "dependencies": {
    "cytoscape": "^3.30.4",
    "cytoscape-fcose": "^2.2.0"
  }
}
```

**å®‰è£…å‘½ä»¤ï¼š**
```bash
npm install cytoscape cytoscape-fcose
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### åŠŸèƒ½æµ‹è¯•æ¸…å•

- [ ] Mock æ•°æ®æ­£ç¡®åŠ è½½
- [ ] Cytoscape å®ä¾‹æ­£å¸¸åˆå§‹åŒ–
- [ ] èŠ‚ç‚¹å’Œè¾¹æ­£ç¡®æ¸²æŸ“
- [ ] fCoSE å¸ƒå±€ç®—æ³•æ­£å¸¸å·¥ä½œ
- [ ] é¡¶æ æŒ‰é’®åŠŸèƒ½æ­£å¸¸
- [ ] è§†å£ç¼©æ”¾ã€å¹³ç§»äº¤äº’æµç•…
- [ ] è§†å£é«˜åº¦è‡ªé€‚åº”çˆ¶å®¹å™¨
- [ ] æŠ˜å é¢æ¿å±•å¼€/æ”¶èµ·æ­£å¸¸

---

## ğŸ“Š å¼€å‘é¡ºåº

1. âœ… å®‰è£…ä¾èµ– (`cytoscape`, `cytoscape-fcose`)
2. âœ… åˆ›å»ºç±»å‹å®šä¹‰ (`starChart.types.ts`)
3. âœ… åˆ›å»º Mock æ•°æ® (`data.mock.ts`)
4. âœ… åˆ›å»º DataSource (`DataSource.ts`)
5. âœ… åˆ›å»º Store (`starChart.store.ts`)
6. âœ… åˆ›å»ºç»„ä»¶ (`StarChartPanel.vue`, `StarChartTopBar.vue`, `StarChartViewport.vue`)
7. âœ… é›†æˆåˆ° WritingPanel
8. âœ… æµ‹è¯•å®Œæ•´æµç¨‹

---

## ğŸ¨ UI/UX è®¾è®¡è¦ç‚¹

### å¸ƒå±€ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  StarChart å¯è§†åŒ–è§†å›¾ [+åˆ›å»º] [å¸ƒå±€] â”‚  <- å›ºå®šé¡¶æ  (56px)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚                                     â”‚
â”‚         Cytoscape è§†å£              â”‚  <- flex: 1, å æ»¡å‰©ä½™
â”‚                                     â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ·å¼è§„èŒƒ

- **é¡¶æ é«˜åº¦**: å›ºå®š 56px, `flex-shrink: 0`
- **è§†å£é«˜åº¦**: `flex: 1`, `min-height: 0`
- **èƒŒæ™¯è‰²**: ä½¿ç”¨ Obsidian ä¸»é¢˜å˜é‡
- **èŠ‚ç‚¹é¢œè‰²**: æ ¹æ®ç±»å‹åŒºåˆ†ï¼ˆè§’è‰²/åœ°ç‚¹/äº‹ä»¶ï¼‰
- **è¾¹æ ·å¼**: è´å¡å°”æ›²çº¿ï¼Œå¸¦ç®­å¤´

---

## ğŸ”„ åç»­æ‰©å±•

### v1.1 è®¡åˆ’åŠŸèƒ½

- [ ] èŠ‚ç‚¹å³é”®èœå•ï¼ˆç¼–è¾‘/åˆ é™¤ï¼‰
- [ ] è¾¹çš„åˆ›å»ºå’Œç¼–è¾‘
- [ ] èŠ‚ç‚¹æœç´¢å’Œç­›é€‰
- [ ] å¯¼å‡ºä¸ºå›¾ç‰‡/JSON
- [ ] æ—¶é—´è½´å¿«ç…§åˆ‡æ¢
- [ ] å¯¹æ¥ StarChart æ•°æ®åº“

---

## ğŸ“– å‚è€ƒæ–‡æ¡£

- [æ·»åŠ æ–° Panel ç³»ç»Ÿå·¥ä½œæµ](../../Workflow/æ·»åŠ æ–°Panelç³»ç»Ÿ.md)
- [Pane åˆ†å±ç³»ç»Ÿè®¾è®¡æ–‡æ¡£](../Paneåˆ†å±ç³»ç»Ÿè®¾è®¡æ–‡æ¡£.md)
- [å¼€å‘é€šç”¨å·¥ä½œæµ](../../Workflow/å¼€å‘é€šç”¨å·¥ä½œæµ.md)
- [Cytoscape.js å®˜æ–¹æ–‡æ¡£](https://js.cytoscape.org/)
- [fcose-gene å‚è€ƒé¡¹ç›®](../../../Reference/Reference-Page/fcose-gene/)

---

**è®¾è®¡å®Œæˆæ—¥æœŸ**: 2025-10-16  
**è®¾è®¡ç‰ˆæœ¬**: v1.0  
**è®¾è®¡çŠ¶æ€**: å¾…å®¡æ‰¹å®ç°
```

---
