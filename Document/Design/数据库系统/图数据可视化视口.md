# StarChart 可视化视图 Panel 系统设计文档

**版本**: v1.0  
**创建时间**: 2025-10-16  
**文档状态**: 待实现  
**基于参考**: fcose-gene Cytoscape.js Demo

---

## 📋 系统概述

StarChart 可视化视图是一个基于 Cytoscape.js 的图数据库可视化面板，用于展示和编辑小说设定中的实体关系图。支持节点创建、连接编辑、布局调整等交互功能。

### 🎯 核心特性

- **图数据可视化**: 使用 Cytoscape.js 渲染节点和边的关系
- **fCoSE 布局算法**: 力导向布局，自动优化节点位置
- **交互式编辑**: 支持节点拖拽、缩放、平移
- **固定顶栏工具**: 提供创建、布局、导出等快捷操作
- **响应式视口**: 视口高度自适应父容器
- **Mock 优先开发**: 使用 Mock 数据快速开发，后期对接 StarChart 数据库

---

## 🏗️ 系统架构

### 组件层次结构

```
NovelAgent Panel (WritingPanel.vue)
└── 分类二: StarChart 可视化视图
    └── StarChartPanel.vue (主容器)
        ├── StarChartTopBar.vue (固定顶栏)
        │   ├── 介绍文本
        │   ├── 创建视图按钮
        │   ├── 布局控制
        │   └── 导出工具
        └── StarChartViewport.vue (Cytoscape 视口)
            ├── Cytoscape 实例
            ├── 节点渲染
            └── 边渲染
```

### 数据流架构

```
Vue组件 ← useStarChartStore (Pinia Store)
           ↓
       DataSource (抽象层)
           ↓
    ┌──────┴──────┐
    ↓             ↓
Mock数据      StarChart数据库
(开发阶段)    (生产环境)
```

---

## 📁 文件结构

### 完整文件清单

```
Nimbria/Client/
├── GUI/
│   ├── components/
│   │   └── ProjectPage.MainPanel/
│   │       └── StarChart/                          [新增目录]
│   │           ├── StarChartPanel.vue              [新增] 主容器
│   │           ├── StarChartTopBar.vue             [新增] 顶栏工具
│   │           ├── StarChartViewport.vue           [新增] Cytoscape 视口
│   │           ├── StarChartNodeTooltip.vue        [新增] 节点悬浮提示
│   │           └── index.ts                        [新增] 组件导出
│   │
│   └── PagesLayout/
│       └── ProjectPage.Shell/
│           └── Navbar.content/
│               └── Writing/
│                   └── WritingPanel.vue            [修改] 添加 StarChart 入口
│
├── stores/
│   └── projectPage/
│       └── starChart/                               [新增目录]
│           ├── index.ts                             [新增] 统一导出 + DataSource 管理
│           ├── starChart.store.ts                   [新增] Store 状态管理
│           ├── starChart.types.ts                   [新增] 类型定义
│           ├── data.mock.ts                         [新增] Mock 数据
│           ├── DataSource.ts                        [新增] 数据源抽象
│           └── logic.ts                             [新增] 业务逻辑封装
```

---

## 🔧 核心实现

### Phase 1: 类型定义

#### `stores/projectPage/starChart/starChart.types.ts`

```typescript
/**
 * StarChart 核心类型定义
 */

// 节点数据结构
export interface StarChartNode {
  id: string
  name: string
  type?: string          // 节点类型 (角色/地点/事件等)
  score?: number         // 重要性评分 (影响节点大小)
  color?: string         // 节点颜色
  metadata?: Record<string, unknown>
}

// 边数据结构
export interface StarChartEdge {
  id: string
  source: string         // 源节点 ID
  target: string         // 目标节点 ID
  weight?: number        // 权重 (影响边粗细)
  type?: string          // 关系类型
  label?: string         // 边标签
  metadata?: Record<string, unknown>
}

// 图数据结构
export interface StarChartGraphData {
  nodes: StarChartNode[]
  edges: StarChartEdge[]
}

// Cytoscape 元素类型 (兼容 Cytoscape.js 格式)
export interface CytoscapeElement {
  data: {
    id: string
    name?: string
    source?: string
    target?: string
    weight?: number
    score?: number
    [key: string]: unknown
  }
  group?: 'nodes' | 'edges'
}

// 布局配置
export interface LayoutConfig {
  name: 'fcose' | 'grid' | 'circle' | 'cose'
  nodeRepulsion?: number
  idealEdgeLength?: number
  animate?: boolean
  randomize?: boolean
}

// 视图状态
export interface ViewportState {
  zoom: number
  pan: { x: number; y: number }
}
```

---

### Phase 2: Mock 数据

#### `stores/projectPage/starChart/data.mock.ts`

```typescript
/**
 * StarChart Mock 数据
 * 包含 30 个节点，每个节点平均 3-5 条关系
 * 节点类型：角色、地点、事件、物品等
 */

import type { StarChartNode, StarChartEdge, StarChartGraphData } from './starChart.types'

// Mock 节点数据 (30个 - 小说设定关系网络)
export const mockNodes: StarChartNode[] = [
  // 主要角色 (6个)
  { id: 'char-1', name: '凌云', type: 'protagonist', score: 0.95, color: '#ff6b6b' },
  { id: 'char-2', name: '烟雨', type: 'heroine', score: 0.9, color: '#f06595' },
  { id: 'char-3', name: '魔尊', type: 'antagonist', score: 0.88, color: '#5c7cfa' },
  { id: 'char-4', name: '清风上人', type: 'mentor', score: 0.78, color: '#51cf66' },
  { id: 'char-5', name: '剑痴', type: 'supporting', score: 0.65, color: '#868e96' },
  { id: 'char-6', name: '月琴仙子', type: 'supporting', score: 0.62, color: '#a78bfa' },
  
  // 次要角色 (8个)
  { id: 'char-7', name: '张三', type: 'supporting', score: 0.45, color: '#868e96' },
  { id: 'char-8', name: '李四', type: 'supporting', score: 0.42, color: '#868e96' },
  { id: 'char-9', name: '王五', type: 'supporting', score: 0.48, color: '#868e96' },
  { id: 'char-10', name: '赵六', type: 'antagonist_minor', score: 0.55, color: '#94d82d' },
  { id: 'char-11', name: '孙七', type: 'supporting', score: 0.38, color: '#868e96' },
  { id: 'char-12', name: '周八', type: 'supporting', score: 0.40, color: '#868e96' },
  { id: 'char-13', name: '吴九', type: 'supporting', score: 0.52, color: '#868e96' },
  { id: 'char-14', name: '郑十', type: 'mentor', score: 0.58, color: '#51cf66' },
  
  // 地点 (7个)
  { id: 'place-1', name: '凌霄宗', type: 'location', score: 0.75, color: '#ffd43b' },
  { id: 'place-2', name: '魔渊地狱', type: 'location', score: 0.72, color: '#fa5252' },
  { id: 'place-3', name: '清风山庄', type: 'location', score: 0.65, color: '#ffd43b' },
  { id: 'place-4', name: '仙界秘境', type: 'location', score: 0.68, color: '#ffd43b' },
  { id: 'place-5', name: '禁地遗迹', type: 'location', score: 0.70, color: '#ff922b' },
  { id: 'place-6', name: '落日城', type: 'location', score: 0.55, color: '#ffd43b' },
  { id: 'place-7', name: '妖兽森林', type: 'location', score: 0.58, color: '#ffd43b' },
  
  // 事件 (5个)
  { id: 'event-1', name: '秘境开启', type: 'event', score: 0.85, color: '#ff8787' },
  { id: 'event-2', name: '大战决战', type: 'event', score: 0.82, color: '#ff8787' },
  { id: 'event-3', name: '宗门历练', type: 'event', score: 0.60, color: '#ff8787' },
  { id: 'event-4', name: '魔族入侵', type: 'event', score: 0.80, color: '#ff8787' },
  { id: 'event-5', name: '渡劫成仙', type: 'event', score: 0.75, color: '#ff8787' },
  
  // 物品/功法 (4个)
  { id: 'item-1', name: '诛仙剑', type: 'item', score: 0.70, color: '#74c0fc' },
  { id: 'item-2', name: '混元功', type: 'technique', score: 0.68, color: '#74c0fc' },
  { id: 'item-3', name: '仙经秘籍', type: 'item', score: 0.55, color: '#74c0fc' },
  { id: 'item-4', name: '破魔珠', type: 'item', score: 0.62, color: '#74c0fc' }
]

// Mock 边数据 (关系网络 - 每个节点平均3-5条)
export const mockEdges: StarChartEdge[] = [
  // 凌云关系 (5条)
  { id: 'e1', source: 'char-1', target: 'char-2', weight: 0.95, type: 'love', label: '爱情' },
  { id: 'e2', source: 'char-1', target: 'char-3', weight: 0.90, type: 'conflict', label: '宿敌' },
  { id: 'e3', source: 'char-1', target: 'char-4', weight: 0.80, type: 'mentor', label: '师徒' },
  { id: 'e4', source: 'char-1', target: 'place-1', weight: 0.75, type: 'location', label: '宗主' },
  { id: 'e5', source: 'char-1', target: 'item-1', weight: 0.70, type: 'possession', label: '持有' },
  
  // 烟雨关系 (4条)
  { id: 'e6', source: 'char-2', target: 'char-5', weight: 0.68, type: 'friendship', label: '朋友' },
  { id: 'e7', source: 'char-2', target: 'char-14', weight: 0.65, type: 'mentor', label: '师长' },
  { id: 'e8', source: 'char-2', target: 'place-3', weight: 0.60, type: 'location', label: '出身' },
  { id: 'e9', source: 'char-2', target: 'item-2', weight: 0.62, type: 'learn', label: '修炼' },
  
  // 魔尊关系 (5条)
  { id: 'e10', source: 'char-3', target: 'char-10', weight: 0.75, type: 'alliance', label: '手下' },
  { id: 'e11', source: 'char-3', target: 'place-2', weight: 0.85, type: 'location', label: '统治' },
  { id: 'e12', source: 'char-3', target: 'event-4', weight: 0.80, type: 'participate', label: '发起' },
  { id: 'e13', source: 'char-3', target: 'event-1', weight: 0.70, type: 'conflict', label: '对抗' },
  { id: 'e14', source: 'char-3', target: 'item-4', weight: 0.65, type: 'possession', label: '持有' },
  
  // 清风上人关系 (4条)
  { id: 'e15', source: 'char-4', target: 'place-1', weight: 0.80, type: 'location', label: '宗内' },
  { id: 'e16', source: 'char-4', target: 'char-5', weight: 0.72, type: 'mentor', label: '教导' },
  { id: 'e17', source: 'char-4', target: 'item-2', weight: 0.70, type: 'teach', label: '传授' },
  { id: 'e18', source: 'char-4', target: 'event-1', weight: 0.68, type: 'participate', label: '参与' },
  
  // 剑痴关系 (3条)
  { id: 'e19', source: 'char-5', target: 'item-1', weight: 0.75, type: 'obsession', label: '痴迷' },
  { id: 'e20', source: 'char-5', target: 'event-2', weight: 0.72, type: 'participate', label: '参战' },
  { id: 'e21', source: 'char-5', target: 'char-13', weight: 0.55, type: 'friendship', label: '旧识' },
  
  // 月琴仙子关系 (4条)
  { id: 'e22', source: 'char-6', target: 'place-4', weight: 0.70, type: 'location', label: '驻地' },
  { id: 'e23', source: 'char-6', target: 'event-2', weight: 0.68, type: 'participate', label: '助战' },
  { id: 'e24', source: 'char-6', target: 'char-2', weight: 0.62, type: 'friendship', label: '知己' },
  { id: 'e25', source: 'char-6', target: 'item-3', weight: 0.58, type: 'possession', label: '收藏' },
  
  // 赵六关系 (3条)
  { id: 'e26', source: 'char-10', target: 'place-2', weight: 0.72, type: 'location', label: '驻扎' },
  { id: 'e27', source: 'char-10', target: 'event-4', weight: 0.70, type: 'participate', label: '参与' },
  { id: 'e28', source: 'char-10', target: 'char-11', weight: 0.60, type: 'alliance', label: '同党' },
  
  // 郑十关系 (3条)
  { id: 'e29', source: 'char-14', target: 'place-3', weight: 0.75, type: 'location', label: '创建' },
  { id: 'e30', source: 'char-14', target: 'event-3', weight: 0.65, type: 'participate', label: '主持' },
  { id: 'e31', source: 'char-14', target: 'char-6', weight: 0.68, type: 'friendship', label: '至友' },
  
  // 地点间关系 (3条)
  { id: 'e32', source: 'place-1', target: 'place-3', weight: 0.55, type: 'neighbor', label: '邻近' },
  { id: 'e33', source: 'place-2', target: 'place-5', weight: 0.65, type: 'connection', label: '相连' },
  { id: 'e34', source: 'place-5', target: 'place-7', weight: 0.50, type: 'neighbor', label: '接壤' },
  
  // 事件间关系 (3条)
  { id: 'e35', source: 'event-1', target: 'event-4', weight: 0.70, type: 'causality', label: '引发' },
  { id: 'e36', source: 'event-4', target: 'event-2', weight: 0.75, type: 'sequence', label: '导致' },
  { id: 'e37', source: 'event-2', target: 'event-5', weight: 0.68, type: 'consequence', label: '成就' },
  
  // 物品使用关系 (3条)
  { id: 'e38', source: 'item-1', target: 'item-4', weight: 0.60, type: 'combination', label: '可结合' },
  { id: 'e39', source: 'item-2', target: 'event-1', weight: 0.65, type: 'requirement', label: '需要' },
  { id: 'e40', source: 'item-3', target: 'item-2', weight: 0.55, type: 'contain', label: '记载' }
]

// Mock 完整图数据
export const mockGraphData: StarChartGraphData = {
  nodes: mockNodes,
  edges: mockEdges
}

// 转换为 Cytoscape 格式
export function convertToCytoscapeFormat(graphData: StarChartGraphData) {
  const nodes = graphData.nodes.map(node => ({
    data: {
      id: node.id,
      name: node.name,
      score: node.score || 0.5,
      type: node.type,
      color: node.color
    },
    group: 'nodes' as const
  }))

  const edges = graphData.edges.map(edge => ({
    data: {
      id: edge.id,
      source: edge.source,
      target: edge.target,
      weight: edge.weight || 0.5,
      type: edge.type,
      label: edge.label
    },
    group: 'edges' as const
  }))

  return [...nodes, ...edges]
}

// 默认导出
export default {
  mockGraphData,
  convertToCytoscapeFormat
}
```

---

### Phase 3: DataSource 抽象层

#### `stores/projectPage/starChart/DataSource.ts`

```typescript
/**
 * StarChart DataSource
 * 负责决定使用 Mock 数据还是真实 StarChart 数据库
 */

import { Environment } from '@utils/environment'
import type { StarChartGraphData } from './starChart.types'
import { mockGraphData } from './data.mock'

export class StarChartDataSource {
  /**
   * 加载图数据
   */
  async loadGraphData(): Promise<StarChartGraphData> {
    if (Environment.shouldUseMock()) {
      console.log('[StarChart DataSource] 使用 Mock 数据')
      return Promise.resolve(mockGraphData)
    }

    // Electron 环境：调用 StarChart 数据库
    try {
      const result = await window.nimbria.starChart.getGraphData()
      if (result.success && result.data) {
        return result.data as StarChartGraphData
      }
      throw new Error(result.error || '加载失败')
    } catch (error) {
      console.error('[StarChart DataSource] 加载失败，回退到 Mock:', error)
      return mockGraphData
    }
  }

  /**
   * 保存图数据
   */
  async saveGraphData(data: StarChartGraphData): Promise<boolean> {
    if (Environment.shouldUseMock()) {
      console.log('[StarChart DataSource] Mock 保存:', data)
      return Promise.resolve(true)
    }

    // Electron 环境：保存到 StarChart 数据库
    try {
      const result = await window.nimbria.starChart.saveGraphData(data)
      return result.success
    } catch (error) {
      console.error('[StarChart DataSource] 保存失败:', error)
      return false
    }
  }

  /**
   * 添加节点
   */
  async addNode(node: StarChartNode): Promise<boolean> {
    if (Environment.shouldUseMock()) {
      console.log('[StarChart DataSource] Mock 添加节点:', node)
      mockGraphData.nodes.push(node)
      return Promise.resolve(true)
    }

    // Electron 环境
    try {
      const result = await window.nimbria.starChart.addNode(node)
      return result.success
    } catch (error) {
      console.error('[StarChart DataSource] 添加节点失败:', error)
      return false
    }
  }
}

// 单例导出
export const starChartDataSource = new StarChartDataSource()
```

---

### Phase 4: Store 状态管理

#### `stores/projectPage/starChart/starChart.store.ts`

```typescript
/**
 * StarChart Store
 * 负责为 Vue 组件提供响应式数据
 */

import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import type { StarChartGraphData, LayoutConfig, ViewportState, StarChartNode } from './starChart.types'
import { starChartDataSource } from './DataSource'
import { convertToCytoscapeFormat } from './data.mock'
import type { CytoscapeElement } from './starChart.types'

export const useStarChartStore = defineStore('projectPage-starChart', () => {
  // ==================== 状态 ====================
  
  const graphData = ref<StarChartGraphData | null>(null)
  const cytoscapeElements = ref<CytoscapeElement[]>([])
  const layoutConfig = ref<LayoutConfig>({
    name: 'fcose',
    nodeRepulsion: 4500,
    idealEdgeLength: 1,
    animate: true,
    randomize: false
  })
  const viewportState = ref<ViewportState>({
    zoom: 1,
    pan: { x: 0, y: 0 }
  })
  
  const loading = ref<boolean>(false)
  const error = ref<string | null>(null)
  const initialized = ref<boolean>(false)
  
  // ==================== 计算属性 ====================
  
  const hasData = computed(() => graphData.value !== null)
  const nodeCount = computed(() => graphData.value?.nodes.length || 0)
  const edgeCount = computed(() => graphData.value?.edges.length || 0)
  
  // ==================== 方法 ====================
  
  /**
   * 初始化：加载图数据
   */
  const initialize = async () => {
    if (initialized.value) {
      console.log('[StarChart Store] 已初始化，跳过')
      return
    }

    loading.value = true
    error.value = null
    
    try {
      const data = await starChartDataSource.loadGraphData()
      graphData.value = data
      cytoscapeElements.value = convertToCytoscapeFormat(data)
      initialized.value = true
      
      console.log('[StarChart Store] 初始化成功:', {
        nodes: data.nodes.length,
        edges: data.edges.length
      })
    } catch (err) {
      const errorMsg = err instanceof Error ? err.message : '初始化失败'
      error.value = errorMsg
      console.error('[StarChart Store] 初始化失败:', err)
      throw err
    } finally {
      loading.value = false
    }
  }
  
  /**
   * 添加节点
   */
  const addNode = async (node: StarChartNode) => {
    try {
      const success = await starChartDataSource.addNode(node)
      if (success && graphData.value) {
        graphData.value.nodes.push(node)
        cytoscapeElements.value = convertToCytoscapeFormat(graphData.value)
      }
      return success
    } catch (err) {
      console.error('[StarChart Store] 添加节点失败:', err)
      return false
    }
  }
  
  /**
   * 更新布局配置
   */
  const updateLayout = (config: Partial<LayoutConfig>) => {
    layoutConfig.value = { ...layoutConfig.value, ...config }
  }
  
  /**
   * 更新视口状态
   */
  const updateViewport = (state: Partial<ViewportState>) => {
    viewportState.value = { ...viewportState.value, ...state }
  }
  
  /**
   * 重置
   */
  const reset = () => {
    graphData.value = null
    cytoscapeElements.value = []
    initialized.value = false
    loading.value = false
    error.value = null
  }
  
  // ==================== 返回 ====================
  
  return {
    // 状态
    graphData,
    cytoscapeElements,
    layoutConfig,
    viewportState,
    loading,
    error,
    initialized,
    
    // 计算属性
    hasData,
    nodeCount,
    edgeCount,
    
    // 方法
    initialize,
    addNode,
    updateLayout,
    updateViewport,
    reset
  }
})
```

---

### Phase 5: 组件实现

#### `GUI/components/ProjectPage.MainPanel/StarChart/StarChartPanel.vue`

```vue
<template>
  <div class="starchart-panel">
    <!-- 顶栏工具 -->
    <StarChartTopBar 
      @create-view="handleCreateView"
      @relayout="handleRelayout"
      @export="handleExport"
    />
    
    <!-- Cytoscape 视口 -->
    <StarChartViewport 
      v-if="starChartStore.initialized"
      :elements="starChartStore.cytoscapeElements"
      :layout="starChartStore.layoutConfig"
      @viewport-change="handleViewportChange"
    />
    
    <!-- 空状态 -->
    <div v-else-if="!starChartStore.loading" class="empty-state">
      <el-empty description="暂无数据">
        <el-button type="primary" @click="handleCreateView">
          创建视图
        </el-button>
      </el-empty>
    </div>
    
    <!-- 加载状态 -->
    <div v-else class="loading-state">
      <el-icon class="is-loading"><Loading /></el-icon>
      <span>加载中...</span>
    </div>
  </div>
</template>

<script setup lang="ts">
import { onMounted } from 'vue'
import { Loading } from '@element-plus/icons-vue'
import { ElMessage } from 'element-plus'
import { useStarChartStore } from '@stores/projectPage/starChart'
import StarChartTopBar from './StarChartTopBar.vue'
import StarChartViewport from './StarChartViewport.vue'
import type { ViewportState } from '@stores/projectPage/starChart/starChart.types'

const starChartStore = useStarChartStore()

// 创建视图
const handleCreateView = async () => {
  try {
    await starChartStore.initialize()
    ElMessage.success('视图创建成功')
  } catch (error) {
    ElMessage.error('创建失败')
  }
}

// 重新布局
const handleRelayout = () => {
  starChartStore.updateLayout({ randomize: true, animate: true })
  ElMessage.success('布局已更新')
}

// 导出
const handleExport = () => {
  ElMessage.info('导出功能开发中...')
}

// 视口变化
const handleViewportChange = (state: ViewportState) => {
  starChartStore.updateViewport(state)
}

// 生命周期
onMounted(() => {
  console.log('[StarChartPanel] 组件已挂载')
})
</script>

<style scoped lang="scss">
.starchart-panel {
  display: flex;
  flex-direction: column;
  height: 100%;
  background: var(--obsidian-background-primary);
  overflow: hidden;
}

.empty-state,
.loading-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  color: var(--obsidian-text-secondary);
}

.loading-state {
  font-size: 14px;
  
  .el-icon {
    font-size: 32px;
  }
}
</style>
```

#### `GUI/components/ProjectPage.MainPanel/StarChart/StarChartTopBar.vue`

```vue
<template>
  <div class="starchart-topbar">
    <div class="topbar-left">
      <span class="topbar-title">📊 StarChart 可视化视图</span>
      <span class="topbar-desc">基于 Cytoscape.js 的小说设定关系图</span>
    </div>
    
    <div class="topbar-right">
      <el-button size="small" @click="$emit('create-view')">
        <el-icon><Plus /></el-icon>
        创建视图
      </el-button>
      
      <el-button size="small" @click="$emit('relayout')">
        <el-icon><Refresh /></el-icon>
        重新布局
      </el-button>
      
      <el-button size="small" @click="$emit('export')">
        <el-icon><Download /></el-icon>
        导出
      </el-button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { Plus, Refresh, Download } from '@element-plus/icons-vue'

defineEmits<{
  'create-view': []
  'relayout': []
  'export': []
}>()
</script>

<style scoped lang="scss">
.starchart-topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 56px; /* 固定高度 */
  padding: 0 16px;
  background: var(--obsidian-background-secondary);
  border-bottom: 1px solid var(--obsidian-border-color);
  flex-shrink: 0; /* 防止被压缩 */
}

.topbar-left {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.topbar-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--obsidian-text-primary);
}

.topbar-desc {
  font-size: 12px;
  color: var(--obsidian-text-secondary);
}

.topbar-right {
  display: flex;
  gap: 8px;
}
</style>
```

#### `GUI/components/ProjectPage.MainPanel/StarChart/StarChartViewport.vue`

```vue
<template>
  <div ref="containerRef" class="starchart-viewport"></div>
</template>

<script setup lang="ts">
import { ref, onMounted, onBeforeUnmount, watch } from 'vue'
import cytoscape from 'cytoscape'
import fcose from 'cytoscape-fcose'
import type { CytoscapeElement, LayoutConfig, ViewportState } from '@stores/projectPage/starChart/starChart.types'

// 注册 fcose 布局
cytoscape.use(fcose)

const props = defineProps<{
  elements: CytoscapeElement[]
  layout: LayoutConfig
}>()

const emit = defineEmits<{
  'viewport-change': [state: ViewportState]
}>()

const containerRef = ref<HTMLElement | null>(null)
let cyInstance: cytoscape.Core | null = null

// 初始化 Cytoscape
const initCytoscape = () => {
  if (!containerRef.value) return

  cyInstance = cytoscape({
    container: containerRef.value,
    elements: props.elements,
    style: getCytoscapeStyle(),
    layout: { name: 'grid' }, // 初始布局
    minZoom: 0.1,
    maxZoom: 5,
    wheelSensitivity: 0.2
  })

  // 监听视口变化
  cyInstance.on('zoom pan', () => {
    if (cyInstance) {
      emit('viewport-change', {
        zoom: cyInstance.zoom(),
        pan: cyInstance.pan()
      })
    }
  })

  // 运行布局
  runLayout()
}

// 运行布局
const runLayout = () => {
  if (!cyInstance) return

  const layout = cyInstance.layout({
    name: props.layout.name,
    nodeRepulsion: props.layout.nodeRepulsion,
    idealEdgeLength: (edge: any) => {
      return props.layout.idealEdgeLength! / (edge.data('weight') || 1)
    },
    animate: props.layout.animate,
    randomize: props.layout.randomize
  })

  layout.run()
}

// Cytoscape 样式（基于 cy-style.json）
const getCytoscapeStyle = () => [
  {
    selector: 'node',
    style: {
      'width': 'mapData(score, 0, 1, 20, 60)',
      'height': 'mapData(score, 0, 1, 20, 60)',
      'content': 'data(name)',
      'font-size': '12px',
      'text-valign': 'center',
      'text-halign': 'center',
      'background-color': 'data(color)',
      'text-outline-color': '#555',
      'text-outline-width': '2px',
      'color': '#fff'
    }
  },
  {
    selector: 'edge',
    style: {
      'curve-style': 'bezier',
      'opacity': 0.6,
      'line-color': '#999',
      'width': 'mapData(weight, 0, 1, 1, 8)',
      'target-arrow-shape': 'triangle',
      'target-arrow-color': '#999'
    }
  },
  {
    selector: 'node:selected',
    style: {
      'border-width': '4px',
      'border-color': '#4dabf7'
    }
  }
]

// 监听 elements 变化
watch(() => props.elements, () => {
  if (cyInstance) {
    cyInstance.elements().remove()
    cyInstance.add(props.elements)
    runLayout()
  }
})

// 监听 layout 变化
watch(() => props.layout, () => {
  runLayout()
}, { deep: true })

onMounted(() => {
  initCytoscape()
})

onBeforeUnmount(() => {
  if (cyInstance) {
    cyInstance.destroy()
    cyInstance = null
  }
})
</script>

<style scoped lang="scss">
.starchart-viewport {
  flex: 1; /* 占满剩余空间 */
  min-height: 0; /* 关键：允许 flex 压缩 */
  width: 100%;
  background: var(--obsidian-background-primary);
  position: relative;
}
</style>
```

---

### Phase 6: 集成到 WritingPanel

#### 修改 `Navbar.content/Writing/WritingPanel.vue`

```vue
<template>
  <div class="writing-panel">
    <div class="writing-header">
      <h3>NovelAgent</h3>
    </div>
    
    <el-collapse v-model="activeNames" class="writing-collapse">
      <!-- 分类一 -->
      <el-collapse-item title="分类一" name="category1">
        <div class="collapse-content">
          <el-empty description="功能开发中..." />
        </div>
      </el-collapse-item>

      <!-- 分类二: StarChart 可视化视图 -->
      <el-collapse-item title="StarChart 可视化视图" name="category2">
        <div class="collapse-content collapse-content--starchart">
          <StarChartPanel />
        </div>
      </el-collapse-item>
    </el-collapse>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import StarChartPanel from '@components/ProjectPage.MainPanel/StarChart/StarChartPanel.vue'

const activeNames = ref(['category1'])
</script>

<style scoped>
/* ... 现有样式 ... */

/* StarChart 专用：取消内边距，让视口占满 */
.collapse-content--starchart {
  padding: 0 !important;
  min-height: 400px; /* 确保最小高度 */
}
</style>
```

---

## 📦 依赖安装

### 需要安装的 npm 包

```json
{
  "dependencies": {
    "cytoscape": "^3.30.4",
    "cytoscape-fcose": "^2.2.0"
  }
}
```

**安装命令：**
```bash
npm install cytoscape cytoscape-fcose
```

---

## 🧪 测试策略

### 功能测试清单

- [ ] Mock 数据正确加载
- [ ] Cytoscape 实例正常初始化
- [ ] 节点和边正确渲染
- [ ] fCoSE 布局算法正常工作
- [ ] 顶栏按钮功能正常
- [ ] 视口缩放、平移交互流畅
- [ ] 视口高度自适应父容器
- [ ] 折叠面板展开/收起正常

---

## 📊 开发顺序

1. ✅ 安装依赖 (`cytoscape`, `cytoscape-fcose`)
2. ✅ 创建类型定义 (`starChart.types.ts`)
3. ✅ 创建 Mock 数据 (`data.mock.ts`)
4. ✅ 创建 DataSource (`DataSource.ts`)
5. ✅ 创建 Store (`starChart.store.ts`)
6. ✅ 创建组件 (`StarChartPanel.vue`, `StarChartTopBar.vue`, `StarChartViewport.vue`)
7. ✅ 集成到 WritingPanel
8. ✅ 测试完整流程

---

## 🎨 UI/UX 设计要点

### 布局结构

```
┌─────────────────────────────────────┐
│  StarChart 可视化视图 [+创建] [布局] │  <- 固定顶栏 (56px)
├─────────────────────────────────────┤
│                                     │
│                                     │
│         Cytoscape 视口              │  <- flex: 1, 占满剩余
│                                     │
│                                     │
└─────────────────────────────────────┘
```

### 样式规范

- **顶栏高度**: 固定 56px, `flex-shrink: 0`
- **视口高度**: `flex: 1`, `min-height: 0`
- **背景色**: 使用 Obsidian 主题变量
- **节点颜色**: 根据类型区分（角色/地点/事件）
- **边样式**: 贝塞尔曲线，带箭头

---

## 🔄 后续扩展

### v1.1 计划功能

- [ ] 节点右键菜单（编辑/删除）
- [ ] 边的创建和编辑
- [ ] 节点搜索和筛选
- [ ] 导出为图片/JSON
- [ ] 时间轴快照切换
- [ ] 对接 StarChart 数据库

---

## 📖 参考文档

- [添加新 Panel 系统工作流](../../Workflow/添加新Panel系统.md)
- [Pane 分屏系统设计文档](../Pane分屏系统设计文档.md)
- [开发通用工作流](../../Workflow/开发通用工作流.md)
- [Cytoscape.js 官方文档](https://js.cytoscape.org/)
- [fcose-gene 参考项目](../../../Reference/Reference-Page/fcose-gene/)

---

**设计完成日期**: 2025-10-16  
**设计版本**: v1.0  
**设计状态**: 待审批实现
```

---
