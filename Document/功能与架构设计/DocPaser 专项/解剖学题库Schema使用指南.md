# 解剖学题库 Multi-Region Schema 使用指南

## 📋 文档概述

**文档**：`解剖学题库完整Schema.json`  
**目标文件**：`C:\Users\zhaowendao\Desktop\test\test1\解剖学\full.md`  
**Schema类型**：Multi-Region（跨区域解析）  
**创建日期**：2025-10-13  
**版本**：1.0.0

---

## 🎯 核心问题与解决方案

### 问题描述

解剖学题库文档有**题目答案分离**的特殊结构：

```
📍 题目区域（第1-51158行）
├─ 第一章 绪 论
│  ├─ 一、A1型题（单句型最佳选择题）
│  │  └─ 1. 人体解剖学属于生物学中的（）范畴
│  │     ├─ A. 力学
│  │     ├─ B. 化学
│  │     └─ ...
│  └─ 二、B1型题...

📍 答案区域（第51159行开始）
├─ # 附录 参考答案
├─ # 第一章 绪 论
│  ├─ # 一、A1型题
│  │  └─ 1.C 2.B 3.D 4.E 5.E
│  └─ # 二、B1型题
│     └─ 1.A 2.C 3.D 4.E 5.A
```

**跨越距离**：题目和答案相距约5万行  
**匹配难度**：需要通过章节+题型+题号三级匹配

### Multi-Region解决方案

```
┌─────────────────────────────────────────┐
│  原始文档 (53053行)                      │
└─────────────────────────────────────────┘
              │
              ↓
┌─────────────────────────────────────────┐
│  区域1: questions (第1-51158行)          │
│  ├─ 提取章节号、题型、题号、题目内容    │
│  └─ 生成 matchKey                        │
└─────────────────────────────────────────┘
              │
              ↓
┌─────────────────────────────────────────┐
│  区域2: answers (第51159行开始)          │
│  ├─ 提取章节号、题型、题号、答案内容    │
│  └─ 生成 matchKey                        │
└─────────────────────────────────────────┘
              │
              ↓
┌─────────────────────────────────────────┐
│  后处理器: merge-lookup                  │
│  ├─ 策略: 精确匹配 matchKey              │
│  ├─ 模式: extend（扩展字段）             │
│  └─ 结果: 题目+答案合并数据              │
└─────────────────────────────────────────┘
```

---

## 🏗️ Schema 结构详解

### 1. 区域定义（Regions）

#### 区域1: questions（题目区域）

```json
{
  "name": "questions",
  "description": "题目内容区域（第1-51158行）",
  "range": {
    "start": 1,
    "end": 51158
  },
  "schema": {
    "type": "array",
    "items": { /* 题目字段定义 */ }
  }
}
```

**提取字段**：
| 字段 | 描述 | 正则示例 | 导出列名 |
|------|------|----------|----------|
| chapterNumber | 章节号（第一章、第二章） | `^#\s*第([一二三...]+)章` | 章节号 |
| chapterName | 章节名称 | `绪 论`、`骨骼系统` | 章节名称 |
| questionType | 题型 | `A1型题（单句型最佳选择题）` | 题型 |
| questionNumber | 题号 | `1`、`2`、`3` | 题号 |
| questionContent | 题目内容 | 题干文本 | 题目内容 |
| optionA ~ optionE | 选项A-E | 选项文本 | A选项~E选项 |
| matchKey | 匹配键 | `第一章-A1型题-1` | (不导出) |

#### 区域2: answers（答案区域）

```json
{
  "name": "answers",
  "description": "答案区域（从'附录 参考答案'开始）",
  "marker": {
    "start": "# 附录 参考答案"
  },
  "schema": {
    "type": "array",
    "items": { /* 答案字段定义 */ }
  }
}
```

**提取字段**：
| 字段 | 描述 | 示例 | 导出列名 |
|------|------|------|----------|
| chapterNumber | 章节号 | `第一章` | (用于匹配) |
| chapterName | 章节名称 | `绪 论` | (用于匹配) |
| questionType | 题型 | `A1型题（单句型最佳选择题）` | (用于匹配) |
| questionNumber | 题号 | `1` | (用于匹配) |
| answerContent | 答案内容 | `C`、`ABCD`、文本描述 | 答案 |
| matchKey | 匹配键 | `第一章-A1型题-1` | (不导出) |

### 2. 后处理器（PostProcessors）

```json
{
  "type": "merge-lookup",
  "name": "关联题目和答案",
  "sourceRegion": "questions",
  "lookupRegion": "answers",
  "matchFields": {
    "source": "matchKey",
    "lookup": "matchKey"
  },
  "strategy": "exact",
  "mergeMode": "extend"
}
```

**工作原理**：
1. **生成匹配键**：`chapterNumber + "-" + questionType + "-" + questionNumber`
2. **精确匹配**：在answers中查找相同matchKey的记录
3. **扩展字段**：将answerContent添加到questions记录中
4. **最终输出**：包含题目和答案的完整记录

---

## 📊 数据流程示例

### 输入数据

**题目区域（第3-10行）**：
```markdown
# 第一章 绪 论

# 一、A1型题（单句型最佳选择题）

1. 人体解剖学属于生物学中的（）范畴
A. 力学
B. 化学
C. 形态学
D. 生理学
E. 病理学
```

**答案区域（第51163-51165行）**：
```markdown
# 第一章 绪 论

# 一、A1型题（单句型最佳选择题）

1.C 2.B 3.D 4.E 5.E
```

### 解析结果

**题目数据**：
```json
{
  "chapterNumber": "第一章",
  "chapterName": "绪 论",
  "questionType": "A1型题（单句型最佳选择题）",
  "questionNumber": "1",
  "questionContent": "人体解剖学属于生物学中的（）范畴",
  "optionA": "力学",
  "optionB": "化学",
  "optionC": "形态学",
  "optionD": "生理学",
  "optionE": "病理学",
  "matchKey": "第一章-A1型题（单句型最佳选择题）-1"
}
```

**答案数据**：
```json
{
  "chapterNumber": "第一章",
  "chapterName": "绪 论",
  "questionType": "A1型题（单句型最佳选择题）",
  "questionNumber": "1",
  "answerContent": "C",
  "matchKey": "第一章-A1型题（单句型最佳选择题）-1"
}
```

**关联后的最终数据**：
```json
{
  "chapterNumber": "第一章",
  "chapterName": "绪 论",
  "questionType": "A1型题（单句型最佳选择题）",
  "questionNumber": "1",
  "questionContent": "人体解剖学属于生物学中的（）范畴",
  "optionA": "力学",
  "optionB": "化学",
  "optionC": "形态学",
  "optionD": "生理学",
  "optionE": "病理学",
  "answerContent": "C"  // 🆕 关联添加的答案字段
}
```

### 导出Excel

| 章节号 | 章节名称 | 题型 | 题号 | 题目内容 | A选项 | B选项 | C选项 | D选项 | E选项 | 答案 |
|--------|----------|------|------|----------|-------|-------|-------|-------|-------|------|
| 第一章 | 绪 论 | A1型题 | 1 | 人体解剖学属于... | 力学 | 化学 | 形态学 | 生理学 | 病理学 | **C** |

---

## 🎮 使用步骤（UI操作）

### 步骤1：导入Schema

1. 打开DocParser Schema编辑器
2. 点击"从JSON导入"
3. 粘贴`解剖学题库完整Schema.json`的内容
4. 系统自动识别为Multi-Region类型

### 步骤2：验证区域配置

在左侧"区域配置"标签页查看：

**区域1: questions**
- ✅ 名称：questions
- ✅ 提取方式：行范围 1-51158
- ✅ Schema类型：Array
- ✅ 字段数：12个

**区域2: answers**  
- ✅ 名称：answers
- ✅ 提取方式：标记符 "# 附录 参考答案"
- ✅ Schema类型：Array
- ✅ 字段数：6个

### 步骤3：检查数据关联配置

在左侧"数据关联"标签页查看：

**后处理器配置**：
- ✅ 类型：merge-lookup
- ✅ 源区域：questions
- ✅ 查找区域：answers
- ✅ 匹配字段：matchKey ↔ matchKey
- ✅ 匹配策略：exact（精确匹配）
- ✅ 合并模式：extend（扩展字段）

### 步骤4：预览和导出

1. 在右侧代码区查看完整JSON Schema
2. 点击"复制"按钮
3. （待后端实现）执行解析，生成Excel

---

## ⚠️ 已知问题与解决方案

### 问题1：第十章答案缺少"二、B1型题"

**现象**：答案区域第十章跳过了"二、B1型题"部分  
**位置**：第51940行附近  
**影响**：该部分题目无法匹配到答案  

**临时解决方案**：
```json
// 在后处理器中添加
{
  "type": "transform",
  "name": "标记缺失答案",
  "rules": [
    {
      "condition": "answerContent === null",
      "action": "set",
      "field": "answerContent",
      "value": "[答案缺失]"
    }
  ]
}
```

### 问题2：部分问答题答案包含多个子问题

**现象**：
```
1. 描述右心室的形态结构。
答：右心室...（1）前壁...（2）后壁...（3）内侧壁...
```

**影响**：答案可能被截断  

**解决方案**：
调整正则表达式，使用更宽松的匹配：
```json
{
  "pattern": "(?<=^\\d+[.、]\\s*)([\\s\\S]+?)(?=\\n\\d+[.、]|\\n#|$)",
  "mode": "extract",
  "flags": "m"
}
```

### 问题3：章节号是中文数字

**现象**：第一章、第二章...第十七章  
**影响**：排序可能不正确  

**解决方案**：
添加辅助字段进行数字转换：
```json
{
  "chapterNumberNumeric": {
    "type": "number",
    "x-parse": {
      "pattern": "^#\\s*第([一二三四五六七八九十]+)章",
      "mode": "extract",
      "captureGroups": [1],
      "transform": "chineseToNumber"  // 需要后端支持
    }
  }
}
```

---

## 🔧 调试与优化

### 调试步骤

1. **分别测试两个区域**：
   - 先测试questions区域是否能正确提取题目
   - 再测试answers区域是否能正确提取答案

2. **检查matchKey生成**：
   ```
   预期格式：第一章-A1型题（单句型最佳选择题）-1
   ```

3. **验证匹配结果**：
   - 检查有多少题目成功匹配到答案
   - 检查有多少题目匹配失败
   - 分析失败原因（章节号不一致、题型名称不一致等）

### 优化建议

1. **提高匹配成功率**：
   - 使用fuzzy匹配策略
   - 添加容错机制（去除空格、标点归一化）

2. **性能优化**：
   - 对大文档分批处理
   - 使用索引加速匹配

3. **导出优化**：
   - 添加数据验证
   - 生成匹配报告
   - 支持多Sheet导出（按章节分Sheet）

---

## 📚 扩展应用

### 适用场景

这个Schema模式可以应用于：

1. **其他医学题库**：病理学、生理学等
2. **标准化考试**：公务员考试、资格考试
3. **教材题库**：各学科教材配套习题
4. **文档类型**：任何"内容-注释"分离的文档

### 模板化改造

将此Schema改造为通用模板：

```json
{
  "type": "multi-region",
  "title": "题目答案分离型题库通用模板",
  "regions": [
    {
      "name": "questions",
      "range": { "start": "${QUESTION_START}", "end": "${QUESTION_END}" },
      "schema": { /* 可配置 */ }
    },
    {
      "name": "answers",
      "marker": { "start": "${ANSWER_MARKER}" },
      "schema": { /* 可配置 */ }
    }
  ],
  "postProcessors": [ /* 通用关联逻辑 */ ]
}
```

---

## 🎯 总结

### 核心优势

✅ **解决跨区域关联**：题目答案相距5万行也能精确匹配  
✅ **灵活配置**：支持行号范围和标记符两种定位方式  
✅ **可视化操作**：UI界面配置，无需手写JSON  
✅ **可复用模板**：可应用于其他类似文档  

### 待开发功能

⏳ **后端引擎**：Multi-Region解析引擎  
⏳ **智能匹配**：支持模糊匹配和容错  
⏳ **批量处理**：一次处理多个文档  
⏳ **质量报告**：生成匹配成功率报告  

---

**文档版本**：1.0.0  
**最后更新**：2025-10-13  
**维护者**：Nimbria Team

