# 多例组件模式 - 快速参考卡

## 🚀 3分钟快速实现

### Step 1: 添加`:key` (组件层)

```vue
<!-- PaneContent.vue -->
<YourComponent
  v-if="condition"
  :key="`component-${uniqueId}`"
  :tab-id="uniqueId"
/>
```

### Step 2: 创建Store (状态层)

```typescript
// yourComponent.store.ts
import { defineStore } from 'pinia'

interface State {
  tabId: string
  // 你的状态...
}

export const useYourComponentStore = defineStore('yourComponent', () => {
  const instances = ref<Map<string, State>>(new Map())
  
  const initInstance = (tabId: string): State => {
    if (instances.value.has(tabId)) {
      return instances.value.get(tabId)!
    }
    const newInstance = { tabId /* 初始状态 */ }
    instances.value.set(tabId, newInstance)
    return newInstance
  }
  
  const updateInstance = (tabId: string, updates: Partial<State>) => {
    const instance = instances.value.get(tabId)
    if (instance) Object.assign(instance, updates)
  }
  
  const removeInstance = (tabId: string) => {
    instances.value.delete(tabId)
  }
  
  return { instances, initInstance, updateInstance, removeInstance }
})
```

### Step 3: 组件生命周期 (组件层)

```vue
<script setup lang="ts">
const props = defineProps<{ tabId: string }>()
const store = useYourComponentStore()

// 本地状态
const localState = ref('')

// 挂载：恢复状态
onMounted(() => {
  const state = store.initInstance(props.tabId)
  localState.value = state.xxx
})

// 卸载：保存状态
onUnmounted(() => {
  store.updateInstance(props.tabId, {
    xxx: localState.value
  })
})
</script>
```

---

## ⚠️ 常见错误速查

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 状态混乱 | 缺少`:key` | 添加`:key="\`type-${id}\`"` |
| Lint错误 | key不唯一 | 使用组合key：`type-${id}` |
| 子组件不更新 | 子组件用ref | 用computed同步props |
| 内存泄漏 | 未清理资源 | onUnmounted中清理 |
| 状态丢失 | 未持久化 | onUnmounted保存到store |

---

## 📋 每次开发检查清单

组件文件 (`.vue`):
- [ ] 添加`:key`属性
- [ ] 添加`:tab-id` prop
- [ ] onMounted恢复状态
- [ ] onUnmounted保存状态
- [ ] 清理资源（listeners, observers等）

Store文件 (`.store.ts`):
- [ ] 使用`Map<string, State>`
- [ ] 实现`initInstance`
- [ ] 实现`updateInstance`
- [ ] 实现`removeInstance`

调试:
- [ ] 挂载时打印日志
- [ ] 卸载时打印日志
- [ ] 验证每个实例独立

---

## 🔍 调试模板

```typescript
onMounted(() => {
  console.log(`[YourComponent ${props.tabId}] Mounted`, {
    state: storeState
  })
})

onUnmounted(() => {
  console.log(`[YourComponent ${props.tabId}] Unmounted`, {
    savedState: { /* ... */ }
  })
})
```

期望日志：
```
✅ [Component tab-1] Mounted
✅ [Component tab-2] Mounted
✅ [Component tab-2] Unmounted  // 切换标签页
✅ [Component tab-1] Mounted (重新挂载)
```

❌ 如果看不到重新Mounted，说明key有问题！

---

## 📚 完整文档

详细说明请查看：[多例组件模式指南.md](./多例组件模式指南.md)

