# Nimbria 架构设计总览 (v2.0 - 2025-10-11)

本文档旨在提供 Nimbria 项目当前技术架构的快照，反映截至 `2025-10-11` 的实际代码组织情况。

## 🏗️ Client/ 前端架构

### 📁 目录结构

```
Client/
├── GUI/                                    # 界面层 (Vue Components)
│   ├── components/                         # 业务组件 (按页面/功能组织)
│   │   ├── HomeDashboardPage/              # 主页相关组件
│   │   ├── ProjectManagement/              # 项目管理对话框
│   │   ├── ProjectPage.MainPanel/          # 项目页 - 主面板组件 (Markdown, Pane)
│   │   ├── ProjectPage.Shell/              # 项目页 - 外壳组件 (文件树, 右侧栏, 命令面板)
│   │   └── Shared/                         # 跨页面共享组件
│   │
│   ├── PagesLayout/                        # 页面级组件 (负责视觉样式和布局)
│   │   ├── HomeDashboardPage.vue
│   │   ├── ProjectPage.MainPanel.vue
│   │   ├── ProjectPage.Shell.vue
│   │   └── ProjectPage.DetachedPage.vue    # 拆分出的独立窗口页面
│   │
│   ├── layouts/                            # 顶层布局 (负责Flex结构和路由视图)
│   │   ├── MainLayout.vue                  # 主窗口布局
│   │   └── ProjectMainLayout.vue           # 项目窗口布局
│   │
│   ├── Index/                              # 系统入口 (不同窗口环境的根组件)
│   │   ├── HomeSystem.vue
│   │   └── ProjectPageSystem.vue
│   │
│   ├── router/                             # 路由配置
│   ├── assets/                             # 全局静态资源
│   └── App.vue                             # 应用入口
│
├── Service/                                # 服务 API 层 (封装高级功能调用)
│   ├── CommandPanelRightSidebar/           # 命令面板与右侧栏 API
│   │   ├── command.api.ts
│   │   └── rightSidebar.api.ts
│   └── ProjectManagement/                  # 项目管理服务
│       └── ProjectService.ts
│
├── stores/                                 # 状态管理 (Pinia)
│   ├── home/                               # 主页状态
│   ├── project/                            # 项目的创建、打开、验证和最近项目列表
│   ├── projectPage/                        # ⭐ 项目页核心状态模块
│   │   ├── commandPalette/                 #   - 命令面板
│   │   ├── Markdown/                       #   - Markdown 编辑与文件树
│   │   ├── paneLayout/                     #   - Pane 分屏布局
│   │   └── rightSidebar/                   #   - 右侧栏
│   ├── settings/                           # 设置状态
│   └── index.ts                            # Store 入口
│
├── Utils/                                  # 工具函数与插件
│   └── Plugins/                            # 插件化系统
│       ├── commands/                       #   - 命令插件
│       └── panels/                         #   - 右侧栏面板插件
│
└── boot/                                   # Quasar 启动文件
```

### 🗂️ stores/ 状态管理模块

| 模块              | 主要职责                                       |
| ----------------- | ---------------------------------------------- |
| `home`            | 主窗口仪表盘的数据与状态                       |
| `project`         | 项目的创建、打开、验证和最近项目列表           |
| `projectPage`     | **项目窗口的核心状态**                         |
| ├ `commandPalette` | 命令面板的状态、命令注册与过滤                 |
| ├ `Markdown`      | 文件树、打开的标签页、自动保存、文件操作         |
| ├ `paneLayout`    | Pane 分屏的树状结构、焦点管理、分屏操作        |
| ├ `rightSidebar`  | 右侧栏的面板注册、激活状态、可见性             |
| `settings`        | 设置对话框状态，缓存管理                       |

### 📞 Service/ 服务 API 层

| 模块                       | 主要职责                                                     |
| -------------------------- | ------------------------------------------------------------ |
| `CommandPanelRightSidebar` | 提供 `commandApi` 和 `rightSidebarApi`，封装对 Store 的复杂操作，供插件系统调用。 |
| `ProjectManagement`        | 封装项目创建、打开等流程，处理与后端 `project-service` 的 IPC 通信。 |

## ⚙️ src-electron/ 主进程架构

### 📁 目录结构

```
src-electron/
├── core/                           # 核心主进程
│   ├── app-manager.ts              # ✅ 应用核心管理器 (生命周期, IPC注册中心)
│   ├── electron-main.ts            # 主进程入口
│   ├── main-preload.ts             # 主窗口预加载脚本
│   └── project-preload.ts          # 项目窗口预加载脚本
│
├── services/                       # 持续运行的服务
│   ├── file-service/               # ✅ 文件系统服务 (读、写、监听)
│   ├── markdown-service/           # ✅ Markdown专项服务 (扫描, 读写队列, 备份)
│   ├── project-service/            # ✅ 项目管理服务 (创建, 验证, 初始化)
│   └── window-service/             # ✅ 窗口管理服务 (多窗口/进程管理)
│
├── ipc/                            # 进程间通信
│   └── main-renderer/              # 主进程-渲染进程通信
│       ├── channel-definitions.ts  # IPC 通道类型定义 (废弃, 见 types/ipc.ts)
│       ├── file-handlers.ts        # 文件操作 IPC 处理器
│       ├── markdown-handlers.ts    # Markdown 操作 IPC 处理器
│       └── ipc-handlers.ts         # 其他 IPC 处理器
│
├── store/                          # 持久化存储
│   └── recent-projects-store.ts    # `electron-store` 封装
│
├── types/                          # 主进程类型定义
│   ├── ipc.ts                      # ✅ 全局 IPC 通道类型映射
│   ├── process.ts                  # 进程、窗口相关类型
│   └── window.ts                   # 窗口模板、配置类型
│
└── utils/                          # 工具函数
```

### 🔧核心服务模块

| 服务模块           | 主要职责                                                     |
| ------------------ | ------------------------------------------------------------ |
| `file-service`     | 通用的文件操作（读写、创建、删除、监听），管理 `FileWatcher`。 |
| `markdown-service` | 针对 Markdown 文件的特化服务，包括元数据扫描、带队列的读写操作、文件备份等。 |
| `project-service`  | 负责项目的创建（模板化）、验证项目结构、初始化配置文件。   |
| `window-service`   | 管理 `BrowserWindow` 实例和渲染进程的生命周期，是多窗口架构的核心。 |

## 🔌 插件化系统 (Client/Utils/Plugins/)

Nimbria 的命令面板和右侧栏功能是基于插件化模式构建的。

- **命令插件** (`commands/`): 每个 `*.plugin.ts` 文件注册一组相关的命令。
- **面板插件** (`panels/`): 每个 `*.plugin.ts` 文件注册一个或多个右侧栏面板。

这种模式使得添加新命令或新面板无需修改核心代码，只需创建并注册新的插件文件即可。

## ⚙️ 配置修改项

### quasar.config.ts 路径别名

```typescript
// Client/ 内部别名
{ find: '@', replacement: 'Client' },
{ find: '@types', replacement: 'Client/types' },
{ find: '@components', replacement: 'Client/GUI/components' },
{ find: '@layouts', replacement: 'Client/GUI/layouts' },
{ find: '@pages', replacement: 'Client/GUI/PagesLayout' },
{ find: '@stores', replacement: 'Client/stores' },
{ find: '@index', replacement: 'Client/GUI/Index' },
{ find: '@service', replacement: 'Client/Service' },
{ find: '@utils', replacement: 'Client/Utils' },
```

