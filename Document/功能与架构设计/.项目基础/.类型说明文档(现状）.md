

## 📋 **Nimbria 项目类型系统完整审计报告**

### **当前问题总结**



1. **类型文件散落无序** - 73个文件定义类型，没有统一规范
2. **重复定义严重** - `ChatMessage` 在前端和后端各定义一遍（type差异）
3. **命名约定混乱** - `types.ts`、`xxx.types.ts`、`types/index.ts` 三种风格混用
4. **分层关系不清** - 不知道哪些是共享的、哪些是本地的、哪些是私有的
5. **前后端混杂** - IPC 接口定义和业务类型没有分离

---

### **5类分类方案的完整清单**

#### **第1类：核心共享类型** 
📍 **目标位置：** `Client/Types/` 和 `src-electron/types/`（根级别）

| 类型 | 当前位置 | 应该位置 | 状态 |
|------|--------|--------|------|
| `ProjectData` | `Client/Types/project.d.ts` | ✅ 正确 | 正确 |
| `ProjectResult` | `Client/Types/project.d.ts` | ✅ 正确 | 正确 |
| `SaveResult` | `Client/Types/project.d.ts` | ✅ 正确 | 正确 |
| `FileSystemItem` | `src-electron/services/file-service/types` | ❌ 应移出 | **迁移** |
| `IPCChannelMap` | `src-electron/types/ipc.ts` | ✅ 正确 | 正确 |
| `DirectMessage` | `src-electron/types/ipc.ts` | ✅ 正确 | 正确 |
| `WindowControlPayload` | `src-electron/types/ipc.ts` | ✅ 正确 | 正确 |

**统计：** 7个核心类型，6个位置正确，1个需要迁移

---

#### **第2类：功能模块业务类型**
📍 **目标位置：** `Client/Types/<ModuleName>/` 和 `src-electron/types/<ModuleName>/`

##### **2.1 LLM Chat 模块**

| 类型 | 当前位置 | 应该位置 | 状态 |
|------|--------|--------|------|
| `ChatMessage` (前端) | `Client/types/llmChat.ts` | `Client/Types/LlmChat/models.ts` | ❌ 混乱 |
| `Conversation` (前端) | `Client/types/llmChat.ts` | `Client/Types/LlmChat/models.ts` | ❌ 混乱 |
| `ConversationSettings` | `Client/types/llmChat.ts` | `Client/Types/LlmChat/models.ts` | ❌ 混乱 |
| `ChatMessage` (后端) | `src-electron/services/llm-chat-service/types.ts` | ❌ 私有化 | **重复定义** |
| `Conversation` (后端) | `src-electron/services/llm-chat-service/types.ts` | ❌ 私有化 | **重复定义** |
| `MessageStartEvent` | `src-electron/services/llm-chat-service/types.ts` | `src-electron/types/LlmChat/backend/events.ts` | ❌ 错位 |
| `StreamChunk` | `Client/types/llmChat.ts` | `Client/Types/LlmChat/operations.ts` | ❌ 错位 |

**统计：** 7个类型，其中：
- 2个前端类型在错误目录
- 2个后端重复定义了前端类型
- 3个类型分层不清

##### **2.2 LLM Translate 模块**

| 类型 | 当前位置 | 应该位置 | 状态 |
|------|--------|--------|------|
| `TranslateConfig` | `Client/GUI/DemoPage/LlmTranslate/types/config.ts` | ✅ 正确 | **✨ 标杆** |
| `Batch` | `Client/GUI/DemoPage/LlmTranslate/types/batch.ts` | ✅ 正确 | **✨ 标杆** |
| `Task` | `Client/GUI/DemoPage/LlmTranslate/types/task.ts` | ✅ 正确 | **✨ 标杆** |
| `TaskMetadata` | `Client/GUI/DemoPage/LlmTranslate/types/task.ts` | ✅ 正确 | **✨ 标杆** |
| `BatchCreateStartEvent` | `src-electron/types/LlmTranslate/backend/events.ts` | ✅ 正确 | **✨ 标杆** |
| `BatchRow` | `src-electron/types/LlmTranslate/backend/database.ts` | ✅ 正确 | **✨ 标杆** |

**统计：** 6个类型，全部正确 ✅

##### **2.3 Markdown 模块**

| 类型 | 当前位置 | 应该位置 | 状态 |
|------|--------|--------|------|
| `MarkdownFile` (前端) | `Client/stores/projectPage/Markdown/types.ts` | `Client/Types/Markdown/models.ts` | ❌ 错位 |
| `MarkdownTab` | `Client/stores/projectPage/Markdown/types.ts` | `Client/Types/Markdown/models.ts` | ❌ 错位 |
| `MarkdownFile` (后端) | `src-electron/services/markdown-service/types.ts` | ❌ 重复 | **重复定义** |
| `SaveTask` | `src-electron/services/markdown-service/types.ts` | `src-electron/types/Markdown/backend/operations.ts` | ❌ 错位 |
| `SaveResult` | `src-electron/services/markdown-service/types.ts` | `src-electron/types/Markdown/backend/operations.ts` | ❌ 错位 |

**统计：** 5个类型，全部有问题 ❌

##### **2.4 DocParser 模块**

| 类型 | 当前位置 | 应该位置 | 状态 |
|------|--------|--------|------|
| `RegexMatch` | `Client/Service/docParser/docParser.service.types.ts` | `Client/Types/DocParser/operations.ts` | ❌ 错位 |
| `ParseContext` | `Client/Service/docParser/docParser.service.types.ts` | `Client/Types/DocParser/operations.ts` | ❌ 错位 |
| `ExcelExportOptions` | `Client/Service/docParser/docParser.service.types.ts` | `Client/Types/DocParser/operations.ts` | ❌ 错位 |
| `ParseMetadata` | `Client/stores/projectPage/docParser/docParser.types.ts` | `Client/Types/DocParser/models.ts` | ❌ 错位 |

**统计：** 4个类型，全部错位 ❌

---

#### **第3类：组件/功能本地类型**
📍 **目标位置：** `Client/GUI/components/*/types.ts` 或 `Client/Service/*/types.ts`

| 类型 | 当前位置 | 应该位置 | 状态 |
|------|--------|--------|------|
| `RegexEngineConfig` | `Client/Service/docParser/docParser.service.types.ts` | ✅ 正确 | **本地私有** |
| `CellFormat` | `Client/Service/docParser/docParser.service.types.ts` | ✅ 正确 | **本地私有** |
| `ExcelColumnConfig` | `Client/Service/docParser/docParser.service.types.ts` | ✅ 正确 | **本地私有** |
| `CustomPageConfig` | `Client/Service/CustomPageManager/types.ts` | ✅ 正确 | **本地私有** |
| `PageOpenOptions` | `Client/Service/CustomPageManager/types.ts` | ✅ 正确 | **本地私有** |

**统计：** 5个类型，全部正确 ✅

---

#### **第4类：Store/Composable 状态类型**
📍 **目标位置：** `Client/stores/<ModuleName>/types/` 或 `Client/GUI/DemoPage/<PageName>/composables/types/`

| 类型 | 当前位置 | 应该位置 | 状态 |
|------|--------|--------|------|
| `TranslateState` | `Client/GUI/DemoPage/LlmTranslate/stores/translate.types.ts` | `Client/GUI/DemoPage/LlmTranslate/stores/types/state.ts` | ⚠️ 可接受 |
| `TranslateDatasource` | `Client/GUI/DemoPage/LlmTranslate/stores/translate.types.ts` | `Client/GUI/DemoPage/LlmTranslate/stores/types/operations.ts` | ⚠️ 可接受 |
| `DatasourceContext` | `Client/GUI/DemoPage/LlmTranslate/stores/translate.types.ts` | `Client/GUI/DemoPage/LlmTranslate/stores/types/context.ts` | ⚠️ 可接受 |
| `CommandPaletteState` | `Client/stores/projectPage/commandPalette/types.ts` | ✅ 正确 | **✨ 标杆** |
| `Command` | `Client/stores/projectPage/commandPalette/types.ts` | ✅ 正确 | **✨ 标杆** |
| `PaneLayoutState` | `Client/stores/projectPage/paneLayout/types.ts` | ✅ 正确 | **✨ 标杆** |
| `PaneNode` | `Client/stores/projectPage/paneLayout/types.ts` | ✅ 正确 | **✨ 标杆** |
| `HomeDashboardState` | `Client/stores/home/types.ts` | ✅ 正确 | **✨ 标杆** |

**统计：** 8个类型，7个正确，1个可接受

---

#### **第5类：服务内部类型**
📍 **目标位置：** `src-electron/services/<ServiceName>/types.ts`（严禁前端导入）

| 类型 | 当前位置 | 应该位置 | 状态 | 前端是否导入 |
|------|--------|--------|------|----------|
| `LangChainClientConfig` | `src-electron/services/llm-chat-service/types.ts` | ✅ 正确 | ✅ 私有 | ❌ 无人导 |
| `StreamCallbacks` | `src-electron/services/llm-chat-service/types.ts` | ✅ 正确 | ✅ 私有 | ❌ 无人导 |
| `MarkdownTreeOptions` | `src-electron/services/markdown-service/types.ts` | ✅ 正确 | ✅ 私有 | ❌ 无人导 |
| `FileOperationResult` | `src-electron/services/markdown-service/types.ts` | ✅ 正确 | ✅ 私有 | ❌ 无人导 |
| `WriteOptions` | `src-electron/services/markdown-service/types.ts` | ✅ 正确 | ✅ 私有 | ❌ 无人导 |
| `ReadOptions` | `src-electron/services/markdown-service/types.ts` | ✅ 正确 | ✅ 私有 | ❌ 无人导 |
| `StarChartInitEvent` | `src-electron/services/star-chart-service/types/index.ts` | ✅ 正确 | ✅ 私有 | ❌ 无人导 |

**统计：** 7个类型，全部正确 ✅

---

### **总体统计**

```
第1类（核心共享）：    7个 | ✅ 86% | ⚠️ 14% 需迁移
第2类（功能业务）：   21个 | ❌ 29% | ⚠️ 71% 有问题
第3类（本地组件）：    5个 | ✅ 100% | ✅ 完美
第4类（Store状态）：   8个 | ✅ 88% | ⚠️ 12% 可优化
第5类（服务私有）：    7个 | ✅ 100% | ✅ 完美
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
总计：               48个 | ❌ 54% | ⚠️ 46% 需整改
```

