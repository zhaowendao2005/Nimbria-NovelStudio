# 命令面板与右栏系统 - 快速参考

> 快速查阅手册，详细指南请参考 [完整开发指南](..\Workflow\命令面板与右栏系统开发指南.md)

---

## 🚀 5分钟上手

### 添加新命令

1. **创建插件文件** `Client/Utils/Plugins/commands/my-commands.plugin.ts`:
   ```typescript
   import { commandApi } from '@service/CommandPanelRightSidebar/command.api'
   
   export function registerMyCommands() {
     commandApi.register({
       id: 'my.action',
       label: '我的操作',
       category: 'custom',
       action: () => { console.log('执行!') }
     })
   }
   ```

2. **注册插件** `Client/Utils/Plugins/commands/index.ts`:
   ```typescript
   import { registerMyCommands } from './my-commands.plugin'
   
   export function registerAllCommandPlugins() {
     // ...
     registerMyCommands()  // 添加这一行
   }
   ```

3. **测试**: `Ctrl+Shift+P` → 搜索 "我的操作"

---

### 添加新面板

1. **创建组件** `Client/GUI/components/ProjectPage.Shell/RightSidebar/panels/MyPanel.vue`:
   ```vue
   <template>
     <div class="my-panel">
       <h3>我的面板</h3>
     </div>
   </template>
   
   <script setup lang="ts">
   // 你的逻辑
   </script>
   
   <style scoped>
   .my-panel { padding: 16px; }
   </style>
   ```

2. **创建插件** `Client/Utils/Plugins/panels/my-panel.plugin.ts`:
   ```typescript
   import { rightSidebarApi } from '@service/CommandPanelRightSidebar/rightSidebar.api'
   import { defineAsyncComponent } from 'vue'
   
   export function registerMyPanel() {
     rightSidebarApi.register({
       id: 'my-panel',
       label: '我的面板',
       component: defineAsyncComponent(() => 
         import('@components/ProjectPage.Shell/RightSidebar/panels/MyPanel.vue')
       )
     })
   }
   ```

3. **注册插件** `Client/Utils/Plugins/panels/index.ts`:
   ```typescript
   import { registerMyPanel } from './my-panel.plugin'
   
   export function registerAllPanelPlugins() {
     // ...
     registerMyPanel()  // 添加这一行
   }
   ```

---

## 📝 命令定义速查

```typescript
interface Command {
  id: string                           // 'category.action' (必需)
  label: string                        // '显示文本' (必需)
  category: CommandCategory            // 'view'|'file'|'edit'|'navigate'|'tools'|'custom' (必需)
  action: () => void | Promise<void>   // 执行函数 (必需)
  icon?: string                        // Element Plus icon name
  keywords?: string[]                  // ['搜索', 'keyword']
  shortcut?: string                    // 'Ctrl+S' (仅展示)
  priority?: number                    // 数值越大越靠前
  when?: () => boolean                 // 显示条件
}
```

**示例**:
```typescript
{
  id: 'file.save',
  label: '保存文件',
  category: 'file',
  keywords: ['save', '保存', 'ctrl+s'],
  shortcut: 'Ctrl+S',
  priority: 100,
  action: async () => {
    await markdownStore.saveFile()
  },
  when: () => markdownStore.hasUnsavedChanges
}
```

---

## 📝 面板定义速查

```typescript
interface RightSidebarPanel {
  id: string                    // 唯一标识 (必需)
  label: string                 // 标签文本 (必需)
  component: Component          // Vue组件 (必需)
  icon?: string                 // Element Plus icon name
  closable?: boolean            // 是否可关闭 (默认 true)
  order?: number                // 排序权重 (数值越小越靠前)
  when?: () => boolean          // 显示条件
}
```

**示例**:
```typescript
{
  id: 'outline',
  label: '大纲',
  icon: 'List',
  closable: true,
  order: 1,
  component: defineAsyncComponent(() => 
    import('@components/ProjectPage.Shell/RightSidebar/panels/OutlinePanel.vue')
  ),
  when: () => markdownStore.hasOpenFile
}
```

---

## 🔗 API 速查

### 命令 API

```typescript
import { commandApi } from '@service/CommandPanelRightSidebar/command.api'

// 注册命令
commandApi.register(command)
commandApi.registerBatch([command1, command2])

// 执行命令
await commandApi.execute('command.id')

// 控制面板
commandApi.open()
commandApi.close()
commandApi.toggle()

// 查询
commandApi.getAvailableCommands()
commandApi.findCommand('command.id')
```

### 右侧栏 API

```typescript
import { rightSidebarApi } from '@service/CommandPanelRightSidebar/rightSidebar.api'

// 注册面板
rightSidebarApi.register(panel)

// 切换面板
rightSidebarApi.switchTo('panel-id')
rightSidebarApi.switchToNext()
rightSidebarApi.switchToPrev()

// 显示控制
rightSidebarApi.show()
rightSidebarApi.hide()
rightSidebarApi.toggle()
rightSidebarApi.setWidth('300px')

// 查询
rightSidebarApi.getAvailablePanels()
rightSidebarApi.getActivePanel()
rightSidebarApi.findPanel('panel-id')
```

---

## 🔗 跨模块状态访问

**核心原则**: Pinia Store 可以在任何地方直接导入，无需注册。

### 在命令插件中访问其他 Store

```typescript
import { useMarkdownStore } from '@stores/projectPage/Markdown'

// 在 action 函数内部调用
action: () => {
  const markdownStore = useMarkdownStore()
  markdownStore.saveCurrentFile()
}

// 在 when() 中使用
when: () => {
  const markdownStore = useMarkdownStore()
  return markdownStore.openTabs.length > 0
}
```

### 在面板组件中访问 Store

```vue
<script setup lang="ts">
import { computed } from 'vue'
import { useMarkdownStore } from '@stores/projectPage/Markdown'

const markdownStore = useMarkdownStore()
const activeFile = computed(() => markdownStore.activeTab)
</script>
```

### ⚠️ 注意

- ✅ 在函数**内部**调用 `useXxxStore()`
- ❌ 不要在模块**顶层**调用

---

## 📁 关键文件位置

| 功能 | 路径 |
|------|------|
| **命令插件** | `Client/Utils/Plugins/commands/` |
| **面板插件** | `Client/Utils/Plugins/panels/` |
| **面板组件** | `Client/GUI/components/ProjectPage.Shell/RightSidebar/panels/` |
| **命令 API** | `Client/Service/CommandPanelRightSidebar/command.api.ts` |
| **右栏 API** | `Client/Service/CommandPanelRightSidebar/rightSidebar.api.ts` |
| **插件注册入口** | `Client/GUI/Index/ProjectPageSystem.vue` |

---

## 🎨 常用 Element Plus 图标

```
Document, Folder, FolderOpened, Files, 
Edit, Delete, Plus, Minus, Close, 
Search, View, Hide, Setting,
ArrowLeft, ArrowRight, ArrowUp, ArrowDown,
Check, Warning, InfoFilled
```

[完整图标列表](https://element-plus.org/zh-CN/component/icon.html)

---

## 🐛 调试技巧

### 1. 查看已注册的命令
```typescript
import { useCommandPaletteStore } from '@stores/projectPage/commandPalette'

const store = useCommandPaletteStore()
console.log('所有命令:', store.commands)
console.log('可用命令:', store.availableCommands)
```

### 2. 查看已注册的面板
```typescript
import { useRightSidebarStore } from '@stores/projectPage/rightSidebar'

const store = useRightSidebarStore()
console.log('所有面板:', store.panels)
console.log('可用面板:', store.availablePanels)
```

### 3. 插件注册日志
确保控制台看到以下日志：
```
[ProjectPageSystem] Registering all plugins...
[Plugin] Outline panel registered
[Plugin] View commands registered
[ProjectPageSystem] All plugins registered successfully
```

---

## ⚠️ 常见错误

| 错误 | 原因 | 解决方案 |
|------|------|----------|
| 命令不显示 | `when()` 返回 `false` | 检查条件逻辑 |
| 面板加载失败 | 组件路径错误 | 检查 `import()` 路径 |
| API 调用失败 | 未在 Vue 上下文中 | 确保在组件或插件中调用 |
| Store 访问失败 | 在模块顶层调用 | 改为在函数内部调用 `useXxxStore()` |

---

## 📖 相关文档

- [完整开发指南](./命令面板与右栏系统开发指南.md)
- [设计文档](../Design/命令面板与右栏重构/Design.md)

---

**版本**: v1.0 | **更新**: 2025-10-08

