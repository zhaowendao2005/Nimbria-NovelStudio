# å‘½ä»¤é¢æ¿ä¸å³æ ç³»ç»Ÿ - å¿«é€Ÿå‚è€ƒ

> å¿«é€ŸæŸ¥é˜…æ‰‹å†Œï¼Œè¯¦ç»†æŒ‡å—è¯·å‚è€ƒ [å®Œæ•´å¼€å‘æŒ‡å—](../Workflow/å‘½ä»¤é¢æ¿ä¸å³æ ç³»ç»Ÿå¼€å‘æŒ‡å—.md)

---

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

Nimbria çš„å‘½ä»¤é¢æ¿ä¸å³ä¾§æ ç³»ç»Ÿæä¾›äº†ä¸€ä¸ªé«˜åº¦å¯æ‰©å±•å’Œçµæ´»çš„ç”¨æˆ·ç•Œé¢ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡å‘½ä»¤é¢æ¿å¿«é€Ÿæ‰§è¡Œæ“ä½œï¼Œå¹¶é€šè¿‡å¯é…ç½®çš„å³ä¾§æ é¢æ¿è·å–ä¸Šä¸‹æ–‡ä¿¡æ¯æˆ–è¿›è¡Œè¾…åŠ©æ“ä½œã€‚æ•´ä¸ªç³»ç»ŸåŸºäºæ’ä»¶åŒ–æ¶æ„ï¼Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤ã€‚

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§

- **å‘½ä»¤é¢æ¿**: ç±»ä¼¼ VS Code çš„æ¨¡ç³Šæœç´¢å‘½ä»¤é¢æ¿ï¼Œæ”¯æŒé€šè¿‡å¿«æ·é”®æ¿€æ´»å’Œæ‰§è¡Œå„ç§æ“ä½œã€‚
- **å³ä¾§æ é¢æ¿**: å¯é…ç½®çš„ã€å¯åˆ‡æ¢çš„ä¾§è¾¹æ ï¼Œç”¨äºæ˜¾ç¤ºæ–‡ä»¶å¤§çº²ã€é¡¹ç›®ä¿¡æ¯ã€æ’ä»¶å·¥å…·ç­‰ã€‚
- **æ’ä»¶åŒ–æ¶æ„**: å‘½ä»¤å’Œé¢æ¿å‡å¯é€šè¿‡æ’ä»¶æ³¨å†Œï¼Œå®ç°é«˜åº¦æ¨¡å—åŒ–å’Œå¯æ‰©å±•æ€§ã€‚
- **ç±»å‹å®‰å…¨**: å…¨é¢çš„ TypeScript æ”¯æŒï¼Œç¡®ä¿å¼€å‘è¿‡ç¨‹ä¸­çš„ç±»å‹ä¸€è‡´æ€§ã€‚
- **è·¨æ¨¡å—çŠ¶æ€è®¿é—®**: é€šè¿‡ `StateRegistryService` å®ç°æ’ä»¶å¯¹æ ¸å¿ƒåº”ç”¨çŠ¶æ€çš„å®‰å…¨è®¿é—®ã€‚

---

## ğŸ—ï¸ æ’ä»¶åŒ–æ¶æ„

å‘½ä»¤å’Œå³ä¾§æ é¢æ¿éƒ½é€šè¿‡æ’ä»¶æœºåˆ¶è¿›è¡Œæ³¨å†Œã€‚è¿™ç§æ¶æ„å¸¦æ¥äº†ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- **è§£è€¦**: UI ç»„ä»¶å’Œä¸šåŠ¡é€»è¾‘åˆ†ç¦»ï¼Œä¾¿äºç‹¬ç«‹å¼€å‘å’Œæµ‹è¯•ã€‚
- **å¯ç»´æŠ¤æ€§**: æ–°åŠŸèƒ½ä»¥æ’ä»¶å½¢å¼æ·»åŠ ï¼Œä¸å½±å“æ ¸å¿ƒä»£ç ã€‚
- **çµæ´»æ€§**: ç”¨æˆ·å¯ä»¥æ ¹æ®éœ€æ±‚å¯ç”¨æˆ–ç¦ç”¨ç‰¹å®šçš„å‘½ä»¤å’Œé¢æ¿ã€‚

### æ’ä»¶æ³¨å†Œæµç¨‹

```mermaid
graph TD
    A[åº”ç”¨å¯åŠ¨ (ProjectPageSystem.vue)] --> B{åŠ è½½æ‰€æœ‰æ’ä»¶}
    B --> C[CommandPanelRightSidebar/command.api.ts] --> D[CommandPaletteStore] --> E[æ³¨å†Œå‘½ä»¤]
    B --> F[CommandPanelRightSidebar/rightSidebar.api.ts] --> G[RightSidebarStore] --> H[æ³¨å†Œé¢æ¿]
    E --> I[å‘½ä»¤é¢æ¿ UI (CommandPalette.vue)]
    H --> J[å³ä¾§æ  UI (RightSidebar.vue)]
```

---

## ğŸš€ 5åˆ†é’Ÿä¸Šæ‰‹

### æ·»åŠ æ–°å‘½ä»¤

1. **åˆ›å»ºæ’ä»¶æ–‡ä»¶** `Client/Utils/Plugins/commands/my-commands.plugin.ts`:
   ```typescript
   import { commandApi } from '@service/CommandPanelRightSidebar/command.api'
   import { useStateRegistryService } from '@utils/Plugins/StateRegistryService' // å¼•å…¥çŠ¶æ€æ³¨å†ŒæœåŠ¡
   
   export function registerMyCommands() {
     const stateRegistry = useStateRegistryService()
     commandApi.register({
       id: 'my.action',
       label: 'æˆ‘çš„æ“ä½œ',
       category: 'custom',
       action: () => {
         console.log('æ‰§è¡Œæˆ‘çš„æ“ä½œ!')
         // ç¤ºä¾‹: è®¿é—® MarkdownStore çš„çŠ¶æ€
         const markdownStore = stateRegistry.getStore('markdownStore')
         if (markdownStore) {
           console.log('å½“å‰æ´»è·ƒæ ‡ç­¾é¡µ:', markdownStore.activeTab?.name)
         }
       }
     })
   }
   ```

2. **æ³¨å†Œæ’ä»¶** `Client/Utils/Plugins/commands/index.ts`:
   ```typescript
   import { registerMyCommands } from './my-commands.plugin'
   // ... å…¶ä»–å‘½ä»¤æ’ä»¶å¯¼å…¥
   
   export function registerAllCommandPlugins() {
     // ...
     registerMyCommands()  // æ·»åŠ è¿™ä¸€è¡Œ
   }
   ```

3. **æµ‹è¯•**: `Ctrl+Shift+P` â†’ æœç´¢ "æˆ‘çš„æ“ä½œ"

---

### æ·»åŠ æ–°é¢æ¿

1. **åˆ›å»ºç»„ä»¶** `Client/GUI/components/ProjectPage.Shell/RightSidebar/panels/MyPanel.vue`:
   ```vue
   <template>
     <div class="my-panel">
       <h3>æˆ‘çš„é¢æ¿</h3>
       <p>å½“å‰æ´»è·ƒæ ‡ç­¾é¡µ: {{ activeTabName }}</p>
     </div>
   </template>
   
   <script setup lang="ts">
   import { computed } from 'vue'
   import { useStateRegistryService } from '@utils/Plugins/StateRegistryService'
   
   const stateRegistry = useStateRegistryService()
   const markdownStore = stateRegistry.getStore('markdownStore')
   
   const activeTabName = computed(() => markdownStore?.activeTab?.name || 'æ— ')
   </script>
   
   <style scoped>
   .my-panel { padding: 16px; }
   </style>
   ```

2. **åˆ›å»ºæ’ä»¶** `Client/Utils/Plugins/panels/my-panel.plugin.ts`:
   ```typescript
   import { rightSidebarApi } from '@service/CommandPanelRightSidebar/rightSidebar.api'
   import { defineAsyncComponent } from 'vue'
   
   export function registerMyPanel() {
     rightSidebarApi.register({
       id: 'my-panel',
       label: 'æˆ‘çš„é¢æ¿',
       component: defineAsyncComponent(() => 
         import('@components/ProjectPage.Shell/RightSidebar/panels/MyPanel.vue')
       )
     })
   }
   ```

3. **æ³¨å†Œæ’ä»¶** `Client/Utils/Plugins/panels/index.ts`:
   ```typescript
   import { registerMyPanel } from './my-panel.plugin'
   // ... å…¶ä»–é¢æ¿æ’ä»¶å¯¼å…¥
   
   export function registerAllPanelPlugins() {
     // ...
     registerMyPanel()  // æ·»åŠ è¿™ä¸€è¡Œ
   }
   ```

---

## ğŸ“ å‘½ä»¤å®šä¹‰é€ŸæŸ¥

```typescript
interface Command {
  id: string                           // 'category.action' (å¿…éœ€)
  label: string                        // 'æ˜¾ç¤ºæ–‡æœ¬' (å¿…éœ€)
  category: CommandCategory            // 'view'|'file'|'edit'|'navigate'|'tools'|'custom' (å¿…éœ€)
  action: () => void | Promise<void>   // æ‰§è¡Œå‡½æ•° (å¿…éœ€)
  icon?: string                        // Element Plus icon name
  keywords?: string[]                  // ['æœç´¢', 'keyword']
  shortcut?: string                    // 'Ctrl+S' (ä»…å±•ç¤º)
  priority?: number                    // æ•°å€¼è¶Šå¤§è¶Šé å‰
  when?: () => boolean                 // æ˜¾ç¤ºæ¡ä»¶ (åœ¨å‘½ä»¤é¢æ¿ä¸­æ˜¯å¦å¯è§)
}
```

**ç¤ºä¾‹**:
```typescript
{
  id: 'file.save',
  label: 'ä¿å­˜æ–‡ä»¶',
  category: 'file',
  keywords: ['save', 'ä¿å­˜', 'ctrl+s'],
  shortcut: 'Ctrl+S',
  priority: 100,
  action: async () => {
    const markdownStore = useStateRegistryService().getStore('markdownStore')
    if (markdownStore) {
      await markdownStore.saveFile()
    }
  },
  when: () => {
    const markdownStore = useStateRegistryService().getStore('markdownStore')
    return !!markdownStore?.hasUnsavedChanges
  }
}
```

---

## ğŸ“ é¢æ¿å®šä¹‰é€ŸæŸ¥

```typescript
interface RightSidebarPanel {
  id: string                    // å”¯ä¸€æ ‡è¯† (å¿…éœ€)
  label: string                 // æ ‡ç­¾æ–‡æœ¬ (å¿…éœ€)
  component: Component          // Vueç»„ä»¶ (å¿…éœ€)
  icon?: string                 // Element Plus icon name
  closable?: boolean            // æ˜¯å¦å¯å…³é—­ (é»˜è®¤ true)
  order?: number                // æ’åºæƒé‡ (æ•°å€¼è¶Šå°è¶Šé å‰)
  when?: () => boolean          // æ˜¾ç¤ºæ¡ä»¶ (åœ¨å³ä¾§æ ä¸­æ˜¯å¦å¯è§)
}
```

**ç¤ºä¾‹**:
```typescript
{
  id: 'outline',
  label: 'å¤§çº²',
  icon: 'List',
  closable: true,
  order: 1,
  component: defineAsyncComponent(() => 
    import('@components/ProjectPage.Shell/RightSidebar/panels/OutlinePanel.vue')
  ),
  when: () => {
    const markdownStore = useStateRegistryService().getStore('markdownStore')
    return !!markdownStore?.hasOpenFile
  }
}
```

---

## ğŸ”— API é€ŸæŸ¥

### å‘½ä»¤ API

```typescript
import { commandApi } from '@service/CommandPanelRightSidebar/command.api'

// æ³¨å†Œå‘½ä»¤
commandApi.register(command)
commandApi.registerBatch([command1, command2])

// æ‰§è¡Œå‘½ä»¤
await commandApi.execute('command.id')

// æ§åˆ¶é¢æ¿
commandApi.open()
commandApi.close()
commandApi.toggle()

// æŸ¥è¯¢
commandApi.getAvailableCommands()
commandApi.findCommand('command.id')
```

### å³ä¾§æ  API

```typescript
import { rightSidebarApi } from '@service/CommandPanelRightSidebar/rightSidebar.api'

// æ³¨å†Œé¢æ¿
rightSidebarApi.register(panel)

// åˆ‡æ¢é¢æ¿
rightSidebarApi.switchTo('panel-id')
rightSidebarApi.switchToNext()
rightSidebarApi.switchToPrev()

// æ˜¾ç¤ºæ§åˆ¶
rightSidebarApi.show()
rightSidebarApi.hide()
rightSidebarApi.toggle()
rightSidebarApi.setWidth('300px')

// æŸ¥è¯¢
rightSidebarApi.getAvailablePanels()
rightSidebarApi.getActivePanel()
rightSidebarApi.findPanel('panel-id')
```

### çŠ¶æ€æ³¨å†ŒæœåŠ¡ (StateRegistryService)

```typescript
import { useStateRegistryService } from '@utils/Plugins/StateRegistryService'
import { useMarkdownStore } from '@stores/projectPage/Markdown/markdown.store'

// åœ¨åº”ç”¨å¯åŠ¨æ—¶æ³¨å†Œ Store
// (é€šå¸¸åœ¨ Client/GUI/Index/ProjectPageSystem.vue ä¸­è°ƒç”¨)
const stateRegistry = useStateRegistryService()
stateRegistry.registerStore('markdownStore', useMarkdownStore())

// åœ¨æ’ä»¶ä¸­è·å– Store å®ä¾‹
const markdownStore = stateRegistry.getStore('markdownStore')
if (markdownStore) {
  console.log(markdownStore.activeTab)
}

// æ³¨æ„ï¼šä¸ºäº†è·¨çª—å£éš”ç¦»ï¼ŒStateRegistryService ä¼šæ ¹æ®å½“å‰çª—å£ ID è‡ªåŠ¨ç®¡ç† Store å®ä¾‹ã€‚
```

---

## ğŸ“ å…³é”®æ–‡ä»¶ä½ç½®

| åŠŸèƒ½ | è·¯å¾„ |
|------|------|
| **å‘½ä»¤æ’ä»¶æ³¨å†Œ** | `Client/Utils/Plugins/commands/index.ts` |
| **é¢æ¿æ’ä»¶æ³¨å†Œ** | `Client/Utils/Plugins/panels/index.ts` |
| **å‘½ä»¤é¢æ¿ API** | `Client/Service/CommandPanelRightSidebar/command.api.ts` |
| **å³ä¾§æ  API** | `Client/Service/CommandPanelRightSidebar/rightSidebar.api.ts` |
| **çŠ¶æ€æ³¨å†ŒæœåŠ¡** | `Client/Utils/Plugins/StateRegistryService.ts` |
| **å‘½ä»¤é¢æ¿ç»„ä»¶** | `Client/GUI/components/ProjectPage.Shell/CommandPalette.vue` |
| **å³ä¾§æ å®¹å™¨ç»„ä»¶** | `Client/GUI/components/ProjectPage.Shell/RightSidebar.vue` |
| **å³ä¾§æ é¢æ¿ç»„ä»¶** | `Client/GUI/components/ProjectPage.Shell/RightSidebar/panels/` |
| **æ ¸å¿ƒ Pinia Store (å‘½ä»¤)** | `Client/stores/projectPage/commandPalette/commandPalette.store.ts` |
| **æ ¸å¿ƒ Pinia Store (å³ä¾§æ )** | `Client/stores/projectPage/rightSidebar/rightSidebar.store.ts` |
| **ä¸»åº”ç”¨å…¥å£ (æ’ä»¶åˆå§‹åŒ–)** | `Client/GUI/Index/ProjectPageSystem.vue` |

---

## ğŸ¨ å¸¸ç”¨ Element Plus å›¾æ ‡

```
Document, Folder, FolderOpened, Files, 
Edit, Delete, Plus, Minus, Close, 
Search, View, Hide, Setting,
ArrowLeft, ArrowRight, ArrowUp, ArrowDown,
Check, Warning, InfoFilled, List, Grid, Monitor, Connection
```

[å®Œæ•´å›¾æ ‡åˆ—è¡¨](https://element-plus.org/zh-CN/component/icon.html)

---

## ğŸ› è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹å·²æ³¨å†Œçš„å‘½ä»¤
```typescript
import { useCommandPaletteStore } from '@stores/projectPage/commandPalette/commandPalette.store'

const store = useCommandPaletteStore()
console.log('æ‰€æœ‰å‘½ä»¤:', store.commands)
console.log('å¯ç”¨å‘½ä»¤:', store.availableCommands)
```

### 2. æŸ¥çœ‹å·²æ³¨å†Œçš„é¢æ¿
```typescript
import { useRightSidebarStore } from '@stores/projectPage/rightSidebar/rightSidebar.store'

const store = useRightSidebarStore()
console.log('æ‰€æœ‰é¢æ¿:', store.panels)
console.log('å¯ç”¨é¢æ¿:', store.availablePanels)
```

### 3. æ’ä»¶æ³¨å†Œæ—¥å¿—
ç¡®ä¿æ§åˆ¶å°çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š
```
[ProjectPageSystem] Registering all plugins...
[Plugin] Outline panel registered
[Plugin] View commands registered
[ProjectPageSystem] All plugins registered successfully
```

### 4. è·¨çª—å£è°ƒè¯•
å¯¹äºæ‹†åˆ†åˆ°æ–°çª—å£çš„æ ‡ç­¾é¡µï¼Œå…¶æ¸²æŸ“è¿›ç¨‹æ˜¯ç‹¬ç«‹çš„ã€‚å¯ä»¥é€šè¿‡ Electron DevTools çš„ `View -> Toggle Developer Tools -> Detached` é€‰é¡¹æ¥è°ƒè¯•å¯¹åº”çš„çª—å£ã€‚

---

## âš ï¸ å¸¸è§é”™è¯¯

| é”™è¯¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| å‘½ä»¤æˆ–é¢æ¿ä¸æ˜¾ç¤º | `when()` è¿”å› `false` | æ£€æŸ¥æ¡ä»¶é€»è¾‘ |
| ç»„ä»¶åŠ è½½å¤±è´¥ | ç»„ä»¶è·¯å¾„é”™è¯¯ | æ£€æŸ¥ `import()` è·¯å¾„ |
| API è°ƒç”¨å¤±è´¥ | æœªåœ¨ Vue ä¸Šä¸‹æ–‡ä¸­æˆ– StateRegistry ä¸­æœªæ³¨å†Œ | ç¡®ä¿åœ¨ç»„ä»¶æˆ–æ’ä»¶ä¸­è°ƒç”¨ `useStateRegistryService()` å¹¶å·²æ³¨å†Œç›¸åº” Store |
| Store è®¿é—®å¤±è´¥ | åœ¨æ¨¡å—é¡¶å±‚è°ƒç”¨ `useXxxStore()` | æ”¹ä¸ºåœ¨å‡½æ•°å†…éƒ¨è°ƒç”¨ `useStateRegistryService().getStore('yourStore')` |

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [æ¶æ„è®¾è®¡æ€»è§ˆ](./æ¶æ„è®¾è®¡æ€»è§ˆ.md)
- [Markdownç¼–è¾‘ç³»ç»Ÿè®¾è®¡æ–‡æ¡£](./Markdownç¼–è¾‘ç³»ç»Ÿè®¾è®¡æ–‡æ¡£.md)
- [Paneåˆ†å±ç³»ç»Ÿè®¾è®¡æ–‡æ¡£](./Paneåˆ†å±ç³»ç»Ÿè®¾è®¡æ–‡æ¡£.md)
- [æ–‡ä»¶ç³»ç»Ÿä¸é¡¹ç›®ç»“æ„è®¾è®¡æ–‡æ¡£](./æ–‡ä»¶ç³»ç»Ÿä¸é¡¹ç›®ç»“æ„è®¾è®¡æ–‡æ¡£.md)
- [å¤šçª—å£ç³»ç»Ÿè®¾è®¡æ–‡æ¡£](./å¤šçª—å£ç³»ç»Ÿè®¾è®¡æ–‡æ¡£.md)
- [å‘½ä»¤é¢æ¿ä¸å³æ ç³»ç»Ÿå¼€å‘æŒ‡å—.md](../Workflow/å‘½ä»¤é¢æ¿ä¸å³æ ç³»ç»Ÿå¼€å‘æŒ‡å—.md)
- [å‘½ä»¤é¢æ¿ä¸å³æ é‡æ„/Design.md](../Design/å‘½ä»¤é¢æ¿ä¸å³æ é‡æ„/Design.md)

---

**æœ€åæ›´æ–°**: 2025å¹´10æœˆ11æ—¥  
**è´Ÿè´£äºº**: Nimbria å¼€å‘å›¢é˜Ÿ

