# 命令面板与右栏系统 - 快速参考

> 快速查阅手册，详细指南请参考 [完整开发指南](../Workflow/命令面板与右栏系统开发指南.md)

---

## 📋 系统概述

Nimbria 的命令面板与右侧栏系统提供了一个高度可扩展和灵活的用户界面，允许用户通过命令面板快速执行操作，并通过可配置的右侧栏面板获取上下文信息或进行辅助操作。整个系统基于插件化架构，易于扩展和维护。

### 🎯 核心特性

- **命令面板**: 类似 VS Code 的模糊搜索命令面板，支持通过快捷键激活和执行各种操作。
- **右侧栏面板**: 可配置的、可切换的侧边栏，用于显示文件大纲、项目信息、插件工具等。
- **插件化架构**: 命令和面板均可通过插件注册，实现高度模块化和可扩展性。
- **类型安全**: 全面的 TypeScript 支持，确保开发过程中的类型一致性。
- **跨模块状态访问**: 通过 `StateRegistryService` 实现插件对核心应用状态的安全访问。

---

## 🏗️ 插件化架构

命令和右侧栏面板都通过插件机制进行注册。这种架构带来了以下优势：

- **解耦**: UI 组件和业务逻辑分离，便于独立开发和测试。
- **可维护性**: 新功能以插件形式添加，不影响核心代码。
- **灵活性**: 用户可以根据需求启用或禁用特定的命令和面板。

### 插件注册流程

```mermaid
graph TD
    A[应用启动<br/>(ProjectPageSystem.vue)] --> B{加载所有插件}
    B --> C[CommandPanelRightSidebar/command.api.ts]
    C --> D[CommandPaletteStore]
    D --> E[注册命令]
    B --> F[CommandPanelRightSidebar/rightSidebar.api.ts]
    F --> G[RightSidebarStore]
    G --> H[注册面板]
    E --> I[命令面板 UI<br/>(CommandPalette.vue)]
    H --> J[右侧栏 UI<br/>(RightSidebar.vue)]
```

---

## 🚀 5分钟上手

### 添加新命令

1. **创建插件文件** `Client/Utils/Plugins/commands/my-commands.plugin.ts`:
   ```typescript
   import { commandApi } from '@service/CommandPanelRightSidebar/command.api'
   import { useStateRegistryService } from '@utils/Plugins/StateRegistryService' // 引入状态注册服务
   
   export function registerMyCommands() {
     const stateRegistry = useStateRegistryService()
     commandApi.register({
       id: 'my.action',
       label: '我的操作',
       category: 'custom',
       action: () => {
         console.log('执行我的操作!')
         // 示例: 访问 MarkdownStore 的状态
         const markdownStore = stateRegistry.getStore('markdownStore')
         if (markdownStore) {
           console.log('当前活跃标签页:', markdownStore.activeTab?.name)
         }
       }
     })
   }
   ```

2. **注册插件** `Client/Utils/Plugins/commands/index.ts`:
   ```typescript
   import { registerMyCommands } from './my-commands.plugin'
   // ... 其他命令插件导入
   
   export function registerAllCommandPlugins() {
     // ...
     registerMyCommands()  // 添加这一行
   }
   ```

3. **测试**: `Ctrl+Shift+P` → 搜索 "我的操作"

---

### 添加新面板

1. **创建组件** `Client/GUI/components/ProjectPage.Shell/RightSidebar/panels/MyPanel.vue`:
   ```vue
   <template>
     <div class="my-panel">
       <h3>我的面板</h3>
       <p>当前活跃标签页: {{ activeTabName }}</p>
     </div>
   </template>
   
   <script setup lang="ts">
   import { computed } from 'vue'
   import { useStateRegistryService } from '@utils/Plugins/StateRegistryService'
   
   const stateRegistry = useStateRegistryService()
   const markdownStore = stateRegistry.getStore('markdownStore')
   
   const activeTabName = computed(() => markdownStore?.activeTab?.name || '无')
   </script>
   
   <style scoped>
   .my-panel { padding: 16px; }
   </style>
   ```

2. **创建插件** `Client/Utils/Plugins/panels/my-panel.plugin.ts`:
   ```typescript
   import { rightSidebarApi } from '@service/CommandPanelRightSidebar/rightSidebar.api'
   import { defineAsyncComponent } from 'vue'
   
   export function registerMyPanel() {
     rightSidebarApi.register({
       id: 'my-panel',
       label: '我的面板',
       component: defineAsyncComponent(() => 
         import('@components/ProjectPage.Shell/RightSidebar/panels/MyPanel.vue')
       )
     })
   }
   ```

3. **注册插件** `Client/Utils/Plugins/panels/index.ts`:
   ```typescript
   import { registerMyPanel } from './my-panel.plugin'
   // ... 其他面板插件导入
   
   export function registerAllPanelPlugins() {
     // ...
     registerMyPanel()  // 添加这一行
   }
   ```

---

## 📝 命令定义速查

```typescript
interface Command {
  id: string                           // 'category.action' (必需)
  label: string                        // '显示文本' (必需)
  category: CommandCategory            // 'view'|'file'|'edit'|'navigate'|'tools'|'custom' (必需)
  action: () => void | Promise<void>   // 执行函数 (必需)
  icon?: string                        // Element Plus icon name
  keywords?: string[]                  // ['搜索', 'keyword']
  shortcut?: string                    // 'Ctrl+S' (仅展示)
  priority?: number                    // 数值越大越靠前
  when?: () => boolean                 // 显示条件 (在命令面板中是否可见)
}
```

**示例**:
```typescript
{
  id: 'file.save',
  label: '保存文件',
  category: 'file',
  keywords: ['save', '保存', 'ctrl+s'],
  shortcut: 'Ctrl+S',
  priority: 100,
  action: async () => {
    const markdownStore = useStateRegistryService().getStore('markdownStore')
    if (markdownStore) {
      await markdownStore.saveFile()
    }
  },
  when: () => {
    const markdownStore = useStateRegistryService().getStore('markdownStore')
    return !!markdownStore?.hasUnsavedChanges
  }
}
```

---

## 📝 面板定义速查

```typescript
interface RightSidebarPanel {
  id: string                    // 唯一标识 (必需)
  label: string                 // 标签文本 (必需)
  component: Component          // Vue组件 (必需)
  icon?: string                 // Element Plus icon name
  closable?: boolean            // 是否可关闭 (默认 true)
  order?: number                // 排序权重 (数值越小越靠前)
  when?: () => boolean          // 显示条件 (在右侧栏中是否可见)
}
```

**示例**:
```typescript
{
  id: 'outline',
  label: '大纲',
  icon: 'List',
  closable: true,
  order: 1,
  component: defineAsyncComponent(() => 
    import('@components/ProjectPage.Shell/RightSidebar/panels/OutlinePanel.vue')
  ),
  when: () => {
    const markdownStore = useStateRegistryService().getStore('markdownStore')
    return !!markdownStore?.hasOpenFile
  }
}
```

---

## 🔗 API 速查

### 命令 API

```typescript
import { commandApi } from '@service/CommandPanelRightSidebar/command.api'

// 注册命令
commandApi.register(command)
commandApi.registerBatch([command1, command2])

// 执行命令
await commandApi.execute('command.id')

// 控制面板
commandApi.open()
commandApi.close()
commandApi.toggle()

// 查询
commandApi.getAvailableCommands()
commandApi.findCommand('command.id')
```

### 右侧栏 API

```typescript
import { rightSidebarApi } from '@service/CommandPanelRightSidebar/rightSidebar.api'

// 注册面板
rightSidebarApi.register(panel)

// 切换面板
rightSidebarApi.switchTo('panel-id')
rightSidebarApi.switchToNext()
rightSidebarApi.switchToPrev()

// 显示控制
rightSidebarApi.show()
rightSidebarApi.hide()
rightSidebarApi.toggle()
rightSidebarApi.setWidth('300px')

// 查询
rightSidebarApi.getAvailablePanels()
rightSidebarApi.getActivePanel()
rightSidebarApi.findPanel('panel-id')
```

### 状态注册服务 (StateRegistryService)

```typescript
import { useStateRegistryService } from '@utils/Plugins/StateRegistryService'
import { useMarkdownStore } from '@stores/projectPage/Markdown/markdown.store'

// 在应用启动时注册 Store
// (通常在 Client/GUI/Index/ProjectPageSystem.vue 中调用)
const stateRegistry = useStateRegistryService()
stateRegistry.registerStore('markdownStore', useMarkdownStore())

// 在插件中获取 Store 实例
const markdownStore = stateRegistry.getStore('markdownStore')
if (markdownStore) {
  console.log(markdownStore.activeTab)
}

// 注意：为了跨窗口隔离，StateRegistryService 会根据当前窗口 ID 自动管理 Store 实例。
```

---

## 📁 关键文件位置

| 功能 | 路径 |
|------|------|
| **命令插件注册** | `Client/Utils/Plugins/commands/index.ts` |
| **面板插件注册** | `Client/Utils/Plugins/panels/index.ts` |
| **命令面板 API** | `Client/Service/CommandPanelRightSidebar/command.api.ts` |
| **右侧栏 API** | `Client/Service/CommandPanelRightSidebar/rightSidebar.api.ts` |
| **状态注册服务** | `Client/Utils/Plugins/StateRegistryService.ts` |
| **命令面板组件** | `Client/GUI/components/ProjectPage.Shell/CommandPalette.vue` |
| **右侧栏容器组件** | `Client/GUI/components/ProjectPage.Shell/RightSidebar.vue` |
| **右侧栏面板组件** | `Client/GUI/components/ProjectPage.Shell/RightSidebar/panels/` |
| **核心 Pinia Store (命令)** | `Client/stores/projectPage/commandPalette/commandPalette.store.ts` |
| **核心 Pinia Store (右侧栏)** | `Client/stores/projectPage/rightSidebar/rightSidebar.store.ts` |
| **主应用入口 (插件初始化)** | `Client/GUI/Index/ProjectPageSystem.vue` |

---

## 🎨 常用 Element Plus 图标

```
Document, Folder, FolderOpened, Files, 
Edit, Delete, Plus, Minus, Close, 
Search, View, Hide, Setting,
ArrowLeft, ArrowRight, ArrowUp, ArrowDown,
Check, Warning, InfoFilled, List, Grid, Monitor, Connection
```

[完整图标列表](https://element-plus.org/zh-CN/component/icon.html)

---

## 🐛 调试技巧

### 1. 查看已注册的命令
```typescript
import { useCommandPaletteStore } from '@stores/projectPage/commandPalette/commandPalette.store'

const store = useCommandPaletteStore()
console.log('所有命令:', store.commands)
console.log('可用命令:', store.availableCommands)
```

### 2. 查看已注册的面板
```typescript
import { useRightSidebarStore } from '@stores/projectPage/rightSidebar/rightSidebar.store'

const store = useRightSidebarStore()
console.log('所有面板:', store.panels)
console.log('可用面板:', store.availablePanels)
```

### 3. 插件注册日志
确保控制台看到以下日志：
```
[ProjectPageSystem] Registering all plugins...
[Plugin] Outline panel registered
[Plugin] View commands registered
[ProjectPageSystem] All plugins registered successfully
```

### 4. 跨窗口调试
对于拆分到新窗口的标签页，其渲染进程是独立的。可以通过 Electron DevTools 的 `View -> Toggle Developer Tools -> Detached` 选项来调试对应的窗口。

---

## ⚠️ 常见错误

| 错误 | 原因 | 解决方案 |
|------|------|----------|
| 命令或面板不显示 | `when()` 返回 `false` | 检查条件逻辑 |
| 组件加载失败 | 组件路径错误 | 检查 `import()` 路径 |
| API 调用失败 | 未在 Vue 上下文中或 StateRegistry 中未注册 | 确保在组件或插件中调用 `useStateRegistryService()` 并已注册相应 Store |
| Store 访问失败 | 在模块顶层调用 `useXxxStore()` | 改为在函数内部调用 `useStateRegistryService().getStore('yourStore')` |

---

## 📖 相关文档

- [架构设计总览](./架构设计总览.md)
- [Markdown编辑系统设计文档](./Markdown编辑系统设计文档.md)
- [Pane分屏系统设计文档](./Pane分屏系统设计文档.md)
- [文件系统与项目结构设计文档](./文件系统与项目结构设计文档.md)
- [多窗口系统设计文档](./多窗口系统设计文档.md)
- [命令面板与右栏系统开发指南.md](../Workflow/命令面板与右栏系统开发指南.md)
- [命令面板与右栏重构/Design.md](../Design/命令面板与右栏重构/Design.md)

---

**最后更新**: 2025年10月11日  
**负责人**: Nimbria 开发团队

