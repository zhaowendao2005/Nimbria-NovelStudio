# Nimbria 多窗口系统设计文档

## 系统设计思想

### 核心理念：进程级隔离的多窗口架构

Nimbria 采用 **专家模式的多进程窗口架构**，实现真正的进程级隔离。每个项目窗口运行在独立的渲染进程中，确保：

- **稳定性保障**：单个项目崩溃不影响其他项目或主窗口
- **性能优化**：充分利用多核 CPU，每个进程独立运行
- **资源隔离**：内存、状态、插件环境完全独立
- **安全性增强**：进程间通信受控，避免意外的数据泄露

### 设计原则

1. **封装复杂性**：提供简洁的 API，开发者无需关心多窗口底层实现
2. **类型安全**：全面的 TypeScript 支持，编译时错误检查
3. **渐进增强**：支持单窗口到多窗口的平滑迁移
4. **可扩展性**：模块化设计，易于添加新功能

## 架构分层

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (Frontend)                     │
│  Vue3 + Quasar + Pinia + TypeScript                        │
│  ├─ 主窗口界面 (项目选择、设置)                               │
│  └─ 项目窗口界面 (编辑器、工具面板)                           │
└─────────────────────────────────────────────────────────────┘
                             ↕ IPC (类型安全)
┌─────────────────────────────────────────────────────────────┐
│                      预加载层 (Preload)                      │
│  安全的 API 桥接 (contextBridge)                            │
│  ├─ 主窗口预加载脚本                                         │
│  └─ 项目窗口预加载脚本                                       │
└─────────────────────────────────────────────────────────────┘
                             ↕ MessagePort 通信
┌─────────────────────────────────────────────────────────────┐
│                       主进程层 (Main)                        │
│  进程管理 + 窗口管理 + IPC 路由                               │
│  ├─ 应用管理器 (生命周期控制)                                 │
│  ├─ 窗口管理器 (多窗口抽象)                                   │
│  ├─ 进程管理器 (进程创建与销毁)                               │
│  ├─ 消息路由器 (进程间通信)                                   │
│  └─ 数据持久化 (状态保存)                                     │
└─────────────────────────────────────────────────────────────┘
```

## 文件架构指导

### 目录组织原则

#### 主进程相关 (`src-electron/`)
```
src-electron/
├── core/                    # 核心应用逻辑
│   ├── app-manager.ts       # 应用生命周期管理
│   ├── main-preload.ts      # 主窗口预加载脚本
│   └── project-preload.ts   # 项目窗口预加载脚本
├── services/                # 核心服务模块
│   └── window-service/      # 窗口管理服务
│       ├── process-manager.ts    # 进程创建与管理
│       ├── message-router.ts     # 消息路由
│       └── window-manager.ts     # 窗口管理抽象
├── store/                   # 数据持久化
│   └── recent-projects-store.ts  # 最近项目存储
├── types/                   # 主进程类型定义
│   ├── process.ts           # 进程相关类型
│   ├── window.ts            # 窗口配置类型
│   └── ipc.ts               # IPC 通道定义
└── ipc/                     # IPC 处理器
    └── main-renderer/       # 主进程-渲染进程通信
```

#### 前端相关 (`Client/`)
```
Client/
├── Types/                   # 前端类型定义
│   ├── window.d.ts          # 🎯 API 接口定义与调用示例
│   └── project.ts           # 业务实体类型
├── stores/                  # Pinia 状态管理
│   └── projectSelection.ts  # 项目选择逻辑
├── GUI/                     # Vue 组件
│   ├── layouts/             # 布局组件
│   ├── components/          # 通用组件
│   └── pages/               # 页面组件
└── Service/                 # 业务逻辑服务
```

### 新功能开发指导

#### 添加新的 API 功能
1. **类型定义**：在 `Client/Types/window.d.ts` 中添加接口定义和详细注释
2. **IPC 通道**：在 `src-electron/types/ipc.ts` 中定义通信协议
3. **主进程处理**：在 `src-electron/core/app-manager.ts` 中注册 IPC 处理器
4. **预加载暴露**：在相应的 preload 脚本中暴露 API
5. **前端调用**：在 Store 或组件中使用 `window.nimbria.*` API

#### 添加新的窗口类型
1. **类型扩展**：在 `src-electron/types/process.ts` 中扩展 `WindowType`
2. **模板定义**：在 `src-electron/types/window.ts` 中定义窗口模板
3. **管理器扩展**：在 `ProcessManager` 中添加创建方法
4. **预加载脚本**：创建专用的 preload 脚本

#### 添加新的存储功能
1. **存储模块**：在 `src-electron/store/` 下创建专用存储模块
2. **类型定义**：定义数据架构和操作接口
3. **服务集成**：在相应服务中集成存储逻辑

## 核心通信机制

### IPC 通信流程
```
前端调用 → contextBridge → ipcRenderer.invoke → ipcMain.handle → 主进程处理 → 返回结果
```

### MessagePort 通信流程
```
渲染进程 → MessagePort → MessageChannelMain → MessageRouter → 目标进程
```

## 开发最佳实践

### 类型安全开发
- **查看接口定义**：所有 API 的详细说明和调用示例都在 `Client/Types/window.d.ts` 中
- **遵循类型约束**：使用 TypeScript 的严格模式，确保类型安全
- **利用 IDE 提示**：通过 `.d.ts` 文件获得完整的智能提示

### 错误处理
- **优雅降级**：所有 API 调用都应包含错误处理逻辑
- **用户反馈**：使用 Quasar Notify 提供友好的错误提示
- **日志记录**：在主进程和渲染进程中记录关键操作

### 性能考虑
- **避免频繁 IPC**：批量处理相关操作
- **使用 MessagePort**：对于高频通信使用 MessagePort 而非 IPC
- **内存管理**：及时清理事件监听器和对象引用

## 扩展点识别

### 当前可扩展的功能点
1. **窗口模板系统**：支持自定义窗口配置
2. **插件架构**：通过 Worker 线程加载插件
3. **状态持久化**：可扩展的存储适配器模式
4. **消息广播**：支持自定义消息类型和处理器

### 未来增强方向
1. **窗口布局管理**：支持窗口停靠、分割视图
2. **跨项目协作**：项目间的数据共享和同步
3. **插件生态**：完善的插件开发和管理系统
4. **性能监控**：进程资源使用情况监控

## 学习路径

### 快速上手
1. **阅读 `Client/Types/window.d.ts`**：了解所有可用的 API 和调用方式
2. **查看 `Client/stores/projectSelection.ts`**：学习实际的 API 使用模式
3. **研究 `src-electron/core/app-manager.ts`**：理解主进程的 IPC 处理逻辑

### 深入理解
1. **进程管理**：研究 `ProcessManager` 的窗口创建和生命周期管理
2. **通信机制**：了解 `MessageRouter` 的消息路由实现
3. **类型系统**：掌握整个系统的 TypeScript 类型架构

---

**📝 重要提醒**: 
- 所有 API 的详细使用方法和示例代码都在 `Client/Types/window.d.ts` 中
- 开发时优先查阅该文件，避免重复实现已有功能
- 新增功能时遵循现有的架构模式，确保系统的一致性
