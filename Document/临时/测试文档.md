🧪 LLM翻译系统完整测试计划
📋 测试环境准备
前置条件
✅ 应用已启动
✅ 已有至少一个配置好的LLM模型（如Claude、GPT-4等）
✅ 准备测试文本（建议：100-500字的中英文混合文本）
🎯 测试模块 1：Token换算配置系统
测试用例 1.1：查看默认Token配置
目的: 验证数据库迁移和默认配置初始化
操作步骤:
创建一个新批次或打开现有批次
点击批次右侧的"配置"按钮，打开SchedulerConfigDrawer
切换到 "Token估算" Tab
预期结果:
✅ 看到4个默认配置：
通用配置（平衡）- 中文2.5:1, ASCII 1.0:1
Gemini中文优化 - 中文4.0:1, ASCII 1.0:1
Claude优化 - 中文2.0:1, ASCII 0.8:1
OpenAI优化 - 中文2.0:1, ASCII 1.0:1
✅ 当前选中的配置有高亮显示
测试用例 1.2：创建自定义Token配置
目的: 验证CRUD中的Create功能
操作步骤:
在"Token估算"Tab中，点击 "创建新配置" 按钮
在弹出的对话框中填写：
配置名称：测试配置A
中文比例：3.0
ASCII比例：1.5
描述：这是测试用的配置
在测试区域输入混合文本：Hello世界测试123
观察实时Token估算结果
点击 "创建" 按钮
预期结果:
✅ 实时显示字符统计（中文字符数、ASCII字符数）
✅ 实时显示估算的token数
✅ 创建成功后显示成功提示
✅ 配置列表中出现新配置"测试配置A"
✅ 后端控制台输出创建日志
测试用例 1.3：切换Token配置
目的: 验证配置选择和保存
操作步骤:
在"Token估算"Tab的配置列表中，点击选择 "Gemini中文优化"
点击抽屉底部的 "保存" 按钮
关闭配置抽屉，重新打开
切换到"Token估算"Tab
预期结果:
✅ 保存后无报错
✅ 重新打开后，"Gemini中文优化"仍然被选中
✅ 后端控制台显示批次配置更新日志
测试用例 1.4：删除Token配置
目的: 验证CRUD中的Delete功能
操作步骤:
在"Token估算"Tab中，找到刚才创建的"测试配置A"
点击右侧的 "删除" 按钮
观察列表变化
预期结果:
✅ 删除成功提示
✅ "测试配置A"从列表中消失
✅ 后端控制台显示删除日志
⚠️ 边界测试：尝试删除正在使用的配置（应该能删，但可能会有警告）
🎯 测试模块 2：三层超时控制
测试用例 2.1：配置超时参数
目的: 验证超时配置UI和保存
操作步骤:
打开配置抽屉，切换到 "超时控制" Tab
查看当前配置的默认值
修改以下参数：
Layer 3 任务总超时：120 秒（2分钟）
Layer 2a HTTP超时：60 秒（1分钟）
Layer 2b 首字超时：30 秒
Layer 2b 空闲超时：20 秒
点击 "保存"
预期结果:
✅ 所有输入框接受有效范围内的值
✅ 超出范围时输入框变红/显示错误
✅ 保存成功提示
✅ 重新打开后值被正确保存
测试用例 2.2：测试HTTP超时（非流式）
目的: 验证Layer 2a HTTP超时生效
操作步骤:
在"请求控制"Tab中，关闭 "启用流式响应"
设置HTTP超时为 30 秒
保存配置
创建一个任务，选择一个响应慢的模型或故意触发超时
点击"发送任务"
观察30秒后的行为
预期结果:
✅ 任务状态变为 error
✅ 错误类型显示为 TIMEOUT_HTTP
✅ 错误信息：TIMEOUT: HTTP请求超时（主动关闭连接）
✅ 后端控制台显示HTTP超时日志
✅ 任务可以手动重试
测试用例 2.3：测试流式首字超时
目的: 验证Layer 2b首字超时生效
操作步骤:
在"请求控制"Tab中，启用 "启用流式响应"
设置首字超时为 10 秒
设置空闲超时为 60 秒（足够大）
保存配置
创建任务并发送（使用响应慢的模型）
观察超过10秒仍未收到第一个token时的行为
预期结果:
✅ 任务标记为 error
✅ 错误类型：TIMEOUT_FIRST_TOKEN
✅ 错误信息：TIMEOUT: 等待首个token超时（主动关闭连接）
✅ 控制台显示首字超时日志
测试用例 2.4：测试流式空闲超时
目的: 验证Layer 2b空闲超时生效
操作步骤:
启用流式响应
设置空闲超时为 5 秒
设置首字超时为 60 秒（足够大）
发送任务
观察：如果流式响应中途停顿超过5秒
预期结果:
✅ 任务标记为 error
✅ 错误类型：TIMEOUT_IDLE
✅ 错误信息：TIMEOUT: 流式响应空闲超时（主动关闭连接）
测试用例 2.5：测试任务总超时（兜底）
目的: 验证Layer 3任务总超时（最高优先级）
操作步骤:
设置任务总超时为 60 秒
设置HTTP超时为 120 秒（故意设大）
发送一个会超时的任务
观察60秒后的行为
预期结果:
✅ 60秒后任务标记为 error
✅ 错误类型：TIMEOUT_TOTAL
✅ 错误信息：TIMEOUT: 任务总超时（兜底）
✅ 任务可以手动重试（这是关键！）
🎯 测试模块 3：调度策略（event vs timed）
测试用例 3.1：事件驱动模式（event）
目的: 验证事件驱动调度
操作步骤:
打开配置抽屉，切换到 "调度策略" Tab
选择 "事件驱动（event）"
保存配置
创建10个任务
设置并发数为 3
点击"发送任务"
观察任务发送行为
预期结果:
✅ 任务立即开始执行（不等待定时器）
✅ 当一个任务完成时，立即触发下一个任务
✅ 始终保持3个并发任务在执行
✅ 后端控制台显示：📋 调度策略: event
✅ 无定时器相关日志
测试用例 3.2：定时调度模式（timed）
目的: 验证定时调度和间隔配置
操作步骤:
打开配置抽屉，切换到"调度策略"Tab
选择 "定时调度（timed）"
设置调度间隔为 3 秒
保存配置
创建10个任务
设置并发数为 2
点击"发送任务"
观察任务发送的时间间隔
预期结果:
✅ 任务不是立即全部发出
✅ 每隔3秒触发一次任务发送
✅ 后端控制台显示：
✅ 即使有任务完成，也要等到下一个3秒间隔才发送新任务
测试用例 3.3：调度间隔边界测试
目的: 验证间隔范围限制（1-10秒）
操作步骤:
在"调度策略"Tab中选择timed模式
尝试设置间隔为 0.5 秒
尝试设置间隔为 15 秒
设置间隔为 1 秒（最小值）
设置间隔为 10 秒（最大值）
预期结果:
✅ 输入框限制范围为1-10秒
✅ 超出范围时有错误提示
✅ 后端自动将越界值钳制到1-10秒范围内
✅ 控制台日志显示实际使用的间隔值
🎯 测试模块 4：错误分类和信息展示
测试用例 4.1：限流错误（RATE_LIMIT）
目的: 验证429错误的特殊处理
操作步骤:
发送大量任务（超过API限流阈值）
观察错误状态和类型
预期结果:
✅ 错误类型显示为 RATE_LIMIT
✅ 错误信息包含 服务器限流 或 429
✅ 调度器自动暂停（进入限流探测模式）
✅ 限流探测恢复后自动继续
测试用例 4.2：API错误分类
目的: 验证不同HTTP状态码的分类
操作步骤:
使用无效的API密钥（触发401/403）
使用不存在的模型（触发404）
发送格式错误的请求（触发400）
预期结果:
✅ 错误类型：API_ERROR
✅ 错误信息包含具体的HTTP状态码
✅ 错误消息清晰描述问题
测试用例 4.3：连接关闭错误
目的: 验证服务器主动关闭连接的处理
操作步骤:
发送任务（触发服务器关闭连接，如网络中断）
观察错误分类
预期结果:
✅ 错误类型：CONNECTION_CLOSED
✅ 错误信息：CONNECTION: 服务器关闭连接
🎯 测试模块 5：Token估算实际应用
测试用例 5.1：Token估算影响进度条
目的: 验证Token配置实际用于任务估算
操作步骤:
创建批次时，选择Token配置为 "Gemini中文优化"（4:1）
输入测试文本（纯中文400字）
观察任务列表中的预估token
切换到 "通用配置"（2.5:1）
重新创建相同文本的任务
对比两次的预估token数
预期结果:
✅ Gemini配置：约100 tokens（400÷4）
✅ 通用配置：约160 tokens（400÷2.5）
✅ 进度条基于不同的估算显示不同的进度
✅ 后端日志显示使用的配置ID和估算结果
测试用例 5.2：混合文本估算准确性
目的: 验证中文和ASCII分别计算
操作步骤:
使用通用配置（中文2.5:1, ASCII 1.0:1）
创建任务，输入：Hello世界123测试ABC
观察实时估算
预期结果:
✅ 中文字符：4个（世界测试）
✅ ASCII字符：11个（Hello123ABC + 空格）
✅ 估算token：约 4/2.5 + 11/1.0 = 1.6 + 11 ≈ 13 tokens
✅ 后端控制台显示字符分类统计
🎯 测试模块 6：配置持久化和切换批次
测试用例 6.1：批次间配置独立性
目的: 验证不同批次可以有不同配置
操作步骤:
创建批次A，配置：
Token配置：Gemini中文优化
超时：任务总超时120秒
调度策略：event
创建批次B，配置：
Token配置：Claude优化
超时：任务总超时300秒
调度策略：timed（间隔5秒）
在批次A和B之间切换
每次切换后打开配置抽屉查看
预期结果:
✅ 批次A始终显示Gemini配置
✅ 批次B始终显示Claude配置
✅ 各批次的超时和调度配置互不影响
✅ 配置存储在数据库的config_json字段
测试用例 6.2：重启应用后配置恢复
目的: 验证配置持久化
操作步骤:
配置一个批次，使用特殊的配置组合
发送一些任务
关闭应用
重新启动应用
打开同一批次，查看配置
预期结果:
✅ 所有配置项保持不变
✅ Token配置选择被恢复
✅ 超时配置被恢复
✅ 调度策略被恢复
🎯 测试模块 7：流式 vs 非流式控制
测试用例 7.1：启用流式响应
目的: 验证流式模式的实时显示
操作步骤:
在"请求控制"Tab中，启用 "启用流式响应"
保存配置
发送任务
观察任务面板中的翻译内容
预期结果:
✅ 翻译内容一点一点地出现（实时流式输出）
✅ 进度条平滑增长
✅ 后端控制台显示流式日志：
测试用例 7.2：关闭流式响应
目的: 验证非流式模式的整体返回
操作步骤:
在"请求控制"Tab中，关闭 "启用流式响应"
保存配置
发送任务
观察任务面板中的翻译内容
预期结果:
✅ 等待一段时间后，翻译内容突然全部出现
✅ 进度条从0%跳到100%
✅ 后端控制台显示非流式日志：
🎯 测试模块 8：综合场景测试
测试用例 8.1：高并发 + 限流恢复
目的: 综合测试调度、限流、重试
操作步骤:
配置：
调度策略：event
并发数：5
Token配置：通用配置
启用流式
创建50个任务