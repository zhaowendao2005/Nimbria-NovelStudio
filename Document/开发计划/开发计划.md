# 📊 LLM Translate 开发计划

## 🎯 项目现状

1. [x] 完成标签页跨面板的拖拽 
2. [x] 完成标签页拖出作为独立的窗口
3. [ ] 项目页实现调出homepage窗口
4. [x] 修复项目页缓存导致多面板异常的问题

---

## 📁 文件架构修改树

完整的开发流程分为 8 个优先级，涉及前后端共 15+ 个文件的修改和新增。下面是详细的修改清单：

### **第一层：新增核心服务模块**

```
Nimbria/src-electron/services/llm-translate-service/
│
├── [新增文件] llm-translation-client.ts
│   └── 内部模块：
│       ├── LlmTranslationClient 类
│       │   ├── constructor(config, llmConfigManager)
│       │   ├── translateStream(request, callbacks) - 流式翻译执行
│       │   ├── translate(request) - 非流式翻译执行
│       │   ├── initClient() - LangChain 客户端初始化
│       │   ├── getModelConfig(modelId) - 获取模型配置
│       │   ├── estimateTokens(text) - Token 快速估算
│       │   ├── countTokensAccurate(text) - Token 精确计算
│       │   ├── calculateCost(inputTokens, outputTokens) - 费用计算
│       │   └── classifyError(error) - 错误分类
│       └── 事件发射：translation:start, translation:progress, translation:complete, translation:error
│
├── [新增文件] task-state-manager.ts
│   └── 内部模块：
│       ├── TaskStateManager 类
│       │   ├── setProjectDatabase(db) - 绑定数据库
│       │   ├── initializeTask(taskId, batchId, estimatedTokens) - 初始化任务状态
│       │   ├── updateState(taskId, newStatus, additionalData) - 更新任务状态
│       │   ├── updateProgress(taskId, chunk, currentTokens) - 更新进度（节流）
│       │   ├── markComplete(taskId, result) - 标记任务完成
│       │   ├── markError(taskId, errorType, errorMessage, retryCount) - 标记任务错误
│       │   ├── pauseTask(taskId) - 暂停任务 [新增]
│       │   ├── getState(taskId) - 获取任务状态快照
│       │   ├── getBatchStates(batchId) - 获取批次所有任务状态
│       │   ├── cleanup(taskId) - 清理单个任务状态
│       │   ├── cleanupBatch(batchId) - 清理批次状态
│       │   ├── shouldEmitProgress(taskId) - 节流判断
│       │   ├── persistState(snapshot) - 状态持久化
│       │   ├── persistProgress(taskId, progress, currentTokens) - 进度持久化
│       │   ├── persistCompletion(taskId, result) - 完成结果持久化
│       │   └── persistError(taskId, errorType, errorMessage, retryCount) - 错误信息持久化
│       └── 事件发射：state:change, progress:update, task:complete, task:error
│
├── [修改文件] translation-executor.ts
│   └── 内部模块修改：
│       ├── TranslationExecutor 类 [修改]
│       │   ├── constructor() - 新增 taskStateManager 参数
│       │   ├── executeTasks() - 添加 TaskStateManager 初始化逻辑
│       │   ├── worker() - 添加任务暂停检查
│       │   └── executeTask() - [重构] 完全重写
│       │       ├── 步骤1：获取任务信息
│       │       ├── 步骤2：初始化任务状态（TaskStateManager）
│       │       ├── 步骤3：更新状态为 waiting
│       │       ├── 步骤4：创建 LlmTranslationClient 配置
│       │       ├── 步骤5：创建翻译客户端实例
│       │       ├── 步骤6：构建翻译请求
│       │       ├── 步骤7：执行翻译流（registerProgressHandler）
│       │       ├── 步骤8：标记任务完成（markComplete）
│       │       └── 步骤9：更新批次统计
│       └── 新增方法：classifyError()
│
├── [修改文件] llm-translate-service.ts
│   └── 内部模块修改：
│       ├── LlmTranslateService 类 [修改]
│       │   ├── initialize() - 新增：TaskStateManager 创建和初始化
│       │   ├── createBatch() - 保持不变（配置已包含在 metadata 中）
│       │   ├── getTasks() - [修改] 添加字段别名映射 ✅ 已完成
│       │   ├── getTask() - [修改] 添加字段别名映射 ✅ 已完成
│       │   ├── getBatches() - [修改] 添加字段别名映射 ✅ 已完成
│       │   ├── getBatch() - [修改] 添加字段别名映射 ✅ 已完成
│       │   ├── loadBatches() - [修改] 添加字段别名映射 ✅ 已完成
│       │   ├── handleTerminatedTasks() - [修改] 添加字段别名映射 ✅ 已完成
│       │   ├── handleRecoveryTasks() - [新增] 启动时异常任务恢复
│       │   │   ├── 查询所有 'sending' 状态的任务
│       │   │   ├── 将其转为 'error' 状态
│       │   │   └── 记录错误代码：'APP_CRASHED'
│       │   ├── pauseTask(taskId) - [新增] 暂停任务处理
│       │   ├── retryFailedTasks() - 新增或修改：集成 TaskStateManager
│       │   └── updateBatchStats() - 同步 TaskStateManager 数据到数据库
│       └── 新增属性：taskStateManager
│
├── [修改文件] types.ts
│   └── 内部模块修改：
│       ├── 导出已有类型：TranslationClientConfig, TranslationRequest, TranslationResult
│       ├── 导出已有类型：ErrorType, TranslationStreamCallbacks
│       ├── [新增] TaskStatus 类型
│       ├── [新增] TaskMetadata 接口
│       ├── [新增] Task 接口（扩展）
│       │   ├── 新增字段：errorType, errorMessage, retryCount
│       │   ├── 新增字段：metadata, metadataJson
│       │   └── 修改字段：status 的可选值
│       ├── [新增] TaskStateChangeEvent 接口
│       ├── [新增] TaskProgressUpdateEvent 接口
│       ├── [新增] TaskCompletionEvent 接口
│       └── [新增] TaskErrorEvent 接口
│
└── export-service.ts - 保持不变（逻辑不受影响）
```

---

### **第二层：前端主要页面和组件修改**

```
Nimbria/Client/GUI/DemoPage/LlmTranslate/
│
├── [新增文件] components/ModelSelector.vue
│   └── 内部模块：
│       ├── 模板部分：
│       │   ├── El-Select 下拉框（支持分组）
│       │   ├── 按提供商分组展示模型
│       │   └── 显示模型名称、提供商信息
│       ├── 脚本部分：
│       │   ├── props: modelId (v-model)
│       │   ├── data: providers 列表, selectedModel
│       │   ├── computed: groupedModels() - 按提供商分组
│       │   ├── methods:
│       │   │   ├── loadProviders() - 从 LlmConfigManager 获取
│       │   │   ├── onModelSelect(modelId) - 选择变更回调
│       │   │   └── getModelInfo(modelId) - 获取模型完整信息
│       │   └── onMounted: 初始化加载提供商列表
│       └── 样式部分：提供商分组样式
│
├── [修改文件] components/HomePage.vue
│   └── 内部模块修改：
│       ├── 模板部分 [修改]：
│       │   ├── 第 215-223 行：替换原简单下拉框
│       │   └── 新增：<ModelSelector v-model="store.modelId" />
│       ├── 脚本部分 [修改]：
│       │   ├── imports：新增 ModelSelector 组件
│       │   ├── data: 确保 modelId 数据绑定
│       │   ├── methods.createNewBatch() - 保持逻辑
│       │   │   ├── 检查 modelId 是否选择
│       │   │   └── 验证 modelId 格式（providerId.modelName）
│       │   └── methods.validateModelId() - [新增]
│       └── 样式部分：保持不变
│
├── [修改文件] components/TaskManagePage.vue
│   └── 内部模块修改：
│       ├── 模板部分 [修改]：
│       │   ├── 第 276-309 行：任务卡片 header 区域
│       │   ├── 原状态标签：<span class="status-tag">{{ task.status }}</span>
│       │   └── 新版本：
│       │   │   ├── 状态标签保持
│       │   │   ├── 新增：错误代码显示 <span v-if="task.errorType">{{ task.errorType }}</span>
│       │   │   └── 新增：暂停按钮 <button v-if="task.status === 'sending'">⏸ 暂停</button>
│       │   ├── 第 380-400 行：进度条显示 [修改]
│       │   │   ├── 原始进度计算：task.progress
│       │   │   └── 保持不变（已由后端计算）
│       │   ├── 第 310-340 行：新增进度条区域（任务卡片内）[新增]
│       │   │   ├── 位置：状态标签下方、原内容上方
│       │   │   ├── 显示条件：task.status === 'sending' 或 task.status === 'waiting'
│       │   │   ├── 进度条样式：
│       │   │   │   ├── 使用 el-progress 组件
│       │   │   │   ├── :percentage="task.progress"
│       │   │   │   ├── :stroke-width="2"
│       │   │   │   ├── 颜色根据状态：sending='#409eff', waiting='#67c23a'
│       │   │   │   └── 下方显示：task.replyTokens / task.predictedTokens tokens
│       │   │   └── 响应式更新：监听 task.progress 变化，实时同步显示
│       │   └── 第 415-440 行：任务统计区域 [修改]
│       │   │   ├── 显示当前正在执行的任务数
│       │   │   └── 显示各种状态的任务统计
│       ├── 脚本部分 [修改]：
│       │   ├── data: 新增 selectedTaskId, threadDrawerVisible
│       │   ├── computed:
│       │   │   ├── currentTask() - 获取当前选中任务 ✅ 已有
│       │   │   └── taskStatistics() - 统计各种状态的任务数 [新增]
│       │   ├── methods:
│       │   │   ├── pauseTask(taskId) - [新增]
│       │   │   │   ├── 调用 IPC 接口：ipc-invoke('pause-task', taskId)
│       │   │   │   ├── 显示确认对话框
│       │   │   │   └── 任务状态变为 'paused'
│       │   │   ├── onTaskClick(taskId) - [修改]
│       │   │   │   ├── 设置 selectedTaskId
│       │   │   │   └── 打开 ThreadDrawer（已有逻辑）
│       │   │   ├── onThreadDrawerClose() - [新增]
│       │   │   │   └── 重置 selectedTaskId
│       │   │   └── 事件监听：监听任务状态变化，实时更新列表
│       │   └── onMounted: 初始化事件监听
│       └── 样式部分：
│           ├── .status-bar 新类
│           ├── .error-code 新类（红色显示）
│           └── .btn-pause 新类（黄色警告色）
│
│       **详细样例代码：**
│       ```vue
│       <!-- 任务卡片内容示例 -->
│       <div class="task-card">
│         <!-- Header：状态和按钮 -->
│         <div class="card-header">
│           <div class="status-bar">
│             <span class="status-tag" :class="task.status">
│               {{ task.status }}
│             </span>
│             <span v-if="task.errorType" class="error-code">
│               {{ task.errorType }}
│             </span>
│             <button v-if="task.status === 'sending'" class="btn-pause">
│               ⏸ 暂停
│             </button>
│           </div>
│         </div>
│
│         <!-- 进度条区域（任务卡片内新增）[优先级 6]-->
│         <div v-if="task.status === 'sending' || task.status === 'waiting'" class="progress-section">
│           <el-progress
│             :percentage="task.progress"
│             :stroke-width="2"
│             :color="task.status === 'sending' ? '#409eff' : '#67c23a'"
│           ></el-progress>
│           <div class="progress-info">
│             {{ task.replyTokens }} / {{ task.predictedTokens }} tokens ({{ task.progress.toFixed(0) }}%)
│           </div>
│         </div>
│
│         <!-- 原有内容 -->
│         <div class="card-content">
│           <p class="task-content">{{ task.content }}</p>
│         </div>
│       </div>
│       ```
│
│       **CSS 样式：**
│       ```scss
│       .progress-section {
│         margin: 8px 0;
│         padding: 8px 0;
│         border-top: 1px solid #f0f0f0;
│         border-bottom: 1px solid #f0f0f0;
│
│         :deep(.el-progress) {
│           margin-bottom: 4px;
│         }
│
│         .progress-info {
│           font-size: 12px;
│           color: #909399;
│           text-align: right;
│           margin-top: 4px;
│         }
│       }
│       ```
│
│       **响应式特性：**
│       - ✅ 实时响应 task.progress 的变化（0-100）
│       - ✅ 基于后端计算的进度（predictedTokens vs replyTokens）
│       - ✅ 颜色区分：sending 蓝色 / waiting 绿色
│       - ✅ 自动隐藏：任务完成或失败时消失
│
├── [修改文件] components/ThreadDrawer.vue
│   └── 内部模块修改：
│       ├── 模板部分 [修改]：
│       │   ├── 第 28-79 行：配置显示区域 ✅ 已有
│       │   │   ├── 模型名称：task.metadata?.modelName
│       │   │   ├── 提供商：task.metadata?.providerId
│       │   │   ├── 系统提示词：<details> 展开显示
│       │   │   ├── 分片策略：task.metadata?.chunkStrategy
│       │   │   ├── 分片大小：task.metadata?.chunkSize
│       │   │   ├── 并发数：task.metadata?.concurrency
│       │   │   ├── 温度参数：task.metadata?.temperature
│       │   │   ├── 最大 Token：task.metadata?.maxTokens
│       │   │   └── 回复模式：task.metadata?.replyMode
│       │   ├── 第 80-120 行：状态信息区域 [修改]
│       │   │   ├── 状态标签：task.status（彩色渲染）
│       │   │   ├── 错误代码：task.errorType （红色显示）
│       │   │   ├── 错误消息：task.errorMessage
│       │   │   ├── 重试次数：task.retryCount
│       │   │   └── 进度条（实时更新）
│       │   │   │   ├── :style="{ width: task.progress + '%' }"
│       │   │   │   └── 显示百分比文本
│       │   ├── 第 121-180 行：Token 统计区域 [修改]
│       │   │   ├── 输入 Token：task.inputTokens
│       │   │   ├── 输出 Token（实际）：task.replyTokens
│       │   │   ├── 输出 Token（预测）：task.predictedTokens
│       │   │   ├── 进度百分比：(task.replyTokens / task.predictedTokens * 100).toFixed(2)%
│       │   │   └── 费用估算：task.cost
│       │   ├── 第 181-250 行：翻译结果区域 [新增]
│       │   │   ├── 原始内容：task.content
│       │   │   ├── 翻译结果：task.translation （实时更新）
│       │   │   └── 时间戳信息
│       │   │   │   ├── 发送时间：task.sentTime
│       │   │   │   ├── 完成时间：task.replyTime
│       │   │   │   └── 耗时：task.durationMs ms
│       │   └── 第 251-280 行：操作按钮区域 [新增]
│       │       ├── 暂停/继续 按钮（条件显示）
│       │       ├── 重试 按钮（仅错误状态）
│       │       └── 关闭 按钮
│       ├── 脚本部分 [修改]：
│       │   ├── props: task (Task interface)
│       │   ├── data: autoRefresh, refreshInterval
│       │   ├── computed:
│       │   │   ├── taskProgress() - 计算进度百分比 [新增]
│       │   │   ├── formattedStatus() - 格式化状态文本 [新增]
│       │   │   └── costDisplay() - 格式化费用显示 [新增]
│       │   ├── methods:
│       │   │   ├── pauseTask() - [新增] 调用暂停接口
│       │   │   ├── retryTask() - [新增] 调用重试接口
│       │   │   └── formatTime() - 时间格式化辅助函数 [新增]
│       │   ├── watchers:
│       │   │   └── watch task.translation - 实时滚动到底部 [新增]
│       │   └── onMounted/onUnmounted: 自动刷新控制 [新增]
│       └── 样式部分：
│           ├── .config-section - 配置区域样式
│           ├── .status-section - 状态区域样式
│           ├── .progress-bar - 进度条样式（带动画）
│           ├── .translation-result - 翻译结果区域样式
│           └── .token-stats - Token 统计样式
│
└── [修改文件] stores/translate.store.ts
    └── 内部模块修改：
        ├── State [修改]：
        │   ├── 现有字段保持不变
        │   ├── 新增：enableRealTimeUpdate（实时更新开关）
        │   └── 新增：taskStateCache（任务状态缓存）
        ├── Getters [修改]：
        │   ├── 现有 Getters 保持不变
        │   └── 新增：getTaskState(taskId)
        ├── Actions [修改]：
        │   ├── fetchTaskList() - 保持不变
        │   ├── subscribeTaskUpdates() - [新增]
        │   │   ├── 订阅后端任务状态变化事件
        │   │   ├── 实时更新 store 中的任务状态
        │   │   └── 触发 UI 响应式更新
        │   ├── pauseTask(taskId) - [新增]
        │   │   ├── 调用后端 IPC：ipc-invoke('pause-task', taskId)
        │   │   ├── 更新本地状态
        │   │   └── 返回成功/失败结果
        │   └── unsubscribeTaskUpdates() - [新增]
        │       └── 清理事件监听
        └── Persistence 层 [修改]：
            ├── 现有持久化逻辑保持不变
            └── 新增：实时推送事件处理
```

---

### **第三层：前端类型定义修改**

```
Nimbria/Client/GUI/DemoPage/LlmTranslate/types/
│
├── [修改文件] task.ts
│   └── 内部模块修改：
│       ├── Task 接口 [扩展]
│       │   ├── 原有字段保持
│       │   ├── 新增字段：errorType?: string （错误类型代码）
│       │   ├── 新增字段：errorMessage?: string （错误信息）
│       │   ├── 新增字段：retryCount: number （重试次数）
│       │   ├── 新增字段：metadata?: TaskMetadata （任务元数据）
│       │   ├── 新增字段：metadataJson?: string （元数据 JSON）
│       │   └── 修改字段：status 的类型值
│       └── TaskStatus 类型 [新增]
│           ├── 'unsent' - 未发送
│           ├── 'waiting' - 等待中
│           ├── 'sending' - 发送中
│           ├── 'throttled' - 限流
│           ├── 'completed' - 已完成
│           ├── 'error' - 错误
│           └── 'paused' - 已暂停
│
├── [新增文件] model.ts
│   └── 内部模块：
│       ├── ModelOption 接口
│       │   ├── modelId: string （格式：providerId.modelName）
│       │   ├── modelName: string （显示名称）
│       │   ├── providerId: string （提供商 ID）
│       │   ├── providerName: string （提供商名称）
│       │   └── isActive: boolean （是否已激活）
│       └── ModelGroup 接口
│           ├── providerId: string
│           ├── providerName: string
│           └── models: ModelOption[]
│
├── [新增文件] metadata.ts
│   └── 内部模块：
│       └── TaskMetadata 接口
│           ├── modelId: string
│           ├── modelName: string
│           ├── providerId: string
│           ├── systemPrompt: string
│           ├── chunkStrategy: 'line' | 'token'
│           ├── chunkSize: number
│           ├── concurrency: number
│           ├── replyMode: 'complete' | 'streaming'
│           ├── temperature: number
│           ├── maxTokens: number
│           └── [其他配置字段]
│
└── [修改文件] batch.ts
    └── 内部模块修改：
        ├── Batch 接口 [修改]
        │   ├── 原有字段保持
        │   ├── configJson: string 保持
        │   ├── 新增字段：config?: BatchConfig （解析后的配置对象）
        │   └── [其他字段]
        └── BatchConfig 接口 [已存在]
```

---

### **第四层：后端 IPC 消息处理修改**

```
Nimbria/src-electron/ipc/main-renderer/
│
└── [修改文件] llm-translate-handlers.ts
    └── 内部模块修改：
        ├── IPC Handler 注册 [修改]：
        │   ├── ipcMain.handle('get-batches', ...) - 保持不变
        │   ├── ipcMain.handle('get-tasks', ...) - 保持不变
        │   ├── ipcMain.handle('submit-tasks', ...) - 保持不变
        │   │   ├── 新增：调用 TaskStateManager.initializeTask()
        │   │   └── 新增：发出任务提交事件
        │   ├── ipcMain.handle('pause-task', ...) - [新增]
        │   │   ├── 参数：taskId
        │   │   ├── 调用 TaskStateManager.pauseTask(taskId)
        │   │   ├── 更新数据库任务状态为 'paused'
        │   │   └── 返回操作结果
        │   ├── ipcMain.handle('retry-task', ...) - [新增]
        │   │   ├── 参数：taskId
        │   │   ├── 重置任务状态为 'waiting'
        │   │   └── 放回任务队列
        │   └── ipcMain.on('task-state-changed', ...) - [新增]
        │       ├── 接收来自后端的任务状态变化事件
        │       └── 转发给所有 renderer 进程
        │
        └── 事件广播 [新增]：
            ├── mainWindow.webContents.send('task:state-changed', event)
            ├── mainWindow.webContents.send('task:progress-updated', event)
            ├── mainWindow.webContents.send('task:completed', event)
            └── mainWindow.webContents.send('task:error-occurred', event)
```

---

### **第五层：数据库类型和初始化修改**

```
Nimbria/src-electron/types/LlmTranslate/
│
├── [修改文件] backend/index.ts
│   └── 内部模块修改：
│       ├── Task 接口 [扩展] ✅ 已在设计文档中定义
│       ├── TaskStatus 类型 [新增] ✅ 已在设计文档中定义
│       ├── TaskMetadata 接口 [新增] ✅ 已在设计文档中定义
│       ├── Batch 接口 - 保持不变
│       └── [其他类型] - 保持不变
│
└── [修改文件] backend/database.ts
    └── 内部模块修改：
        ├── initializeLlmTranslateSchema() - 保持不变（表已存在）
        ├── 迁移脚本（如需） - 添加新字段
        │   ├── 迁移：ALTER TABLE Llmtranslate_tasks ADD COLUMN error_type TEXT
        │   ├── 迁移：ALTER TABLE Llmtranslate_tasks ADD COLUMN error_message TEXT
        │   ├── 迁移：ALTER TABLE Llmtranslate_tasks ADD COLUMN retry_count INTEGER DEFAULT 0
        │   ├── 迁移：ALTER TABLE Llmtranslate_tasks ADD COLUMN metadata_json TEXT
        │   └── [验证所有字段都已存在]
        └── 字段别名映射已完成 ✅
```

---

## 📋 实现优先级和依赖关系

```
优先级 1: ModelSelector 组件 [前提：无]
  └─ 优先级 2: ThreadDrawer 详情面板增强
      └─ 优先级 3: 异常处理与状态管理
          ├─ 优先级 4: LlmTranslationClient
          └─ 优先级 5: TaskStateManager
              ├─ 优先级 6: UI 组件调整（任务卡片）
              ├─ 优先级 7: 事件驱动集成
              └─ 优先级 8: 逻辑完整性检查
```

---

## ✅ 已完成的工作

- [x] 字段别名映射修复（6 个 SQL 查询方法）
- [x] 批注文档处理和设计文档编写
- [x] 文件架构修改树规划

## ⏳ 待完成的工作

- [ ] 优先级 1: ModelSelector.vue 组件开发
- [ ] 优先级 2: ThreadDrawer 增强
- [ ] 优先级 3-8: 核心服务和状态管理开发

