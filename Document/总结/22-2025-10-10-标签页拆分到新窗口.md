# æ ‡ç­¾é¡µæ‹†åˆ†åˆ°æ–°çª—å£åŠŸèƒ½å®ç°æ€»ç»“

> å®ç°æ—¥æœŸï¼š2025å¹´10æœˆ10æ—¥  
> å‚è€ƒé¡¹ç›®ï¼šJiuZhang-NovelStudio  
> è®¾è®¡ç†å¿µï¼šç®€å•å®ç”¨ï¼Œé¿å…è¿‡åº¦å¤æ‚åŒ–

---

## ğŸ“Š é¡¹ç›®æ¦‚è¿°

### æ ¸å¿ƒéœ€æ±‚
åœ¨Nimbriaé¡¹ç›®çš„ProjectPageä¸­ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡å³é”®èœå•å°†æ ‡ç­¾é¡µæ‹†åˆ†åˆ°ç‹¬ç«‹çš„æ–°çª—å£ä¸­ï¼Œæ–°çª—å£åªæ˜¾ç¤ºMainPanelï¼ˆæ— å·¦å³æ ï¼‰ï¼Œå¹¶ä¸æ¯çª—å£é€šè¿‡æ¡æ‰‹æœºåˆ¶åŒæ­¥å…³é—­æºæ ‡ç­¾é¡µã€‚

### è®¾è®¡åŸåˆ™
- âœ… **ç®€å•å®ç”¨**ï¼šå‚è€ƒJiuZhangçš„ç®€åŒ–æ–¹æ¡ˆï¼Œè€Œéå¤æ‚çš„å¤šè¿›ç¨‹æ¶æ„
- âœ… **å¤ç”¨ç°æœ‰æ¶æ„**ï¼šä¸å¼•å…¥æ–°çš„çª—å£ç±»å‹ï¼Œå¤ç”¨`project`çª—å£çš„é¢„åŠ è½½è„šæœ¬
- âœ… **URLå‚æ•°ä¼ é€’**ï¼šä½¿ç”¨URLå‚æ•°ä¼ é€’åˆå§‹çŠ¶æ€ï¼Œé¿å…å¤æ‚çš„çŠ¶æ€åŒæ­¥
- âœ… **IPCæ¡æ‰‹æœºåˆ¶**ï¼šç®€å•çš„IPCé€šä¿¡å®Œæˆæºæ ‡ç­¾é¡µå…³é—­

---

## ğŸ—ï¸ å®ç°æ¶æ„

### æ¶æ„å¯¹æ¯”

| ç»´åº¦ | âŒ åŸè®¾è®¡ï¼ˆè¿‡åº¦å¤æ‚ï¼‰ | âœ… æ–°æ–¹æ¡ˆï¼ˆç®€å•å®ç”¨ï¼‰ |
|------|-------------------|-------------------|
| çª—å£ç±»å‹ | æ–°å¢`project-detached-pane`ç±»å‹ | å¤ç”¨`project`ç±»å‹ï¼Œæ·»åŠ `minimal`æ¨¡å¼ |
| çŠ¶æ€åŒæ­¥ | MessagePortåŒå‘åŒæ­¥ | URLå‚æ•° + ç®€å•IPC |
| æ•°æ®ä¼ é€’ | StateSyncManager | JSONåºåˆ—åŒ– + URL |
| é€šä¿¡æœºåˆ¶ | MessageChannel | IPC invoke/send |
| æ–°å¢æ–‡ä»¶ | 15+ | 1ä¸ª |
| ä¿®æ”¹æ–‡ä»¶ | 20+ | 6ä¸ª |
| å¼€å‘æ—¶é—´ | 7-8å¤© | 2-3å°æ—¶ |

---

## ğŸ“ æ–‡ä»¶ä¿®æ”¹æ¸…å•

### 1. åç«¯å±‚ï¼ˆsrc-electronï¼‰

#### âœ… `core/app-manager.ts`
- **æ–°å¢å±æ€§**ï¼š`transferMap` - è®°å½•çª—å£è½¬ç§»æ˜ å°„
- **æ–°å¢IPCå¤„ç†å™¨**ï¼š
  - `project:detach-tab-to-window` - åˆ›å»ºåˆ†ç¦»çª—å£
  - `project:detached-ready` - æ¡æ‰‹å…³é—­æºæ ‡ç­¾
- **æ–°å¢æ–¹æ³•**ï¼š`createDetachedWindow()` - åˆ›å»ºåˆ†ç¦»çª—å£

#### âœ… `core/project-preload.ts`
- **æ–°å¢API**ï¼š`project.detachTabToWindow()` - æš´éœ²ç»™å‰ç«¯
- **æ–°å¢API**ï¼š`on()` / `send()` - äº‹ä»¶é€šä¿¡

---

### 2. å‰ç«¯å±‚ï¼ˆClientï¼‰

#### âœ… `GUI/router/routes.ts`
- **æ–°å¢è·¯ç”±**ï¼š`/project-detached` - åˆ†ç¦»çª—å£è·¯ç”±

#### âœ… `GUI/PagesLayout/ProjectPage.DetachedPage.vue`ï¼ˆæ–°å»ºï¼‰
- **åŠŸèƒ½**ï¼šåˆ†ç¦»çª—å£é¡µé¢ç»„ä»¶
- **ç‰¹ç‚¹**ï¼š
  - åªæ¸²æŸ“PaneSystemï¼ˆæ— å·¦å³æ ï¼‰
  - ä»URLå‚æ•°æ¢å¤æ ‡ç­¾é¡µæ•°æ®
  - å‘é€å°±ç»ªä¿¡å·è§¦å‘æ¡æ‰‹

#### âœ… `GUI/components/ProjectPage.MainPanel/PaneSystem/ContextMenu.vue`
- **æ–°å¢å›¾æ ‡**ï¼š`FullScreen` - æ”¯æŒå…¨å±å›¾æ ‡

#### âœ… `GUI/components/ProjectPage.MainPanel/PaneSystem/PaneContent.vue`
- **æ–°å¢èœå•é¡¹**ï¼š
  ```typescript
  {
    action: 'detach-to-window',
    label: 'æ‹†åˆ†åˆ°æ–°çª—å£',
    icon: 'full-screen'
  }
  ```
- **æ–°å¢æ–¹æ³•**ï¼š
  - `handleDetachToWindow()` - æ‹†åˆ†åˆ°æ–°çª—å£
  - `handleCloseSourceTab()` - å…³é—­æºæ ‡ç­¾ç›‘å¬å™¨
- **æ–°å¢ç”Ÿå‘½å‘¨æœŸ**ï¼šæ³¨å†Œ`project:close-source-tab`äº‹ä»¶ç›‘å¬

#### âœ… `types/core/window.d.ts`
- **æ–°å¢APIç±»å‹**ï¼š`project.detachTabToWindow()`
- **æ–°å¢APIç±»å‹**ï¼š`on()` / `send()`

---

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

```
ç”¨æˆ·æ“ä½œ: å³é”®æ ‡ç­¾é¡µ â†’ "æ‹†åˆ†åˆ°æ–°çª—å£"
    â†“
PaneContent.vue: handleDetachToWindow()
    â”œâ”€ è·å–æ ‡ç­¾é¡µæ•°æ®ï¼ˆæ–‡ä»¶è·¯å¾„ã€æ ‡é¢˜ç­‰ï¼‰
    â”œâ”€ è·å–é¡¹ç›®è·¯å¾„
    â””â”€ è°ƒç”¨ window.nimbria.project.detachTabToWindow()
        â†“
project-preload.ts: ipcRenderer.invoke('project:detach-tab-to-window')
        â†“
app-manager.ts: ipcMain.handle('project:detach-tab-to-window')
        â”œâ”€ ç”Ÿæˆ transferId
        â”œâ”€ ä¿å­˜ transferMap[transferId] = { sourceWebContentsId, tabId }
        â””â”€ createDetachedWindow()
            â”œâ”€ åˆ›å»ºæ–°BrowserWindowï¼ˆå¤ç”¨project-preloadï¼‰
            â”œâ”€ è®¾ç½®çª—å£æ ‡é¢˜
            â””â”€ åŠ è½½URL: /#/project-detached?newWindow=true&ui=minimal&transferId=xxx&tabData=...
                â†“
æ–°çª—å£: ProjectPage.DetachedPage.vue onMounted()
        â”œâ”€ è§£æURLå‚æ•°
        â”œâ”€ é€šè¿‡ markdownStore.openFile() æ‰“å¼€æ–‡ä»¶
        â””â”€ å‘é€ 'project:detached-ready' äº‹ä»¶
            â†“
app-manager.ts: ipcMain.on('project:detached-ready')
        â”œâ”€ æŸ¥æ‰¾transferMap[transferId]
        â”œâ”€ è·å–æºçª—å£webContents
        â””â”€ å‘é€ 'project:close-source-tab' åˆ°æºçª—å£
            â†“
æºçª—å£: PaneContent.vue handleCloseSourceTab()
        â””â”€ handleTabRemove(tabId) âœ… å…³é—­æºæ ‡ç­¾é¡µ
```

---

## ğŸ¯ å…³é”®å®ç°ç»†èŠ‚

### 1. URLå‚æ•°ä¼ é€’æœºåˆ¶

**åç«¯æ„å»ºURL**ï¼š
```typescript
const params = new URLSearchParams({
  newWindow: 'true',
  ui: 'minimal',
  transferId: transferId,
  projectPath: projectPath,
  tabData: encodeURIComponent(JSON.stringify(tabData))
})

const detachedUrl = `${baseUrl}#/project-detached?${params.toString()}`
```

**å‰ç«¯è§£æURL**ï¼š
```typescript
const params = route.query
const tabData = JSON.parse(decodeURIComponent(params.tabData as string))
```

---

### 2. æ¡æ‰‹å…³é—­æœºåˆ¶

**transferMapæ˜ å°„è¡¨**ï¼š
```typescript
private transferMap?: Map<string, { 
  sourceWebContentsId: number
  tabId: string 
}>
```

**æ¡æ‰‹æµç¨‹**ï¼š
1. åç«¯åˆ›å»ºçª—å£æ—¶è®°å½•`transferId â†’ { sourceWebContentsId, tabId }`
2. æ–°çª—å£å°±ç»ªåå‘é€`detached-ready`äº‹ä»¶ï¼Œæºå¸¦`transferId`
3. åç«¯é€šè¿‡`transferId`æŸ¥æ‰¾æºçª—å£ï¼Œå‘é€`close-source-tab`äº‹ä»¶
4. æºçª—å£æ”¶åˆ°äº‹ä»¶åå…³é—­å¯¹åº”æ ‡ç­¾é¡µ
5. åˆ é™¤`transferMap`ä¸­çš„è®°å½•

---

### 3. åˆ†ç¦»çª—å£åˆå§‹åŒ–

**å…³é”®ä»£ç **ï¼š
```typescript
// å»¶è¿ŸåŠ è½½æ–‡ä»¶ï¼Œç¡®ä¿ Store å·²åˆå§‹åŒ–
await new Promise(resolve => setTimeout(resolve, 300))

// ç›´æ¥é€šè¿‡ markdownStore æ‰“å¼€æ–‡ä»¶
await markdownStore.openFile(tabData.filePath)

// è®¾ç½®ä¸ºèšç„¦çŠ¶æ€
const paneId = paneLayoutStore.focusedPaneId
if (paneId) {
  paneLayoutStore.setFocusedPane(paneId)
}
```

**ä¸ºä»€ä¹ˆéœ€è¦å»¶è¿Ÿ**ï¼š
- Pinia Store çš„åˆå§‹åŒ–éœ€è¦æ—¶é—´
- PaneSystem ç»„ä»¶çš„æŒ‚è½½éœ€è¦æ—¶é—´
- 300ms è¶³å¤Ÿç¡®ä¿ç¯å¢ƒå‡†å¤‡å°±ç»ª

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### ç”¨æˆ·æ“ä½œæµç¨‹

1. **æ‰“å¼€é¡¹ç›®**ï¼šåœ¨Nimbriaä¸­æ‰“å¼€ä»»æ„é¡¹ç›®
2. **æ‰“å¼€æ–‡ä»¶**ï¼šåœ¨æ–‡ä»¶æ ‘ä¸­æ‰“å¼€Markdownæ–‡ä»¶
3. **å³é”®æ ‡ç­¾é¡µ**ï¼šåœ¨æ ‡ç­¾é¡µä¸Šå³é”®ç‚¹å‡»
4. **é€‰æ‹©èœå•**ï¼šç‚¹å‡»"æ‹†åˆ†åˆ°æ–°çª—å£"
5. **æ–°çª—å£æ‰“å¼€**ï¼šæ–°çª—å£è‡ªåŠ¨æ‰“å¼€å¹¶æ˜¾ç¤ºè¯¥æ–‡ä»¶
6. **æºæ ‡ç­¾å…³é—­**ï¼šåŸçª—å£çš„æ ‡ç­¾é¡µè‡ªåŠ¨å…³é—­

### é¢„æœŸæ•ˆæœ

- âœ… æ–°çª—å£æ— å·¦ä¾§æ ï¼ˆæ–‡ä»¶æ ‘ã€å¯¼èˆªï¼‰
- âœ… æ–°çª—å£æ— å³ä¾§æ ï¼ˆæ’ä»¶é¢æ¿ï¼‰
- âœ… æ–°çª—å£åªæ˜¾ç¤ºPaneSystemï¼ˆç¼–è¾‘å™¨ä¸»åŒºåŸŸï¼‰
- âœ… æ–°çª—å£å¯ç‹¬ç«‹ç¼–è¾‘ã€ä¿å­˜
- âœ… å‘½ä»¤é¢æ¿å¯ç”¨ï¼ˆCtrl+Shift+Pï¼‰
- âœ… æºçª—å£æ ‡ç­¾é¡µè‡ªåŠ¨å…³é—­

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

### åŠŸèƒ½æµ‹è¯•
- [ ] å³é”®èœå•æ˜¾ç¤º"æ‹†åˆ†åˆ°æ–°çª—å£"é€‰é¡¹
- [ ] ç‚¹å‡»èœå•åæ–°çª—å£åˆ›å»ºæˆåŠŸ
- [ ] æ–°çª—å£æ˜¾ç¤ºæ­£ç¡®çš„æ–‡ä»¶å†…å®¹
- [ ] æ–°çª—å£æ— å·¦å³æ ï¼ˆåªæœ‰MainPanelï¼‰
- [ ] æºçª—å£æ ‡ç­¾é¡µè‡ªåŠ¨å…³é—­ï¼ˆ1ç§’å†…ï¼‰
- [ ] æ–°çª—å£å¯ä»¥æ­£å¸¸ç¼–è¾‘ã€ä¿å­˜
- [ ] æ–°çª—å£å¯ä»¥ä½¿ç”¨å‘½ä»¤é¢æ¿

### è¾¹ç¼˜æƒ…å†µ
- [ ] é¡¹ç›®è·¯å¾„ä¸ºç©ºæ—¶æ˜¯å¦æœ‰é”™è¯¯æç¤º
- [ ] æ ‡ç­¾é¡µæ•°æ®ä¸å®Œæ•´æ—¶æ˜¯å¦ä¼˜é›…é™çº§
- [ ] å¤šæ¬¡å¿«é€Ÿç‚¹å‡»æ˜¯å¦ä¼šåˆ›å»ºå¤šä¸ªçª—å£
- [ ] æºçª—å£å…³é—­æ—¶ï¼Œåˆ†ç¦»çª—å£æ˜¯å¦æ­£å¸¸è¿è¡Œ

### æ€§èƒ½æµ‹è¯•
- [ ] çª—å£åˆ›å»ºé€Ÿåº¦ï¼ˆ< 1ç§’ï¼‰
- [ ] æ¡æ‰‹å…³é—­å»¶è¿Ÿï¼ˆ< 1ç§’ï¼‰
- [ ] å¤§æ–‡ä»¶åŠ è½½æ˜¯å¦æµç•…
- [ ] å¤šä¸ªåˆ†ç¦»çª—å£æ˜¯å¦å½±å“æ€§èƒ½

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. æ–°çª—å£æ‰“å¼€åæ˜¾ç¤ºç©ºç™½
**åŸå› **ï¼šURLå‚æ•°è§£æå¤±è´¥æˆ–tabDataæ ¼å¼é”™è¯¯  
**è§£å†³**ï¼šæ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ï¼Œç¡®è®¤tabDataæ˜¯å¦æ­£ç¡®ç¼–ç 

#### 2. æºæ ‡ç­¾é¡µæ²¡æœ‰å…³é—­
**åŸå› **ï¼šæ¡æ‰‹äº‹ä»¶ç›‘å¬å™¨æœªæ³¨å†Œæˆ–transferIdä¸åŒ¹é…  
**è§£å†³**ï¼š
- æ£€æŸ¥`PaneContent.vue`çš„`onMounted`æ˜¯å¦æ­£ç¡®æ³¨å†Œç›‘å¬
- æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰`Event listener registered`æ—¥å¿—

#### 3. æ–°çª—å£æ— æ³•æ‰“å¼€æ–‡ä»¶
**åŸå› **ï¼šæ–‡ä»¶è·¯å¾„ä¸å­˜åœ¨æˆ–markdownStoreæœªåˆå§‹åŒ–  
**è§£å†³**ï¼š
- å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼ˆ300ms â†’ 500msï¼‰
- æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å½“å‰æ€§èƒ½
- çª—å£åˆ›å»ºæ—¶é—´ï¼š~500ms
- æ¡æ‰‹å…³é—­å»¶è¿Ÿï¼š1000msï¼ˆåˆ»æ„å»¶è¿Ÿç¡®ä¿åˆå§‹åŒ–ï¼‰
- æ–‡ä»¶åŠ è½½å»¶è¿Ÿï¼š300msï¼ˆç­‰å¾…Storeåˆå§‹åŒ–ï¼‰

### ä¼˜åŒ–æ–¹å‘
1. **å‡å°‘æ¡æ‰‹å»¶è¿Ÿ**ï¼šä»1000msé™è‡³500msï¼ˆéœ€æµ‹è¯•ç¨³å®šæ€§ï¼‰
2. **ä¼˜åŒ–æ–‡ä»¶åŠ è½½**ï¼šç›‘å¬Store readyäº‹ä»¶ï¼Œè€Œéå›ºå®šå»¶è¿Ÿ
3. **çª—å£é¢„åˆ›å»º**ï¼šé¢„å…ˆåˆ›å»ºçª—å£æ± ï¼Œå‡å°‘åˆ›å»ºæ—¶é—´

---

## ğŸ“ è®¾è®¡ç»éªŒæ€»ç»“

### âœ… æˆåŠŸä¹‹å¤„

1. **ç®€å•ä¼˜äºå¤æ‚**
   - æ”¾å¼ƒå¤æ‚çš„å¤šè¿›ç¨‹æ¶æ„
   - ä½¿ç”¨URLå‚æ•°è€ŒéMessagePort
   - å¼€å‘æ—¶é—´ä»7-8å¤©ç¼©çŸ­è‡³2-3å°æ—¶

2. **å¤ç”¨ç°æœ‰èµ„æº**
   - å¤ç”¨project-preload.ts
   - å¤ç”¨PaneSystemç»„ä»¶
   - å¤ç”¨markdownStore

3. **æ¸è¿›å¼å®ç°**
   - å…ˆå®ç°æ ¸å¿ƒåŠŸèƒ½
   - åç»­å¯æ‰©å±•å‘½ä»¤é¢æ¿è½¬å‘
   - ä¿ç•™ä¼˜åŒ–ç©ºé—´

### âŒ é¿å…çš„å‘

1. **è¿‡åº¦è®¾è®¡**
   - åŸè®¾è®¡æ–¹æ¡ˆå¼•å…¥15+æ–°æ–‡ä»¶
   - StateSyncManagerã€MessageRouterç­‰å¤æ‚ç»„ä»¶
   - å¼€å‘å’Œç»´æŠ¤æˆæœ¬è¿‡é«˜

2. **çŠ¶æ€åŒæ­¥åœ°ç‹±**
   - åŒå‘çŠ¶æ€åŒæ­¥å®¹æ˜“å‡ºç°å†²çª
   - MessagePorté€šä¿¡è°ƒè¯•å›°éš¾
   - ç®€å•çš„URLå‚æ•°è¶³ä»¥æ»¡è¶³éœ€æ±‚

3. **ç±»å‹è†¨èƒ€**
   - ä¸å¼•å…¥æ–°çš„çª—å£ç±»å‹
   - é€šè¿‡`ui: 'minimal'`å‚æ•°æ§åˆ¶æ¨¡å¼
   - ä¿æŒæ¶æ„æ¸…æ™°

---

## ğŸ“ åç»­æ‰©å±•æ–¹å‘

### å¯é€‰åŠŸèƒ½
1. **å‘½ä»¤é¢æ¿è½¬å‘**ï¼šå­çª—å£æ“ä½œæ¯çª—å£å³ä¾§æ 
2. **æ‹–æ‹½åˆå¹¶**ï¼šå°†åˆ†ç¦»çª—å£æ‹–å›æ¯çª—å£
3. **çª—å£å¸ƒå±€ä¿å­˜**ï¼šè®°å¿†ç”¨æˆ·çš„çª—å£åˆ†å¸ƒ
4. **å¤šæ˜¾ç¤ºå™¨æ”¯æŒ**ï¼šè‡ªåŠ¨åœ¨ç¬¬äºŒå±å¹•æ‰“å¼€

### æ€§èƒ½ä¼˜åŒ–
1. **çª—å£æ± æœºåˆ¶**ï¼šé¢„åˆ›å»ºçª—å£å‡å°‘å»¶è¿Ÿ
2. **æ‡’åŠ è½½ä¼˜åŒ–**ï¼šæŒ‰éœ€åŠ è½½æ–‡ä»¶å†…å®¹
3. **è™šæ‹Ÿæ»šåŠ¨**ï¼šå¤§æ–‡ä»¶æ€§èƒ½ä¼˜åŒ–

---

## ğŸ™ è‡´è°¢

æ„Ÿè°¢ **JiuZhang-NovelStudio** é¡¹ç›®æä¾›çš„ç®€åŒ–å®ç°æ€è·¯ï¼Œé¿å…äº†è¿‡åº¦å¤æ‚åŒ–çš„é™·é˜±ã€‚

---

**ç‰ˆæœ¬**: v1.0  
**ä½œè€…**: AI Assistant  
**æ—¥æœŸ**: 2025å¹´10æœˆ10æ—¥

