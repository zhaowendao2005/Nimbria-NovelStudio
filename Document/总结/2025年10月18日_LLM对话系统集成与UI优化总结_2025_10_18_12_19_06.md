# Nimbria NovelStudio - LLM å¯¹è¯ç³»ç»Ÿé›†æˆä¸ UI ä¼˜åŒ–æ€»ç»“

**å®Œæˆæ—¶é—´ï¼š** 2025å¹´10æœˆ18æ—¥ 12:19:06 (ä¸œå…«åŒº)  
**å·¥ä½œèŒƒå›´ï¼š** LLM å¯¹è¯æ ‡ç­¾é¡µé›†æˆ + æ‹†åˆ†åŠŸèƒ½ + UI ä¼˜åŒ–  
**æ¶‰åŠæ¨¡å—ï¼š** CustomPageManagerã€PaneSystemã€DetachedPageã€LlmChatStoreã€UI ç»„ä»¶

---

## ğŸ“‹ å·²å®ç°åŠŸèƒ½æ€»è§ˆ

### 1. LLM å¯¹è¯æ ‡ç­¾é¡µé›†æˆ âœ…

#### 1.1 æ ¸å¿ƒé›†æˆ
- **LlmChatTab.vue** - ä¸»é¢æ¿ä¸­çš„ LLM å¯¹è¯æ ‡ç­¾é¡µå±•ç¤º
- **LlmChatPage.vue** - CustomPageManager çš„åŒ…è£…å±‚
- **register.ts** - æ ‡ç­¾é¡µæ³¨å†Œç³»ç»Ÿ
- **çŠ¶æ€åŒæ­¥** - é€šè¿‡ Pinia `llmChatStore` å®ç°è·¨çª—å£çŠ¶æ€åŒæ­¥

#### 1.2 æ ‡ç­¾é¡µæ‹†åˆ†åŠŸèƒ½
- **æ‹†åˆ†åˆ°ä¸»é¢æ¿** - å³é”®èœå•å¿«é€Ÿæ‰“å¼€å¯¹è¯
- **æ‹†åˆ†åˆ°æ–°çª—å£** - åˆ›å»ºç‹¬ç«‹çª—å£æ˜¾ç¤ºå¯¹è¯
- **æ–°çª—å£æ”¯æŒ** - DetachedPage.vue å®Œæ•´æ”¯æŒ `llmchat` ç±»å‹

#### 1.3 çŠ¶æ€ç®¡ç†ä¼˜åŒ–
- **é¡¹ç›®è·¯å¾„ä¼ é€’** - æ–°çª—å£é€šè¿‡ `setProjectPath` è®¿é—®é¡¹ç›®èµ„æº
- **å¯¹è¯åŠ è½½** - `loadConversationById` æ–¹æ³•æ”¯æŒæŒ‡å®šå¯¹è¯æ¢å¤
- **æ¨¡å‹åˆ‡æ¢** - æ”¯æŒåœ¨æ–°çª—å£ä¸­åˆ‡æ¢ AI æ¨¡å‹

### 2. Bug ä¿®å¤ âœ…

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|--------|
| åˆ›å»ºå¯¹è¯é‡å¤æ˜¾ç¤ºä¸¤ä¸ªæ ‡ç­¾ | `onStreamComplete` ç›‘å¬å™¨é‡å¤è°ƒç”¨ `loadConversation()` | ç§»é™¤ç›‘å¬å™¨ä¸­çš„é‡å¤è°ƒç”¨ |
| å†å²è®°å½•æ‰“å¼€æ— æ ‡ç­¾æ˜¾ç¤º | `loadConversation()` è®¿é—®é”™è¯¯å±æ€§ (`response.conversation` â†’ `response.data`) | ä¿®æ­£ IPC å“åº”æ•°æ®è®¿é—®è·¯å¾„ |
| å³é”®èœå•ä¸è§¦å‘ | `el-dropdown` çš„ `trigger` å†²çª | ç§»é™¤ `trigger="contextmenu"` æ”¹ä¸ºæ‰‹åŠ¨æ§åˆ¶ |
| "æ‹†åˆ†åˆ°ä¸»é¢æ¿" ä¸å¯è§ | ContextMenu é¡¹é…ç½®é”™è¯¯ (`divider: true` å¯¼è‡´åªæ˜¾ç¤ºåˆ†éš”çº¿) | åˆ†éš”çº¿ç‹¬ç«‹ä¸ºå•ç‹¬é¡¹ç›® |
| æ–°çª—å£é¡¹ç›®è·¯å¾„ä¸º null | æ–°çª—å£ç¯å¢ƒä¸­ `window.nimbria.getCurrentProjectPath()` è¿”å› null | æ·»åŠ  `externalProjectPath` æœºåˆ¶ |

### 3. UI ä¼˜åŒ– âœ…

#### 3.1 æ¨¡å¼é€‰æ‹©å™¨ (ModeSelector.vue)
- **ç»„ä»¶åˆ›å»º** - æ–°å¢æ¨¡å¼é€‰æ‹©å™¨ç»„ä»¶
- **ä¸‹æ‹‰èœå•è®¾è®¡** - ä¸æ¨¡å‹é€‰æ‹©å™¨ç»Ÿä¸€äº¤äº’æ–¹å¼
- **èƒ¶å›Šå½¢çŠ¶** - åœ†è§’ 18px çš„ç°ä»£è®¾è®¡
- **å½“å‰æ”¯æŒæ¨¡å¼**ï¼šChat (é»˜è®¤)ã€Assistantã€Creative

#### 3.2 å·¥å…·æ å¸ƒå±€ä¼˜åŒ– (ChatInput.vue)
- **Flex å¸ƒå±€** - æ¨¡å¼é€‰æ‹©å™¨ + æ¨¡å‹é€‰æ‹©å™¨åè°ƒæ’åˆ—
- **èƒ¶å›Šå½¢çŠ¶ç»Ÿä¸€** - ä¸¤ä¸ªé€‰æ‹©å™¨è§†è§‰ä¸€è‡´
- **å“åº”å¼é€‚é…** - è‡ªåŠ¨è°ƒæ•´å¸ƒå±€ä»¥é€‚åº”å®¹å™¨

---

## ğŸ› ï¸ æŠ€æœ¯å®ç°ç»†èŠ‚

### æ–°å¢/ä¿®æ”¹æ–‡ä»¶æ¸…å•

**æ–°å»ºæ–‡ä»¶ï¼š**
- `Nimbria/Client/GUI/components/ProjectPage.MainPanel/LlmChat/LlmChatTab.vue`
- `Nimbria/Client/GUI/components/ProjectPage.MainPanel/LlmChat/LlmChatPage.vue`
- `Nimbria/Client/GUI/components/ProjectPage.MainPanel/LlmChat/register.ts`
- `Nimbria/Client/GUI/components/ProjectPage.Shell/Navbar.content/LlmChat/ModeSelector.vue`

**ä¿®æ”¹æ–‡ä»¶ï¼š**
- `Nimbria/Client/stores/llmChat/llmChatStore.ts` - æ·»åŠ  setProjectPath, ä¿®å¤ getCurrentProjectPath
- `Nimbria/Client/GUI/components/ProjectPage.Shell/Navbar.content/LlmChat/ChatInput.vue`
- `Nimbria/Client/GUI/components/ProjectPage.Shell/Navbar.content/LlmChat/LlmChatPanel.vue`
- `Nimbria/Client/GUI/components/ProjectPage.MainPanel/PaneSystem/PaneContent.vue`
- `Nimbria/Client/GUI/PagesLayout/ProjectPage.DetachedPage.vue` - æ·»åŠ  llmchat ç±»å‹å¤„ç†
- `Nimbria/Client/types/core/window.d.ts`
- `Nimbria/src-electron/core/app-manager.ts`
- `Nimbria/src-electron/core/project-preload.ts`
- `Nimbria/src-electron/ipc/main-renderer/llm-chat-handlers.ts`

### æ ¸å¿ƒ API ä½¿ç”¨

**CustomPageManager:**
```typescript
CustomPageAPI.open('llmchat-conversation', { 
  params: { conversationId }, 
  focus: true 
})
```

**LlmChatStore:**
```typescript
llmChatStore.setProjectPath(path)
await llmChatStore.loadConversationById(conversationId)
await llmChatStore.sendMessage(content)
```

**Electron IPC:**
```typescript
window.nimbria.project.detachTabToWindow({
  tabId, tabData, projectPath
})
```

---

## ğŸ“ é¡¹ç›®è§„èŒƒæ€»ç»“

### æ–‡ä»¶ç»„ç»‡
- âœ… Vue ç»„ä»¶ï¼š`Client/GUI/components/` (PascalCase)
- âœ… ä¸šåŠ¡é€»è¾‘ï¼š`Client/Service/`
- âœ… çŠ¶æ€ç®¡ç†ï¼š`Client/stores/`
- âœ… ç±»å‹å®šä¹‰ï¼š`Client/Types/`
- âœ… åç«¯å¤„ç†ï¼š`src-electron/ipc/`

### ä»£ç è§„èŒƒ
- âœ… å•æ–‡ä»¶ < 500 è¡Œ
- âœ… å¿…é¡»æœ‰é”™è¯¯å¤„ç†
- âœ… å¿…é¡»è€ƒè™‘è¾¹ç¼˜æƒ…å†µ
- âŒ ç¦æ­¢ç¡¬ç¼–ç ä¸šåŠ¡é€»è¾‘
- âŒ ç¦æ­¢ Mock æ•°æ®ï¼ˆæ— æ˜ç¡®è¦æ±‚ï¼‰

---

## ğŸ” è¸©å‘ä¸ç»éªŒ

### å‘ #1ï¼šContextMenu åˆ†éš”çº¿é…ç½®
**é”™è¯¯ï¼š** `divider: true` çš„é¡¹ç›®åŒæ—¶å¸¦ label å¯¼è‡´ä¸æ˜¾ç¤º
**è§£å†³ï¼š** åˆ†éš”çº¿ç‹¬ç«‹ä¸ºå•ç‹¬é¡¹ç›® `{ divider: true }`

### å‘ #2ï¼šå¯¹è¯é‡å¤åˆ›å»º
**é”™è¯¯ï¼š** `onStreamComplete` é‡å¤è°ƒç”¨ `loadConversation()`
**è§£å†³ï¼š** ç§»é™¤é‡å¤è°ƒç”¨

### å‘ #3ï¼šIPC æ•°æ®è®¿é—®
**é”™è¯¯ï¼š** è®¿é—® `response.conversation` è€Œå®é™…æ˜¯ `response.data`
**è§£å†³ï¼š** ç»Ÿä¸€æ•°æ®æ ¼å¼çº¦å®š

### å‘ #4ï¼šæ–°çª—å£ç¯å¢ƒå˜é‡
**é”™è¯¯ï¼š** æ–°è¿›ç¨‹æ— æ³•è®¿é—®æ¯çª—å£çš„ `getCurrentProjectPath()`
**è§£å†³ï¼š** URL å‚æ•°ä¼ é€’ + Store ä¸­è®¾ç½®

---

## ğŸ“Š åç«¯å·¥ä½œæµç¨‹

æ ‡å‡†çš„ LLM åŠŸèƒ½æ·»åŠ æµç¨‹ï¼š

1. **å®šä¹‰éœ€æ±‚** - åŠŸèƒ½åˆ—è¡¨ã€UI æµç¨‹ã€æ•°æ®ç»“æ„
2. **IPC å®ç°** - åˆ›å»ºäº‹ä»¶å¤„ç†ã€è¿”å›ç»Ÿä¸€æ ¼å¼
3. **é¢„åŠ è½½æ›´æ–°** - æš´éœ²æ–¹æ³•åˆ° `window.nimbria`
4. **ç±»å‹å®šä¹‰** - æ›´æ–° `window.d.ts`
5. **Store åˆ›å»º** - Pinia çŠ¶æ€å’Œ Action
6. **UI å¼€å‘** - ç»„ä»¶ã€é€»è¾‘ã€äº¤äº’
7. **æ³¨å†Œé¡µé¢** - CustomPageManager
8. **æµ‹è¯•** - åŠŸèƒ½ã€æ€§èƒ½ã€å¤šçª—å£åŒæ­¥

---

**å®Œæˆæ—¥æœŸï¼š** 2025å¹´10æœˆ18æ—¥ 12:19:06 (ä¸œå…«åŒº)  
**è´¨é‡è¯„çº§ï¼š** â­â­â­â­â­ (åŠŸèƒ½å®Œæ•´ã€Bug ä¿®å¤ã€UI ä¼˜åŒ–)
