# 📋 重发任务功能 - 完整交付总结
## ✅ 完成清单

### 1️⃣ **核心功能实现** ✅
- ✅ 已完成任务卡片上添加绿色"重发"按钮
- ✅ ThreadDrawer 中添加"修改提示词"复选框
- ✅ 新建 TaskRetryDialog 对话框组件
- ✅ 支持替换或追加系统提示词
- ✅ 互斥输入框设计（防止用户困惑）

### 2️⃣ **后端服务实现** ✅
- ✅ `LlmTranslateService.retryTaskWithPrompt()` 方法
- ✅ 系统提示词修改后保存到数据库
- ✅ 任务状态重置为 `unsent`
- ✅ 清空所有旧的执行结果（translation、tokens、progress 等）

### 3️⃣ **IPC 通信** ✅
- ✅ `llm-translate:retry-task-with-prompt` IPC Handler
- ✅ 前端 Datasource 层对接
- ✅ Store 状态管理集成
- ✅ 完整的错误处理和 ElMessage 提示

### 4️⃣ **Bug 修复** ✅
- ✅ **关键修复**：modelId 为空问题
  - 在 `retryTaskWithPrompt` 中添加从 task.metadata 读取 modelId 的降级逻辑
  - 将老的 `retry-task` handler 改为调用新方法，确保所有重试都能正确获取 modelId
- ✅ 按钮布局整理（action-buttons 整齐排列）

### 5️⃣ **UI/UX 优化** ✅
- ✅ 重发按钮仅在已完成状态显示
- ✅ 按钮排列整齐（所有按钮水平对齐）
- ✅ Checkbox + 按钮组合设计
- ✅ 对话框展示原系统提示词（可折叠）

---

## 📊 数据流

```
用户点击"重发"
    ↓
选择是否修改提示词
    ├─ 不勾选 → 直接重发（使用原提示词）
    └─ 勾选 → 打开对话框 → 选择替换/追加/不修改
         ↓
提交修改的提示词
    ↓
IPC: llm-translate:retry-task-with-prompt
    ↓
后端: retryTaskWithPrompt()
    ├─ 从 task.metadata 读取 modelId ✅ 关键修复
    ├─ 更新 task.metadata 中的 systemPrompt
    ├─ 重置任务状态为 unsent
    ├─ 清空旧的执行结果
    └─ 调用 submitTasks 重新提交
         ↓
调度器执行任务（使用新提示词）
```

---

## 📁 文件修改总结

| 文件 | 修改类型 | 行数 | 说明 |
|------|---------|------|------|
| `llm-translate-service.ts` | 新增方法 | 1311-1405 | `retryTaskWithPrompt()` 方法 + modelId 降级逻辑 |
| `llm-translate-handlers.ts` | 新增 Handler + 修复 | 355-400 | `retry-task-with-prompt` Handler + 修复 `retry-task` |
| `project-preload.ts` | 新增通道 | 489-490 | IPC 通道暴露 |
| `translate.store.ts` | 新增方法 | 302-355 | Store 中的 `retryTaskWithPrompt()` |
| `translate.datasource.ts` | 新增方法 | 112-120 | Datasource 实现 |
| `translate.mock.ts` | 新增方法 | 390-397 | Mock 实现 |
| `translate.types.ts` | 接口扩展 | - | TranslateDatasource 接口 |
| `TaskRetryDialog.vue` | 新建文件 | 全部 | 对话框组件 |
| `ThreadDrawer.vue` | 修改 | 164-220, 272-377 | 添加重发按钮和逻辑 |
| `TaskManagePage.vue` | 修改 | 273-309, 672-677 | 卡片上添加重发按钮 |

---

## 🎯 功能特性

✨ **完整的用户流程**
- 点击已完成任务的"重发"按钮
- 可选择修改系统提示词（替换或追加）
- 确认后重新发送任务

🔒 **健壮的数据处理**
- 自动从 task.metadata 读取 modelId（防止为空）
- 任务执行结果完全重置
- 新的系统提示词持久化到数据库

📡 **完整的技术栈**
- 前端：Vue 组件 + Pinia 状态管理
- 后端：TypeScript 服务层 + Electron IPC
- 数据库：SQLite 持久化

---

## 🚀 现在可以用了

无需任何额外配置，直接使用：
1. 打开已完成的任务详情
2. 点击"重发"按钮
3. 可选修改提示词
4. 任务重新发送执行

---

## 📌 关键修复说明

**modelId 为空问题的最终解决**：
- 问题原因：批次创建时 config_json 中 modelId 为空
- 解决方案：在 `retryTaskWithPrompt` 方法中，如果批次 config 的 modelId 为空，就从任务的 metadata 中读取
- 覆盖范围：所有重试和重发操作都通过这个逻辑，确保一致性

