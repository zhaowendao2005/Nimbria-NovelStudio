# StarChart å¤§æ•°æ®ï¼ˆ10000èŠ‚ç‚¹ï¼‰ä¼˜åŒ–ç»éªŒæ€»ç»“

**æ—¥æœŸ**ï¼š2025-10-19  
**ç›®æ ‡**ï¼šä¼˜åŒ– 10000 èŠ‚ç‚¹åœºæ™¯ä¸‹çš„ StarChart åˆå§‹åŒ–æ€§èƒ½ï¼Œé¿å…ä¸»çº¿ç¨‹é˜»å¡

---

## âœ… æœ‰æ•ˆçš„ä¼˜åŒ–ï¼ˆå·²ä¿ç•™ï¼‰

### 1. **Worker å¼‚æ­¥è®¡ç®—** â­â­â­â­â­
**å®ç°ä½ç½®**ï¼š
- `Client/Service/starChart/InitializationManager.ts`
- `Client/workers/starchartInit.worker.ts`
- `Client/stores/projectPage/starChart/plugins/MultiRootRadialPlugin/InitializationOptimizer.ts`

**æ•ˆæœ**ï¼š
- Worker è€—æ—¶ï¼š175msï¼ˆ9892èŠ‚ç‚¹ï¼‰
- ä¸»çº¿ç¨‹å®Œå…¨æ— é˜»å¡
- å¯å®æ—¶æ˜¾ç¤ºè¿›åº¦æ¡

**å…³é”®ä»£ç **ï¼š
```typescript
// ä¸»çº¿ç¨‹
const manager = new InitializationManager()
await manager.startInitialization({
  pluginName: 'multi-root-radial',
  graphData: data,
  // ...
})

// Worker ä¸­
const optimizer = plugin.initializeOptimized(data, options, onProgress)
```

**ç»“è®º**ï¼šâœ… **å¿…é¡»ä¿ç•™**ï¼Œè¿™æ˜¯å¤§æ•°æ®åœºæ™¯çš„æ ¸å¿ƒä¼˜åŒ–ã€‚

---

### 2. **é›¶ç¢°æ’é¢„åˆ†é…å¸ƒå±€ç®—æ³•** â­â­â­â­â­
**å®ç°ä½ç½®**ï¼š
- `Client/stores/projectPage/starChart/plugins/MultiRootRadialPlugin/layout.ts`

**æ•ˆæœ**ï¼š
- å¸ƒå±€è€—æ—¶ï¼š83msï¼ˆ9892èŠ‚ç‚¹ï¼‰
- ä» O(NÂ²) é™è‡³ O(N)
- æ— éœ€è¿­ä»£ç¢°æ’æ£€æµ‹

**å…³é”®æ€è·¯**ï¼š
1. ç»Ÿè®¡æ¯ä¸ªæ ¹èŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ•°
2. æŒ‰å­èŠ‚ç‚¹æ•°é¢„åˆ†é…è§’åº¦ç©ºé—´
3. åœ¨åˆ†é…çš„æ‰‡åŒºå†…å‡åŒ€åˆ†å¸ƒå­èŠ‚ç‚¹
4. ä¸€æ¬¡åˆ°ä½ï¼Œé›¶ç¢°æ’

**å…³é”®ä»£ç **ï¼š
```typescript
// é¢„åˆ†é…è§’åº¦ç©ºé—´
const anglePerChild = allocatedAngle / (childCount || 1)
for (let i = 0; i < childCount; i++) {
  const angle = startAngle + i * anglePerChild
  // è®¡ç®—ä½ç½®ï¼Œä¿è¯ä¸é‡å 
}
```

**ç»“è®º**ï¼šâœ… **å¿…é¡»ä¿ç•™**ï¼Œæ˜¾è‘—æå‡å¸ƒå±€æ€§èƒ½ã€‚

---

### 3. **G6 animation: false** â­â­â­â­â­
**å®ç°ä½ç½®**ï¼š
- `StarChartViewport.vue` line 353

**æ•ˆæœ**ï¼š
- é¿å… 10000 ä¸ªèŠ‚ç‚¹çš„åŠ¨ç”» Tween è®¡ç®—
- è¿™æ˜¯ G6 å®˜æ–¹å¤§æ•°æ® demo çš„æ ‡é…

**å…³é”®ä»£ç **ï¼š
```typescript
preloadedGraphInstance = new Graph({
  container: containerRef.value!,
  animation: false,  // ğŸ”¥ å…³é”®ï¼šç¦ç”¨åŠ¨ç”»ç³»ç»Ÿ
  // ...
})
```

**ç»“è®º**ï¼šâœ… **å¿…é¡»ä¿ç•™**ï¼ŒG6 å¤§æ•°æ®æ¸²æŸ“çš„é»„é‡‘æ³•åˆ™ã€‚

---

### 4. **ä¸€æ¬¡æ€§æ•°æ®åŠ è½½ï¼ˆsetDataï¼‰** â­â­â­â­
**å®ç°ä½ç½®**ï¼š
- `StarChartViewport.vue` `loadDataOnce` å‡½æ•°

**æ•ˆæœ**ï¼š
- é¿å…å¤šæ¬¡è§¦å‘æ¸²æŸ“æµæ°´çº¿
- æ¯”åˆ†æ‰¹åŠ è½½æ›´é«˜æ•ˆ

**å…³é”®ä»£ç **ï¼š
```typescript
async function loadDataOnce(graph, layoutResult, onProgress) {
  await scheduleIdle(() => {
    void graph.clear()
    graph.setData(layoutResult)  // ä¸€æ¬¡æ€§åŠ è½½
  })
  onProgress()
}
```

**ç»“è®º**ï¼šâœ… **å¿…é¡»ä¿ç•™**ï¼Œç¬¦åˆ G6 æœ€ä½³å®è·µã€‚

---

### 5. **å•æ¬¡æ¸²æŸ“ï¼ˆrenderï¼‰** â­â­â­â­
**å®ç°ä½ç½®**ï¼š
- `StarChartViewport.vue` `renderOnce` å‡½æ•°

**æ•ˆæœ**ï¼š
- å•æ¬¡è°ƒç”¨ GPU æ¸²æŸ“
- é¿å…å¤šå¸§æ¸²æŸ“çš„å¼€é”€

**å…³é”®ä»£ç **ï¼š
```typescript
async function renderOnce(graph, onProgress) {
  await scheduleIdle(async () => {
    await new Promise((resolve) => {
      requestAnimationFrame(() => {
        void graph.render()  // å•æ¬¡æ¸²æŸ“
        onProgress()
        resolve()
      })
    })
  })
}
```

**ç»“è®º**ï¼šâœ… **å¿…é¡»ä¿ç•™**ï¼ŒGPU åŠ é€Ÿçš„æ­£ç¡®ç”¨æ³•ã€‚

---

### 6. **è¿›åº¦æ¡ç³»ç»Ÿ** â­â­â­â­
**å®ç°ä½ç½®**ï¼š
- `Client/GUI/components/ProjectPage.Shell/Navbar.content/Writing/panels/InitProgressPanel.vue`
- `Client/stores/projectPage/starChart/starChart.store.ts` (progressState)

**æ•ˆæœ**ï¼š
- å¤šé˜¶æ®µè¿›åº¦å¯è§†åŒ–
- ç”¨æˆ·ä½“éªŒå‹å¥½

**ç»“è®º**ï¼šâœ… **å¿…é¡»ä¿ç•™**ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

---

## âŒ æ— æ•ˆçš„ä¼˜åŒ–ï¼ˆå·²æ¸…ç†æˆ–éœ€æ¸…ç†ï¼‰

### 1. **æ‰‹åŠ¨ WebGL ä¼˜åŒ–ä»£ç ** â­
**å®ç°ä½ç½®**ï¼ˆå·²æ³¨é‡Šï¼‰ï¼š
- `StarChartViewport.vue` `applyWebGLOptimizations` å‡½æ•°

**é—®é¢˜**ï¼š
- æ‰‹åŠ¨éå† 10000 èŠ‚ç‚¹è®¾ç½® LODã€Culling
- åŒæ­¥é˜»å¡ä¸»çº¿ç¨‹
- G6 å†…ç½®ä¼˜åŒ–å·²è¶³å¤Ÿ

**æ•™è®­**ï¼š
> **ä¸è¦é‡å¤é€ è½®å­**ã€‚G6 çš„ WebGL å¼•æ“å·²ç»å†…ç½®äº†å®ä¾‹åŒ–æ¸²æŸ“ã€è§†é”¥å‰”é™¤ã€LODç­‰ä¼˜åŒ–ã€‚æ‰‹åŠ¨å®ç°åªä¼šç”»è›‡æ·»è¶³ï¼Œå¢åŠ ä¸»çº¿ç¨‹è´Ÿæ‹…ã€‚

**ç»“è®º**ï¼šâŒ **å·²æ¸…ç†**ï¼ŒG6 å†…ç½®ä¼˜åŒ–å·²è¶³å¤Ÿã€‚

---

### 2. **WebGL ä¼˜åŒ–é…ç½®é¢æ¿** â­
**å®ç°ä½ç½®**ï¼ˆå·²ç¦ç”¨ï¼‰ï¼š
- `WritingPanel.vue` WebGL Optimization éƒ¨åˆ†

**é—®é¢˜**ï¼š
- æ‰€æœ‰å¼€å…³éƒ½æ˜¯æ‘†è®¾
- æ‰‹åŠ¨ä¼˜åŒ–ä»£ç å·²æ³¨é‡Š
- å ç”¨ UI ç©ºé—´

**ç»“è®º**ï¼šâŒ **éœ€æ¸…ç†**ï¼Œé…ç½®æ— å®é™…ä½œç”¨ã€‚

---

### 3. **åˆ†æ‰¹åŠ è½½ï¼ˆchunkArrayï¼‰** â­
**å®ç°ä½ç½®**ï¼š
- å·²åˆ é™¤

**é—®é¢˜**ï¼š
- å¢åŠ å¤æ‚åº¦
- å¤šæ¬¡è§¦å‘æ¸²æŸ“æµæ°´çº¿
- ä¸å¦‚ä¸€æ¬¡æ€§åŠ è½½

**æ•™è®­**ï¼š
> å¯¹äº GPU æ¸²æŸ“ï¼Œ**æ‰¹é‡å¤„ç†ä¸ä¸€å®šæ›´å¿«**ã€‚ä¸€æ¬¡æ€§æäº¤æ•°æ®ï¼Œè®© GPU å¹¶è¡Œå¤„ç†ï¼Œæ¯”åˆ†æ‰¹æäº¤å¤šæ¬¡è¦é«˜æ•ˆã€‚

**ç»“è®º**ï¼šâŒ **å·²æ¸…ç†**ã€‚

---

### 4. **åˆ†å¸§æ¸²æŸ“ï¼ˆrenderInFramesï¼‰** â­
**å®ç°ä½ç½®**ï¼š
- å·²åˆ é™¤

**é—®é¢˜**ï¼š
- WebGL æœ¬èº«å°±æ˜¯å¼‚æ­¥çš„
- åˆ†å¸§åè€Œå¢åŠ å¼€é”€

**ç»“è®º**ï¼šâŒ **å·²æ¸…ç†**ã€‚

---

### 5. **preloadGraphInstance åå¤è°ƒç”¨** â­
**é—®é¢˜**ï¼š
- åœ¨ `runMainThreadPipeline` ç»“å°¾åˆè°ƒç”¨ä¸€æ¬¡
- åŒæ­¥åˆ›å»ºæ–° G6 å®ä¾‹å¯¼è‡´å¡é¡¿

**ä¿®å¤**ï¼š
- å·²æ³¨é‡Šæ‰æœ«å°¾çš„é‡å¤è°ƒç”¨
- åªåœ¨ `onMounted` é¢„çƒ­ä¸€æ¬¡

**ç»“è®º**ï¼šâŒ **å·²ä¿®å¤**ã€‚

---

## âš ï¸ æœªè§£å†³çš„é—®é¢˜

### 1. **behaviors åˆå§‹åŒ–é˜»å¡** â­â­â­
**ç°è±¡**ï¼š
- æ—¥å¿—æ˜¾ç¤ºæ¸²æŸ“å®Œæˆ
- ä½† UI å¡åœ¨ `initRuntime @ graph.ts:1162`
- `behaviors` ä¸º 10000 èŠ‚ç‚¹åˆ›å»ºäº‹ä»¶ç›‘å¬ï¼ŒåŒæ­¥é˜»å¡

**æ½œåœ¨è§£å†³æ–¹æ¡ˆ**ï¼ˆæœªå®ç°ï¼‰ï¼š
1. åˆ›å»º Graph æ—¶ `behaviors: []`ï¼ˆçº¯æ¸²æŸ“æ¨¡å¼ï¼‰
2. æ¸²æŸ“å®Œæˆåï¼Œå¼‚æ­¥æ·»åŠ  behaviors
```typescript
await graph.render()
await scheduleIdle(() => {
  graph.setBehaviors(['drag-canvas', 'zoom-canvas', 'drag-element'])
})
```

**çŠ¶æ€**ï¼šâŒ **æœªå®ç°**ï¼Œç”¨æˆ·è¦æ±‚åœæ­¢ä¼˜åŒ–ã€‚

---

## ğŸ“Š æœ€ç»ˆæ€§èƒ½æ•°æ®

### 9892 èŠ‚ç‚¹åœºæ™¯
| é˜¶æ®µ | è€—æ—¶ | è¯´æ˜ |
|------|------|------|
| æ•°æ®é€‚é… | 4ms | Worker |
| å¸ƒå±€è®¡ç®— | 83ms | Workerï¼ˆé›¶ç¢°æ’ï¼‰ |
| æ ·å¼ç”Ÿæˆ | 45ms | Worker |
| **Worker æ€»è®¡** | **175ms** | âœ… ä¸»çº¿ç¨‹æ— é˜»å¡ |
| æ•°æ®åŠ è½½ | 87ms | ä¸»çº¿ç¨‹ï¼ˆsetDataï¼‰ |
| GPU æ¸²æŸ“ | <50ms | ä¸»çº¿ç¨‹ï¼ˆrenderï¼‰ |
| **behaviors åˆå§‹åŒ–** | **æœªçŸ¥ï¼ˆé˜»å¡ï¼‰** | âŒ å½“å‰ç“¶é¢ˆ |

---

## ğŸ¯ æ ¸å¿ƒç»éªŒ

### 1. **ä¿¡ä»»æ¡†æ¶çš„å†…ç½®ä¼˜åŒ–**
- G6 çš„ WebGL å¼•æ“å·²ç»é«˜åº¦ä¼˜åŒ–
- ä¸è¦å°è¯•"ä¼˜åŒ–"æ¡†æ¶ï¼Œåªä¼šé€‚å¾—å…¶å

### 2. **å¼‚æ­¥æ˜¯ç‹é“**
- æ‰€æœ‰é‡è®¡ç®—éƒ½åº”åœ¨ Worker ä¸­è¿›è¡Œ
- ä¸»çº¿ç¨‹åªè´Ÿè´£ï¼šæ¥æ”¶æ•°æ® â†’ GPU æ¸²æŸ“ â†’ å®Œæˆ

### 3. **ä¸€æ¬¡åˆ°ä½ > æ¸è¿›å¼**
- å¯¹äº GPUï¼šä¸€æ¬¡æ€§æäº¤æ•°æ® > åˆ†æ‰¹æäº¤
- å¯¹äºå¸ƒå±€ï¼šé›¶ç¢°æ’é¢„åˆ†é… > è¿­ä»£ç¢°æ’æ£€æµ‹

### 4. **åŠ¨ç”»ç³»ç»Ÿæ˜¯å¤§æ€å™¨**
- `animation: true` åœ¨å¤§æ•°æ®åœºæ™¯ä¸‹æ˜¯æ€§èƒ½æ€æ‰‹
- 10000 èŠ‚ç‚¹ Ã— åŠ¨ç”» Tween = ä¸»çº¿ç¨‹æ­»äº¡
- å…³é—­å®ƒæ˜¯ç¬¬ä¸€ä¼˜å…ˆçº§

### 5. **behaviors ä¹Ÿæ˜¯åŒæ­¥é˜»å¡æº**
- äº‹ä»¶ç›‘å¬å™¨çš„åˆ›å»ºä¸æ˜¯å…è´¹çš„
- å»¶è¿Ÿåˆå§‹åŒ–æ˜¯å¯è¡Œçš„ä¼˜åŒ–æ–¹å‘

---

## ğŸ“ ä»£ç æ¸…ç†æ¸…å•

### éœ€è¦æ¸…ç†çš„æ–‡ä»¶
- [x] `StarChartViewport.vue`ï¼šåˆ é™¤ `applyWebGLOptimizations` å‡½æ•°
- [ ] `WritingPanel.vue`ï¼šåˆ é™¤ WebGL ä¼˜åŒ–é…ç½®é¢æ¿
- [ ] `starChart.config.types.ts`ï¼šåˆ é™¤ `WebGLOptimizationConfig`
- [ ] `starChart.config.store.ts`ï¼šåˆ é™¤ `webglOptimization` ç›¸å…³ä»£ç 
- [ ] `worker.types.ts`ï¼šåˆ é™¤ `WebGLOptimizationConfig` å¯¼å…¥

### éœ€è¦ä¿ç•™çš„æ–‡ä»¶
- âœ… `InitializationManager.ts`
- âœ… `starchartInit.worker.ts`
- âœ… `InitializationOptimizer.ts`
- âœ… `layout.ts`ï¼ˆé›¶ç¢°æ’ç®—æ³•ï¼‰
- âœ… `InitProgressPanel.vue`
- âœ… `starChart.store.ts`ï¼ˆè¿›åº¦ç®¡ç†ï¼‰

---

## ğŸš€ æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **å»¶è¿Ÿåˆå§‹åŒ– behaviors**ï¼ˆå½“å‰ç“¶é¢ˆï¼‰
2. **è™šæ‹ŸåŒ–æ¸²æŸ“**ï¼šåªæ¸²æŸ“å¯è§†åŒºåŸŸå†…çš„èŠ‚ç‚¹
3. **Canvas åˆ†å±‚**ï¼šé™æ€å±‚ + äº¤äº’å±‚
4. **WebGL Instanced Drawing**ï¼šG6 å¯èƒ½éœ€è¦æ›´æ–°

---

**æ€»ç»“**ï¼šWorker + é›¶ç¢°æ’ + animation:false + ä¿¡ä»» G6 = æ­£ç¡®çš„ä¼˜åŒ–è·¯çº¿ã€‚  
**æ•™è®­**ï¼šä¸è¦è¿‡åº¦è®¾è®¡ï¼Œä¸è¦é‡å¤é€ è½®å­ã€‚

